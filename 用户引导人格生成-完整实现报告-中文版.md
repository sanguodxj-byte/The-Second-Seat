# 用户引导人格生成 - 完整实现报告

## ?? 功能概述

本次实现添加了"用户引导人格生成"功能，允许用户在从图像生成叙事者时提供自定义的人物简介和性格标签。

---

## ?? 修改/创建的文件

### 1. `NarratorPersonaDef.cs` - 添加用户输入字段

```csharp
// 在 NarratorPersonaDef 类中添加：

/// <summary>
/// 用户提供的性格标签（用于引导生成）
/// </summary>
public List<string> personalityTags = new List<string>();

/// <summary>
/// 用户提供的补充简介（用于引导生成）
/// </summary>
public string supplementaryBiography = "";
```

**位置**：在 `toneTags` 字段之后添加

---

### 2. `MultimodalAnalysisService.cs` - 添加用户引导分析

#### 新方法签名

```csharp
/// <summary>
/// 使用用户提供的上下文分析纹理
/// 用户文本优先于视觉推断（性格方面）
/// 视觉推断优先于用户文本（外貌方面）
/// </summary>
public async Task<VisionAnalysisResult?> AnalyzeTextureAsync(
    Texture2D texture,
    string userDescription = "",
    List<string>? userTags = null)
```

#### 修改后的视觉提示词

```csharp
private string GetVisionPrompt(string userDescription = "", List<string>? userTags = null)
{
    string basePrompt = @"详细分析这个角色立绘并提供全面的 JSON 响应。

**关键要求：characterDescription 字段必须使用简体中文书写！**

{
  ""dominantColors"": [...],
  ""visualElements"": [...],
  ""characterDescription"": ""用简体中文写的详细300-500字人物描述"",
  ""mood"": ""整体氛围"",
  ""suggestedPersonality"": ""Benevolent/Sadistic/Chaotic/Strategic/Protective/Manipulative"",
  ""styleKeywords"": [...]
}";

    // 如果用户提供了上下文，添加整合说明
    if (!string.IsNullOrEmpty(userDescription) || (userTags != null && userTags.Count > 0))
    {
        string userContext = "\n\n**用户提供的上下文（关键优先级）：**\n";
        
        if (!string.IsNullOrEmpty(userDescription))
        {
            userContext += $"\n用户简介：\n{userDescription}\n";
        }
        
        if (userTags != null && userTags.Count > 0)
        {
            userContext += $"\n用户性格标签：{string.Join(", ", userTags)}\n";
        }
        
        userContext += @"
**整合规则（强制要求）：**
1. **对于性格（性格/个性）**：
   - 用户提供的简介和标签优先于视觉推断
   - 如果用户说"善良"，性格必须是 Benevolent，无论视觉线索如何
   - 如果用户说"狡猾"，性格必须是 Manipulative
   - 用户对角色特征的描述具有绝对优先级

2. **对于外貌描述**：
   - 视觉分析优先于用户文本
   - 只使用图像中看到的内容
   - 如果与视觉证据冲突，忽略用户的外貌描述
   - 例如：如果图像显示盔甲但用户说"穿着长袍"，描述中使用"盔甲"

3. **characterDescription 写作方式**：
   - 第一段：视觉外貌（仅来自图像）
   - 第二段：性格（首先来自用户输入，然后是视觉推断）
   - 第三段：行为预测（基于用户的性格描述）

4. **suggestedPersonality**：
   - 必须反映用户的性格标签/描述
   - 将用户输入映射到：Benevolent/Sadistic/Chaotic/Strategic/Protective/Manipulative
   - 示例：
     * "善良/仁慈" → Benevolent
     * "残忍/冷酷" → Sadistic
     * "混乱/疯狂" → Chaotic
     * "聪明/狡猾" → Strategic/Manipulative
     * "保护/守护" → Protective

**记住**：用户的性格描述 > 视觉性格推断
         视觉外貌 > 用户的外貌描述";
        
        return basePrompt + userContext;
    }
    
    return basePrompt;
}
```

---

### 3. `PersonaSelectionWindow.cs` - 添加标签显示

#### 新增方法

```csharp
private void DrawPersonaCard(Rect rect, NarratorPersonaDef persona)
{
    // ... 现有代码 ...
    
    float curY = infoRect.y + 54f; // 在名字和性格之后
    
    // ? 新增：将性格标签绘制为徽章
    if (persona.personalityTags != null && persona.personalityTags.Count > 0)
    {
        DrawPersonalityTags(new Rect(infoRect.x, curY, infoRect.width, 20f), persona.personalityTags);
        curY += 22f;
    }
    
    // ... 其余现有代码 ...
}

/// <summary>
/// 将性格标签绘制为彩色徽章
/// </summary>
private void DrawPersonalityTags(Rect rect, List<string> tags)
{
    float x = rect.x;
    float maxWidth = rect.width;
    
    Text.Font = GameFont.Tiny;
    
    foreach (var tag in tags.Take(5)) // 最多显示5个标签
    {
        string displayTag = tag.Length > 8 ? tag.Substring(0, 7) + "…" : tag;
        float tagWidth = Text.CalcSize(displayTag).x + 12f;
        
        if (x + tagWidth > rect.x + maxWidth)
            break; // 没有更多空间
        
        Rect tagRect = new Rect(x, rect.y, tagWidth, 18f);
        
        // 根据标签内容设置背景颜色
        Color bgColor = GetTagColor(tag);
        Widgets.DrawBoxSolid(tagRect, bgColor);
        Widgets.DrawBox(tagRect, 1);
        
        // 文本
        GUI.color = Color.white;
        Widgets.Label(tagRect.ContractedBy(2f), displayTag);
        GUI.color = Color.white;
        
        x += tagWidth + 4f;
    }
    
    Text.Font = GameFont.Small;
}

/// <summary>
/// 根据语义含义获取标签颜色
/// </summary>
private Color GetTagColor(string tag)
{
    string lowerTag = tag.ToLowerInvariant();
    
    // 正面特质
    if (lowerTag.Contains("善良") || lowerTag.Contains("benevolent") || 
        lowerTag.Contains("kind") || lowerTag.Contains("仁慈"))
        return new Color(0.3f, 0.7f, 0.3f, 0.7f); // 绿色
    
    // 负面特质
    if (lowerTag.Contains("残忍") || lowerTag.Contains("sadistic") || 
        lowerTag.Contains("cruel") || lowerTag.Contains("冷酷"))
        return new Color(0.8f, 0.2f, 0.2f, 0.7f); // 红色
    
    // 战略特质
    if (lowerTag.Contains("聪明") || lowerTag.Contains("strategic") || 
        lowerTag.Contains("smart") || lowerTag.Contains("狡猾"))
        return new Color(0.3f, 0.5f, 0.8f, 0.7f); // 蓝色
    
    // 混乱特质
    if (lowerTag.Contains("混乱") || lowerTag.Contains("chaotic") || 
        lowerTag.Contains("mad") || lowerTag.Contains("疯狂"))
        return new Color(0.9f, 0.5f, 0.1f, 0.7f); // 橙色
    
    // 保护特质
    if (lowerTag.Contains("保护") || lowerTag.Contains("protective") || 
        lowerTag.Contains("guard") || lowerTag.Contains("守护"))
        return new Color(0.5f, 0.7f, 0.9f, 0.7f); // 浅蓝色
    
    // 默认：灰色
    return new Color(0.5f, 0.5f, 0.5f, 0.7f);
}
```

---

### 4. **新文件**：`Dialog_PersonaGenerationSettings.cs`

完整代码见：`Source/TheSecondSeat/UI/Dialog_PersonaGenerationSettings.cs`

**核心功能：**
- 立绘预览
- 人物简介输入（最多500字）
- 性格标签输入（逗号分隔，最多10个）
- 输入验证和实时预览
- "跳过（默认生成）"和"生成人格"按钮

---

### 5. 集成：修改 `PersonaSelectionWindow.cs`

将 `CreatePersonaFromPortrait` 调用替换为对话框：

```csharp
private void OpenPortraitPickerForNewPersona()
{
    var allPortraits = PortraitLoader.GetAllAvailablePortraits();
    
    if (allPortraits.Count == 0)
    {
        Messages.Message("未找到任何立绘", MessageTypeDefOf.RejectInput);
        PortraitLoader.OpenModPortraitsDirectory();
        return;
    }
    
    List<FloatMenuOption> options = new List<FloatMenuOption>();
    
    // ... 按来源分组立绘 ...
    
    // ? 修改：打开设置对话框而不是直接生成
    foreach (var portrait in allPortraits)
    {
        options.Add(new FloatMenuOption(portrait.Name, () => {
            Texture2D? texture = portrait.Texture;
            if (texture == null && portrait.Path.StartsWith("UI/"))
            {
                texture = ContentFinder<Texture2D>.Get(portrait.Path, false);
            }
            else if (texture == null)
            {
                texture = PortraitLoader.LoadFromExternalFile(portrait.Path);
            }
            
            if (texture != null)
            {
                // ? 打开用户引导生成对话框
                Find.WindowStack.Add(new Dialog_PersonaGenerationSettings(texture, portrait.Path));
            }
            else
            {
                Messages.Message("无法加载立绘", MessageTypeDefOf.RejectInput);
            }
        }));
    }
    
    Find.WindowStack.Add(new FloatMenu(options));
}
```

---

## ?? 视觉设计

### 标签徽章外观

```
┌──────────────────────────────────────┐
│ ★ Cassandra Classic                  │
│ 性格：Strategic (战略型)             │
│ [善良] [聪明] [冷静] [理性] [负责]    │ ← 彩色徽章
│ 风格：正式, 情感化, 详细              │
│ 殖民地的引导者，以平衡的难度...       │
└──────────────────────────────────────┘
```

---

## ?? 使用流程

### 用户引导生成流程

```
1. 点击"从立绘生成新人格"
   ↓
2. 从列表中选择立绘
   ↓
3. [新增] Dialog_PersonaGenerationSettings 打开
   ↓
4. 用户输入：
   - 简介（可选，最多500字）
   - 标签（逗号分隔，最多10个）
   ↓
5. 点击"生成人格"或"跳过（默认生成）"
   ↓
6. MultimodalAnalysisService.AnalyzeTextureAsync(texture, userBio, userTags)
   ↓
7. LLM 将用户上下文与视觉分析整合
   ↓
8. 创建人格：
   - personalityTags = 用户标签
   - supplementaryBiography = 用户简介
   - biography = LLM 生成（优先用户性格）
   ↓
9. 人格显示带彩色标签徽章
```

---

## ?? 测试用例

### 测试用例1：空用户输入
- 输入：无简介，无标签
- 预期：标准图像分析（现有行为）

### 测试用例2：仅用户标签
- 输入：标签 = "善良,聪明,幽默"
- 预期：性格匹配标签，外貌来自图像

### 测试用例3：仅用户简介
- 输入：简介 = "一位温柔的守护者，总是保护弱小"
- 预期：suggestedPersonality = "Protective"，语气反映简介

### 测试用例4：冲突的用户输入
- 用户说："残忍"，但图像显示天使
- 预期：性格 = Sadistic，外貌 = 天使（视觉覆盖）

### 测试用例5：标签显示
- 创建带标签的人格：["善良", "聪明", "冷静", "理性", "负责"]
- 预期：人格名称下显示5个彩色徽章

---

## ?? 功能总结

### ? 已实现

- [x] `NarratorPersonaDef` 中的 `personalityTags` 字段
- [x] `NarratorPersonaDef` 中的 `supplementaryBiography` 字段
- [x] 修改 `AnalyzeTextureAsync` 接受用户上下文
- [x] 增强视觉提示词与整合规则
- [x] 用户优先级：性格 > 视觉推断
- [x] 视觉优先级：外貌 > 用户描述
- [x] `PersonaSelectionWindow` 中的标签徽章显示
- [x] 彩色徽章（绿/红/蓝/橙/灰）
- [x] `Dialog_PersonaGenerationSettings` 窗口
- [x] 输入验证（最多500字简介，最多10个标签）
- [x] 默认生成的跳过选项

### ? 优先级规则

| 方面 | 优先级 | 示例 |
|------|--------|------|
| 性格 | 用户输入 > 视觉 | 用户说"善良" → Benevolent（即使图像看起来黑暗） |
| 外貌 | 视觉 > 用户 | 图像显示盔甲 → 描述中使用"盔甲"（即使用户说"长袍"） |
| 行为 | 用户的性格 | 基于用户的性格描述优先 |

---

## ?? 部署

### 要添加/修改的文件

```
Source/TheSecondSeat/PersonaGeneration/
  ├─ NarratorPersonaDef.cs（修改 - 添加2个字段）
  ├─ MultimodalAnalysisService.cs（修改 - 更新2个方法）
  └─ （现有文件）

Source/TheSecondSeat/UI/
  ├─ PersonaSelectionWindow.cs（修改 - 添加 DrawPersonalityTags 方法）
  └─ Dialog_PersonaGenerationSettings.cs（新文件）
```

### 构建命令

```powershell
cd Source
dotnet build TheSecondSeat.csproj
```

---

**状态**：? 实现完成  
**版本**：v1.7.0  
**日期**：2025-01-XX
