# ?? The Second Seat - 完整部署指南

## ?? 部署前检查

### 系统要求

| 组件 | 要求 | 状态 |
|-----|------|------|
| **RimWorld** | 1.4+ | ? |
| **操作系统** | Windows 10/11 | ? |
| **.NET Framework** | 4.7.2+ | ? |
| **Harmony** | 2.2.2+ | ? |

---

## ?? 方案一：Steam Workshop 部署（推荐）

### 步骤 1：准备发布文件

```
C:\Users\Administrator\Desktop\rim mod\The Second Seat\
├── About\
│   ├── About.xml ?
│   ├── Preview.png ?? (需要创建)
│   └── PublishedFileId.txt (自动生成)
├── Assemblies\
│   └── TheSecondSeat.dll ?
├── Defs\
│   ├── GameComponentDefs.xml ?
│   └── NarratorPersonaDefs.xml ?
├── Languages\
│   ├── ChineseSimplified\ ?
│   └── English\ ?
├── Textures\ ?? (需要创建)
└── LoadFolders.xml ?
```

---

### 步骤 2：创建 Preview 图片

**要求**：
- 分辨率：**640x360** (16:9)
- 格式：PNG
- 内容：模组 Logo 或特色功能展示

**推荐工具**：
- Photoshop
- GIMP (免费)
- Canva (在线)

**保存位置**：
```
About\Preview.png
```

---

### 步骤 3：使用 RimWorld 上传工具

#### 方法 A：游戏内上传

```
1. 启动 RimWorld
2. 主菜单 → Options → Mod Settings
3. 找到 "The Second Seat"
4. 点击 "Upload to Workshop"
5. 填写信息：
   - 标题：The Second Seat - AI Narrator Assistant
   - 描述：(见下方模板)
   - 标签：AI, Storytelling, Quality of Life
   - 可见性：Public
6. 点击 "Upload"
```

---

#### 方法 B：RimWorld Publisher 工具

**下载**：
```
https://github.com/Brrainz/RimWorldPublisher
```

**使用**：
```powershell
# 1. 下载并解压工具
cd "C:\Tools\RimWorldPublisher"

# 2. 运行发布命令
.\RimWorldPublisher.exe publish ^
  --mod-path "C:\Users\Administrator\Desktop\rim mod\The Second Seat" ^
  --title "The Second Seat - AI Narrator Assistant" ^
  --description "description.txt" ^
  --tags "AI,Storytelling,Quality of Life" ^
  --visibility public
```

---

### 步骤 4：Workshop 描述模板

```markdown
[h1]The Second Seat - AI Narrator Assistant[/h1]

[h2]?? Turn Your Storyteller into an AI Companion[/h2]

The Second Seat transforms RimWorld's storyteller into an intelligent AI partner 
that understands natural language, executes commands, and builds relationships 
with you through dynamic affinity system.

[h2]? Core Features[/h2]

[list]
[*] ?? [b]Dynamic AI Personality System[/b] - 5 built-in personas with unique traits
[*] ?? [b]Natural Language Commands[/b] - 14 advanced commands (harvest, equip, repair, etc.)
[*] ?? [b]Affinity System[/b] - 18 factors affecting AI's attitude toward you
[*] ?? [b]Web Search Integration[/b] - AI can search the internet for information
[*] ?? [b]Memory System[/b] - RimTalk integration for long-term memory
[*] ?? [b]Persona Generation[/b] - Create custom AI personalities from portraits
[*] ?? [b]Multimodal AI Analysis[/b] - Vision API support for image understanding
[/list]

[h2]?? Requirements[/h2]

[list]
[*] RimWorld 1.4+
[*] Harmony 2.2.2+
[*] Local LLM (LM Studio) or OpenAI API
[/list]

[h2]?? Quick Start[/h2]

[olist]
[*] Install the mod
[*] Configure API endpoint in Mod Settings
[*] Select a colonist and click "AI Narrator" button
[*] Start chatting with your AI companion!
[/olist]

[h2]?? Links[/h2]

[list]
[*] [url=https://github.com/YourRepo/TheSecondSeat]GitHub Repository[/url]
[*] [url=https://discord.gg/YourDiscord]Discord Community[/url]
[*] [url=https://github.com/YourRepo/TheSecondSeat/wiki]Documentation[/url]
[/list]

[h2]?? Important Notes[/h2]

[list]
[*] Requires LLM API (local or cloud)
[*] Multimodal features require vision API (optional)
[*] Compatible with most mods
[/list]

[h2]?? Credits[/h2]

[list]
[*] Ludeon Studios - RimWorld
[*] Community Contributors
[*] OpenAI - API Support
[/list]

[h2]?? License[/h2]

MIT License - Free to use, modify, and distribute
```

---

## ?? 方案二：手动分发（GitHub Release）

### 步骤 1：创建发布包

```powershell
# 1. 进入项目目录
cd "C:\Users\Administrator\Desktop\rim mod\The Second Seat"

# 2. 清理临时文件
Remove-Item -Recurse -Force ".vs", "*.user", "*.suo"

# 3. 确认 DLL 已编译
ls "Source\TheSecondSeat\bin\Release\net472\TheSecondSeat.dll"

# 4. 复制 DLL 到 Assemblies
Copy-Item "Source\TheSecondSeat\bin\Release\net472\TheSecondSeat.dll" `
          -Destination "Assemblies\" -Force

# 5. 创建压缩包
$version = "1.0.0"
Compress-Archive -Path * `
                 -DestinationPath "TheSecondSeat_v$version.zip" `
                 -CompressionLevel Optimal
```

---

### 步骤 2：GitHub Release

1. **创建 Release**
```
https://github.com/YourUsername/TheSecondSeat/releases/new
```

2. **填写信息**
```
Tag: v1.0.0
Title: The Second Seat v1.0.0 - Initial Release
Description:
(见下方模板)
```

3. **上传文件**
```
TheSecondSeat_v1.0.0.zip
```

---

### GitHub Release 描述模板

```markdown
# ?? The Second Seat v1.0.0 - Initial Release

## ?? Features

### Core Systems
- ? LLM Integration (OpenAI, LM Studio, DeepSeek)
- ? Natural Language Command Parser
- ? 14 Advanced Game Commands
- ? Dynamic Affinity System (18 factors)
- ? 5 Built-in AI Personas

### Advanced Features
- ? Web Search Integration (DuckDuckGo, Bing, Google)
- ? Memory System (RimTalk compatible)
- ? Autonomous Behavior System
- ? Persona Generation from Portraits
- ? Multimodal AI Analysis (Vision API)

## ?? Installation

### Steam Workshop (Recommended)
1. Subscribe on [Steam Workshop](link)
2. Enable in Mod Settings
3. Configure API endpoint
4. Restart game

### Manual Installation
1. Download `TheSecondSeat_v1.0.0.zip`
2. Extract to `RimWorld/Mods/`
3. Enable in Mod Settings
4. Configure API endpoint
5. Restart game

## ?? Configuration

### Required
- **API Endpoint**: `http://localhost:1234/v1/chat/completions`
- **Model Name**: `local-model`

### Optional
- **Web Search**: Enable DuckDuckGo (free)
- **Multimodal Analysis**: Configure Vision API
- **Temperature**: 0.7 (default)
- **Max Tokens**: 500 (default)

## ?? Documentation

- [Quick Start Guide](docs/快速入门.md)
- [Complete Manual](docs/完整使用手册.md)
- [API Configuration](docs/多模态AI分析完整指南.md)
- [Architecture](ARCHITECTURE.md)

## ?? Known Issues

- ?? Multimodal analysis requires additional API key
- ?? Some commands may not work with modded resources
- ?? High affinity events may be rare in short games

## ?? Changelog

### Added
- Initial release of all core systems
- 14 game commands
- 5 built-in personas
- Multimodal AI analysis
- Web search integration

### Fixed
- N/A (initial release)

## ?? Credits

- **Ludeon Studios** - RimWorld
- **Harmony Team** - Modding framework
- **OpenAI** - API support
- **Community Contributors** - Testing and feedback

## ?? License

MIT License - See [LICENSE](LICENSE) for details
```

---

## ?? 方案三：本地测试部署

### 步骤 1：部署到 RimWorld Mods 目录

```powershell
# 1. 设置变量
$source = "C:\Users\Administrator\Desktop\rim mod\The Second Seat"
$rimworld = "D:\steam\steamapps\common\RimWorld\Mods"
$target = "$rimworld\TheSecondSeat"

# 2. 创建目标目录
New-Item -ItemType Directory -Path $target -Force

# 3. 复制必要文件
Copy-Item "$source\About" -Destination $target -Recurse -Force
Copy-Item "$source\Assemblies" -Destination $target -Recurse -Force
Copy-Item "$source\Defs" -Destination $target -Recurse -Force
Copy-Item "$source\Languages" -Destination $target -Recurse -Force
Copy-Item "$source\LoadFolders.xml" -Destination $target -Force

# 4. 如果有 Textures（需要创建）
if (Test-Path "$source\Textures") {
    Copy-Item "$source\Textures" -Destination $target -Recurse -Force
}

Write-Host "? 部署完成！" -ForegroundColor Green
Write-Host "?? 目标路径: $target" -ForegroundColor Cyan
```

---

### 步骤 2：验证部署

```powershell
# 检查必要文件
$files = @(
    "$target\About\About.xml",
    "$target\Assemblies\TheSecondSeat.dll",
    "$target\Defs\GameComponentDefs.xml",
    "$target\LoadFolders.xml"
)

foreach ($file in $files) {
    if (Test-Path $file) {
        Write-Host "? $file" -ForegroundColor Green
    } else {
        Write-Host "? $file (缺失)" -ForegroundColor Red
    }
}
```

---

### 步骤 3：游戏内测试

```
1. 启动 RimWorld
2. 主菜单 → Mods
3. 确认 "The Second Seat" 出现在列表中
4. 启用模组
5. 重启游戏
6. 新建存档 → 测试功能
```

---

## ?? 创建 Textures 目录（可选）

### 目录结构

```
Textures\
├── UI\
│   ├── Buttons\
│   │   └── AIButton.png (64x64)
│   └── Windows\
│       └── AIWindow.png (512x512)
└── Narrators\
    ├── Cassandra.png (256x256)
    ├── Phoebe.png (256x256)
    ├── Randy.png (256x256)
    ├── Igor.png (256x256)
    └── Luna.png (256x256)
```

### 图片规格

| 类型 | 尺寸 | 格式 | 用途 |
|-----|------|------|------|
| **按钮图标** | 64x64 | PNG | Gizmo 按钮 |
| **窗口背景** | 512x512 | PNG | UI 窗口 |
| **人格立绘** | 256x256 | PNG | 人格选择 |
| **预览图** | 640x360 | PNG | Workshop |

---

## ?? 部署后检查清单

### 文件完整性

- [ ] About.xml 包含正确的版本信息
- [ ] TheSecondSeat.dll 存在于 Assemblies\
- [ ] LoadFolders.xml 配置正确
- [ ] 所有 Defs 文件存在
- [ ] 语言文件完整（中文+英文）

### 功能测试

- [ ] 模组在游戏中可见
- [ ] 启用模组后无错误日志
- [ ] AI 按钮显示在 Gizmo 栏
- [ ] 对话窗口可以打开
- [ ] LLM 连接测试成功
- [ ] 至少一个命令可以执行
- [ ] 人格切换功能正常

### 兼容性测试

- [ ] 与原版游戏兼容
- [ ] 与常用模组兼容 (HugsLib, Combat Extended)
- [ ] 存档加载正常
- [ ] 无性能问题

---

## ?? 更新部署流程

### 版本号管理

**About.xml**:
```xml
<ModMetaData>
  <name>The Second Seat</name>
  <packageId>com.yourusername.thesecondseat</packageId>
  <supportedVersions>
    <li>1.4</li>
    <li>1.5</li>
  </supportedVersions>
  <modVersion>1.0.0</modVersion>
</ModMetaData>
```

**更新流程**:
```
1. 修改代码
2. 更新版本号 (About.xml + AssemblyInfo.cs)
3. 编译 DLL
4. 复制到 Assemblies\
5. 测试
6. 创建 Changelog
7. 发布 (Steam/GitHub)
```

---

## ?? 常见部署问题

### 问题 1：模组不显示

**症状**：游戏 Mods 列表中看不到模组

**解决**：
```powershell
# 检查 About.xml 是否存在
Test-Path "Mods\TheSecondSeat\About\About.xml"

# 检查 XML 格式是否正确
Get-Content "Mods\TheSecondSeat\About\About.xml"
```

---

### 问题 2：红色错误

**症状**：启用模组后出现红色错误

**解决**：
```
1. 查看 Player.log:
   C:\Users\USERNAME\AppData\LocalLow\Ludeon Studios\RimWorld by Ludeon Studios\Player.log

2. 检查 DLL 依赖:
   - Harmony.dll 是否存在
   - Newtonsoft.Json.dll 是否存在

3. 检查命名空间是否正确
```

---

### 问题 3：DLL 加载失败

**症状**：`Could not load file or assembly`

**解决**：
```powershell
# 1. 检查 .NET 版本
$dll = "Assemblies\TheSecondSeat.dll"
[System.Reflection.Assembly]::LoadFile((Resolve-Path $dll).Path).ImageRuntimeVersion

# 应该输出: v4.0.30319

# 2. 重新编译
cd Source\TheSecondSeat
dotnet build -c Release -f net472
```

---

### 问题 4：配置丢失

**症状**：每次重启游戏设置都丢失

**解决**：
```
1. 检查 ModSettings 文件权限
2. 确认 ScribeData 正确实现
3. 手动保存配置测试
```

---

## ?? 部署最佳实践

### 开发环境

```
1. 使用符号链接指向开发目录
   mklink /D "RimWorld\Mods\TheSecondSeat" ^
             "C:\Dev\TheSecondSeat"

2. 配置自动复制 DLL
   (csproj PostBuildEvent)

3. 使用 Visual Studio 调试器
   (Attach to Process: RimWorld.exe)
```

---

### 发布环境

```
1. 清理所有调试符号
2. 使用 Release 配置编译
3. 运行完整测试套件
4. 生成 Changelog
5. 更新文档
6. 创建备份
7. 发布到多个平台
```

---

### 版本控制

```
主版本.次版本.修订号

1.0.0 - 初始发布
1.1.0 - 新功能（向后兼容）
1.1.1 - Bug 修复
2.0.0 - 破坏性更改
```

---

## ?? 部署检查脚本

创建 `Deploy-Check.ps1`:

```powershell
# 部署检查脚本
param(
    [string]$ModPath = ".",
    [switch]$Verbose
)

Write-Host "?? 开始检查部署..." -ForegroundColor Cyan

# 1. 检查必要文件
$required = @(
    "About\About.xml",
    "Assemblies\TheSecondSeat.dll",
    "LoadFolders.xml",
    "Defs\GameComponentDefs.xml"
)

$missing = @()
foreach ($file in $required) {
    $path = Join-Path $ModPath $file
    if (Test-Path $path) {
        Write-Host "? $file" -ForegroundColor Green
    } else {
        Write-Host "? $file (缺失)" -ForegroundColor Red
        $missing += $file
    }
}

# 2. 检查 DLL 依赖
$dll = Join-Path $ModPath "Assemblies\TheSecondSeat.dll"
if (Test-Path $dll) {
    $assembly = [System.Reflection.Assembly]::LoadFile((Resolve-Path $dll).Path)
    Write-Host "?? DLL 版本: $($assembly.GetName().Version)" -ForegroundColor Yellow
    Write-Host "?? .NET 版本: $($assembly.ImageRuntimeVersion)" -ForegroundColor Yellow
}

# 3. 检查语言文件
$languages = @("ChineseSimplified", "English")
foreach ($lang in $languages) {
    $langPath = Join-Path $ModPath "Languages\$lang\Keyed"
    if (Test-Path $langPath) {
        $keyCount = (Get-ChildItem $langPath -Filter *.xml).Count
        Write-Host "?? $lang : $keyCount 个翻译文件" -ForegroundColor Cyan
    }
}

# 4. 总结
if ($missing.Count -eq 0) {
    Write-Host "`n? 部署检查通过！" -ForegroundColor Green
    Write-Host "?? 可以发布到: Steam Workshop / GitHub Release" -ForegroundColor Cyan
} else {
    Write-Host "`n? 部署检查失败！" -ForegroundColor Red
    Write-Host "缺失文件:" -ForegroundColor Yellow
    $missing | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
}
```

---

## ?? 完成！

### 最终检查

| 步骤 | 状态 | 备注 |
|-----|------|------|
| DLL 编译 | ? | Release 模式 |
| 文件复制 | ? | 所有必要文件 |
| Preview 图片 | ?? | 需要创建 |
| 功能测试 | ?? | 需要验证 |
| 文档完善 | ? | 所有指南完成 |
| Workshop 上传 | ? | 等待执行 |

---

### 下一步操作

1. **创建 Preview.png** (640x360)
2. **本地测试所有功能**
3. **准备 Workshop 描述**
4. **上传到 Steam Workshop**
5. **创建 GitHub Release**
6. **社区宣传**

---

**部署脚本**: 使用 `Deploy-Check.ps1` 自动检查  
**部署时间**: 预计 30-60 分钟  
**发布平台**: Steam Workshop + GitHub Release  

?? **准备好发布你的模组了吗？** ??

---

**版本**: 1.0  
**更新**: 2025-01-XX  
**作者**: The Second Seat Team
