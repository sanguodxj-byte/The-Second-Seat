# 立绘模式功能实现总结 v1.6.16

## ? 实现完成

**版本：** v1.6.16  
**日期：** 2025-01-XX  
**功能：** 立绘模式（1024x1572 全身立绘）

---

## ?? 实现内容

### 1?? 添加设置选项

**文件：** `Source/TheSecondSeat/Settings/ModSettings.cs`

**新增字段：**
```csharp
// ? 立绘模式设置
public bool usePortraitMode = false;  // 默认使用头像模式（512x512）
```

**UI 设置界面：**
```
[?] 使用立绘模式（1024x1572 全身立绘）
    启用后，AI 按钮将显示完整立绘而非头像
    立绘尺寸：1024x1572（全身）
    
[ ] 当前使用头像模式：512x512（脸部特写）
```

---

### 2?? 修改 UI 按钮加载逻辑

**文件：** `Source/TheSecondSeat/UI/NarratorScreenButton.cs`

**修改方法：** `UpdatePortrait()`

**实现逻辑：**
```csharp
// 根据设置选择加载头像或立绘
var modSettings = LoadedModManager.GetMod<TheSecondSeatMod>()?.GetSettings<TheSecondSeatSettings>();
if (modSettings != null && modSettings.usePortraitMode)
{
    // 立绘模式：使用 1024x1572 全身立绘
    currentPortrait = PortraitLoader.LoadPortrait(persona, currentExpression);
}
else
{
    // 头像模式：使用 512x512 头像
    currentPortrait = AvatarLoader.LoadAvatar(persona, currentExpression);
}
```

---

### 3?? 纹理文件目录结构

#### 头像模式（512x512）

```
Textures/UI/Narrators/Avatars/
└── {PersonaName}/
    ├── base.png          # 512x512 头像（中性表情）
    ├── happy.png         # 512x512 头像（开心表情）
    ├── sad.png           # 512x512 头像（悲伤表情）
    └── ...
```

#### 立绘模式（1024x1572）

```
Textures/UI/Narrators/9x16/
├── {PersonaName}/
│   └── base.png         # 1024x1572 基础立绘
└── Expressions/
    └── {PersonaName}/
        ├── happy.png     # 1024x1572 开心表情立绘
        ├── sad.png       # 1024x1572 悲伤表情立绘
        └── ...
```

---

## ?? 使用方法

### 切换到立绘模式

1. **打开 Mod 设置：**
   - 主菜单 → 选项 → Mod 设置 → The Second Seat

2. **启用立绘模式：**
   - 勾选"使用立绘模式（1024x1572 全身立绘）"

3. **保存设置：**
   - 点击"应用"按钮

4. **重新加载游戏：**
   - 设置将在下次加载游戏时生效

---

### 准备立绘素材

#### 文件命名规范

**基础立绘：**
```
Textures/UI/Narrators/9x16/Sideria/base.png
```

**表情立绘：**
```
Textures/UI/Narrators/9x16/Expressions/Sideria/happy.png
Textures/UI/Narrators/9x16/Expressions/Sideria/sad.png
Textures/UI/Narrators/9x16/Expressions/Sideria/angry.png
```

#### 尺寸要求

| 模式 | 尺寸 | 比例 | 用途 |
|------|------|------|------|
| **头像模式** | 512x512 | 1:1 | 脸部特写 |
| **立绘模式** | 1024x1572 | 约 2:3 | 全身立绘 |

---

## ?? 对比

### 头像模式 vs 立绘模式

| 特性 | 头像模式 (512x512) | 立绘模式 (1024x1572) |
|------|-------------------|---------------------|
| **尺寸** | 512x512 | 1024x1572 |
| **比例** | 1:1 正方形 | 约 2:3 竖版 |
| **内容** | 脸部特写 | 全身立绘 |
| **文件大小** | 约 100-300 KB | 约 400-800 KB |
| **加载速度** | 快 | 稍慢 |
| **视觉效果** | 精致，表情清晰 | 震撼，全身展示 |
| **适用场景** | 简洁 UI，性能优先 | 视觉体验优先 |

---

## ?? 技术细节

### 加载逻辑

```
用户点击设置
    ↓
保存 usePortraitMode = true
    ↓
UpdatePortrait() 检测设置
    ↓
if (usePortraitMode)
    使用 PortraitLoader.LoadPortrait()
    尝试加载 1024x1572 立绘
else
    使用 AvatarLoader.LoadAvatar()
    尝试加载 512x512 头像
    ↓
显示在 AI 按钮上
```

### 回退机制

**立绘模式回退顺序：**
1. 尝试加载完整表情立绘（如 `happy.png`）
2. 回退到面部覆盖模式（`base.png` + `happy_face.png`）
3. 回退到基础立绘（`base.png`）
4. 回退到占位符（自动生成）

**头像模式回退顺序：**
1. 尝试加载表情头像（如 `happy.png`）
2. 回退到面部覆盖模式（`base.png` + `happy_face.png`）
3. 回退到基础头像（`base.png`）
4. 回退到占位符（自动生成）

---

## ?? 文件清单

### 修改的文件

| 文件 | 修改内容 |
|------|---------|
| `Source/TheSecondSeat/Settings/ModSettings.cs` | 添加 `usePortraitMode` 字段和 UI |
| `Source/TheSecondSeat/UI/NarratorScreenButton.cs` | 修改 `UpdatePortrait()` 方法 |

### 新增的文档

| 文档 | 说明 |
|------|------|
| `立绘模式功能实现总结-v1.6.16.md` | 本文档 |
| `立绘模式-快速参考.md` | 快速参考卡 |

---

## ?? 示例场景

### 场景 1: 默认使用头像模式

```
玩家 A：我想要精致的 UI，性能优先
设置：[ ] 使用立绘模式
结果：AI 按钮显示 512x512 头像
     文件路径：Textures/UI/Narrators/Avatars/Sideria/base.png
```

### 场景 2: 切换到立绘模式

```
玩家 B：我想要震撼的视觉效果
设置：[?] 使用立绘模式
结果：AI 按钮显示 1024x1572 全身立绘
     文件路径：Textures/UI/Narrators/9x16/Sideria/base.png
```

### 场景 3: 表情变化

```
触发事件：玩家连续触摸头像10次
表情变化：Neutral → Happy

头像模式：
  加载 Textures/UI/Narrators/Avatars/Sideria/happy.png

立绘模式：
  加载 Textures/UI/Narrators/9x16/Expressions/Sideria/happy.png
```

---

## ?? 验证方法

### 检查设置

```csharp
var modSettings = LoadedModManager.GetMod<TheSecondSeatMod>()?.GetSettings<TheSecondSeatSettings>();
if (modSettings != null)
{
    Log.Message($"立绘模式: {modSettings.usePortraitMode}");
}
```

### 检查加载的纹理

```csharp
if (currentPortrait != null)
{
    Log.Message($"当前纹理尺寸: {currentPortrait.width}x{currentPortrait.height}");
    // 头像模式: 512x512
    // 立绘模式: 1024x1572
}
```

---

## ?? 部署步骤

### 1. 编译项目

```powershell
dotnet build Source/TheSecondSeat/TheSecondSeat.csproj --configuration Release
```

### 2. 准备立绘素材

```
创建目录结构：
Textures/UI/Narrators/9x16/Sideria/
├── base.png (1024x1572)
└── Expressions/
    ├── happy.png (1024x1572)
    ├── sad.png (1024x1572)
    └── angry.png (1024x1572)
```

### 3. 部署到 Mod 目录

```powershell
.\Deploy-Animation-System.ps1
```

**部署结果：**
```
? DLL 已复制: TheSecondSeat.dll
? Defs 已复制: 2 个文件
? Textures 已复制: 46 个文件
? Materials 已复制: 0 个文件（可选）
? 立绘素材已部署
```

### 4. 启动游戏测试

```
1. 启动 RimWorld
2. 加载存档
3. 打开 Mod 设置
4. 启用立绘模式
5. 保存设置
6. 重新加载游戏
7. 观察 AI 按钮是否显示立绘
```

---

## ?? 注意事项

### 1. 性能影响

**立绘模式：**
- ? 纹理尺寸更大（约 3-4 倍）
- ?? 加载时间稍长
- ?? 内存占用增加

**建议：**
- 低性能设备：使用头像模式
- 高性能设备：使用立绘模式

---

### 2. 素材要求

**必需的立绘：**
```
? base.png (1024x1572) - 基础立绘
```

**可选的表情立绘：**
```
○ happy.png (1024x1572)
○ sad.png (1024x1572)
○ angry.png (1024x1572)
○ ...
```

**如果缺失：**
- 系统会自动回退到头像模式
- 或使用占位符

---

### 3. 兼容性

**与其他功能的兼容性：**

| 功能 | 头像模式 | 立绘模式 |
|------|---------|---------|
| 动态表情 | ? | ? |
| 触摸互动 | ? | ? |
| 好感度系统 | ? | ? |
| TTS 语音 | ? | ? |
| 面部覆盖 | ? | ? |

---

## ? 总结

### 新增功能

```
? 立绘模式设置选项
? 动态切换头像/立绘
? 支持 1024x1572 全身立绘
? 保持所有表情功能
? 自动回退机制
```

### 使用建议

| 场景 | 推荐模式 |
|------|---------|
| 追求性能 | 头像模式 |
| 追求视觉 | 立绘模式 |
| 移动设备 | 头像模式 |
| 高端 PC | 立绘模式 |

---

**立绘模式实现完成！** ?  
**版本：** v1.6.16  
**状态：** 可选功能，由用户控制

现在用户可以在设置中自由切换头像模式和立绘模式！??

_The Second Seat Mod Team_
