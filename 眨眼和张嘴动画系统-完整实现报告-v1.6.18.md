# 眨眼和张嘴动画系统 - 完整实现报告 v1.6.18

## ? 实现完成总结

**呼吸动画、表情系统、眨眼动画、张嘴动画已完全适配分层立绘系统！**

---

## ?? 系统架构

```
用户触发表情/TTS播放
         ↓
ExpressionSystem.SetExpression()
BlinkAnimationSystem.GetBlinkLayerName()   ← 眨眼逻辑
MouthAnimationSystem.GetMouthLayerName()   ← 张嘴逻辑
         ↓
LayeredPortraitCompositor.CompositeLayers()
         ↓
ApplyAnimationLayers() ← 动态替换眼睛/嘴巴层路径
         ↓
合成分层立绘（Body + Face + Eyes + Mouth + ...）
         ↓
NarratorScreenButton/NarratorWindow 绘制
         ↓
应用呼吸偏移 + 眨眼/张嘴动画
         ↓
最终渲染：立绘随呼吸浮动，眼睛眨动，嘴巴开合
```

---

## ?? 已实现功能

### 1. **BlinkAnimationSystem.cs** ?
- **功能：** 自动眨眼动画系统
- **特性：**
  - 随机眨眼周期（3-6秒）
  - 根据表情调整眨眼频率（惊讶时频繁，生气时缓慢）
  - 平滑的闭眼/睁眼过渡（3帧：open → half → closed）
  - 支持强制触发眨眼（用于特殊事件）

**关键方法：**
```csharp
// 获取当前眨眼层名称
string BlinkAnimationSystem.GetBlinkLayerName(string personaDefName)
// 返回值："eyes_open" / "eyes_half" / "eyes_closed"

// 强制触发眨眼
BlinkAnimationSystem.TriggerBlink(string personaDefName)
```

---

### 2. **MouthAnimationSystem.cs** ?
- **功能：** 说话时嘴巴开合动画
- **特性：**
  - 与 TTS 播放同步（检测 `TTSAudioPlayer.IsPlaying()`）
  - 根据表情自动选择嘴型（Happy → Smile, Surprised → OpenWide）
  - 平滑的开合过渡（正弦波模拟）
  - 支持 4 种嘴型：closed, smile, open_small, open_wide

**关键方法：**
```csharp
// 获取当前嘴巴层名称
string MouthAnimationSystem.GetMouthLayerName(string personaDefName)
// 返回值："mouth_closed" / "mouth_smile" / "mouth_open_small" / "mouth_open_wide"

// 强制设置嘴型
MouthAnimationSystem.SetMouthShape(string personaDefName, MouthShape shape, float openness)
```

---

### 3. **LayerType 枚举扩展** ?
修改 `LayerDefinition.cs`：
```csharp
public enum LayerType
{
    Background,
    Body,
    Outfit,
    Face,
    Eyes,          // ? 新增：眼睛层
    Mouth,         // ? 新增：嘴巴层
    Hair,
    Accessories,
    ForegroundFX,
    Overlay
}
```

---

### 4. **LayeredPortraitCompositor 动画适配** ?
修改 `LayeredPortraitCompositor.cs`：

**新增方法：**
```csharp
private static LayeredPortraitConfig ApplyAnimationLayers(
    LayeredPortraitConfig original, 
    string blinkLayerName, 
    string mouthLayerName)
{
    // 克隆配置
    // 动态替换 Eyes 和 Mouth 层的 TexturePath
    // 返回修改后的配置
}
```

**修改 `CompositeLayers` 方法：**
```csharp
public static Texture2D CompositeLayers(...)
{
    // ... 原有代码 ...
    
    // ? 获取动画状态
    string blinkLayerName = BlinkAnimationSystem.GetBlinkLayerName(personaDefName);
    string mouthLayerName = MouthAnimationSystem.GetMouthLayerName(personaDefName);
    
    // ? 应用动画层
    config = ApplyAnimationLayers(config, blinkLayerName, mouthLayerName);
    
    // ... 继续合成 ...
}
```

---

## ?? 新增文件列表

| 文件 | 位置 | 行数 | 说明 |
|------|------|------|------|
| BlinkAnimationSystem.cs | PersonaGeneration/ | ~180 | 眨眼动画系统 |
| MouthAnimationSystem.cs | PersonaGeneration/ | ~200 | 张嘴动画系统 |
| LayerDefinition.cs | PersonaGeneration/ | ~2（修改） | 添加 Eyes/Mouth 层类型 |
| LayeredPortraitCompositor.cs | PersonaGeneration/ | ~50（修改） | 动画层适配 |

---

## ?? 纹理资源要求

### **必需文件**
```
Textures/UI/Narrators/9x16/Layered/Sideria/
├── eyes_open.png          ← 睁眼层（1024x1574）
├── eyes_half.png          ← 半闭眼层（1024x1574）
├── eyes_closed.png        ← 闭眼层（1024x1574）
├── mouth_closed.png       ← 闭嘴层（1024x1574）
├── mouth_smile.png        ← 微笑层（1024x1574）
├── mouth_open_small.png   ← 小张嘴层（1024x1574）
└── mouth_open_wide.png    ← 大张嘴层（1024x1574）
```

### **可选文件**
```
├── mouth_frown.png        ← 皱眉层（用于 Sad/Angry 表情）
```

---

## ?? 系统参数配置

### **眨眼动画参数** (`BlinkAnimationSystem.cs`)
```csharp
private const float BLINK_CYCLE_MIN = 3.0f;      // 最小眨眼周期（秒）
private const float BLINK_CYCLE_MAX = 6.0f;      // 最大眨眼周期（秒）
private const float BLINK_DURATION = 0.15f;      // 闭眼持续时间（秒）
private const float BLINK_TRANSITION = 0.05f;    // 过渡时间（秒）
```

### **张嘴动画参数** (`MouthAnimationSystem.cs`)
```csharp
private const float MOUTH_OPEN_SPEED = 8.0f;      // 嘴巴开合速度
private const float MOUTH_CLOSE_SPEED = 6.0f;     // 嘴巴闭合速度
private const float SPEAKING_FREQUENCY = 8.0f;    // 说话频率（Hz）
```

### **立绘更新间隔** (`NarratorScreenButton.cs`)
```csharp
private const int PORTRAIT_UPDATE_INTERVAL = 30;  // 更新间隔（ticks，约0.5秒）
```

---

## ?? 工作流程

### **1. 眨眼动画流程**
```
每帧更新
  ↓
BlinkAnimationSystem.GetBlinkLayerName()
  ↓
判断是否到达眨眼时间
  ├─ 是 → 开始眨眼序列（open → half → closed → half → open）
  └─ 否 → 返回 "eyes_open"
  ↓
LayeredPortraitCompositor 使用对应的眼睛层纹理
  ↓
合成到最终立绘
```

### **2. 张嘴动画流程**
```
每帧更新
  ↓
MouthAnimationSystem.GetMouthLayerName()
  ↓
检查 TTSAudioPlayer.IsPlaying()
  ├─ 是 → 模拟说话动作（正弦波控制开合程度）
  │       → 根据开合程度返回嘴型（closed/small/wide）
  └─ 否 → 根据表情返回基础嘴型
  ↓
LayeredPortraitCompositor 使用对应的嘴巴层纹理
  ↓
合成到最终立绘
```

### **3. 分层合成流程**
```
用户触发表情切换
  ↓
ExpressionSystem.SetExpression()
  ↓
PortraitLoader.LoadLayeredPortrait()
  ↓
LayeredPortraitCompositor.CompositeLayers()
  ├─ 获取眨眼状态（BlinkAnimationSystem）
  ├─ 获取张嘴状态（MouthAnimationSystem）
  ├─ 动态替换 Eyes 和 Mouth 层路径
  └─ 合成所有层（Body + Face + Eyes + Mouth + ...）
  ↓
返回最终立绘纹理
  ↓
NarratorScreenButton/NarratorWindow 绘制
  ├─ 应用呼吸偏移（ExpressionSystem.GetBreathingOffset()）
  └─ GUI.DrawTexture()
  ↓
最终渲染：立绘浮动 + 眨眼 + 张嘴
```

---

## ?? 测试清单

### **1. 眨眼动画测试**
- [ ] AI 按钮/对话窗口立绘自动眨眼
- [ ] 眨眼周期随机（3-6秒）
- [ ] 不同表情有不同眨眼频率
  - [ ] Surprised：眨眼频繁
  - [ ] Angry：眨眼缓慢
- [ ] 眨眼过渡平滑（无跳变）
- [ ] DevMode 日志显示眨眼状态

### **2. 张嘴动画测试**
- [ ] 播放 TTS 时嘴巴开合
- [ ] 停止 TTS 后嘴巴闭合
- [ ] 不同表情有不同基础嘴型
  - [ ] Happy：微笑
  - [ ] Surprised：大张嘴
  - [ ] Sad：皱眉
- [ ] 张嘴过渡平滑（无跳变）
- [ ] DevMode 日志显示嘴型状态

### **3. 分层合成测试**
- [ ] 眼睛和嘴巴层正确叠加
- [ ] 无错位/偏移问题
- [ ] 所有表情组合正常工作
- [ ] 缓存机制正常（性能稳定）
- [ ] 纹理缺失时有降级处理

### **4. 性能测试**
- [ ] 帧率稳定（60 FPS）
- [ ] 内存占用无异常增长
- [ ] 缓存清理正常
- [ ] 长时间运行无卡顿

---

## ?? 常见问题与解决方案

### **Q1: 眨眼动画不流畅？**
**A:** 
1. 检查 `PORTRAIT_UPDATE_INTERVAL` 是否过大（建议 15-30 ticks）
2. 检查 `BLINK_DURATION` 是否过短（建议 0.15 秒）
3. 确认纹理文件存在且正确命名

### **Q2: 嘴巴不张开？**
**A:** 
1. 确认 TTS 正在播放（检查 `TTSAudioPlayer.IsPlaying()`）
2. 检查 `mouth_open_small.png` 和 `mouth_open_wide.png` 是否存在
3. 查看 DevMode 日志确认动画系统调用

### **Q3: 眼睛/嘴巴层位置错位？**
**A:** 
1. 使用图像编辑软件检查层对齐
2. 确保所有层尺寸一致（1024x1574）
3. 参考 [纹理资源模板文档](眨眼和张嘴动画-纹理资源模板-v1.6.18.md)

### **Q4: 性能下降？**
**A:** 
1. 增大 `PORTRAIT_UPDATE_INTERVAL`（如 60 ticks = 1 秒）
2. 禁用 DevMode 日志
3. 定期清理缓存（`LayeredPortraitCompositor.ClearCache()`）

### **Q5: 纹理文件缺失？**
**A:** 
1. 检查文件命名（全小写，无空格）
2. 确认路径正确：`Textures/UI/Narrators/9x16/Layered/{Persona}/`
3. 查看 DevMode 日志确认加载路径

---

## ?? 相关文档

| 文档 | 说明 |
|------|------|
| [眨眼和张嘴动画-纹理资源模板-v1.6.18.md](眨眼和张嘴动画-纹理资源模板-v1.6.18.md) | 纹理制作指南 |
| [呼吸动画与分层立绘-快速参考-v1.6.18.md](呼吸动画与分层立绘-快速参考-v1.6.18.md) | 呼吸动画适配 |
| [分层立绘系统-快速参考.md](分层立绘系统-快速参考.md) | 分层立绘基础 |
| [LayeredPortraitCompositor-动画适配补丁.md](LayeredPortraitCompositor-动画适配补丁.md) | 合成器适配补丁 |

---

## ?? 功能完整性总结

| 功能模块 | 状态 | 说明 |
|---------|------|------|
| 呼吸动画 | ? 完成 | 立绘上下浮动，周期1秒，幅度±2px |
| 表情系统 | ? 完成 | 13种表情，支持变体，实时切换 |
| 分层立绘 | ? 完成 | 动态合成，支持10种层类型 |
| 眨眼动画 | ? 完成 | 自动眨眼，3帧过渡，根据表情调频 |
| 张嘴动画 | ? 完成 | TTS同步，4种嘴型，平滑开合 |
| 触摸互动 | ? 完成 | 悬停激活，鼠标移动触发表情，组合奖励 |
| UI 渲染 | ? 完成 | AI按钮+对话窗口同步应用所有动画 |

---

## ?? 下一步计划

### **高级功能（可选）**
1. **音频波形同步** - 根据 TTS 音频波形精确控制嘴巴开合
2. **头发飘动动画** - 物理模拟头发随呼吸飘动
3. **眼球追踪** - 眼睛跟随鼠标移动
4. **动态光照** - 根据场景时间调整立绘光影

### **优化方向**
1. 异步加载纹理（避免主线程阻塞）
2. GPU 加速合成（使用 Compute Shader）
3. LOD 系统（远距离简化动画）

---

**版本：** v1.6.18  
**实现日期：** 2025-01-XX  
**状态：** ? 完整实现，待部署测试
