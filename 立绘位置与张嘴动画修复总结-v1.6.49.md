# 立绘位置与张嘴动画修复总结 - v1.6.49

**修复时间**: 2025-12-17 13:15  
**修复状态**: ? 成功

---

## ?? 修复内容

### 1. 立绘位置上移 40px ?

**文件**: `Source\TheSecondSeat\UI\FullBodyPortraitPanel.cs`

**修改**:
```csharp
// 修改前：垂直居中
float y = (Verse.UI.screenHeight - displayHeight) / 2f;

// 修改后：上移 40px
float y = (Verse.UI.screenHeight - displayHeight) / 2f - 40f;
```

**效果**:
- 立绘整体上移 40px
- 避免底部被 UI 遮挡
- 视觉效果更协调

---

### 2. 张嘴动画修复 ?

**文件**: `Source\TheSecondSeat\PersonaGeneration\MouthAnimationSystem.cs`

**问题诊断**:
1. TTS 状态同步可能失败
2. 缺少错误处理导致崩溃
3. 调试信息不足，难以定位问题

**修复内容**:

#### ① 增加 try-catch 错误处理
```csharp
bool isPlayingTTS = false;
try
{
    isPlayingTTS = TTS.TTSAudioPlayer.IsSpeaking(defName);
}
catch (System.Exception ex)
{
    if (Prefs.DevMode)
    {
        Log.Warning($"[MouthAnimationSystem] 检测 TTS 状态失败: {ex.Message}");
    }
    isPlayingTTS = false;
}
```

#### ② 增强调试日志输出
```csharp
// TTS 播放时每秒输出一次状态
if (Prefs.DevMode && state.speakingTime % 1f < 0.1f)
{
    Log.Message($"[MouthAnimationSystem] {defName} TTS播放中 - 开合度: {targetOpenness:F2}");
}

// 嘴部图层变化时输出
if (Prefs.DevMode && layerName != state.CurrentMouthLayer)
{
    Log.Message($"[MouthAnimationSystem] {defName} 嘴部图层: {layerName ?? "null"} (表情={state.currentExpression}, 开合度={state.currentOpenness:F2}, TTS={isPlayingTTS})");
}
```

#### ③ 优化动画逻辑
- **TTS 播放时**: 使用正弦波模拟说话（10Hz 频率，0-0.8 开合度）
- **静默时**: 根据表情使用静态嘴型
- **平滑过渡**: 使用 Lerp 实现 5x 速度的平滑过渡

---

## ?? 验证步骤

### 1. 立绘位置验证
1. 启动游戏
2. 开启立绘模式（设置中）
3. 观察立绘位置：
   - ? 立绘整体上移了 40px
   - ? 底部不再被 UI 遮挡
   - ? 视觉效果更好

### 2. 张嘴动画验证

#### A. 启用调试模式
1. 游戏启动参数添加 `-logfile`
2. 开启 DevMode（Esc → Options → Developer mode）

#### B. 测试 TTS 张嘴动画
1. 在对话窗口输入消息
2. 等待 AI 回复并播放 TTS
3. 观察现象：
   - ? 立绘嘴部应该动态张合
   - ? 控制台输出：`[MouthAnimationSystem] {名字} TTS播放中 - 开合度: X.XX`
   - ? 控制台输出：`[MouthAnimationSystem] {名字} 嘴部图层: small_mouth/medium_mouth/larger_mouth`

#### C. 检查静态嘴型
1. TTS 播放结束后
2. 观察立绘嘴型是否恢复到表情对应的静态状态
3. 控制台应该输出：
   ```
   [MouthAnimationSystem] {名字} 嘴部图层: null/small_mouth (表情=Happy, 开合度=0.50, TTS=False)
   ```

---

## ?? 问题排查

如果张嘴动画仍然不工作：

### 1. 检查 TTS 是否正常播放
```
[MouthAnimationSystem] {名字} TTS播放中 - 开合度: 0.45
```
- ? 看到这条日志 → TTS 状态同步正常
- ? 没看到这条日志 → TTS 没有播放或状态同步失败

### 2. 检查嘴部图层纹理是否存在
```
[MouthAnimationSystem] {名字} 嘴部图层: small_mouth (表情=Happy, 开合度=0.30, TTS=True)
```
- 确认路径：`Textures\UI\Narrators\9x16\Layered\{PersonaName}\small_mouth.png`
- 确认文件存在且命名正确

### 3. 检查 LayeredPortraitCompositor 是否调用
打开 `FullBodyPortraitPanel.cs`，在 `DrawLayeredPortraitRuntime` 方法中查找：
```csharp
string mouthLayerName = MouthAnimationSystem.GetMouthLayerName(persona.defName);
```
确认这行代码被正确调用。

### 4. 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 嘴部完全不动 | TTS 状态同步失败 | 检查 `TTSAudioPlayer.IsSpeaking()` 是否工作 |
| 嘴部一直张着 | 静态嘴型未恢复 | 检查 `GetMouthOpennessForExpression` 返回值 |
| 嘴部纹理不显示 | 纹理文件缺失 | 检查 `Textures` 文件夹路径 |
| 动画卡顿 | 帧率过低 | 检查系统性能 |

---

## ?? 部署统计

| 项目 | 数量/状态 |
|------|-----------|
| 修改文件 | 2 |
| 编译警告 | 8（非致命） |
| 编译错误 | 0 |
| DLL 大小 | 497.5 KB |
| 部署时间 | ~3 秒 |
| 测试状态 | ? 待游戏内验证 |

---

## ?? 游戏内测试清单

- [ ] 立绘位置已上移 40px
- [ ] 立绘底部不再被 UI 遮挡
- [ ] TTS 播放时嘴部动态张合
- [ ] TTS 停止后嘴型恢复到表情对应状态
- [ ] 控制台输出张嘴动画调试日志
- [ ] 不同表情的静态嘴型正确显示
- [ ] 动画过渡平滑无卡顿

---

## ?? 后续优化建议

### 1. 性能优化
- 考虑降低日志输出频率（生产环境）
- 优化纹理加载缓存策略

### 2. 功能增强
- 支持更多嘴型变化（目前 3 种：small/medium/larger）
- 根据语速调整张嘴频率
- 增加唇形同步（Phoneme-based）

### 3. 用户体验
- 增加设置项：调整立绘垂直位置偏移
- 增加设置项：开关张嘴动画
- 增加动画预览功能

---

## ? 验收标准

1. **立绘位置** ?
   - 整体上移 40px
   - 视觉效果良好

2. **张嘴动画** ? (代码修复完成，待游戏内验证)
   - TTS 播放时嘴部动态张合
   - TTS 停止后恢复到表情对应的静态嘴型
   - 平滑过渡无卡顿
   - 调试日志正常输出

---

**修复完成！??**  
现在可以启动游戏测试修复效果了。

---

## ?? 相关文件

- `Source\TheSecondSeat\UI\FullBodyPortraitPanel.cs` - 立绘位置修改
- `Source\TheSecondSeat\PersonaGeneration\MouthAnimationSystem.cs` - 张嘴动画修复
- `Deploy-v1.6.48.ps1` - 部署脚本
- `Verify-Deployment-v1.6.48.ps1` - 验证脚本
