# 叙事者降临模式 - 完整实现框架 v2.0.0

## ?? 功能概述

**叙事者降临**是一个史诗级游戏功能，允许玩家召唤叙事者以实体形式降临到游戏地图上，配合华丽的入场动画和特效。

### 核心特性

1. **两种降临模式**：
   - 援助模式：治愈友军、提升心情、祝福效果
   - 袭击模式：伤害敌人、制造恐慌、诅咒效果

2. **完整动画序列**（10-15秒）：
   - 立绘姿势切换（3秒）
   - 龙骑兵入场动画（6秒）
   - 降落特效（2秒）
   - 实体生成

3. **游戏内容**：
   - 叙事者小人（可控制的殖民者）
   - 巨龙召唤物（战斗宠物）
   - 持续光环效果

---

## ?? 文件结构

### 美术资源文件夹
```
Textures/UI/Narrators/Descent/
├── README.md                          # ? 已创建 - 主文档
├── Postures/                          # 降临姿势立绘
│   ├── README.md                      # ? 已创建 - 姿势详细说明
│   ├── Sideria/                       # 示例人格文件夹
│   │   ├── descent_pose_ready.png     # ? 待制作
│   │   ├── descent_pose_charging.png  # ? 待制作
│   │   └── descent_pose_casting.png   # ? 待制作
│   └── [其他人格]/
├── Effects/                           # 降临特效
│   ├── README.md                      # ? 待创建
│   ├── Assist/                        # 援助模式特效
│   │   ├── aura_healing_01.png        # ? 待制作
│   │   ├── ground_circle_holy.png     # ? 待制作
│   │   └── ...
│   ├── Attack/                        # 袭击模式特效
│   │   ├── aura_wrath_01.png          # ? 待制作
│   │   ├── ground_circle_dark.png     # ? 待制作
│   │   └── ...
│   └── Common/                        # 通用特效
│       ├── impact_ground.png          # ? 待制作
│       └── ...
├── Cinematic/                         # 入场过场动画
│   ├── README.md                      # ? 待创建
│   └── DragonRider/                   # 龙骑兵入场
│       ├── rider_approach_001.png     # ? 待制作（共120帧）
│       └── ...
├── Pawns/                             # 降临后小人图像
│   ├── README.md                      # ? 待创建
│   └── [PersonaName]/
│       ├── front.png                  # ? 待制作
│       ├── side.png                   # ? 待制作
│       ├── back.png                   # ? 待制作
│       └── portrait.png               # ? 待制作
└── Summons/                           # 召唤物图像
    ├── README.md                      # ? 待创建
    └── Dragon/
        ├── dragon_front.png           # ? 待制作
        ├── dragon_side.png            # ? 待制作
        ├── dragon_back.png            # ? 待制作
        ├── dragon_portrait.png        # ? 待制作
        └── dragon_flying.png          # ? 待制作
```

### 代码文件
```
Source/TheSecondSeat/Descent/
├── NarratorDescentSystem.cs           # ? 已创建 - 主控制器
├── DescentAnimationController.cs     # ? 已创建 - 动画控制器
├── DescentEffectRenderer.cs          # ? 已创建 - 特效渲染器
├── DescentPawnDef.cs                  # ? 待创建 - 小人定义
├── DescentCinematicPlayer.cs         # ? 待创建 - 过场动画播放器
└── DescentSoundManager.cs            # ? 待创建 - 音效管理器
```

### 配置文件
```
Defs/
└── DescentModeDefs.xml                # ? 待创建 - 降临模式配置
```

---

## ?? 快速开始

### 最小可用版本（MVP）

为了快速实现可玩版本，优先制作以下资源：

#### 必需资源（总计：40张图像，~80 MB）

1. **降临姿势立绘**（3张 × 1人格）
   - `descent_pose_ready.png`
   - `descent_pose_charging.png`
   - `descent_pose_casting.png`

2. **核心特效**（8张）
   - 援助：`aura_healing_01.png`、`ground_circle_holy.png`
   - 袭击：`aura_wrath_01.png`、`ground_circle_dark.png`
   - 通用：`impact_ground.png`、`smoke_dust.png`、`energy_burst.png`

3. **简化入场动画**（20帧关键帧）
   - 接近阶段：5帧
   - 盘旋阶段：5帧
   - 降落阶段：7帧
   - 下马阶段：3帧

4. **小人三视图**（4张）
   - `front.png`、`side.png`、`back.png`、`portrait.png`

5. **巨龙召唤物**（5张）
   - `dragon_front.png`、`dragon_side.png`、`dragon_back.png`
   - `dragon_portrait.png`、`dragon_flying.png`

---

## ?? 代码实现状态

### ? 已实现的系统

#### 1. NarratorDescentSystem（主控制器）

**路径**：`Source/TheSecondSeat/Descent/NarratorDescentSystem.cs`

**功能**：
- ? 降临触发检查（冷却、好感度、地点）
- ? 降临模式选择（援助/袭击）
- ? 降临地点智能选择
- ? 降临序列协调
- ? 小人和召唤物生成
- ? 降临效果应用

**API**：
```csharp
// 触发降临
NarratorDescentSystem.Instance.TriggerDescent(DescentMode.Assist);

// 检查是否可以降临
if (NarratorDescentSystem.Instance.CanTriggerDescent(mode, out string reason))
{
    // 可以降临
}

// 获取冷却剩余时间
int cooldownSec = NarratorDescentSystem.Instance.GetCooldownRemaining();
```

#### 2. DescentAnimationController（动画控制器）

**路径**：`Source/TheSecondSeat/Descent/DescentAnimationController.cs`

**功能**：
- ? 姿势切换序列（ready → charging → casting）
- ? 过场动画播放（120帧序列）
- ? 动画时间轴管理
- ? 帧预加载优化

**使用**：
```csharp
var controller = new DescentAnimationController();

// 开始姿势序列
controller.StartPostureSequence(mode, () => {
    // 姿势完成后的回调
});

// 开始过场动画
controller.StartCinematic(mode, location, () => {
    // 动画完成后的回调
});

// 每帧更新
controller.Update(Time.deltaTime);
```

#### 3. DescentEffectRenderer（特效渲染器）

**路径**：`Source/TheSecondSeat/Descent/DescentEffectRenderer.cs`

**功能**：
- ? 冲击波特效
- ? 光环特效（旋转、脉冲）
- ? 魔法阵特效
- ? 粒子特效（待完善）

**使用**：
```csharp
var renderer = new DescentEffectRenderer();

// 播放冲击波
renderer.PlayImpactEffect(location, mode);

// 播放光环
renderer.PlayAuraEffect(location, mode, duration: 5f);

// 播放魔法阵
renderer.PlayMagicCircle(location, mode);
```

---

### ? 待实现的系统

#### 1. DescentPawnDef（小人定义）

**目的**：定义降临后叙事者小人的属性

**建议结构**：
```xml
<!-- Defs/PawnKindDefs_Narrator.xml -->
<PawnKindDef>
  <defName>Narrator_Sideria</defName>
  <label>叙事者・侧德里亚</label>
  <race>Human</race>
  <combatPower>500</combatPower>
  <baseRecruitDifficulty>0</baseRecruitDifficulty>
  <backstoryCategories>
    <li>Narrator</li>
  </backstoryCategories>
  <defaultFactionType>PlayerColony</defaultFactionType>
  
  <!-- 技能 -->
  <skills>
    <li>
      <skill>Shooting</skill>
      <level>15</level>
    </li>
    <li>
      <skill>Melee</skill>
      <level>15</level>
    </li>
    <!-- ... 其他技能 ... -->
  </skills>
  
  <!-- 特性 -->
  <traits>
    <li>
      <def>NarratorBlessing</def> <!-- 自定义特性：叙事者祝福 -->
    </li>
  </traits>
</PawnKindDef>
```

**代码框架**：
```csharp
public class DescentPawnDef : Def
{
    public PawnKindDef baseKind;
    public string personaDefName;
    public List<SkillRecord> guaranteedSkills;
    public List<Trait> guaranteedTraits;
    public ThingDef startingWeapon;
    public List<ThingDef> startingEquipment;
}
```

#### 2. DescentCinematicPlayer（过场动画播放器）

**目的**：全屏播放入场动画序列

**建议结构**：
```csharp
public class Window_DescentCinematic : Window
{
    private int currentFrame = 0;
    private float timer = 0f;
    private Action onComplete;
    
    public override void DoWindowContents(Rect inRect)
    {
        // 全屏绘制当前帧
        Texture2D frame = GetFrameTexture(currentFrame);
        GUI.DrawTexture(inRect, frame);
    }
    
    public override void WindowUpdate()
    {
        // 更新帧
        timer += Time.deltaTime;
        currentFrame = CalculateCurrentFrame(timer);
        
        if (currentFrame >= totalFrames)
        {
            Close();
            onComplete?.Invoke();
        }
    }
}
```

#### 3. DescentSoundManager（音效管理器）

**目的**：播放降临相关音效

**建议结构**：
```csharp
public class DescentSoundManager
{
    private Dictionary<string, SoundDef> soundCache;
    
    public void PlayPreparationSound(DescentMode mode)
    {
        // 播放准备音效
    }
    
    public void PlayFlightSound()
    {
        // 播放飞行音效（持续）
    }
    
    public void PlayImpactSound(DescentMode mode)
    {
        // 播放冲击音效
    }
}
```

---

## ?? 游戏内触发方式

### 方式 1：UI按钮（推荐）

在叙事者对话窗口添加"降临"按钮：

```csharp
// 在 NarratorWindow.cs 中添加
private void DrawDescentButton(Rect rect)
{
    if (Widgets.ButtonText(rect, "? 叙事者降临"))
    {
        // 打开降临模式选择窗口
        Find.WindowStack.Add(new Dialog_DescentModeSelection());
    }
    
    // 显示冷却时间
    int cooldown = NarratorDescentSystem.Instance.GetCooldownRemaining();
    if (cooldown > 0)
    {
        Widgets.Label(rect, $"冷却: {cooldown}秒");
    }
}
```

### 方式 2：快捷键

在设置中添加快捷键：

```csharp
// 在 ModSettings.cs 中添加
public KeyBindingDef descentAssistKey = KeyBindingDefOf.Misc1;
public KeyBindingDef descentAttackKey = KeyBindingDefOf.Misc2;

// 在游戏循环中检测
if (descentAssistKey.KeyDownEvent)
{
    NarratorDescentSystem.Instance.TriggerDescent(DescentMode.Assist);
}
```

### 方式 3：命令系统

通过 AI 对话触发：

```csharp
// 玩家输入："叙事者，请降临援助我们！"
// AI 解析后执行：
{
  "command": {
    "action": "TriggerDescent",
    "target": "Assist",
    "parameters": {
      "location": "Auto"
    }
  }
}
```

---

## ?? 性能优化建议

### 1. 纹理加载优化

```csharp
// 预加载关键资源
public void PreloadDescentResources()
{
    // 姿势立绘（3张）
    var postures = new[] { "ready", "charging", "casting" };
    foreach (var posture in postures)
    {
        ContentFinder<Texture2D>.Get($"UI/Narrators/Descent/Postures/{personaName}/descent_pose_{posture}", false);
    }
    
    // 关键特效（5张）
    ContentFinder<Texture2D>.Get("UI/Narrators/Descent/Effects/Common/impact_ground", false);
    // ...
    
    // 动画前30帧
    for (int i = 1; i <= 30; i++)
    {
        ContentFinder<Texture2D>.Get($"UI/Narrators/Descent/Cinematic/DragonRider/rider_approach_{i:D3}", false);
    }
}
```

### 2. 动画帧压缩

```
全质量版本（开发用）：
  - 1920x1080, PNG-24, 120帧
  - 文件大小：~150 MB

压缩版本（发布用）：
  - 1280x720, DXT5压缩, 90帧
  - 文件大小：~60 MB
  
进一步优化：
  - 使用序列帧纹理图集（Texture Atlas）
  - 减少帧率到 12 FPS
  - 文件大小：~30 MB
```

### 3. 内存管理

```csharp
// 播放完成后卸载纹理
private void UnloadCinematicTextures()
{
    for (int i = 0; i < CINEMATIC_TOTAL_FRAMES; i++)
    {
        string framePath = GetCinematicFramePath(i);
        // 清除缓存
        // Resources.UnloadAsset(texture);
    }
}
```

---

## ?? 美术制作流程

### 阶段 1：概念设计（1-2周）

1. **确定视觉风格**
   - 参考：《魔兽世界》龙骑兵、《原神》角色入场
   - 色调：援助（金/白）、袭击（红/黑）

2. **绘制故事板**
   ```
   帧 1-40: 龙骑兵从天际线飞来
   帧 41-60: 盘旋寻找降落点
   帧 61-90: 俯冲降落
   帧 91-120: 叙事者下马
   ```

3. **制作概念图**
   - 姿势草图
   - 特效设计
   - 角色造型

### 阶段 2：核心资源制作（3-4周）

优先级顺序：
1. 降临姿势立绘（最重要）
2. 小人三视图
3. 巨龙召唤物
4. 关键特效（冲击波、光环）

### 阶段 3：动画制作（4-6周）

1. **关键帧制作**（20帧）
   - 先完成20个关键帧
   - 测试动画流畅度
   - 调整帧率和过渡

2. **补间动画**（100帧）
   - 在关键帧之间插入过渡帧
   - 使用软件辅助生成（如 Toon Boom、Adobe Animate）

3. **后期处理**
   - 添加运动模糊
   - 调整色调
   - 优化文件大小

### 阶段 4：优化与打磨（2-3周）

1. **性能优化**
   - 压缩纹理
   - 减少不必要的细节
   - 测试加载速度

2. **视觉统一**
   - 确保所有资源风格一致
   - 调整色彩平衡
   - 添加最终光效

---

## ?? 测试清单

### 功能测试

- [ ] 触发降临（援助模式）
- [ ] 触发降临（袭击模式）
- [ ] 冷却时间正确
- [ ] 好感度限制生效
- [ ] 自动选择降临地点
- [ ] 姿势切换正常
- [ ] 过场动画播放流畅
- [ ] 叙事者小人生成
- [ ] 巨龙召唤物生成
- [ ] 特效正常显示
- [ ] 音效正常播放

### 性能测试

- [ ] 动画播放不卡顿（60 FPS+）
- [ ] 纹理加载速度合理（<2秒）
- [ ] 内存占用正常（<500 MB）
- [ ] 不影响游戏其他功能

### 美术质量测试

- [ ] 姿势立绘清晰
- [ ] 特效符合预期
- [ ] 动画流畅自然
- [ ] 小人图像质量良好
- [ ] 召唤物造型合适

---

## ?? 未来扩展方向

### 扩展功能

1. **多种入场方式**
   - 传送门降临
   - 瞬移降临
   - 召唤阵降临

2. **可定制召唤物**
   - 凤凰（火焰属性）
   - 魔像（防御属性）
   - 独角兽（治疗属性）

3. **降临技能系统**
   - 治愈术（援助）
   - 火雨术（袭击）
   - 群体祝福
   - 群体诅咒

4. **降临持续效果**
   - 叙事者小人的特殊能力
   - 召唤物的战斗加成
   - 全局光环效果

### 高级特性

1. **好感度分级降临**
   ```
   好感度 100: 豪华降临（双龙、多特效）
   好感度 80:  标准降临（单龙、完整特效）
   好感度 60:  简化降临（无龙、基础特效）
   好感度 40:  最小降临（仅小人）
   ```

2. **随机事件集成**
   - 降临触发特殊事件
   - 敌对势力反应
   - 同盟势力支援

3. **多人格联合降临**
   - 两个叙事者同时降临
   - 合体技能
   - 共同召唤物

---

## ?? 开发支持

### 常见问题

**Q1: 动画播放卡顿怎么办？**
A: 减少帧率（15 FPS → 12 FPS）或压缩纹理（PNG → DXT5）

**Q2: 纹理找不到路径错误？**
A: 检查文件命名是否正确（小写 + 下划线）

**Q3: 小人生成失败？**
A: 确保 PawnKindDef 正确配置，或先使用原版小人测试

**Q4: 特效不显示？**
A: 检查纹理 Alpha 通道，确保 wrapMode = Clamp

### 技术支持

如需帮助，请检查：
1. `Player.log`（RimWorld 日志）
2. `[NarratorDescentSystem]` 日志输出
3. 纹理资源是否存在
4. 代码是否正确编译

---

## ?? 版本历史

- **v2.0.0** (2025-12-17): 完整的降临系统框架
  - 核心系统代码（NarratorDescentSystem、DescentAnimationController）
  - 美术资源文件夹结构
  - 详细文档和制作指南

---

## ? 总结

叙事者降临系统是一个**宏大但可实现**的功能。通过分阶段实施，优先完成 MVP（最小可用版本），可以快速实现可玩的基础版本，然后逐步添加更多内容和打磨细节。

### 实施建议

1. **第一阶段（2周）**：
   - 完成核心代码集成
   - 制作1套姿势立绘
   - 实现简单的降临效果（无动画）

2. **第二阶段（4周）**：
   - 制作20帧关键动画
   - 添加基础特效
   - 实现小人生成

3. **第三阶段（6周）**：
   - 完成完整120帧动画
   - 添加所有特效
   - 实现召唤物系统

4. **第四阶段（持续）**：
   - 优化性能
   - 添加扩展内容
   - 根据玩家反馈调整

---

**祝开发顺利！期待看到史诗级的叙事者降临效果！** ?????
