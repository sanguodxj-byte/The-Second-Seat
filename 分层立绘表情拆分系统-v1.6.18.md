# 分层立绘表情拆分系统 - v1.6.18

## ? **新特性：表情部件拆分**

将原来的完整表情图（如 `happy.png`）拆分为**独立部件**，然后在 `base_body.png` 底图上进行拼接合成。

---

## ?? **新的文件夹结构**

```
Textures/UI/Narrators/9x16/Layered/{PersonaName}/
├── base_body.png           ← 底图（身体+默认表情）
├── background.png          ← 背景（可选）
├── outfit_default.png      ← 默认服装
├── hair.png                ← 头发层
├── accessories.png         ← 配饰层
└── 表情部件（拆分）：
    ├── neutral_eyes.png    ← 默认表情：眼睛
    ├── neutral_mouth.png   ← 默认表情：嘴巴
    ├── neutral_flush.png   ← 默认表情：脸红（可选）
    ├── happy_eyes.png      ← 开心表情：眼睛
    ├── happy_mouth.png     ← 开心表情：嘴巴
    ├── happy_flush.png     ← 开心表情：脸红（可选）
    ├── sad_eyes.png
    ├── sad_mouth.png
    ├── angry_eyes.png
    ├── angry_mouth.png
    └── ...
```

---

## ?? **表情部件命名规则**

### **格式：`{expression}_{part}.png`**

| 表情类型 | 眼睛部件 | 嘴巴部件 | 脸红部件（可选） |
|---------|---------|---------|----------------|
| Neutral | `neutral_eyes.png` | `neutral_mouth.png` | `neutral_flush.png` |
| Happy   | `happy_eyes.png` | `happy_mouth.png` | `happy_flush.png` |
| Sad     | `sad_eyes.png` | `sad_mouth.png` | `sad_flush.png` |
| Angry   | `angry_eyes.png` | `angry_mouth.png` | `angry_flush.png` |
| Surprised | `surprised_eyes.png` | `surprised_mouth.png` | `surprised_flush.png` |
| Confused | `confused_eyes.png` | `confused_mouth.png` | - |
| Smug    | `smug_eyes.png` | `smug_mouth.png` | - |
| Shy     | `shy_eyes.png` | `shy_mouth.png` | `shy_flush.png` |

---

## ?? **图层叠加顺序（从底到顶）**

```
Priority  图层ID        文件名                      说明
--------  ----------   -------------------------  ------------------
0         base_body    base_body.png              底图（身体+默认表情）
5         background   background.png             背景（可选）
10        outfit       outfit_{outfit}.png        服装层
20        flush        {expression}_flush.png     脸红层（可选）
30        eyes         {expression}_eyes.png      眼睛层（必需）
40        mouth        {expression}_mouth.png     嘴巴层（必需）
50        hair         hair.png                   头发层
60        accessories  accessories.png            配饰层
70        fx           fx.png                     特效层（可选）
```

---

## ?? **拼接逻辑**

### **1. 默认状态（Neutral 表情）**
```
base_body.png              ← 底图（已包含默认表情的身体）
  └─ 如果需要额外表情变化：
      ├─ neutral_flush.png   ← 脸红（可选）
      ├─ neutral_eyes.png    ← 眼睛
      └─ neutral_mouth.png   ← 嘴巴
```

### **2. 切换表情（如 Happy）**
```
base_body.png              ← 底图不变
  └─ 覆盖新的表情部件：
      ├─ happy_flush.png     ← 脸红（如果有）
      ├─ happy_eyes.png      ← 新的眼睛
      └─ happy_mouth.png     ← 新的嘴巴
```

---

## ?? **制作指南**

### **Step 1: 准备底图**
1. 创建 **`base_body.png`**（1024x1572）
   - 包含：身体、默认表情（眼睛+嘴巴）
   - 用途：作为所有表情的基础

### **Step 2: 制作表情部件**
对于每个表情（如 `happy`）：

1. **眼睛层 `happy_eyes.png`**
   - 只绘制眼睛部分
   - 其余区域保持透明
   - 大小：1024x1572（与底图一致）

2. **嘴巴层 `happy_mouth.png`**
   - 只绘制嘴巴部分
   - 其余区域保持透明
   - 大小：1024x1572

3. **脸红层 `happy_flush.png`**（可选）
   - 绘制脸颊红晕
   - 使用 Additive 或 Multiply 混合模式
   - 大小：1024x1572

---

## ?? **Photoshop/GIMP 制作流程**

### **推荐图层结构：**
```
Photoshop/GIMP 项目：
├── 底图 (base_body.png)
│   ├── 身体
│   ├── 默认眼睛
│   └── 默认嘴巴
└── 表情变体（每个表情一个图层组）：
    ├── Happy 表情组
    │   ├── happy_flush.png   ← 导出为独立PNG
    │   ├── happy_eyes.png    ← 导出为独立PNG
    │   └── happy_mouth.png   ← 导出为独立PNG
    ├── Sad 表情组
    │   ├── sad_eyes.png
    │   └── sad_mouth.png
    └── ...
```

### **导出步骤：**
1. 隐藏所有表情图层
2. 导出 `base_body.png`（底图）
3. 对于每个表情：
   - 只显示该表情的部件图层
   - 导出为独立PNG（如 `happy_eyes.png`）
   - 确保其余区域透明

---

## ?? **代码实现**

### **图层配置（LayerDefinition.cs）**
```csharp
new LayerDefinition
{
    LayerId = "eyes",
    LayerType = LayerType.Face,
    Priority = 30,
    TexturePath = "UI/Narrators/9x16/Layered/{persona}/{expression}_eyes.png",
    Visible = true,
    BlendMode = BlendMode.Normal
}
```

### **自动拼接（LayeredPortraitCompositor.cs）**
系统会自动：
1. 加载 `base_body.png` 作为底图
2. 根据当前表情（如 `ExpressionType.Happy`）：
   - 加载 `happy_flush.png`（如果存在）
   - 加载 `happy_eyes.png`
   - 加载 `happy_mouth.png`
3. 按 Priority 顺序叠加合成

---

## ?? **优势**

### **1. 灵活性**
- 可以单独修改眼睛、嘴巴、脸红
- 不需要为每个表情绘制完整立绘

### **2. 动画支持**
- 眼睛可以独立眨眼（`BlinkAnimationSystem`）
- 嘴巴可以独立张嘴（`MouthAnimationSystem`）
- 脸红可以独立淡入淡出

### **3. 文件大小**
- 底图只需要1个文件
- 每个表情只需要2-3个小文件（部件）
- 总文件大小比完整立绘更小

### **4. 表情组合**
- 可以混搭不同表情的部件
- 例如：`happy_eyes.png` + `neutral_mouth.png` = 微笑但不张嘴

---

## ?? **示例文件结构（Sideria）**

```
Textures/UI/Narrators/9x16/Layered/Sideria/
├── base_body.png           (1024x1572, 300KB)
├── hair.png                (1024x1572, 200KB)
├── accessories.png         (1024x1572, 150KB)
└── 表情部件：
    ├── neutral_eyes.png    (1024x1572, 50KB)
    ├── neutral_mouth.png   (1024x1572, 30KB)
    ├── happy_eyes.png      (1024x1572, 50KB)
    ├── happy_mouth.png     (1024x1572, 30KB)
    ├── happy_flush.png     (1024x1572, 20KB)
    ├── sad_eyes.png        (1024x1572, 50KB)
    ├── sad_mouth.png       (1024x1572, 30KB)
    └── ...
```

**总大小：** ~1.5MB（8个表情）  
**对比完整立绘：** ~3MB（8个表情）

---

## ?? **快速开始**

### **1. 准备底图**
```bash
Photoshop 项目 → 导出 base_body.png
放置到：Textures/UI/Narrators/9x16/Layered/{PersonaName}/base_body.png
```

### **2. 制作表情部件**
```bash
# 对于每个表情（如 happy）：
1. 只显示眼睛图层 → 导出 happy_eyes.png
2. 只显示嘴巴图层 → 导出 happy_mouth.png
3. （可选）只显示脸红图层 → 导出 happy_flush.png
```

### **3. 放置文件**
```
Textures/UI/Narrators/9x16/Layered/Sideria/
├── base_body.png
├── happy_eyes.png
├── happy_mouth.png
├── happy_flush.png
└── ...
```

### **4. 测试**
```csharp
// 代码会自动加载并合成：
// base_body.png + happy_flush.png + happy_eyes.png + happy_mouth.png
ExpressionSystem.SetExpression("Sideria_Default", ExpressionType.Happy);
```

---

## ?? **常见问题**

### **Q1: 部件图层对不齐怎么办？**
**A:** 确保所有PNG文件尺寸一致（1024x1572），并且使用相同的坐标系统。建议在Photoshop中用参考线标记眼睛和嘴巴位置。

### **Q2: 脸红层不显示？**
**A:** 检查文件名是否正确（`{expression}_flush.png`），并确保该图层的 `Visible` 设置为 `true`。

### **Q3: 表情切换时闪烁？**
**A:** 这是因为纹理加载延迟。系统会自动缓存纹理，第二次切换时不会闪烁。

### **Q4: 可以不使用脸红层吗？**
**A:** 可以！脸红层是可选的。如果文件不存在，系统会跳过该图层。

---

## ?? **相关文档**

- [分层立绘系统-快速参考.md](分层立绘系统-快速参考.md)
- [眨眼和张嘴动画-快速参考-v1.6.18.md](眨眼和张嘴动画-快速参考-v1.6.18.md)
- [Textures/UI/Narrators/9x16/Layered/README.md](Textures/UI/Narrators/9x16/Layered/README.md)

---

**版本：** v1.6.18  
**最后更新：** 2024  
**作者：** GitHub Copilot
