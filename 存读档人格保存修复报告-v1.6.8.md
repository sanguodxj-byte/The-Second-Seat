# ?? 存读档人格选择保存问题修复报告

**版本**: v1.6.8  
**日期**: 2025-01-15  
**状态**: ? **修复完成，已编译**

---

## ?? 问题诊断

### 现象

**存读档后人格选择未保存**
- 每次读档都恢复为默认的第一个人格（Cassandra Classic）
- 玩家选择的人格未被保存

---

### 根本原因

**问题代码**（`NarratorManager.cs` 第 297-301 行）：

```csharp
// ? 使用 LongEventHandler 可能导致加载时机不正确
LongEventHandler.ExecuteWhenFinished(() =>
{
    LoadPersona(personaDef);
    Log.Message($"[NarratorManager] 成功恢复人格: {personaDef.narratorName}");
});
```

**为什么会失败**：
1. `LongEventHandler.ExecuteWhenFinished` 在加载完成**后**执行
2. 但此时 UI 可能已经显示（使用默认人格）
3. 导致人格加载被延迟或跳过

---

## ? 修复方案

### 代码修改

**文件**：`Source\TheSecondSeat\Narrator\NarratorManager.cs`

**修改内容**（第 291-320 行）：

```csharp
if (Scribe.mode == LoadSaveMode.PostLoadInit)
{
    // 加载时，根据保存的 defName 恢复人格
    Log.Message($"[NarratorManager] 正在加载人格: {personaDefName}");
    
    if (!string.IsNullOrEmpty(personaDefName))
    {
        var personaDef = DefDatabase<NarratorPersonaDef>.GetNamedSilentFail(personaDefName);
        if (personaDef != null)
        {
            // ? 直接加载，不使用 LongEventHandler
            LoadPersona(personaDef);
            Log.Message($"[NarratorManager] ? 成功恢复人格: {personaDef.narratorName}");
        }
        else
        {
            Log.Warning($"[NarratorManager] ? 未找到人格 {personaDefName}，使用默认人格");
            InitializeDefaultPersona();
        }
    }
    else
    {
        Log.Warning("[NarratorManager] personaDefName 为空，使用默认人格");
        InitializeDefaultPersona();
    }
    
    // ? 关键修复：加载存档后，根据好感度调整对话风格
    if (storytellerAgent != null)
    {
        storytellerAgent.AdjustDialogueStyleByAffinity();
    }
    
    // ? 重置自动问候标记，允许自动问候
    hasGreetedThisSession = false;
    ticksSinceLoad = 0;
}
```

---

### 关键改进

1. **移除 `LongEventHandler`**
   - 直接在 `PostLoadInit` 阶段加载人格
   - 确保时机正确

2. **添加日志**
   - `? 成功恢复人格`
   - `? 未找到人格`
   - 方便诊断

3. **调整对话风格**
   - 根据好感度自动调整
   - 确保一致性

---

## ?? 测试清单

### 基础功能测试

- [ ] **新建游戏**
  - 默认使用 Cassandra Classic
  - 人格正常加载

- [ ] **切换人格**
  - 打开人格选择窗口
  - 选择其他人格
  - 点击"应用"
  - 确认切换成功

- [ ] **存档**
  - 切换到非默认人格（如 Sideria）
  - 保存游戏
  - 记录当前人格名称

- [ ] **读档**
  - 关闭游戏
  - 重新打开游戏
  - 加载存档
  - **验证人格是否正确**

---

### 高级测试

#### 测试 1：多次切换

1. 新建游戏（默认 Cassandra）
2. 切换到 Sideria
3. 保存为 Save1
4. 切换到其他人格
5. 保存为 Save2
6. 重启游戏
7. 加载 Save1 → 应该是 Sideria
8. 加载 Save2 → 应该是其他人格

#### 测试 2：自定义人格

1. 创建自定义人格
2. 切换到自定义人格
3. 保存游戏
4. 重启游戏
5. 加载存档 → 应该是自定义人格

#### 测试 3：好感度保存

1. 切换人格
2. 修改好感度（通过调试窗口）
3. 保存游戏
4. 重启游戏
5. 加载存档 → 好感度应该保持

---

## ?? 已知限制

### 删除人格后的处理

**问题**：
- 如果存档中保存的人格被删除（XML 文件被移除）
- 加载时会回退到默认人格

**解决方案**：
- 不要删除正在使用的人格的 XML 文件
- 或者在删除前切换到其他人格

---

## ?? 日志检查

### 正常加载日志

```
[NarratorManager] 保存人格: Sideria_Mystic
[NarratorManager] 正在加载人格: Sideria_Mystic
[NarratorManager] ? 成功恢复人格: Sideria
```

### 异常加载日志

```
[NarratorManager] 保存人格: CustomPersona_12345678
[NarratorManager] 正在加载人格: CustomPersona_12345678
[NarratorManager] ? 未找到人格 CustomPersona_12345678，使用默认人格
[NarratorManager] 已加载人格: Cassandra (Strategic)
```

---

## ?? 部署步骤

### 方法 1：手动复制

1. **复制 DLL**
   ```
   源文件：
   C:\Users\Administrator\Desktop\rim mod\The Second Seat\Source\TheSecondSeat\bin\Release\net472\TheSecondSeat.dll
   
   目标位置：
   D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Assemblies\TheSecondSeat.dll
   ```

2. **启动游戏测试**

---

### 方法 2：使用 PowerShell（管理员）

```powershell
Copy-Item -Path "C:\Users\Administrator\Desktop\rim mod\The Second Seat\Source\TheSecondSeat\bin\Release\net472\TheSecondSeat.dll" -Destination "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Assemblies\TheSecondSeat.dll" -Force
```

---

## ?? 验证方法

### 1. 检查日志文件

**位置**：
```
C:\Users\Administrator\AppData\LocalLow\Ludeon Studios\RimWorld by Ludeon Studios\Player.log
```

**搜索关键词**：
```
[NarratorManager] 保存人格
[NarratorManager] 正在加载人格
```

### 2. 游戏内验证

1. 打开人格选择窗口
2. 查看当前人格（绿色标记 "(当前)"）
3. 应该与存档前选择的人格一致

### 3. 控制台命令（如果启用开发者模式）

```
打开控制台（~ 键）
输入：PersonaDebug
查看当前人格信息
```

---

## ?? 相关代码

### ExposeData 方法（存读档）

```csharp
public override void ExposeData()
{
    base.ExposeData();
    Scribe_Values.Look(ref favorability, "favorability", 0f);
    Scribe_Collections.Look(ref recentEvents, "recentEvents", LookMode.Deep);
    Scribe_Deep.Look(ref storytellerAgent, "storytellerAgent");
    
    // ? 保存和加载人格 defName
    string personaDefName = null;
    
    if (Scribe.mode == LoadSaveMode.Saving)
    {
        personaDefName = currentPersonaDef?.defName ?? "Cassandra_Classic";
    }
    
    Scribe_Values.Look(ref personaDefName, "currentPersonaDefName", "Cassandra_Classic");
    
    if (Scribe.mode == LoadSaveMode.PostLoadInit)
    {
        // ? 加载人格
        var personaDef = DefDatabase<NarratorPersonaDef>.GetNamedSilentFail(personaDefName);
        if (personaDef != null)
        {
            LoadPersona(personaDef);
        }
    }
}
```

---

## ?? 修复效果

### 修复前

- ? 切换人格 → 保存 → 读档 → **恢复为默认人格**
- ? 玩家需要每次读档后重新选择人格
- ? 好感度可能不一致

### 修复后

- ? 切换人格 → 保存 → 读档 → **保持选择的人格**
- ? 人格、好感度、对话风格完整保存
- ? 自动问候系统正常工作

---

## ?? 总结

### 修改内容

| 文件 | 修改行数 | 修改内容 |
|------|---------|----------|
| `NarratorManager.cs` | 297-301 | 移除 `LongEventHandler`，直接加载 |
|  | 302-305 | 添加详细日志 |
|  | 308-310 | 调整对话风格 |

### 测试要点

1. ? 新建游戏 → 切换人格 → 保存 → 读档 → **验证人格**
2. ? 多次切换人格 → 保存多个存档 → **分别加载验证**
3. ? 自定义人格 → 保存 → 读档 → **验证自定义人格**

### 部署状态

- ? 代码已修复
- ? 编译成功（0 错误，82 警告）
- ? 等待手动部署到游戏目录
- ? 等待游戏内测试验证

---

**版本**: v1.6.8  
**状态**: ? **编译成功，等待部署测试**  
**优先级**: **高**（影响存读档功能）

?? **修复完成！现在人格选择会正确保存到存档中！**
