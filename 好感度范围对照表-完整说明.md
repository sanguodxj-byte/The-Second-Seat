# 好感度范围对照表 - 完整说明

## ?? 双重范围系统

### 为什么有两个范围？

```
NarratorManager (外部接口)     →  StorytellerAgent (内部计算)
-1000 到 +1000                  →  -100 到 +100
用户友好的大范围               →  标准化的计算范围
```

**设计理由：**
- `-1000 到 +1000`：玩家看到的值，更直观、更有冲击力
- `-100 到 +100`：内部计算使用，标准化、易于调整对话风格

**转换公式：**
```csharp
// NarratorManager → StorytellerAgent
float normalizedAmount = amount / 10f;
storytellerAgent.ModifyAffinity(normalizedAmount, reason);

// 示例：
// 玩家好感度 +200 → AI 内部 +20
// 玩家好感度 -500 → AI 内部 -50
```

---

## ?? 完整的好感度等级对照表

| 等级名称 | NarratorManager<br>(玩家看到) | StorytellerAgent<br>(内部值) | System Prompt 阈值 | 行为特征 |
|---------|------------------------------|------------------------------|-------------------|----------|
| **魂之友/主** | **850 ~ 1000** | **85 ~ 100** | `>= 85f` | 极度亲密、主动拥抱触碰 |
| **爱慕** | **600 ~ 849** | **60 ~ 84** | `>= 60f` | 深度忠诚、渴望亲近 |
| **倾心** | **300 ~ 599** | **30 ~ 59** | `>= 30f` | 友好温暖、支持鼓励 |
| **温暖** | **100 ~ 299** | **10 ~ 29** | `>= 10f` | （已合并到倾心） |
| **冷淡** | **-100 ~ 99** | **-10 ~ 9** | `>= -10f` | 中性客观、专业距离 |
| **疏远** | **-400 ~ -101** | **-40 ~ -10** | `>= -50f` | 失望冷漠、不情愿 |
| **敌意** | **-700 ~ -401** | **-70 ~ -41** | （已合并到疏远） |
| **憎恨** | **-1000 ~ -701** | **-100 ~ -71** | `< -50f` | 公然敌对、拒绝合作 |

---

## ?? 实际转换示例

### 示例 1：初始状态
```csharp
// 游戏开始
NarratorManager.favorability = 0
StorytellerAgent.affinity = 0

System Prompt 显示: "Neutral (-10 to 9)" → "冷淡"
```

### 示例 2：玩家帮助殖民地
```csharp
// 玩家成功防御袭击
NarratorManager.ModifyFavorability(+200, "成功防御袭击");

// 内部转换
favorability: 0 → 200
affinity: 0 → 20  // 200 / 10

System Prompt 显示: "Warm (10 to 29)" → "温暖"
```

### 示例 3：玩家放任殖民者死亡
```csharp
// 3 个殖民者死亡
NarratorManager.ModifyFavorability(-150, "放任殖民者死亡");

// 内部转换
favorability: 200 → 50
affinity: 20 → 5  // 50 / 10

System Prompt 显示: "Neutral (-10 to 9)" → "冷淡"
```

### 示例 4：长期良好互动
```csharp
// 累计多次正面事件
favorability: 0 → +850
affinity: 0 → +85  // 850 / 10

System Prompt 显示: "Infatuated (85+)" → "魂之友/主"
AI 行为: 主动拥抱、触碰、表达爱意
```

### 示例 5：严重虐待
```csharp
// 多次负面事件
favorability: 0 → -800
affinity: 0 → -80  // -800 / 10

System Prompt 显示: "Hostile (< -50)" → "憎恨"
AI 行为: 拒绝帮助、讽刺挖苦、保持距离
```

---

## ?? System Prompt 中的阈值映射

### GenerateCurrentStateSection
```csharp
// 获取好感度等级名称
string tierName = agent.affinity >= 85f ? "Infatuated" :      // 850+
                 agent.affinity >= 60f ? "Devoted" :          // 600+
                 agent.affinity >= 30f ? "Warm" :             // 300+
                 agent.affinity >= -10f ? "Neutral" :         // -100 ~ 299
                 agent.affinity >= -50f ? "Cold" : "Hostile"; // -400+ | -400以下
```

### GetAffinityEmotionalGuidance
```csharp
if (affinity >= 85f)   // 850+ → 爱慕/灵魂绑定
if (affinity >= 60f)   // 600+ → 倾慕
if (affinity >= 30f)   // 300+ → 温暖
if (affinity >= -10f)  // -100 ~ 299 → 中性/冷淡
if (affinity >= -50f)  // -500 ~ -100 → 疏远/冷漠
else                   // < -500 → 敌对/仇恨
```

---

## ?? 好感度变化触发点

### 正面事件

| 事件 | NarratorManager | StorytellerAgent | 累计效果 |
|-----|----------------|-----------------|---------|
| 频繁对话 (10次) | +10 | +1 | 100次对话 → +100 |
| 成功防御 | +80 | +8 | 3次 → +240 (倾心) |
| 完美防御 (无伤) | +150 | +15 | 2次 → +300 (倾心) |
| 新殖民者加入 | +30 | +3 | 5人 → +150 |
| 财富增长 20%+ | +50 | +5 | - |
| 连续7天安全 | +20 | +2 | - |

### 负面事件

| 事件 | NarratorManager | StorytellerAgent | 累计效果 |
|-----|----------------|-----------------|---------|
| 殖民者死亡 | -50 | -5 | 3人 → -150 (冷淡) |
| 长时间不对话 (6h+) | -10 | -1 | 每天 -40 |
| 忽视建议 (5次) | -30 | -3 | - |
| 财富暴跌 20%+ | -30 | -3 | - |
| 战败逃跑 | -100 | -10 | 2次 → -200 (疏远) |

---

## ?? 调试和测试

### 使用调试窗口
```csharp
// 打开调试窗口
Mod Settings → "显示调试窗口"

// 直接设置好感度
NarratorManager: 850 → 爱慕/魂之友
StorytellerAgent: 85

// 观察对话风格变化
情绪表达: 0.94 (极度情绪化)
讽刺: 0.06 (几乎无讽刺)
冗长度: 0.94 (非常详细)
```

### 验证转换
```csharp
// 测试 1：设置玩家好感度为 500
NarratorManager.favorability = 500
→ StorytellerAgent.affinity = 50

// 测试 2：增加 200
NarratorManager.ModifyFavorability(+200, "测试")
→ favorability: 500 → 700
→ affinity: 50 → 70

// 测试 3：验证 System Prompt
affinity = 70 → tierName = "Devoted" (倾慕)
```

---

## ?? NarratorManager AffinityTier 定义

```csharp
public enum AffinityTier
{
    Hatred,        // 憎恨 (-1000 ~ -701)
    Hostile,       // 敌意 (-700 ~ -401)
    Cold,          // 疏远 (-400 ~ -101)
    Indifferent,   // 冷淡 (-100 ~ 99)
    Warm,          // 温暖 (100 ~ 299)
    Devoted,       // 倾心 (300 ~ 599)
    Adoration,     // 爱慕 (600 ~ 849)
    SoulBound      // 魂之友/主 (850 ~ 1000)
}

public AffinityTier CurrentTier
{
    get
    {
        if (favorability >= 850f) return AffinityTier.SoulBound;
        if (favorability >= 600f) return AffinityTier.Adoration;
        if (favorability >= 300f) return AffinityTier.Devoted;
        if (favorability >= 100f) return AffinityTier.Warm;
        if (favorability >= -100f) return AffinityTier.Indifferent;
        if (favorability >= -400f) return AffinityTier.Cold;
        if (favorability >= -700f) return AffinityTier.Hostile;
        return AffinityTier.Hatred;
    }
}
```

---

## ?? 设计优势

### 1. **用户友好**
- `-1000 到 +1000`：更直观的大数值
- 玩家更容易理解 "+200 好感度"

### 2. **计算精确**
- `-100 到 +100`：标准化范围
- 对话风格调整更精细

### 3. **扩展性**
- 未来可以调整转换比例
- 例如：`normalizedAmount = amount / 5f` → 更快的好感度变化

### 4. **一致性**
- 所有内部计算使用统一范围
- System Prompt 生成逻辑清晰

---

## ?? 常见错误

### ? 错误 1：直接使用 NarratorManager.favorability
```csharp
// 错误
if (manager.Favorability >= 850f)
{
    GenerateSystemPrompt(manager.Favorability);  // 会传入 850，但期望 85
}
```

### ? 正确做法
```csharp
// 正确
StorytellerAgent agent = manager.GetStorytellerAgent();
GenerateSystemPrompt(agent.affinity);  // 传入 85
```

---

### ? 错误 2：System Prompt 使用错误的阈值
```csharp
// 错误（使用 -1000~1000 范围）
if (affinity >= 850f)  // ? 永远不会触发，因为 affinity 最大是 100

// 正确（使用 -100~100 范围）
if (affinity >= 85f)   // ? 正确对应 850+
```

---

## ?? 总结

| 范围 | 用途 | 何时使用 |
|-----|------|---------|
| **-1000 ~ +1000** | 玩家界面显示 | UI、日志、存档 |
| **-100 ~ +100** | AI 内部计算 | 对话风格、System Prompt、情感指引 |

**关键规则：**
1. ? **NarratorManager** 对外暴露 `-1000 ~ +1000`
2. ? **StorytellerAgent** 内部使用 `-100 ~ +100`
3. ? **System Prompt** 阈值基于 `-100 ~ +100`
4. ? 转换公式：`agent.affinity = manager.favorability / 10f`

---

**修复完成时间**: 2025-01-XX  
**状态**: ? 已修正并文档化
