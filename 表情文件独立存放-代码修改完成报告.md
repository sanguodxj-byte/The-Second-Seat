# 表情文件独立存放 - 代码修改完成报告

## ? 修改完成

### 文件修改清单
- ? `Source\TheSecondSeat\PersonaGeneration\PortraitLoader.cs` - 已修改

---

## ?? 核心改动

### 1. 新增常量
```csharp
// ? 基础立绘路径
private const string BASE_PATH_9x16 = "UI/Narrators/9x16/";

// ? 表情文件路径（新增）
private const string EXPRESSIONS_PATH = "UI/Narrators/9x16/Expressions/";
```

---

### 2. 加载整图表情的逻辑变化

#### 修改前（旧路径）
```csharp
// 从人格文件夹加载
string expressionPath = def.portraitPath + expressionSuffix;
// 路径: UI/Narrators/9x16/Cassandra/happy
```

#### 修改后（新路径）?
```csharp
// ? 优先：从 Expressions 文件夹加载
string expressionPath = EXPRESSIONS_PATH + def.defName + expressionSuffix;
// 路径: UI/Narrators/9x16/Expressions/Cassandra/happy

var texture = ContentFinder<Texture2D>.Get(expressionPath, false);

if (texture != null)
{
    Log.Message($"? 从 Expressions 加载整图表情: {expressionPath}");
    return texture;
}

// ? 降级：尝试旧路径（兼容性）
if (!string.IsNullOrEmpty(def.portraitPath))
{
    string oldPath = def.portraitPath + expressionSuffix;
    texture = ContentFinder<Texture2D>.Get(oldPath, false);
    
    if (texture != null)
    {
        Log.Warning($"?? 从旧路径加载表情（请迁移到 Expressions 文件夹）: {oldPath}");
        return texture;
    }
}
```

---

### 3. 加载面部纹理的逻辑变化

#### 修改前（旧路径）
```csharp
// 从人格文件夹加载面部纹理
string facePath = def.portraitPath + faceSuffix;
// 路径: UI/Narrators/9x16/Cassandra/happy_face
```

#### 修改后（新路径）?
```csharp
// ? 从 Expressions 文件夹加载面部纹理
string facePath = EXPRESSIONS_PATH + def.defName + "/" + faceSuffix;
// 路径: UI/Narrators/9x16/Expressions/Cassandra/happy_face

Texture2D faceTexture = ContentFinder<Texture2D>.Get(facePath, false);

// ? 降级：尝试旧路径
if (faceTexture == null && !string.IsNullOrEmpty(def.portraitPath))
{
    string oldFacePath = def.portraitPath + faceSuffix;
    faceTexture = ContentFinder<Texture2D>.Get(oldFacePath, false);
    
    if (faceTexture != null)
    {
        Log.Warning($"?? 从旧路径加载面部纹理: {oldFacePath}");
    }
}
```

---

### 4. 加载基础立绘保持不变
```csharp
// ? 优先：从 9:16 文件夹的 base.png 加载
string basePath = BASE_PATH_9x16 + def.defName + "/base";
// 路径: UI/Narrators/9x16/Cassandra/base

var texture = ContentFinder<Texture2D>.Get(basePath, false);
```

---

## ?? 新的文件加载顺序

### 情况 1: 加载整图表情（如 Happy）

```
优先级 1: ? UI/Narrators/9x16/Expressions/Cassandra/happy.png
优先级 2: ??  UI/Narrators/9x16/Cassandra/happy.png (旧路径，兼容)
优先级 3: ?? 自定义路径（如果设置）
```

### 情况 2: 加载面部纹理（如 Happy Face）

```
优先级 1: ? UI/Narrators/9x16/Expressions/Cassandra/happy_face.png
优先级 2: ??  UI/Narrators/9x16/Cassandra/happy_face.png (旧路径，兼容)
优先级 3: ?? 自定义路径（如果设置）
```

### 情况 3: 加载基础立绘

```
优先级 1: ? UI/Narrators/9x16/Cassandra/base.png
优先级 2: ?? Mod 路径（def.portraitPath）
优先级 3: ?? 自定义路径（def.customPortraitPath）
```

---

## ?? 兼容性保证

### 降级策略
1. ? **优先加载新路径** - `Expressions/Cassandra/happy.png`
2. ?? **降级到旧路径** - `Cassandra/happy.png`（发出警告）
3. ?? **降级到自定义路径** - 用户指定的外部文件

### 日志输出

#### 成功加载新路径
```
[PortraitLoader] ? 从 Expressions 加载整图表情: UI/Narrators/9x16/Expressions/Cassandra/happy
```

#### 降级到旧路径
```
[PortraitLoader] ?? 从旧路径加载表情（请迁移到 Expressions 文件夹）: UI/Narrators/9x16/Cassandra/happy
```

#### 使用面部覆盖
```
[PortraitLoader] ? 使用面部覆盖模式: Cassandra + happy_face
```

---

## ?? 下一步操作

### 1. 运行文件迁移脚本
```powershell
# 模拟运行（查看预览）
.\Reorganize-Expressions.ps1 -DryRun

# 实际执行迁移
.\Reorganize-Expressions.ps1
```

### 2. 验证迁移结果
```
检查目录结构:
Textures/UI/Narrators/9x16/
├─ Cassandra/
│  └─ base.png              ← 只有基础立绘
│
└─ Expressions/             ← 表情文件夹
   └─ Cassandra/
      ├─ happy.png
      ├─ sad.png
      └─ layers/
         └─ ...
```

### 3. 测试加载
```csharp
// 测试 1: 基础立绘
var persona = DefDatabase<NarratorPersonaDef>.GetNamed("Cassandra_Classic");
var baseTex = PortraitLoader.LoadPortrait(persona, ExpressionType.Neutral);
// 预期: UI/Narrators/9x16/Cassandra/base

// 测试 2: 整图表情
var happyTex = PortraitLoader.LoadPortrait(persona, ExpressionType.Happy);
// 预期: UI/Narrators/9x16/Expressions/Cassandra/happy

// 测试 3: 面部覆盖
// （删除 happy.png 强制使用面部覆盖）
var faceOverlay = PortraitLoader.LoadPortrait(persona, ExpressionType.Happy);
// 预期: base + Expressions/Cassandra/happy_face
```

### 4. 查看日志验证
```
启动游戏 → 打开聊天窗口 → 切换表情

预期日志:
[PortraitLoader] ? 从 Expressions 加载整图表情: UI/Narrators/9x16/Expressions/Cassandra/happy
```

---

## ?? 修改影响范围

### 影响的功能
- ? **立绘加载系统** - 支持新路径
- ? **表情切换系统** - 从新路径加载
- ? **面部覆盖系统** - 从新路径加载分层
- ? **调试窗口** - 表情预览

### 不影响的功能
- ? **基础立绘加载** - 仍从人格文件夹加载
- ? **占位符生成** - 逻辑不变
- ? **缓存系统** - 逻辑不变
- ? **自定义路径** - 仍然支持

---

## ?? 测试场景

### 场景 1: 新文件结构（推荐）
```
Textures/UI/Narrators/9x16/
├─ Cassandra/
│  └─ base.png
└─ Expressions/
   └─ Cassandra/
      ├─ happy.png
      ├─ sad.png
      └─ angry.png

结果: ? 从 Expressions 加载，日志显示绿色 ?
```

### 场景 2: 旧文件结构（兼容）
```
Textures/UI/Narrators/9x16/
└─ Cassandra/
   ├─ base.png
   ├─ happy.png
   ├─ sad.png
   └─ angry.png

结果: ?? 从旧路径加载，日志显示黄色警告 ??
```

### 场景 3: 混合结构（部分迁移）
```
Textures/UI/Narrators/9x16/
├─ Cassandra/
│  ├─ base.png
│  └─ sad.png            ← 未迁移
└─ Expressions/
   └─ Cassandra/
      └─ happy.png       ← 已迁移

结果:
- Happy: ? 从 Expressions 加载
- Sad:   ?? 从旧路径加载（警告）
```

### 场景 4: 文件缺失
```
Textures/UI/Narrators/9x16/
├─ Cassandra/
│  └─ base.png
└─ Expressions/
   └─ （空）

结果:
- 表情加载失败
- 降级到基础立绘
- 日志: "未找到表情，返回基础立绘"
```

---

## ?? 用户指南更新

### 需要更新的文档
1. ? **立绘放置完整指南.md**
   - 更新文件夹结构说明
   - 添加 Expressions 文件夹说明

2. ? **表情文件放置说明.txt**
   - 更新路径说明
   - 强调新旧路径兼容性

3. ? **9-16立绘动态表情方案.md**
   - 更新代码示例
   - 更新路径引用

---

## ?? 优势总结

### 用户体验
- ? **选择立绘时更清爽** - 只看到 base.png
- ? **文件组织更清晰** - 立绘和表情分离
- ? **不会误选表情文件** - 表情在独立文件夹

### 开发维护
- ? **结构清晰** - Expressions 专门存放表情
- ? **易于扩展** - 添加新表情不影响立绘文件夹
- ? **兼容性好** - 支持旧结构，平滑迁移
- ? **日志清晰** - 明确显示加载路径

### 性能
- ? **无性能损失** - 路径变化不影响加载速度
- ? **缓存继续有效** - 缓存 key 包含完整路径
- ? **降级策略** - 找不到新路径时自动降级

---

## ? 完成清单

- [x] 修改 `PortraitLoader.cs` 代码
- [x] 添加 `EXPRESSIONS_PATH` 常量
- [x] 修改整图表情加载逻辑
- [x] 修改面部纹理加载逻辑
- [x] 添加降级策略（兼容旧路径）
- [x] 添加详细日志输出
- [x] 创建迁移脚本 `Reorganize-Expressions.ps1`
- [x] 创建完整指南文档
- [ ] 运行迁移脚本
- [ ] 测试验证
- [ ] 更新用户文档

---

**修改完成时间**: 2025-01-XX  
**状态**: ? 代码已修改，待迁移文件和测试  
**下一步**: 运行 `.\Reorganize-Expressions.ps1` 迁移文件
