# ?? 表情包系统 + 全局提示词 - 完整实现报告

## ? 实现状态

**编译状态**: ? 成功（0 错误，44 警告）  
**部署状态**: ? 已部署到游戏目录  
**功能状态**: ? 完整实现

---

## ?? 新增功能总览

### 1. **表情包发送系统** ?
叙事者可以根据对话内容和情感自动选择表情包发送给玩家

### 2. **全局提示词设置** ?
在模组设置中添加全局提示词输入框，自定义 AI 的行为准则和语言风格

---

## ?? 表情包系统详解

### 文件结构
```
Emoticons/
├── README.md              # 使用指南
├── emoticons.txt          # 元数据配置文件
├── smile.png              # 示例：微笑表情（用户自己添加）
├── cry.png                # 示例：哭泣表情
├── think.png              # 示例：思考表情
└── ... 更多表情包 ...
```

### 核心组件

#### 1. EmoticonLoader（表情包加载器）
**文件**: `Source/TheSecondSeat/Emoticons/EmoticonLoader.cs`

**功能**:
- 从 `Emoticons/` 文件夹加载所有 PNG/JPG 图片
- 加载元数据文件 `emoticons.txt`
- 解析表情包标签和描述
- 自动创建文件夹和示例配置

**支持格式**:
- ? PNG（推荐，支持透明背景）
- ? JPG / JPEG

**数据结构**:
```csharp
public class EmoticonData
{
    public string id;              // 表情包ID（文件名不含扩展名）
    public string displayName;     // 显示名称
    public string filePath;        // 完整文件路径
    public Texture2D texture;      // 加载的纹理
    public List<string> tags;      // 情感标签（happy, sad, angry等）
    public string description;     // 描述
}
```

---

#### 2. EmoticonManager（表情包管理器）
**文件**: `Source/TheSecondSeat/Emoticons/EmoticonManager.cs`

**功能**:
- 管理所有加载的表情包
- 建立标签索引（快速查询）
- 智能情感分析选择合适的表情包
- 生成表情包列表供 LLM 选择

**智能选择逻辑**:
```csharp
// 根据好感度选择
if (affinity >= 60f) → 选择 happy, joy, love 标签
if (affinity < -50f) → 选择 angry, frustrated, smug 标签

// 根据情绪状态
if (mood.Contains("joy")) → 选择 happy, joy 标签
if (mood.Contains("angry")) → 选择 angry, frustrated 标签

// 根据对话关键词
if (dialogue.Contains("哈哈")) → 选择 happy, excited 标签
if (dialogue.Contains("...")) → 选择 thinking, confused 标签
```

**方法**:
- `GetEmoticonByTag(tag)` - 根据标签随机选择一个表情包
- `GetEmoticonById(id)` - 根据ID获取表情包
- `SelectEmoticonBySentiment(dialogue, affinity, mood)` - 智能选择
- `GenerateEmoticonListForPrompt()` - 生成供 LLM 选择的列表

---

#### 3. UI 显示
**文件**: `Source/TheSecondSeat/UI/NarratorWindow.cs`

**修改**:
```csharp
// ChatMessage 添加 emoticon 字段
private class ChatMessage
{
    public string sender = "";
    public string content = "";
    public System.DateTime timestamp;
    public Emoticons.EmoticonData emoticon = null;  // ? 新增
}

// AddAIMessage 支持传入表情包ID
public static void AddAIMessage(string content, string emoticonId = "")
{
    var msg = new ChatMessage { ... };
    
    if (!string.IsNullOrEmpty(emoticonId))
    {
        msg.emoticon = EmoticonManager.Instance.GetEmoticonById(emoticonId);
    }
    
    chatHistory.Add(msg);
}

// DrawChatMessage 显示表情包
if (hasEmoticon)
{
    // 绘制表情包图片（100x100）
    GUI.DrawTexture(emoticonRect, message.emoticon.texture);
    
    // 显示表情包名称
    Widgets.Label(nameRect, message.emoticon.displayName);
}
```

---

#### 4. LLM 集成
**文件**: `Source/TheSecondSeat/LLM/LLMDataStructures.cs`

**LLMResponse 添加字段**:
```csharp
public class LLMResponse
{
    public string thought { get; set; } = "";
    public string dialogue { get; set; } = "";
    public LLMCommand? command { get; set; }
    public string emoticon { get; set; } = "";  // ? 新增
}
```

**System Prompt 添加表情包列表**:
```
Available emoticons (optional, choose ONE if appropriate):
  - happy: smile, joy, laugh
  - sad: cry, disappointed
  - angry: mad, frustrated
  ...

To use an emoticon, include in JSON: "emoticon": "emoticon_id"
Only use emoticons when they naturally fit the emotion of your response.
```

**NarratorController 处理表情包**:
```csharp
private void ProcessResponse(LLMResponse response, string userMessage)
{
    // 提取表情包ID
    string emoticonId = "";
    if (!string.IsNullOrEmpty(response.emoticon))
    {
        emoticonId = response.emoticon;
    }
    
    // 添加到聊天框（包含表情包）
    UI.NarratorWindow.AddAIMessage(displayText, emoticonId);
}
```

---

### 元数据配置格式

**文件**: `Emoticons/emoticons.txt`

```ini
# 表情包元数据文件

[smile]
name = 微笑
tags = happy, joy
description = 开心的微笑

[cry]
name = 哭泣
tags = sad, crying
description = 伤心地哭泣

[think]
name = 思考
tags = thinking, confused
description = 陷入思考
```

### 可用标签列表

| 类别 | 标签 | 说明 |
|------|------|------|
| **开心** | happy, joy, excited, smug, proud | 开心、喜悦、兴奋、得意 |
| **难过** | sad, disappointed, crying, melancholic | 难过、失望、哭泣、忧郁 |
| **生气** | angry, frustrated | 生气、沮丧 |
| **惊讶** | surprised, shocked | 惊讶、震惊 |
| **思考** | thinking, confused | 思考、困惑 |
| **感情** | love, affection | 爱、亲昵 |
| **中性** | neutral, calm | 中性、平静 |
| **其他** | embarrassed, shy, tired, sleepy | 尴尬、害羞、疲惫、困倦 |

---

## ?? 全局提示词系统详解

### 设置界面

**位置**: 游戏主菜单 → 选项 → 模组设置 → The Second Seat → 全局提示词

**UI 元素**:
- 标题：`全局提示词`
- 描述：简要说明功能
- 多行文本输入框（120像素高）
- "加载示例"按钮

### 示例全局提示词

点击"加载示例"按钮会加载以下内容：

```markdown
# 全局指令示例

## 语言风格
- 使用简洁清晰的语言
- 避免过于冗长的描述
- 可以使用一些中文成语或俗语增加趣味性

## 行为准则
- 优先考虑殖民者的安全
- 提供建设性建议而非单纯批评
- 在危险情况下主动警告

## 个性特点
- 保持友善但专业的态度
- 偶尔展现幽默感
- 对玩家的决策表示尊重
```

### System Prompt 集成

**文件**: `Source/TheSecondSeat/PersonaGeneration/SystemPromptGenerator.cs`

**完整版 Prompt**:
```csharp
public static string GenerateSystemPrompt(...)
{
    var sb = new StringBuilder();
    
    // 0. 全局提示词（如果设置了）
    var modSettings = LoadedModManager.GetMod<Settings.TheSecondSeatMod>()
        ?.GetSettings<Settings.TheSecondSeatSettings>();
    
    if (!string.IsNullOrWhiteSpace(modSettings.globalPrompt))
    {
        sb.AppendLine("=== GLOBAL INSTRUCTIONS ===");
        sb.AppendLine(modSettings.globalPrompt.Trim());
        sb.AppendLine();
        sb.AppendLine("---");
        sb.AppendLine();
    }
    
    // 1. 存在与身份
    // 2. 人格特质
    // ...
}
```

**简化版 Prompt** 也添加了相同逻辑。

### 使用场景

1. **设置语言风格**
   ```
   - 使用正式/非正式语言
   - 使用中文/英文回复
   - 避免使用特定词汇
   ```

2. **设置行为准则**
   ```
   - 优先考虑安全
   - 提供详细解释
   - 不提供危险建议
   ```

3. **设置个性特点**
   ```
   - 保持幽默感
   - 表现专业性
   - 展现同理心
   ```

4. **设置禁止行为**
   ```
   - 不使用脏话
   - 不讽刺玩家
   - 不建议自杀式战术
   ```

---

## ?? 数据流图

### 表情包系统流程

```
用户将PNG放入 Emoticons/ 文件夹
   ↓
EmoticonLoader.LoadAllEmoticons()
   ↓ (加载图片和元数据)
EmoticonManager.Initialize()
   ↓ (建立标签索引)
LLM 返回 response.emoticon = "smile"
   ↓
NarratorController.ProcessResponse()
   ↓ (提取表情包ID)
NarratorWindow.AddAIMessage(text, "smile")
   ↓ (查询表情包)
EmoticonManager.GetEmoticonById("smile")
   ↓ (显示)
DrawChatMessage() 绘制表情包图片
```

### 全局提示词流程

```
用户在设置中输入全局提示词
   ↓ (保存到配置)
ModSettings.globalPrompt = "..."
   ↓ (生成 Prompt 时)
SystemPromptGenerator.GenerateSystemPrompt()
   ↓ (读取设置)
LoadedModManager.GetSettings<TheSecondSeatSettings>()
   ↓ (添加到 Prompt 开头)
sb.AppendLine("=== GLOBAL INSTRUCTIONS ===");
sb.AppendLine(modSettings.globalPrompt);
   ↓ (发送到 LLM)
LLMService.SendMessageAsync(prompt, userMessage)
   ↓ (AI 遵循指令)
LLM 按照全局指令回复
```

---

## ?? 使用指南

### 表情包使用步骤

1. **准备表情包图片**
   - 格式：PNG 或 JPG
   - 尺寸：建议 128x128 至 512x512 像素
   - 命名：使用英文字母和数字（如 `smile.png`）

2. **放入文件夹**
   - 复制到 `<模组目录>/Emoticons/` 文件夹

3. **配置元数据**（可选）
   - 编辑 `Emoticons/emoticons.txt`
   - 添加表情包ID、名称和标签

4. **重启游戏**
   - 表情包会在游戏加载时自动加载

5. **测试**
   - 打开 AI 对话窗口
   - 与 AI 聊天，观察是否使用表情包

### 全局提示词使用步骤

1. **打开设置**
   - 游戏主菜单 → 选项 → 模组设置 → The Second Seat

2. **找到全局提示词**
   - 滚动到"全局提示词"部分

3. **输入指令**
   - 在文本框中输入你的指令
   - 或点击"加载示例"查看示例

4. **点击应用**
   - 点击"应用设置"按钮保存

5. **测试**
   - 与 AI 对话，观察是否遵循指令

---

## ?? 配置示例

### 表情包配置示例

```ini
# 完整配置示例
[happy_smile]
name = 开心微笑
tags = happy, joy, excited
description = 非常开心的表情

[sad_cry]
name = 难过哭泣
tags = sad, crying, disappointed
description = 伤心难过的表情

[think_hmm]
name = 思考中
tags = thinking, confused
description = 正在思考问题

[angry_mad]
name = 生气
tags = angry, frustrated
description = 愤怒的表情

[love_heart]
name = 爱心
tags = love, affection, happy
description = 表达爱意
```

### 全局提示词配置示例

**示例 1：友好型 AI**
```markdown
## 语言风格
- 使用温暖友善的语言
- 多使用鼓励性词汇
- 避免批评和负面评价

## 行为准则
- 优先关心殖民者的健康和快乐
- 提供积极的建议
- 在失败时给予安慰
```

**示例 2：专业型 AI**
```markdown
## 语言风格
- 使用简洁专业的语言
- 提供数据和事实支持
- 避免情感化表达

## 行为准则
- 以效率为优先
- 提供详细的战术分析
- 关注资源优化
```

**示例 3：幽默型 AI**
```markdown
## 语言风格
- 使用幽默风趣的语言
- 可以开玩笑和调侃
- 保持轻松愉快的氛围

## 行为准则
- 在安全的情况下开玩笑
- 用幽默缓解紧张
- 避免过度严肃
```

---

## ?? 翻译键

### 中文翻译
```xml
<!-- 全局提示词 -->
<TSS_Settings_GlobalPrompt_Title>全局提示词</TSS_Settings_GlobalPrompt_Title>
<TSS_Settings_GlobalPrompt_Description>在此输入全局指令，这些指令会被添加到所有 AI 对话的开头。\n可用于设置 AI 的语言风格、行为准则等。留空则不使用全局提示词。</TSS_Settings_GlobalPrompt_Description>
<TSS_Settings_GlobalPrompt_LoadExample>加载示例</TSS_Settings_GlobalPrompt_LoadExample>
```

### 英文翻译
```xml
<!-- Global Prompt -->
<TSS_Settings_GlobalPrompt_Title>Global Prompt</TSS_Settings_GlobalPrompt_Title>
<TSS_Settings_GlobalPrompt_Description>Enter global instructions here. These will be added to the beginning of all AI conversations.\nYou can use this to set AI's language style, behavior guidelines, etc. Leave empty to disable global prompt.</TSS_Settings_GlobalPrompt_Description>
<TSS_Settings_GlobalPrompt_LoadExample>Load Example</TSS_Settings_GlobalPrompt_LoadExample>
```

---

## ??? 故障排除

### 表情包未加载

**问题**: 游戏日志显示"已加载 0 个表情包"

**解决方案**:
1. 检查文件夹路径是否正确（`Emoticons/`）
2. 检查图片格式是否为 PNG/JPG
3. 检查文件名是否包含特殊字符
4. 查看日志文件：`RimWorld/Logs/Player.log`

### 表情包显示异常

**问题**: 表情包图片扭曲或显示不正常

**解决方案**:
1. 检查图片尺寸（推荐 256x256）
2. 确保图片未损坏
3. 尝试重新转换为 PNG 格式

### AI 不使用表情包

**问题**: AI 从不发送表情包

**解决方案**:
1. 检查 `emoticons.txt` 是否正确配置
2. 确保添加了情感标签
3. AI 会根据情况选择（不是每次都用）
4. 在对话中明确要求"用表情包回复我"

### 全局提示词不生效

**问题**: AI 没有遵循全局提示词

**解决方案**:
1. 检查是否点击了"应用设置"
2. 确认提示词已保存（重启游戏后仍在）
3. 提示词应该清晰明确
4. 避免与人格设定冲突的指令

---

## ?? 相关文档

- [Emoticons/README.md](Emoticons/README.md) - 表情包使用指南
- [好感度影响对话风格-完整实现报告.md](好感度影响对话风格-完整实现报告.md)
- [人格生成系统指南.md](人格生成系统指南.md)
- [完整使用手册.md](完整使用手册.md)

---

## ? 新增文件列表

### 代码文件
- `Source/TheSecondSeat/Emoticons/EmoticonLoader.cs` - 表情包加载器
- `Source/TheSecondSeat/Emoticons/EmoticonManager.cs` - 表情包管理器

### 配置文件
- `Emoticons/README.md` - 表情包使用指南
- `Emoticons/emoticons.txt` - 表情包元数据模板

### 修改的文件
- `Source/TheSecondSeat/LLM/LLMDataStructures.cs` - 添加 emoticon 字段
- `Source/TheSecondSeat/UI/NarratorWindow.cs` - 支持显示表情包
- `Source/TheSecondSeat/Core/NarratorController.cs` - 处理表情包
- `Source/TheSecondSeat/PersonaGeneration/SystemPromptGenerator.cs` - 添加全局提示词和表情包列表
- `Source/TheSecondSeat/Settings/ModSettings.cs` - 添加全局提示词设置
- `Languages/ChineseSimplified/Keyed/TheSecondSeat_Keys.xml` - 添加翻译
- `Languages/English/Keyed/TheSecondSeat_Keys.xml` - 添加翻译

---

## ?? 总结

### 实现的功能

1. ? **表情包加载系统**
   - 支持 PNG/JPG 格式
   - 自动创建文件夹和配置
   - 元数据支持名称、标签、描述

2. ? **表情包管理系统**
   - 智能情感分析
   - 标签索引查询
   - 根据好感度/情绪/关键词选择

3. ? **UI 显示系统**
   - 聊天气泡中显示表情包
   - 表情包名称显示
   - 自适应布局

4. ? **LLM 集成**
   - LLMResponse 支持表情包
   - System Prompt 提供表情包列表
   - AI 可自主选择表情包

5. ? **全局提示词系统**
   - 模组设置界面
   - 多行文本输入
   - 示例提示词
   - System Prompt 集成

### 下一步

- [ ] 用户添加表情包图片
- [ ] 测试表情包显示效果
- [ ] 配置全局提示词
- [ ] 观察 AI 是否正确使用

---

**版本**: v1.5.0  
**日期**: 2024  
**状态**: ? 已完成并部署

?? **重启 RimWorld 开始使用！**
