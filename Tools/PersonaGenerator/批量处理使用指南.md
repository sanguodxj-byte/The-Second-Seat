# RimWorld Persona Generator - 批量处理使用指南

## ?? 功能说明

此工具可以批量处理图片，自动生成 RimWorld 角色定义 XML 文件。

### 工作流程

```
input_images/          output_mods/
├── char1.png    →    ├── char1_Def.xml
├── char2.png    →    ├── char2_Def.xml
└── char3.png    →    └── char3_Def.xml
```

## ?? 快速开始

### 方法 1: 使用批处理文件（推荐）

1. **准备图片**
   - 将 `.png` 格式的角色立绘放入 `input_images` 文件夹
   - 文件名将作为角色名称（例如：`Sideria.png` → 角色名：Sideria）

2. **运行批处理**
   - 双击 `批量处理.bat`
   - 或在命令行运行：`批量处理.bat`

3. **查看结果**
   - 生成的 XML 文件位于 `output_mods` 文件夹
   - 控制台会显示处理进度和结果

### 方法 2: 使用 Python 脚本

```bash
# 确保已安装 Python 3.7+
python batch_process.py
```

### 方法 3: 使用原始脚本

```bash
python rimworld_persona_generator.py --batch ./input_images ./output_mods
```

## ?? 文件夹结构

```
Tools/PersonaGenerator/
├── rimworld_persona_generator.py   # 核心生成器
├── batch_process.py                # 批量处理脚本
├── rules.json                      # 标签规则配置
├── 批量处理.bat                     # Windows 批处理文件
├── input_images/                   # 输入图片文件夹
│   ├── Character1.png
│   └── Character2.png
└── output_mods/                    # 输出 XML 文件夹
    ├── Character1_Def.xml
    └── Character2_Def.xml
```

## ?? 图片要求

- **格式**: PNG（推荐）
- **内容**: 角色立绘、头像或全身像
- **命名**: 文件名将作为角色名称
  - 示例：`Sideria.png` → `<label>Sideria</label>`
  - 自动生成 defName：`Sideria_Def`

## ?? 配置说明

### rules.json

定义了视觉标签到特性/技能的映射规则：

```json
{
  "tag_rules": [
    {
      "tag": "angry",
      "traits": [
        {
          "traitDef": "Bloodlust",
          "degree": 0,
          "priority": 60
        }
      ],
      "skills": [
        {
          "skillName": "Melee",
          "bonus": 3,
          "passion": 1
        }
      ]
    }
  ]
}
```

### 标签优先级

- `priority`: 0-100，数值越高优先级越高
- 冲突的特性会自动解决（保留高优先级）

## ?? 输出格式

生成的 XML 文件包含两个定义：

### 1. PawnKindDef（角色类型定义）

```xml
<PawnKindDef>
  <defName>Sideria</defName>
  <label>Sideria</label>
  <race>Human</race>
  <forcedTraits>
    <li>
      <def>Bloodlust</def>
      <degree>0</degree>
    </li>
  </forcedTraits>
</PawnKindDef>
```

### 2. BackstoryDef（背景故事定义）

```xml
<BackstoryDef>
  <defName>Sideria_Backstory</defName>
  <slot>Adulthood</slot>
  <title>Sideria's Journey</title>
  <titleShort>Sideria</titleShort>
  <baseDesc>A character generated from visual analysis.</baseDesc>
  <skillGains>
    <Melee>3</Melee>
    <Shooting>2</Shooting>
  </skillGains>
</BackstoryDef>
```

## ?? 注意事项

### 当前版本使用模拟模式

**重要**: 当前 `analyze_image()` 函数使用**模拟模式**，随机返回标签用于测试。

要启用真实的图像分析，需要：

1. **集成 Vision AI**
   - OpenAI GPT-4 Vision
   - Google Gemini Vision
   - 本地 WD14 Tagger
   - CLIP 模型

2. **替换 analyze_image 函数**

示例（使用 OpenAI GPT-4 Vision）:

```python
def analyze_image(self, image_path: str) -> List[str]:
    import openai
    import base64
    
    # 读取图片并转为 base64
    with open(image_path, "rb") as f:
        base64_image = base64.b64encode(f.read()).decode()
    
    # 调用 GPT-4 Vision API
    response = openai.ChatCompletion.create(
        model="gpt-4-vision-preview",
        messages=[{
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": "Analyze this character image and return visual tags..."
                },
                {
                    "type": "image_url",
                    "image_url": {
                        "url": f"data:image/png;base64,{base64_image}"
                    }
                }
            ]
        }]
    )
    
    # 解析返回的标签
    tags = parse_response(response)
    return tags
```

## ?? 故障排除

### 问题：找不到输入文件夹

**解决方案**：
- 脚本会自动创建 `input_images` 文件夹
- 请将 PNG 图片放入该文件夹后重新运行

### 问题：没有检测到标签

**解决方案**：
- 当前版本使用模拟模式，会随机返回标签
- 要启用真实检测，请集成 Vision AI（见上文）

### 问题：生成的 XML 无法被 RimWorld 识别

**解决方案**：
1. 检查 XML 格式是否正确
2. 确保 `defName` 唯一
3. 检查特性名称是否为有效的 RimWorld TraitDef
4. 将 XML 文件放入模组的 `Defs/` 文件夹

### 问题：特性冲突

**解决方案**：
- 脚本会自动解决冲突（保留高优先级特性）
- 可在 `rules.json` 中调整优先级

## ?? 进阶使用

### 自定义标签规则

编辑 `rules.json` 添加新标签：

```json
{
  "tag_rules": [
    {
      "tag": "your_custom_tag",
      "description": "Description of this tag",
      "traits": [
        {
          "traitDef": "YourTraitDef",
          "degree": 0,
          "priority": 50,
          "category": "uncategorized",
          "conflictsWith": []
        }
      ],
      "skills": [
        {
          "skillName": "YourSkill",
          "bonus": 5,
          "passion": 2
        }
      ]
    }
  ]
}
```

### 导出当前规则

```bash
python rimworld_persona_generator.py
```

脚本会在测试后生成 `exported_rules.json`

## ?? 相关文件

- `rimworld_persona_generator.py` - 核心生成器逻辑
- `batch_process.py` - 批量处理封装
- `rules.json` - 标签规则配置
- `README.md` - 完整文档

## ?? 提示

1. **命名规范**: 使用有意义的文件名，它们将成为角色名称
2. **批量处理**: 一次可以处理多个图片
3. **错误处理**: 即使部分图片失败，也会继续处理其他图片
4. **日志输出**: 所有操作都会在控制台输出详细日志

## ?? 支持

如遇到问题，请查看：
1. 控制台输出的错误信息
2. `output_mods` 文件夹中的 XML 文件
3. RimWorld 的日志文件

---

**祝您使用愉快！Happy modding! ??**
