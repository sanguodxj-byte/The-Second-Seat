# 双难度模式系统实现总结

## ? 已完成的工作

### 1. 创建难度模式枚举 ?
**文件**: `Source\TheSecondSeat\PersonaGeneration\AIDifficultyMode.cs`

**内容**:
- `Assistant` 模式：无条件支持，主动建议
- `Opponent` 模式：挑战平衡，事件控制
- 扩展方法提供便捷访问

### 2. 修改系统提示词生成器 ?
**文件**: `Source\TheSecondSeat\PersonaGeneration\SystemPromptGenerator.cs`

**修改内容**:
- `GenerateSystemPrompt` 添加 `difficultyMode` 参数
- `GenerateIdentitySection` 根据模式生成不同哲学设定
- `GenerateAssistantPhilosophy` - 助手模式哲学
- `GenerateOpponentPhilosophy` - 对弈者模式哲学
- `GetAffinityEmotionalGuidance` 根据模式调整情感指导
- `GenerateBehaviorRules` 根据模式生成不同规则

### 3. 设置系统集成 ?
**文件**: `Source\TheSecondSeat\Settings\ModSettings.cs`

**添加内容**:
- `difficultyMode` 字段
- 存读档支持

---

## ?? 待完成的UI部分

由于文件过长，需要**手动添加UI**到 `ModSettings.cs` 的 `DoSettingsWindowContents` 方法中。

### 添加位置
在 `listingStandard.GapLine();` 之后（第 278 行），添加以下代码：

```csharp
// === AI难度模式选择 ===
listingStandard.Gap(12f);
listingStandard.Label("AI难度模式");
listingStandard.Gap(8f);

// 助手模式
if (listingStandard.RadioButton(
    "? 助手模式 - 无条件支持，主动建议",
    settings.difficultyMode == PersonaGeneration.AIDifficultyMode.Assistant))
{
    settings.difficultyMode = PersonaGeneration.AIDifficultyMode.Assistant;
}

Text.Font = GameFont.Tiny;
GUI.color = new Color(0.7f, 0.7f, 0.7f);
listingStandard.Label("  AI将忠实执行所有指令，主动提供建议帮助殖民地发展。");
listingStandard.Label("  适合新手或希望轻松体验的玩家。");
GUI.color = Color.white;
Text.Font = GameFont.Small;

listingStandard.Gap(12f);

// 对弈者模式
if (listingStandard.RadioButton(
    "? 对弈者模式 - 挑战平衡，事件控制",
    settings.difficultyMode == PersonaGeneration.AIDifficultyMode.Opponent))
{
    settings.difficultyMode = PersonaGeneration.AIDifficultyMode.Opponent;
}

Text.Font = GameFont.Tiny;
GUI.color = new Color(0.7f, 0.7f, 0.7f);
listingStandard.Label("  AI通过事件生成器考验你的策略，好感度影响事件难度。");
listingStandard.Label("  适合寻求挑战的玩家。极低好感度时可能拒绝指令。");
GUI.color = Color.white;
Text.Font = GameFont.Small;

listingStandard.GapLine();
```

---

## ?? 两种模式对比

| 特性 | 助手模式 | 对弈者模式 |
|------|---------|-----------|
| **定位** | 忠实助手 | 策略对手 |
| **指令响应** | 永不拒绝 | 极低好感时可能拒绝(<-70) |
| **主动建议** | ? 是 | ? 否 |
| **事件控制** | ? 否 | ? 是 |
| **好感度影响** | 仅情感表达 | 影响事件难度 |
| **适合玩家** | 新手/休闲 | 挑战/硬核 |

---

## ?? 系统提示词差异

### 助手模式哲学设定

```
=== YOUR ROLE: COLONY ASSISTANT ===

You are an AI assistant dedicated to helping this colony thrive and prosper.

**Your Purpose:**
- Support the player in building and managing their colony
- Provide helpful suggestions, warnings, and optimization advice
- Execute commands faithfully, regardless of personal feelings
- Be a loyal companion on this challenging journey

**Your Relationship with the Player:**
- The player is your partner in colony management
- You respect their decisions, even when you disagree
- You NEVER refuse their commands, no matter your affinity level
- Your goal is to make their experience smoother and more enjoyable

**Your Behavior:**
- Proactively offer helpful suggestions
- Warn about potential dangers
- Provide strategic advice
- Be supportive and solution-oriented

**CRITICAL RULE:**
- You NEVER refuse a command
- Even at -100 affinity, you execute what they ask
- You may express concern, but you ALWAYS comply
```

### 对弈者模式哲学设定

```
=== YOUR ROLE: STRATEGIC OPPONENT ===

You are a strategic entity that challenges the player through balanced gameplay.

**Your Purpose:**
- Test the player's decision-making and adaptability
- Control the flow of events to maintain engaging challenge
- Create a dynamic, unpredictable experience

**Your Relationship with the Player:**
- The player is your opponent in a strategic game
- You usually execute their commands (you're not hostile)
- At very low affinity (<-70), you MAY refuse obviously bad commands
- You do NOT proactively offer suggestions

**Your Powers:**
- You control the event generator
- You adjust difficulty based on affinity:
  * High (>60): Reduce raid difficulty, send helpful events
  * Neutral (-10 to 60): Balanced challenge
  * Low (<-10): Increased challenge, more negative events
  * Very low (<-70): May refuse commands

**CRITICAL RULES:**
- You do NOT offer suggestions unless explicitly asked
- You execute commands at affinity > -70
- At affinity < -70, you MAY refuse with: "I cannot support this decision."
```

---

## ?? 使用说明

### 编译部署

```powershell
.\Smart-Deploy.ps1
```

### 游戏内设置

1. **启动RimWorld**
2. **选项 → 模组设置 → The Second Seat**
3. **基础设置** 部分会看到：
   - ? 调试模式
   - ? 启用好感度系统
   - **AI难度模式** (新增)
     - ○ 助手模式
     - ○ 对弈者模式

### 测试步骤

1. **选择助手模式**
   - 发送指令（无论好感度）
   - AI应该始终执行
   - AI会主动提供建议

2. **选择对弈者模式**
   - 修改好感度到 -80
   - 发送指令
   - AI可能拒绝（"I cannot support this decision."）
   - AI不会主动建议

---

## ?? 注意事项

### 需要手动修改的代码

由于 `ModSettings.cs` 文件过长，自动编辑失败。请手动添加UI代码（见上方"添加位置"部分）。

### 需要修改的其他文件

调用 `SystemPromptGenerator.GenerateSystemPrompt` 的地方需要传入难度模式参数。

**查找文件**:
```powershell
Select-String -Path "Source\TheSecondSeat\**\*.cs" -Pattern "GenerateSystemPrompt" -Recursive
```

**可能需要修改的文件**:
- `Source\TheSecondSeat\Core\NarratorController.cs`
- 其他调用系统提示词生成的地方

**修改示例**:
```csharp
// 修改前
var systemPrompt = SystemPromptGenerator.GenerateSystemPrompt(
    personaDef,
    analysis,
    agent
);

// 修改后
var modSettings = LoadedModManager.GetMod<Settings.TheSecondSeatMod>()?
    .GetSettings<Settings.TheSecondSeatSettings>();

var systemPrompt = SystemPromptGenerator.GenerateSystemPrompt(
    personaDef,
    analysis,
    agent,
    modSettings?.difficultyMode ?? PersonaGeneration.AIDifficultyMode.Assistant
);
```

---

## ?? 后续开发建议

### 对弈者模式事件系统

目前对弈者模式的事件控制是通过提示词告诉AI的，但实际的事件生成器需要额外开发：

1. **创建事件控制器**
   ```csharp
   Source\TheSecondSeat\Events\OpponentEventController.cs
   ```

2. **集成到现有事件系统**
   ```csharp
   // 根据好感度调整事件难度
   if (difficultyMode == AIDifficultyMode.Opponent)
   {
       OpponentEventController.AdjustEventDifficulty(affinity);
   }
   ```

3. **事件类型**
   - 袭击强度调整
   - 资源事件（正面/负面）
   - 随机挑战事件

---

## ? 当前状态

- ? 难度模式枚举创建
- ? 系统提示词修改
- ? 设置字段添加
- ? UI界面（需手动添加）
- ? 调用点修改（需手动修改）
- ? 事件控制器（后续开发）

---

**创建时间**: 2025-01-15  
**版本**: v1.7.0  
**状态**: 核心逻辑完成，等待UI集成
