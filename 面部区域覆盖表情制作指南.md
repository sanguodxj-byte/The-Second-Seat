# ?? 面部区域覆盖表情制作指南

## ?? 系统概述

这个方案让你可以**只制作面部表情区域**，系统会自动将其叠加到完整立绘上，无需每个表情都制作完整的512x512图片。

---

## ?? 两种表情模式对比

### 模式1：完整立绘替换（简单但占空间）

```
Cassandra.png           (512x512, 完整立绘, 200KB)
Cassandra_happy.png     (512x512, 完整立绘, 200KB)
Cassandra_sad.png       (512x512, 完整立绘, 200KB)
Cassandra_angry.png     (512x512, 完整立绘, 200KB)

总计：800KB (4个文件)
```

### 模式2：面部区域叠加（推荐，节省空间）?

```
Cassandra.png               (512x512, 完整立绘, 200KB)
Cassandra_happy_face.png    (256x256, 仅面部, 30KB)
Cassandra_sad_face.png      (256x256, 仅面部, 30KB)
Cassandra_angry_face.png    (256x256, 仅面部, 30KB)

总计：290KB (4个文件)
节省：63%空间！
```

---

## ?? 面部区域规格

### 标准配置

| 属性 | 值 | 说明 |
|-----|---|------|
| **面部纹理尺寸** | 256x256 | 推荐，也可以用512x512 |
| **覆盖区域** | 40% × 30% | 占完整立绘的百分比 |
| **中心位置** | (50%, 35%) | 水平居中，垂直偏上 |
| **羽化半径** | 5% | 边缘柔化，避免硬边 |
| **文件格式** | PNG (RGBA) | 必须支持透明通道 |

### 可视化示意

```
完整立绘 (512x512)
┌─────────────────────────────┐
│                             │ 
│         ┌──────┐            │ ← 面部区域 (40% × 30%)
│      XTTnTTTTTTnTT[         │    中心在 (256, 179)
│      U  │ ??? ??? │  U         │    尺寸 205×154 像素
│      U  │  ??  │  U         │
│      U  │  ??  │  U         │
│      ^TTnTTTTTTnTTa         │
│         └──────┘            │
│                             │
│    (身体和背景保持不变)      │
│                             │
└─────────────────────────────┘
```

---

## ??? Photoshop制作流程

### 步骤1：准备基础立绘

```
1. 打开你的完整立绘 (512x512)
2. 保存为 Cassandra.png
```

### 步骤2：创建面部区域选区

```
1. 使用选框工具（M）
2. 创建矩形选区，覆盖：
   - 眉毛
   - 眼睛
   - 鼻子
   - 嘴巴
   - 适当的周边区域

推荐尺寸：约 205×154 像素 (完整立绘的40%×30%)
```

### 步骤3：提取面部区域

```
1. 选中面部区域
2. Ctrl+J 复制为新图层
3. 隐藏其他图层
4. 图像 → 裁剪 → 裁剪到选区
5. 图像 → 画布大小 → 256×256 (居中)
```

### 步骤4：制作表情变体

```
1. 修改面部表情（眼睛、嘴巴、眉毛）
2. 确保背景透明
3. 文件 → 导出 → 快速导出为PNG
4. 保存为 Cassandra_happy_face.png
```

### 步骤5：批量制作其他表情

重复步骤4，创建：
- `Cassandra_sad_face.png`
- `Cassandra_angry_face.png`
- `Cassandra_surprised_face.png`
- 等等...

---

## ?? 文件命名规范

### 完整立绘替换模式

```
基础：Cassandra.png
表情：Cassandra_happy.png
     Cassandra_sad.png
     Cassandra_angry.png
```

### 面部叠加模式 ?

```
基础：Cassandra.png
面部：Cassandra_happy_face.png
     Cassandra_sad_face.png
     Cassandra_angry_face.png
```

**关键区别**：面部叠加模式的文件名有 `_face` 后缀！

---

## ?? 面部纹理制作要求

### ? 正确示例

```
面部纹理内容：
- ? 眼睛（完整）
- ? 眉毛（完整）
- ? 鼻子（完整）
- ? 嘴巴（完整）
- ? 周边皮肤（渐变到透明）
- ? 背景完全透明
```

### ? 错误示例

```
- ? 包含身体部分（肩膀、衣服）
- ? 背景不透明
- ? 边缘有硬边界
- ? 尺寸不是正方形
```

### Photoshop图层结构示例

```
Cassandra_happy_face.psd
├── 眉毛 (快乐表情)
├── 眼睛 (睁大、眼角上扬)
├── 鼻子 (可选，通常不变)
├── 嘴巴 (微笑)
├── 腮红 (可选)
└── 背景 (透明)
```

---

## ?? 自定义面部区域位置

### 默认配置

系统默认假设面部在：
- 水平：居中 (50%)
- 垂直：略偏上 (35%)
- 宽度：40%
- 高度：30%

### 为特定人格自定义

如果你的立绘构图不同，可以在代码中调整：

```csharp
// 在 PersonaFaceRegions.cs 的构造函数中添加
regions["MyCustomPersona"] = new FaceRegion
{
    CenterX = 0.5f,   // 水平位置 (0-1)
    CenterY = 0.30f,  // 垂直位置 (0-1, 0=顶部, 1=底部)
    Width = 0.45f,    // 宽度占比 (0-1)
    Height = 0.35f,   // 高度占比 (0-1)
    FeatherRadius = 0.06f  // 羽化半径 (0-1)
};
```

### 可视化调整工具

创建一个测试图层，显示面部区域范围：

```csharp
// 在Photoshop中绘制参考框
完整立绘尺寸：512×512
面部区域中心：(256, 179)  // 50%, 35%
面部区域尺寸：205×154     // 40%, 30%
左上角坐标：(154, 102)
右下角坐标：(359, 256)
```

---

## ?? 系统加载逻辑

### 加载顺序（优先级）

```
1. 尝试加载完整表情立绘
   - Cassandra_happy.png
   
2. 如果失败，尝试面部叠加模式
   - 加载 Cassandra.png (基础)
   - 加载 Cassandra_happy_face.png (面部)
   - 合成图片
   
3. 如果面部也失败，仅显示基础立绘
   - Cassandra.png
   
4. 如果基础立绘也不存在，显示占位符
```

### 缓存机制

```
系统会缓存：
- 基础立绘
- 完整表情立绘
- 合成后的表情立绘

避免重复加载和合成
```

---

## ??? 进阶技巧

### 技巧1：使用羽化蒙版

在Photoshop中创建柔和边缘：

```
1. 选中面部图层
2. 添加图层蒙版
3. 选择 渐变工具 (G)
4. 从中心向边缘拉径向渐变
5. 调整羽化强度
```

### 技巧2：保持一致的基准点

```
所有表情的面部区域应该：
- 眼睛位置一致
- 鼻子位置一致
- 嘴巴基准点一致

这样切换表情时不会"跳动"
```

### 技巧3：使用智能对象

```
1. 将基础立绘转为智能对象
2. 创建多个表情图层
3. 批量导出时切换图层可见性
```

### 技巧4：批量导出脚本

```javascript
// Photoshop脚本 - 批量导出面部表情
var doc = app.activeDocument;
var expressions = ["happy", "sad", "angry", "surprised"];
var baseName = "Cassandra";
var outputFolder = "~/Desktop/Faces/";

for (var i = 0; i < expressions.length; i++) {
    // 显示对应表情图层
    showLayer("表情/" + expressions[i]);
    
    // 裁剪到面部区域
    doc.crop([154, 102, 359, 256]);  // [x1, y1, x2, y2]
    
    // 调整画布到256x256
    doc.resizeCanvas(256, 256, AnchorPosition.MIDDLECENTER);
    
    // 导出
    var file = new File(outputFolder + baseName + "_" + expressions[i] + "_face.png");
    savePNG(file);
    
    // 撤销操作
    doc.activeHistoryState = doc.historyStates[doc.historyStates.length - 3];
    
    // 隐藏图层
    hideLayer("表情/" + expressions[i]);
}
```

---

## ?? 测试和验证

### 测试清单

- [ ] 基础立绘显示正常
- [ ] 表情文件命名正确（有 `_face` 后缀）
- [ ] 面部区域大小合适
- [ ] 面部位置对齐
- [ ] 边缘羽化自然
- [ ] 切换表情无闪烁
- [ ] 背景透明正确

### 常见问题

#### 问题1：面部位置偏移

**原因**：面部区域配置不正确

**解决**：
```csharp
// 调整 CenterX 和 CenterY
regions["YourPersona"].CenterX = 0.52f;  // 向右移动2%
regions["YourPersona"].CenterY = 0.33f;  // 向上移动2%
```

#### 问题2：边缘有硬边

**原因**：羽化半径太小或面部纹理边缘不透明

**解决**：
```csharp
regions["YourPersona"].FeatherRadius = 0.08f;  // 增加羽化
```

或在Photoshop中调整面部纹理的Alpha通道。

#### 问题3：表情不显示

**检查**：
```
1. 文件名是否正确（包含 _face 后缀）
2. 文件是否放在正确目录
3. 文件格式是否为PNG
4. 是否有透明通道
```

---

## ?? 性能对比

### 模式1（完整替换）

| 文件 | 大小 | 加载时间 |
|-----|------|---------|
| 基础 | 200KB | ~5ms |
| Happy | 200KB | ~5ms |
| Sad | 200KB | ~5ms |
| Angry | 200KB | ~5ms |
| **总计** | **800KB** | **20ms** |

### 模式2（面部叠加）

| 文件 | 大小 | 加载时间 | 合成时间 |
|-----|------|---------|---------|
| 基础 | 200KB | ~5ms | - |
| Happy面部 | 30KB | ~2ms | ~10ms |
| Sad面部 | 30KB | ~2ms | ~10ms |
| Angry面部 | 30KB | ~2ms | ~10ms |
| **总计** | **290KB** | **36ms** | - |

**结论**：
- 磁盘空间：节省 **63%**
- 首次加载：略慢（多了合成步骤）
- 后续切换：速度相同（都有缓存）

---

## ? 推荐工作流程

### 第一次制作（建议简单模式）

```
1. 使用完整立绘替换模式
2. 制作 3 个基础表情：
   - Cassandra.png
   - Cassandra_happy.png
   - Cassandra_sad.png
```

### 熟练后（切换到高效模式）

```
1. 切换到面部叠加模式
2. 制作更多表情：
   - Cassandra.png (保留)
   - Cassandra_happy_face.png (新建)
   - Cassandra_sad_face.png (新建)
   - Cassandra_angry_face.png (新建)
   - Cassandra_surprised_face.png (新建)
   - 等等...
```

---

## ?? 快速开始

### 最小化测试（3个文件）

```
Cassandra.png              (512x512, 完整立绘)
Cassandra_happy_face.png   (256x256, 仅笑脸)
Cassandra_sad_face.png     (256x256, 仅哭脸)
```

放入目录：
```
D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\
```

启动游戏测试！

---

## ?? 相关文档

- [立绘动态表情系统-完整指南.md](立绘动态表情系统-完整指南.md) - 表情系统总览
- [ExpressionSystem.cs](Source/TheSecondSeat/PersonaGeneration/ExpressionSystem.cs) - 表情触发逻辑
- [ExpressionCompositor.cs](Source/TheSecondSeat/PersonaGeneration/ExpressionCompositor.cs) - 面部合成技术

---

## ?? 总结

**面部区域覆盖模式的优势**：
- ? 节省磁盘空间（63%）
- ? 制作更快（只需画面部）
- ? 保持一致性（身体背景不变）
- ? 易于维护（修改一个表情不影响其他）

**适用场景**：
- ? 立绘数量多（5+个人格）
- ? 每个人格有多个表情（6+个）
- ? 磁盘空间有限
- ? 需要频繁调整表情

**不适用场景**：
- ? 只有1-2个人格
- ? 表情变化涉及全身（如姿势改变）
- ? 不熟悉Photoshop透明通道

选择最适合你的模式，享受动态表情带来的乐趣吧！??

---

**版本**：v1.0.0  
**作者**：The Second Seat Team  
**最后更新**：2025-01-XX
