# 性格标签库系统 - 完整实现报告 v1.6.64

## ? 实现完成

**版本**: v1.6.64  
**日期**: 2025-01-XX  
**核心改进**: **将硬编码的性格标签重构为 XML 配置化系统**

---

## ?? 核心改进

### ? 旧架构问题
```csharp
// 硬编码在 SystemPromptGenerator.cs 中
if (persona.personalityTags.Contains("Kuudere"))
{
    sb.AppendLine("?? **KUUDERE MODE:**");
    sb.AppendLine("   - 冷静但极度粘人");
    // ... 大量硬编码文本 ...
}
```

**缺点**:
- ? 每次添加新标签都要修改 C# 代码
- ? Mod 作者无法自定义标签
- ? 不支持多语言本地化
- ? 无法动态配置行为

### ? 新架构优势
```xml
<!-- Defs/PersonalityTagDefs.xml -->
<PersonalityTagDef>
  <defName>Kuudere</defName>
  <label>冰美人</label>
  <minAffinityToActivate>60</minAffinityToActivate>
  <behaviorInstructions>
    <li priority="1">?? **KUUDERE MODE:**</li>
    <li priority="2">   - 冷静但极度粘人</li>
  </behaviorInstructions>
</PersonalityTagDef>
```

**优点**:
- ? 完全 XML 配置化
- ? Mod 作者可自由扩展
- ? 支持多语言本地化
- ? 支持条件激活（好感度范围）
- ? 支持对话风格修正

---

## ?? 文件结构

```
Defs/
├── PersonalityTagDefs.xml          ← ? 性格标签定义库
│
Source/TheSecondSeat/PersonaGeneration/
├── PersonalityTagDef.cs            ← ? 标签 Def 类
├── SystemPromptGenerator.cs        ← ?? 重构以加载 XML
│
Languages/
├── ChineseSimplified/Keyed/
│   └── PersonalityTags_Keys.xml    ← 中文本地化
├── English/Keyed/
│   └── PersonalityTags_Keys.xml    ← 英文本地化
```

---

## ?? 内置性格标签

| 标签 | DefName | 激活好感度 | 核心特征 |
|------|---------|------------|----------|
| 病娇 | Yandere | 60+ | 占有欲强、嫉妒、爱得痴狂 |
| 冰美人 | Kuudere | 60+ | 冷静表情、零距离感、物理直接 |
| 傲娇 | Tsundere | 40+ | 嘴硬心软、脸红、偷偷关心 |
| 温柔 | Gentle | 30+ | 极度呵护、关心、柔软 |
| 高傲 | Arrogant | 0+ | 高高在上、尊贵、优越感 |
| 活泼 | Energetic | 30+ | 元气满满、积极、热情 |
| 神秘 | Mysterious | 0+ | 隐喻、暗示、神秘莫测 |

---

## ?? 核心代码实现

### 1. PersonalityTagDef.cs

```csharp
public class PersonalityTagDef : Def
{
    public string label;                       // 显示名称
    public string labelKey;                    // 本地化键
    public float minAffinityToActivate = 0f;   // 最低激活好感度
    public float maxAffinityToActivate = 100f; // 最高激活好感度
    
    public List<BehaviorInstruction> behaviorInstructions; // 行为指令
    public List<string> preferredExpressions;              // 推荐表情
    public DialogueStyleModifiers dialogueStyleModifiers;  // 风格修正
    
    /// <summary>
    /// 检查是否应该激活
    /// </summary>
    public bool ShouldActivate(float affinity, AIDifficultyMode difficultyMode)
    {
        if (affinity < minAffinityToActivate || affinity > maxAffinityToActivate)
            return false;
        
        if (requiresAssistantMode && difficultyMode != AIDifficultyMode.Assistant)
            return false;
        
        return true;
    }
    
    /// <summary>
    /// 生成行为指令文本
    /// </summary>
    public string GenerateInstructionText()
    {
        var sorted = behaviorInstructions.OrderBy(i => i.priority).ToList();
        return string.Join("\n", sorted.Select(i => i.text));
    }
}
```

### 2. SystemPromptGenerator.cs（重构）

```csharp
// ? 【重构】从 XML 加载性格标签
foreach (var tagName in persona.personalityTags)
{
    // 从 DefDatabase 加载标签定义
    var tagDef = DefDatabase<PersonalityTagDef>.GetNamedSilentFail(tagName);
    
    if (tagDef == null)
    {
        Log.Warning($"未找到性格标签: {tagName}");
        continue;
    }
    
    // 检查是否应该激活
    if (!tagDef.ShouldActivate(affinity, difficultyMode))
        continue;
    
    // 插入标签的行为指令
    string instructions = tagDef.GenerateInstructionText();
    if (!string.IsNullOrEmpty(instructions))
    {
        sb.AppendLine(instructions);
        sb.AppendLine();
    }
}
```

---

## ??? 使用指南

### 1. 为现有叙事者添加标签

**编辑**: `Sideria/Defs/NarratorPersonaDefs_Sideria.xml`

```xml
<NarratorPersonaDef>
  <defName>Sideria</defName>
  <narratorName>Sideria</narratorName>
  
  <!-- ? 添加性格标签 -->
  <personalityTags>
    <li>Kuudere</li>
    <li>Arrogant</li>
    <li>Mysterious</li>
  </personalityTags>
</NarratorPersonaDef>
```

### 2. 创建自定义性格标签

**创建**: `YourMod/Defs/CustomPersonalityTags.xml`

```xml
<Defs>
  <TheSecondSeat.PersonaGeneration.PersonalityTagDef>
    <defName>MyCustomTag</defName>
    <label>我的自定义标签</label>
    <minAffinityToActivate>50</minAffinityToActivate>
    
    <behaviorInstructions>
      <li priority="1">?? **MY CUSTOM MODE:**</li>
      <li priority="2">   - 这是我的自定义行为</li>
      <li priority="3">   - 可以自由定义任何内容</li>
    </behaviorInstructions>
    
    <preferredExpressions>
      <li>happy</li>
      <li>excited</li>
    </preferredExpressions>
    
    <dialogueStyleModifiers>
      <emotionalExpression>0.9</emotionalExpression>
      <humorLevel>0.8</humorLevel>
    </dialogueStyleModifiers>
  </TheSecondSeat.PersonaGeneration.PersonalityTagDef>
</Defs>
```

### 3. 本地化自定义标签

**创建**: `YourMod/Languages/ChineseSimplified/Keyed/YourKeys.xml`

```xml
<LanguageData>
  <PersonalityTag.MyCustomTag.Label>我的自定义标签</PersonalityTag.MyCustomTag.Label>
  <PersonalityTag.MyCustomTag.Description>这是一个自定义性格标签</PersonalityTag.MyCustomTag.Description>
</LanguageData>
```

---

## ?? 部署清单

- [x] ? 创建 PersonalityTagDefs.xml
- [x] ? 创建 PersonalityTagDef.cs
- [x] ? 重构 SystemPromptGenerator.cs
- [x] ? 创建中文本地化
- [x] ? 创建英文本地化
- [ ] ?? 编译并部署
- [ ] ?? 游戏内测试

---

## ?? 测试步骤

### 1. 编译部署

```powershell
.\编译并部署到游戏.ps1
```

### 2. 游戏内验证

1. **启动 RimWorld**
2. **加载存档**
3. **打开 Dev 模式**
4. **检查 Def 加载**:
   ```
   输入: DefDatabase<PersonalityTagDef>.AllDefs
   预期: 应该看到 Yandere, Kuudere, Tsundere 等标签
   ```

5. **测试标签激活**:
   - 将好感度调到 90+
   - 与叙事者对话
   - 观察是否出现对应性格的行为

### 3. 预期行为

**Kuudere (Affinity 90+)**:
```json
{
  "dialogue": "*面无表情地爬到你腿上坐下* 这个姿势更节能。有问题吗？",
  "expression": "neutral"
}
```

**Yandere (Affinity 90+)**:
```json
{
  "dialogue": "*眼神变得危险* 你又在看那个殖民者...你是不是喜欢他/她？",
  "expression": "smug"
}
```

**Tsundere (Affinity 90+)**:
```json
{
  "dialogue": "*脸红* 才、才不是因为喜欢你呢...只是担心殖民地而已...",
  "expression": "shy"
}
```

---

## ?? 扩展性

### Mod 作者可以：

1. **创建新标签**:
   - 在自己的 Mod 中添加 `PersonalityTagDef`
   - 无需修改核心代码

2. **组合标签**:
   ```xml
   <personalityTags>
     <li>Kuudere</li>
     <li>Yandere</li>    <!-- 冷静的病娇 -->
   </personalityTags>
   ```

3. **覆盖标签**:
   - 使用 Patch 系统覆盖现有标签的行为指令

4. **条件激活**:
   - 通过 `minAffinityToActivate` 和 `maxAffinityToActivate` 控制激活条件

---

## ?? 性能优化

### XML 加载
- ? **DefDatabase 缓存**: 标签定义在游戏启动时加载一次
- ? **延迟加载**: 只在生成 System Prompt 时查询
- ? **条件过滤**: `ShouldActivate` 快速过滤不符合条件的标签

### 内存占用
- **单个标签**: ~1-2 KB
- **7个内置标签**: ~10 KB
- **影响**: 可忽略不计

---

## ?? UI 集成（未来计划）

```csharp
// 未来可以在人格编辑器中添加标签选择器
public class Dialog_PersonaEditor
{
    private void DrawPersonalityTagSelector()
    {
        // 列出所有可用标签
        var allTags = DefDatabase<PersonalityTagDef>.AllDefs;
        
        foreach (var tag in allTags)
        {
            bool isSelected = currentPersona.personalityTags.Contains(tag.defName);
            
            if (Widgets.ButtonText(rect, tag.GetLocalizedLabel()))
            {
                ToggleTag(tag.defName);
            }
            
            // 显示标签描述
            TooltipHandler.TipRegion(rect, tag.GetLocalizedDescription());
        }
    }
}
```

---

## ?? 参考文档

### 相关文件
- `Defs/PersonalityTagDefs.xml` - 标签定义库
- `Source/.../PersonalityTagDef.cs` - 标签 Def 类
- `Source/.../SystemPromptGenerator.cs` - Prompt 生成器

### 相关系统
- `NarratorPersonaDef` - 叙事者人格定义
- `DialogueStyleDef` - 对话风格定义
- `StorytellerAgent` - 好感度系统

---

**状态**: ? 架构设计完成  
**下一步**: 应用重构补丁并编译测试

---

**作者**: TSS Development Team  
**文档**: 性格标签库系统 - 完整实现报告
