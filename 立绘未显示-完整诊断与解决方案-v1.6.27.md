# ?? 立绘未显示问题诊断与解决方案 v1.6.27

## ?? 问题总结

### ? 核心问题
**Sideria 立绘未显示**，原因是：
1. ? 文件夹结构已修复（嵌套 Textures 问题已解决）
2. ? **立绘PNG文件缺失** - Sideria 文件夹下只有空的子文件夹，没有实际图片文件
3. ?? 当前使用的是分层立绘系统，需要特定的PNG图层文件

---

## ?? 诊断结果

### 当前文件夹结构（已修复）
```
D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\
  └── UI\
      └── Narrators\
          └── 9x16\
              ├── Sideria\                 ? 位置正确（已从 Layered 移出）
              │   ├── Base\                ? 空文件夹
              │   ├── Eyes\                ? 空文件夹
              │   ├── Hair\                ? 空文件夹
              │   ├── Mouth\               ? 空文件夹
              │   └── Outfit\              ? 空文件夹
              │
              ├── Expressions\             ? 表情文件夹存在
              │   └── Sideria\
              │       ├── happy.png        ? 12个表情PNG文件
              │       ├── sad.png
              │       └── ...
              │
              └── Layered\                 ? 分层立绘文件夹（现在为空）
                  └── (可用于其他人格)
```

### 关键发现
- ? **嵌套Textures问题已修复**
- ? **Sideria文件夹位置正确**
- ? **表情文件存在**（12个PNG）
- ? **立绘图层文件完全缺失**

---

## ?? 您的选择：使用分层立绘系统

### 方案：全部使用分层立绘系统

#### 优点
- ? 高度灵活，支持独立更换眼睛、嘴巴、头发、服装
- ? 支持表情动画（眨眼、张嘴、呼吸）
- ? 节省内存和磁盘空间（共享基础图层）
- ? 易于扩展新表情和服装

#### 缺点
- ? 需要准备多个分离的PNG图层
- ? 初期制作工作量较大

---

## ?? 分层立绘系统完整实现方案

### 第一步：准备图层文件

#### 必需图层（放在 `Textures\UI\Narrators\9x16\Layered\Sideria\`）
```
Layered\Sideria\
  ├── body.png              ? 必需 - 身体/底层
  ├── neutral_eyes.png      ? 必需 - 中性表情眼睛
  ├── neutral_mouth.png     ? 必需 - 中性表情嘴巴
  ├── hair.png              ??  推荐 - 头发（前景）
  ├── background.png        ? 可选 - 背景层
  └── hair_back.png         ? 可选 - 后发（背景层）
```

#### 表情变体图层（可选）
```
Layered\Sideria\
  ├── happy_eyes.png        ? 开心的眼睛
  ├── happy_mouth.png       ? 开心的嘴巴
  ├── sad_eyes.png          ? 悲伤的眼睛
  ├── sad_mouth.png         ? 悲伤的嘴巴
  ├── angry_eyes.png        ? 生气的眼睛
  ├── angry_mouth.png       ? 生气的嘴巴
  └── ...
```

#### 动画帧图层（高级）
```
Layered\Sideria\
  ├── blink_half.png        ? 半闭眼（眨眼动画）
  ├── blink_closed.png      ? 闭眼（眨眼动画）
  ├── mouth_open.png        ? 张嘴（说话动画）
  ├── mouth_half_open.png   ? 半张嘴（说话动画）
  └── ...
```

---

### 第二步：配置 NarratorPersonaDef

在 `Defs\NarratorPersonaDefs.xml` 中添加：

```xml
<TheSecondSeat.PersonaGeneration.NarratorPersonaDef>
  <defName>Sideria</defName>
  <narratorName>Sideria</narratorName>
  <useLayeredPortrait>true</useLayeredPortrait>  <!-- ? 启用分层立绘 -->
  
  <!-- 分层配置 -->
  <layeredConfig>
    <layers>
      <li>
        <layerName>background</layerName>
        <zIndex>0</zIndex>
        <required>false</required>
      </li>
      <li>
        <layerName>body</layerName>
        <zIndex>10</zIndex>
        <required>true</required>
      </li>
      <li>
        <layerName>hair_back</layerName>
        <zIndex>15</zIndex>
        <required>false</required>
      </li>
      <li>
        <layerName>eyes</layerName>
        <zIndex>30</zIndex>
        <required>true</required>
        <dynamicExpression>true</dynamicExpression>  <!-- 根据表情动态选择 -->
      </li>
      <li>
        <layerName>mouth</layerName>
        <zIndex>35</zIndex>
        <required>true</required>
        <dynamicExpression>true</dynamicExpression>  <!-- 根据表情动态选择 -->
      </li>
      <li>
        <layerName>hair</layerName>
        <zIndex>50</zIndex>
        <required>false</required>
      </li>
    </layers>
  </layeredConfig>
</TheSecondSeat.PersonaGeneration.NarratorPersonaDef>
```

---

### 第三步：图层文件制作指南

#### 工具推荐
1. **Photoshop** / **GIMP** / **Krita**（免费）
2. **Live2D Cubism**（高级动画）

#### 制作流程

##### 1. 准备基础立绘
- 分辨率：**1080×1920** (9:16)
- 格式：**PNG 32位** (支持透明)
- 背景：**透明**

##### 2. 分离图层
将完整立绘拆分为以下图层：

| 图层 | 内容 | 透明区域 |
|------|------|----------|
| body.png | 身体、衣服、皮肤 | 头部以上透明 |
| neutral_eyes.png | 眼睛、眉毛 | 其他部分透明 |
| neutral_mouth.png | 嘴巴、嘴唇 | 其他部分透明 |
| hair.png | 头发（前景） | 脸部和身体透明 |
| background.png | 背景装饰 | 人物部分透明 |

##### 3. 对齐所有图层
- **所有PNG必须相同尺寸**（1080×1920）
- **相同坐标系统**（图层位置对齐）
- **使用图层蒙版**而不是裁剪

##### 4. 导出PNG
- 格式：PNG-32
- 透明背景：是
- 压缩：推荐 Zlib
- 文件名：严格按照上面的命名

---

### 第四步：测试与验证

#### 4.1 运行诊断脚本
```powershell
powershell -ExecutionPolicy Bypass -File "Diagnose-Layered-Portraits-v1.6.27.ps1"
```

#### 4.2 检查必需图层
确认以下文件存在：
```
? Layered\Sideria\body.png
? Layered\Sideria\neutral_eyes.png
? Layered\Sideria\neutral_mouth.png
```

#### 4.3 游戏内测试
1. 重启 RimWorld
2. 加载存档
3. 打开 AI 旁白按钮
4. 切换到"立绘模式"
5. 检查 Sideria 是否正确显示

---

## ?? 快速创建示例图层（临时测试）

如果您暂时没有图层文件，可以使用以下脚本生成测试用的占位符：

```powershell
# 创建测试图层占位符 v1.6.27
$layeredPath = "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\9x16\Layered\Sideria"

# 创建文件夹
New-Item -ItemType Directory -Path $layeredPath -Force | Out-Null

# 注意：以下只是示意，实际需要使用图像处理软件创建PNG
Write-Host "请使用图像编辑软件创建以下PNG文件:" -ForegroundColor Yellow
Write-Host ""
Write-Host "必需文件:" -ForegroundColor Red
Write-Host "  $layeredPath\body.png" -ForegroundColor Red
Write-Host "  $layeredPath\neutral_eyes.png" -ForegroundColor Red
Write-Host "  $layeredPath\neutral_mouth.png" -ForegroundColor Red
Write-Host ""
Write-Host "推荐文件:" -ForegroundColor Yellow
Write-Host "  $layeredPath\hair.png"
Write-Host "  $layeredPath\background.png"
Write-Host ""
Write-Host "表情变体（可选）:" -ForegroundColor Gray
Write-Host "  $layeredPath\happy_eyes.png"
Write-Host "  $layeredPath\happy_mouth.png"
Write-Host "  $layeredPath\sad_eyes.png"
Write-Host "  $layeredPath\sad_mouth.png"
```

---

## ?? 参考资源

### 相关文档
- `分层立绘系统-快速参考.md`
- `Textures\UI\Narrators\9x16\Layered\README.md`
- `LayeredPortraitCompositor.cs`

### 图层合成逻辑
```csharp
// LayeredPortraitCompositor.CompositeLayers()
// 图层叠加顺序（从底到顶）：
1. background.png        (Z-Index: 0)
2. body.png              (Z-Index: 10)
3. hair_back.png         (Z-Index: 15)
4. {expression}_eyes.png (Z-Index: 30)  // 根据当前表情动态选择
5. {expression}_mouth.png(Z-Index: 35)  // 根据当前表情动态选择
6. hair.png              (Z-Index: 50)
```

---

## ?? 常见问题

### Q1: 为什么必须使用分层系统？
**A**: 您已经选择使用分层立绘系统，它提供更好的灵活性和动画支持。

### Q2: 可以混合使用分层和整图吗？
**A**: 可以，每个人格可以独立选择：
- Sideria：分层立绘 (`useLayeredPortrait=true`)
- Cassandra：整图立绘 (`useLayeredPortrait=false`)

### Q3: 如何快速制作分层图层？
**A**: 
1. 使用 Photoshop 打开完整立绘
2. 选择 "图层" → "导出" → "快速导出为PNG"
3. 为每个部分（身体、眼睛、嘴巴）创建独立图层
4. 隐藏其他图层，只导出当前图层

### Q4: 图层文件太大怎么办？
**A**: 
- 使用在线工具压缩：https://tinypng.com/
- 或使用 `pngcrush` / `optipng`
- 目标大小：< 500KB/图层

---

## ?? 下一步行动

### 立即行动
1. ? 文件夹结构已修复
2. ? **准备图层PNG文件**（最重要）
3. ? 配置 `useLayeredPortrait=true`
4. ? 重启游戏测试

### 如果您需要帮助
- 提供现有的完整立绘图片
- 我可以指导如何拆分为图层
- 或者先使用测试用的简单图层验证系统工作正常

---

**版本**: v1.6.27  
**完成时间**: 2025-12-13  
**状态**: ?? 等待立绘PNG文件

?? **准备好图层文件后，立绘就能正常显示了！**
