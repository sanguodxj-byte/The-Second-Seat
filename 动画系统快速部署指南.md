# 动画系统快速部署指南 v1.6.14

## ?? 一键部署

### 基本用法

```powershell
# 在项目根目录执行
.\Deploy-Animation-System.ps1
```

### 自定义 RimWorld 路径

```powershell
.\Deploy-Animation-System.ps1 -RimWorldPath "E:\Games\RimWorld"
```

### 部署后自动启动游戏

```powershell
.\Deploy-Animation-System.ps1 -OpenGameAfter
```

### 跳过编译（调试用）

```powershell
.\Deploy-Animation-System.ps1 -SkipBuild
```

---

## ?? 部署步骤详解

### 步骤 1: 检查环境

脚本会自动检查：
- ? RimWorld 路径是否存在
- ? 项目文件是否存在
- ? Mod 目录是否存在（不存在会自动创建）

### 步骤 2: 编译项目

```powershell
dotnet build Source\TheSecondSeat\TheSecondSeat.csproj --configuration Release
```

**输出：**
- ? `Source\TheSecondSeat\bin\Release\net472\TheSecondSeat.dll`

### 步骤 3: 复制 DLL

**目标：** `RimWorld\Mods\TheSecondSeat\Assemblies\TheSecondSeat.dll`

### 步骤 4: 复制 Defs

**目标：** `RimWorld\Mods\TheSecondSeat\Defs\*`

**包含：**
- ? `NarratorPersonaDefs.xml`（包含动画路径配置）

### 步骤 5: 复制纹理

**目标：** `RimWorld\Mods\TheSecondSeat\Textures\*`

**包含：**
- ? `UI/Narrators/Avatars/Sideria/base.png`（必需）
- ? `UI/Narrators/Avatars/Sideria/blink.png`（可选）
- ? `UI/Narrators/Avatars/Sideria/speaking.png`（可选）

---

## ? 验证部署

### 自动验证

脚本会自动检查以下文件：

| 文件 | 状态 | 说明 |
|------|------|------|
| `Assemblies\TheSecondSeat.dll` | ? 必需 | 编译的 DLL |
| `Defs\NarratorPersonaDefs.xml` | ? 必需 | 人格定义 |
| `Textures\...\base.png` | ? 必需 | 基础立绘 |
| `Textures\...\blink.png` | ? 可选 | 眨眼纹理 |
| `Textures\...\speaking.png` | ? 可选 | 说话纹理 |

### 手动验证

```powershell
# 检查 DLL 是否存在
Test-Path "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Assemblies\TheSecondSeat.dll"

# 检查纹理
Test-Path "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\Avatars\Sideria\base.png"
```

---

## ?? 游戏内测试

### 测试清单

1. **启动游戏**
   - ? 确认 Mod 已加载
   - ? 无错误日志

2. **进入存档**
   - ? AI 按钮显示
   - ? 显示 `base.png` 中性表情

3. **测试眨眼**
   - ? 每 3-6 秒触发眨眼
   - ? 眨眼持续 0.15 秒
   - ? 自动恢复到 base.png

4. **测试语音同步**
   - ? 发送消息并播放 TTS
   - ? 播放时显示 speaking.png
   - ? 播放结束恢复 base.png

5. **测试优先级**
   - ? 说话时触发眨眼
   - ? 眨眼动画优先显示
   - ? 眨眼结束恢复说话动画

---

## ?? 常见问题

### 问题 1: 编译失败

**症状：**
```
error CS0234: The type or namespace name 'XXX' does not exist
```

**解决：**
1. 检查 NuGet 包是否安装
2. 清理并重新编译
   ```powershell
   dotnet clean
   dotnet build
   ```

### 问题 2: DLL 未复制

**症状：**
```
找不到 DLL 文件
```

**解决：**
1. 检查编译配置
   ```powershell
   .\Deploy-Animation-System.ps1 -Configuration Debug
   ```
2. 手动复制
   ```powershell
   Copy-Item "Source\TheSecondSeat\bin\Release\net472\TheSecondSeat.dll" `
       "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Assemblies\"
   ```

### 问题 3: 纹理未显示

**症状：**
- 显示灰色占位符

**解决：**
1. 检查纹理路径
   ```powershell
   Get-ChildItem "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\Avatars\Sideria\"
   ```

2. 确认 XML 配置
   ```xml
   <portraitPath>UI/Narrators/Avatars/Sideria/base</portraitPath>
   ```

### 问题 4: 眨眼不工作

**症状：**
- 没有眨眼动画

**原因：**
- `blink.png` 缺失（可选文件）

**解决：**
1. 制作 `blink.png`（基于 `base.png`，闭眼）
2. 或接受回退行为（使用 `base.png`）

---

## ?? 部署检查清单

### 编译前

- [ ] 确认项目文件存在
- [ ] 确认 NuGet 包已安装
- [ ] 确认 RimWorld 路径正确

### 编译后

- [ ] DLL 文件生成成功
- [ ] 文件大小合理（约 500KB-2MB）
- [ ] 无编译错误

### 部署后

- [ ] DLL 已复制到 Assemblies
- [ ] Defs 已复制
- [ ] Textures 已复制
- [ ] base.png 存在

### 游戏测试

- [ ] Mod 加载成功
- [ ] AI 按钮显示
- [ ] base.png 正确显示
- [ ] 眨眼动画工作（可选）
- [ ] 语音同步工作（可选）

---

## ?? 快速命令参考

### 完整部署

```powershell
# 编译 + 复制 + 验证
.\Deploy-Animation-System.ps1
```

### 编译并启动游戏

```powershell
.\Deploy-Animation-System.ps1 -OpenGameAfter
```

### 跳过编译（仅复制）

```powershell
.\Deploy-Animation-System.ps1 -SkipBuild
```

### 自定义路径

```powershell
.\Deploy-Animation-System.ps1 -RimWorldPath "E:\Games\RimWorld"
```

### Debug 配置

```powershell
.\Deploy-Animation-System.ps1 -Configuration Debug
```

---

## ?? 部署日志

脚本会输出详细日志：

```
=== 步骤 1/5: 检查环境 ===
? RimWorld 路径存在
? 项目文件存在
? Mod 目录存在

=== 步骤 2/5: 编译项目 ===
? 编译成功

=== 步骤 3/5: 复制 DLL ===
? DLL 已复制到: ...
? DLL 大小: 1234.56 KB

=== 步骤 4/5: 复制 Defs ===
? Defs 已复制: 15 个 XML 文件

=== 步骤 5/5: 复制纹理文件 ===
? 纹理已复制: 42 个文件

=== 验证部署 ===
? 存在: Assemblies\TheSecondSeat.dll
? 存在: Defs\NarratorPersonaDefs.xml
? 存在: Textures\...\base.png
? 缺失（可选）: Textures\...\blink.png
? 缺失（可选）: Textures\...\speaking.png

=== 部署总结 ===
? 部署完成！所有必需文件已就位

=== 下一步 ===
1. 启动 RimWorld
2. 确认 Mod 已加载
3. 进入游戏测试
```

---

## ?? 更新流程

### 代码更新后

```powershell
# 1. 重新编译和部署
.\Deploy-Animation-System.ps1

# 2. 重启游戏
# 3. 测试新功能
```

### 纹理更新后

```powershell
# 只复制纹理（跳过编译）
.\Deploy-Animation-System.ps1 -SkipBuild
```

---

**部署指南完成！** ?  
**版本：** v1.6.14  
**状态：** 可以开始部署

现在可以运行：
```powershell
.\Deploy-Animation-System.ps1 -OpenGameAfter
```

_The Second Seat Mod Team_
