# 纹理加载静默回退 - 快速参考 v1.6.18

## ?? 核心原则

**静默回退** = **不刷屏日志** + **自动尝试所有路径** + **只在完全失败时警告**

---

## ?? 回退流程

### **完整回退链（7层）**

```
1. 具体变体表情 (happy3.png)           ← 最优先
   ↓ 失败（静默）
2. 通用表情 (happy.png)                 ← 第1层回退
   ↓ 失败（静默）
3. 变体面部叠加 (happy3_face + base)    ← 第2层回退
   ↓ 失败（静默）
4. 通用面部叠加 (happy_face + base)     ← 第3层回退
   ↓ 失败（静默）
5. 基础立绘 (base.png/neutral.png)     ← 第4层回退
   ↓ 失败（静默）
6. 立绘裁剪为头像                       ← 第5层回退
   ↓ 失败（静默）
7. 占位符生成                           ← 最终兜底
   ? 始终成功
```

---

## ?? 日志输出策略

### **正常模式（默认）**
```
? 成功加载：无日志
? 中间失败：无日志
?? 完全失败：1条简短警告
```

**示例（完全失败）：**
```
[PortraitLoader] 立绘加载失败: Sideria（已尝试所有路径）
```

### **DevMode（开发者模式）**
```
? 成功加载：显示成功路径
? 中间失败：无日志
?? 完全失败：显示详细路径列表
```

**示例（DevMode 成功）：**
```
[PortraitLoader] ========== 立绘加载诊断 ==========
[PortraitLoader] defName: Sideria_Default
[PortraitLoader] narratorName: Sideria
[PortraitLoader] ? 路径1成功: UI/Narrators/9x16/Sideria/base
```

**示例（DevMode 失败）：**
```
[PortraitLoader] 立绘加载失败: UnknownPersona（已尝试所有路径）
[PortraitLoader] 请确保以下路径之一存在纹理文件:
[PortraitLoader]   - Textures/UI/Narrators/9x16/UnknownPersona/base.png
[PortraitLoader]   - Textures/UI/Narrators/9x16/UnknownPersona.png
[PortraitLoader]   - Textures/UI/HeroArt/UnknownPersona.png
```

---

## ?? 效果对比

| 场景 | 优化前 | 优化后 | 减少比例 |
|------|--------|--------|---------|
| 成功加载 | 3-5 条日志 | 0 条 | 100% ↓ |
| 回退成功 | 5-8 条日志 | 0 条 | 100% ↓ |
| 完全失败 | 15+ 条日志 | 1 条 | 93% ↓ |

---

## ??? 使用方法

### **正常使用（无需改动）**
```csharp
// 自动应用静默回退机制
var portrait = PortraitLoader.LoadPortrait(def, ExpressionType.Happy);
var avatar = AvatarLoader.LoadAvatar(def, ExpressionType.Happy);
```

### **启用 DevMode 诊断**
```
游戏内按 F12（或 Ctrl+F12）开启 DevMode
然后查看日志会显示详细加载过程
```

---

## ?? 文件路径优先级

### **表情加载顺序**
```
1. Textures/UI/Narrators/9x16/Expressions/{PersonaName}/happy3.png
2. Textures/UI/Narrators/9x16/Expressions/{PersonaName}/happy.png
3. Textures/UI/Narrators/9x16/Expressions/{PersonaName}/happy3_face.png + base.png
4. Textures/UI/Narrators/9x16/Expressions/{PersonaName}/happy_face.png + base.png
```

### **基础立绘加载顺序**
```
1. Textures/UI/Narrators/9x16/{PersonaName}/base.png
2. Textures/UI/Narrators/9x16/{PersonaName}.png
3. Textures/{def.portraitPath}
4. Textures/{def.customPortraitPath}
5. Textures/UI/HeroArt/{PersonaName}.png
```

### **头像加载顺序**
```
1. Textures/UI/Narrators/Avatars/{PersonaName}/happy3.png
2. Textures/UI/Narrators/Avatars/{PersonaName}/happy.png
3. Textures/UI/Narrators/Avatars/{PersonaName}/base.png
4. Textures/UI/Narrators/Avatars/{PersonaName}/neutral.png
5. 从立绘裁剪
6. 占位符
```

---

## ?? 故障排查

### **Q: 为什么我看不到任何日志？**
**A:** 这是正常的！静默回退机制会自动尝试所有路径，只在完全失败时才警告。

### **Q: 如何查看详细加载过程？**
**A:** 启用 DevMode（F12），然后重新加载即可看到详细诊断信息。

### **Q: 如何确认文件是否加载成功？**
**A:** 
1. 如果看到立绘显示，说明加载成功
2. 如果看到占位符（渐变色），说明所有路径失败
3. DevMode 下会显示成功的路径

### **Q: 表情变体没有生效？**
**A:** 检查文件命名：
- ? 正确：`happy3.png`（小写，数字在最后）
- ? 错误：`Happy3.png`（大写）
- ? 错误：`happy_3.png`（有下划线）

---

## ?? 相关文档

- [纹理加载静默回退机制-完成总结-v1.6.18.md](纹理加载静默回退机制-完成总结-v1.6.18.md)
- [表情和分层立绘文件夹-快速参考-v1.6.18.md](表情和分层立绘文件夹-快速参考-v1.6.18.md)
- [Expressions/README.md](Textures/UI/Narrators/9x16/Expressions/README.md)
- [Layered/README.md](Textures/UI/Narrators/9x16/Layered/README.md)

---

## ?? 关键要点

1. **静默回退** - 中间失败不输出日志
2. **完整尝试** - 自动尝试所有7层路径
3. **DevMode 友好** - 开发者仍可查看详情
4. **用户体验** - 不再被日志刷屏

---

**版本：** v1.6.18-silent-fallback  
**状态：** ? 已完成并推送  
**Commit:** 2cc1e22
