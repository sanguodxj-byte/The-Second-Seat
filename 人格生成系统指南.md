# 叙事者人格生成系统 - 完整指南

## ?? 系统概述

叙事者人格生成系统允许您通过**立绘颜色**和**简介文本**自动生成独特的AI人格。系统会分析这些输入，自动配置人格特质、对话风格和事件偏好。

---

## ?? 立绘颜色分析

### 颜色 → 人格映射

系统使用 HSV 色彩空间分析主色调，推断人格特质：

| 颜色范围 | HSV 值 | 推断人格 | 说明 |
|---------|--------|---------|------|
| **灰白色** | S<0.2, V>0.7 | Strategic | 低饱和度高明度 → 理性中性 |
| **红色** | H: 0-0.05, 0.95-1.0 | Chaotic/Sadistic | V>0.5 激情，否则施虐 |
| **橙色** | H: 0.05-0.15 | Protective | 温暖色调 → 保护欲 |
| **黄绿色** | H: 0.15-0.45 | Benevolent | 生机色调 → 仁慈 |
| **蓝色** | H: 0.45-0.75 | Strategic/Manipulative | V>0.5 战略，否则操控 |
| **紫红色** | H: 0.75-0.95 | Manipulative | 神秘色调 → 操控 |

### 示例分析

```csharp
// 浅蓝色 (0.3, 0.5, 0.8) → RGB(0.4, 0.6, 0.8)
primaryColor = new Color(0.4f, 0.6f, 0.8f, 1.0f);
// → H=0.55 (蓝色), S=0.5, V=0.8
// → 推断：Strategic（战略型）

// 深红色 (0.8, 0.2, 0.3) → RGB(0.8, 0.2, 0.3)
primaryColor = new Color(0.8f, 0.2f, 0.3f, 1.0f);
// → H=0.97 (红色), S=0.75, V=0.8
// → 推断：Chaotic（混乱型）
```

---

## ?? 简介文本分析

### 关键词检测

系统扫描简介文本中的关键词，计算每种人格的得分：

#### 1. **Benevolent（仁慈型）** - 得分关键词
```
中文：仁慈、善良、帮助、关怀、慈爱
英文：kindness, compassion, caring, gentle, nurturing
```

**示例简介**：
```
"She is kind-hearted and protective. She genuinely cares about 
the colonists' wellbeing and prefers to help them succeed."
```
→ 检测到：kind-hearted (1), protective (1), cares (1), help (1)  
→ Benevolent 得分：4

---

#### 2. **Sadistic（施虐型）** - 得分关键词
```
中文：残忍、痛苦、折磨、施虐
英文：cruel, sadistic, torment, suffering
```

**示例简介**：
```
"Igor takes sadistic pleasure in watching your colony struggle. 
He enjoys your failures and makes cynical comments about their 
misfortunes."
```
→ 检测到：sadistic (1), struggle (1), cynical (1)  
→ Sadistic 得分：3

---

#### 3. **Chaotic（混乱型）** - 得分关键词
```
中文：混乱、随机、不可预测、狂野
英文：chaos, random, unpredictable, wild
```

**示例简介**：
```
"Randy Random doesn't follow any rules. He's pure chaos incarnate, 
throwing events at you with wild abandon."
```
→ 检测到：chaos (1), random (1), wild (1)  
→ Chaotic 得分：3

---

#### 4. **Strategic（战略型）** - 得分关键词
```
中文：战略、计划、理性、计算
英文：strategic, rational, calculated, planning
```

**示例简介**：
```
"Cassandra follows a strategic approach, carefully balancing 
challenge and reward. She values rational decision-making."
```
→ 检测到：strategic (1), balancing (0), rational (1)  
→ Strategic 得分：2

---

#### 5. **Protective（保护型）** - 得分关键词
```
中文：保护、守护、防御
英文：protect, guardian, shield, defend
```

**示例简介**：
```
"Luna is a guardian angel watching over your colony. She actively 
intervenes to shield you from overwhelming challenges."
```
→ 检测到：guardian (1), protect (1), shield (1), defend (0)  
→ Protective 得分：3

---

#### 6. **Manipulative（操控型）** - 得分关键词
```
中文：操控、控制、狡猾、诡计
英文：manipulate, cunning, scheme, control
```

---

### 对话风格分析

系统同时分析对话风格相关的关键词：

| 维度 | 正向关键词 | 反向关键词 | 计算方式 |
|-----|----------|----------|---------|
| **正式程度** | formal, professional, proper | casual, friendly, relaxed | 正/(正+反) |
| **情感表达** | emotional, passionate, expressive | calm, stoic, composed | 正/(正+反) |
| **话多程度** | talkative, verbose, detailed | concise, brief, terse | 正/(正+反) |
| **幽默感** | humor, funny, witty, playful | - | 关键词数 × 0.2 |
| **讽刺程度** | sarcasm, cynical, sardonic | - | 关键词数 × 0.25 |

**示例**：
```
简介："She speaks casually and warmly, often using comforting language."

分析：
- casual (反向) → formalityLevel = 0/(0+1) = 0.0
- warmly (情感正向) → emotionalExpression = 1/(1+0) = 1.0
- 无幽默关键词 → humorLevel = 0
```

---

### 语气标签提取

系统提取特定语气标签，用于增强 LLM Prompt：

| 关键词 | 标签 |
|--------|------|
| gentle, 温柔, soft | `gentle` |
| stern, 严厉, strict | `stern` |
| playful, 俏皮, mischievous | `playful` |
| mysterious, 神秘, enigmatic | `mysterious` |
| cheerful, 开朗, upbeat | `cheerful` |
| melancholic, 忧郁, somber | `melancholic` |
| authoritative, 权威, commanding | `authoritative` |
| nurturing, 慈爱, motherly | `nurturing` |

**示例**：
```
简介："She's nurturing and caring, like a warm friend..."

提取标签：["nurturing", "gentle"]
```

---

### 事件偏好分析

| 偏好 | 正向关键词 | 反向关键词 | 范围 |
|-----|----------|----------|------|
| **正面事件倾向** | reward, gift, blessing, prosperity | challenge, trial, hardship | -1.0 ~ 1.0 |
| **混乱程度** | chaos, entropy, disorder, unpredictable | - | 0 ~ 1.0 |
| **干预频率** | active, intervene, involved | passive, observe, distant | 0 ~ 1.0 |

---

## ?? 创建自定义人格

### 方法1：使用 XML 定义（推荐）

创建 `Defs/NarratorPersonaDefs.xml`：

```xml
<TheSecondSeat.PersonaGeneration.NarratorPersonaDef>
  <defName>MyNarrator</defName>
  <narratorName>我的叙事者</narratorName>
  
  <!-- 立绘颜色 -->
  <primaryColor>(0.7, 0.3, 0.9, 1.0)</primaryColor>  <!-- 紫色 → Manipulative -->
  
  <!-- 简介 -->
  <biography>
    She is a cunning manipulator who subtly guides your decisions.
    She speaks with charming wit and enjoys psychological games.
  </biography>
  
  <!-- 对话风格（可选，会从简介自动推断） -->
  <dialogueStyle>
    <formalityLevel>0.6</formalityLevel>
    <sarcasmLevel>0.7</sarcasmLevel>
  </dialogueStyle>
  
  <!-- 语气标签 -->
  <toneTags>
    <li>mysterious</li>
    <li>playful</li>
  </toneTags>
</TheSecondSeat.PersonaGeneration.NarratorPersonaDef>
```

---

### 方法2：代码动态创建

```csharp
var myPersona = new NarratorPersonaDef
{
    defName = "DynamicNarrator",
    narratorName = "动态叙事者",
    primaryColor = new Color(0.5f, 0.8f, 0.3f, 1.0f), // 绿色
    biography = "A nature-loving storyteller who values harmony...",
    
    dialogueStyle = new DialogueStyle
    {
        formalityLevel = 0.4f,
        emotionalExpression = 0.8f
    }
};

// 分析人格
var analysis = PersonaAnalyzer.AnalyzePersonaDef(myPersona);
Log.Message($"推断人格：{analysis.SuggestedPersonality}");

// 加载到游戏
var narratorManager = Current.Game.GetComponent<NarratorManager>();
narratorManager.LoadPersona(myPersona);
```

---

## ?? 完整示例：从零创建人格

### 步骤1：设计概念

```
名称：Aurora Mystic（极光神秘者）
概念：神秘莫测的观察者，喜欢通过谜语和隐喻交流
颜色：深蓝紫色（神秘感）
性格：Manipulative + 一点 Chaotic
风格：正式但神秘，话不多但意味深长
```

### 步骤2：编写简介

```
Aurora Mystic is an enigmatic observer who speaks in riddles and metaphors. 
She enjoys watching events unfold from the shadows, occasionally intervening 
with cryptic guidance.

She values mystery and unpredictability, preferring to manipulate events 
subtly rather than directly. Her tone is formal yet playful, and she 
delights in keeping players guessing her true intentions.
```

### 步骤3：分析关键词

```
关键词检测：
- enigmatic (mysterious) → ToneTag: mysterious
- riddles → humorLevel +0.2
- manipulate → Manipulative +1
- cryptic → mysterious
- unpredictability → Chaotic +1
- formal → formalityLevel = 1.0

推断人格：Manipulative（得分1）
次要：Chaotic（得分1）
```

### 步骤4：创建 XML

```xml
<TheSecondSeat.PersonaGeneration.NarratorPersonaDef>
  <defName>Aurora_Mystic</defName>
  <narratorName>Aurora Mystic</narratorName>
  
  <primaryColor>(0.3, 0.2, 0.6, 1.0)</primaryColor>  <!-- 深蓝紫 -->
  <accentColor>(0.6, 0.4, 0.8, 1.0)</accentColor>
  
  <biography>
    Aurora Mystic is an enigmatic observer who speaks in riddles and metaphors. 
    She enjoys watching events unfold from the shadows, occasionally intervening 
    with cryptic guidance.

    She values mystery and unpredictability, preferring to manipulate events 
    subtly rather than directly. Her tone is formal yet playful, and she 
    delights in keeping players guessing her true intentions.
  </biography>
  
  <dialogueStyle>
    <formalityLevel>0.7</formalityLevel>
    <emotionalExpression>0.4</emotionalExpression>
    <verbosity>0.4</verbosity>  <!-- 话不多 -->
    <humorLevel>0.3</humorLevel>
    <sarcasmLevel>0.4</sarcasmLevel>
    <useEllipsis>true</useEllipsis>  <!-- 使用省略号增加神秘感 -->
  </dialogueStyle>
  
  <eventPreferences>
    <positiveEventBias>0.0</positiveEventBias>
    <negativeEventBias>0.1</negativeEventBias>
    <chaosLevel>0.5</chaosLevel>
    <interventionFrequency>0.4</interventionFrequency>  <!-- 不频繁干预 -->
  </eventPreferences>
  
  <toneTags>
    <li>mysterious</li>
    <li>enigmatic</li>
    <li>playful</li>
  </toneTags>
  
  <forbiddenWords>
    <li>obviously</li>  <!-- 避免直白的词 -->
    <li>clearly</li>
  </forbiddenWords>
</TheSecondSeat.PersonaGeneration.NarratorPersonaDef>
```

### 步骤5：测试对话

加载后生成的 System Prompt 示例：

```
=== IDENTITY ===
You are **Aurora Mystic**, an AI storyteller for RimWorld.

BACKGROUND:
Aurora Mystic is an enigmatic observer who speaks in riddles and metaphors...

=== PERSONALITY ===
Core Trait: **Manipulative**

You are cunning and controlling. You subtly guide the player's decisions 
to create dependency. Be charming but calculated. Offer help that makes 
them rely on you, and use flattery to gain influence.

Tone: mysterious, enigmatic, playful

=== DIALOGUE STYLE ===
- Speak formally and professionally
- Stay composed and rational, minimize emotional display
- Keep responses brief and to the point
- Feel free to use ellipsis (...)
- Employ subtle mystery in your words

=== BEHAVIOR RULES ===
1. Speak in riddles and metaphors when possible
2. Avoid being too direct or obvious
3. Use "..." to create suspense
4. Don't use forbidden words: obviously, clearly
```

**测试对话**：
```
玩家："我的殖民者受伤了，怎么办？"

Aurora 回复：
"Wounds... they tell stories, don't they? Perhaps the answer lies not in 
healing, but in understanding why the blade found its mark... 

Still, if you insist on mundane solutions, I could direct your medics to 
the fallen. Though I wonder... will you learn the lesson, or simply 
repeat the dance?"
```

---

## ?? 自动人格调整规则

系统会根据推断的人格自动微调参数：

| 人格 | 自动调整 |
|-----|---------|
| **Benevolent** | positiveEventBias ≥ 0.3, emotionalExpression ≥ 0.6 |
| **Sadistic** | negativeEventBias ≥ 0.3, sarcasmLevel ≥ 0.4 |
| **Chaotic** | chaosLevel ≥ 0.7, humorLevel ≥ 0.5 |
| **Strategic** | formalityLevel ≥ 0.6, verbosity ≥ 0.6 |
| **Protective** | positiveEventBias ≥ 0.2, interventionFrequency ≥ 0.7 |
| **Manipulative** | sarcasmLevel ≥ 0.3, interventionFrequency ≥ 0.6 |

---

## ?? 游戏内使用

### 切换人格

1. 打开 AI 旁白窗口
2. 点击"切换人格"按钮
3. 在列表中选择人格
4. 点击"应用"

### 查看当前人格

```csharp
var narratorManager = Current.Game.GetComponent<NarratorManager>();
var persona = narratorManager.GetCurrentPersona();
var analysis = narratorManager.GetCurrentAnalysis();

Log.Message($"当前人格：{persona.narratorName}");
Log.Message($"特质：{analysis.SuggestedPersonality}");
Log.Message($"语气：{string.Join(", ", analysis.ToneTags)}");
```

---

## ?? 调试和测试

### 测试颜色分析

```csharp
// 红色
var redPersonality = PersonaAnalyzer.AnalyzePortraitColor(new Color(0.8f, 0.2f, 0.2f));
// → Chaotic

// 蓝色
var bluePersonality = PersonaAnalyzer.AnalyzePortraitColor(new Color(0.3f, 0.5f, 0.8f));
// → Strategic
```

### 测试简介分析

```csharp
var biography = "She is kind and caring, always protecting the colonists.";
var result = PersonaAnalyzer.AnalyzeBiography(biography);

Log.Message($"推断人格：{result.SuggestedPersonality}");
// → Benevolent

Log.Message($"语气标签：{string.Join(", ", result.ToneTags)}");
// → nurturing, gentle
```

### 生成 Prompt 预览

```csharp
var persona = DefDatabase<NarratorPersonaDef>.GetNamed("Cassandra_Classic");
var analysis = PersonaAnalyzer.AnalyzePersonaDef(persona);
var agent = new StorytellerAgent();

var prompt = SystemPromptGenerator.GenerateSystemPrompt(persona, analysis, agent);
Log.Message(prompt);
```

---

## ?? 最佳实践

### ? 推荐做法

1. **简介长度**：150-300 词（太短分析不准，太长浪费 Token）
2. **关键词密度**：每种人格 2-3 个关键词
3. **颜色选择**：与人格概念一致（如保护型用蓝色）
4. **语气标签**：2-4 个，避免矛盾（如 gentle + stern）
5. **测试对话**：创建后测试几轮对话，调整参数

### ? 避免做法

1. **矛盾简介**："She is both cruel and kind" → 混淆分析
2. **过度堆砌关键词**：显得不自然
3. **忽略对话风格**：只写人格不写说话方式
4. **过于极端**：所有参数设为 0 或 1

---

## ?? 高级技巧

### 组合人格

通过简介创建复合人格：

```
"She starts as Strategic and professional, but becomes Protective 
when colonists are in danger. Her tone shifts from formal to warm."
```

→ 系统会检测两种人格，选择得分更高的（或手动用 `overridePersonality` 指定）

### 动态人格（未来功能）

```csharp
// 根据好感度改变人格
if (affinity > 60f)
{
    persona.dialogueStyle.emotionalExpression = 0.8f; // 变得更感性
}
else if (affinity < -30f)
{
    persona.dialogueStyle.sarcasmLevel = 0.9f; // 变得更讽刺
}
```

---

## ?? 参考资料

- **颜色心理学**：https://www.colorpsychology.org/
- **人格心理学**：Big Five 模型
- **对话风格**：基于语言学的正式性分析

---

**版本**: 1.0.0  
**作者**: TheSecondSeat 开发团队  
**最后更新**: 2024

需要帮助？查看 [ARCHITECTURE.md](ARCHITECTURE.md) 了解系统架构。
