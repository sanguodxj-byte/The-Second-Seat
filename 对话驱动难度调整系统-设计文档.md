# ?? 对话和好感度驱动的动态难度调整系统 - 设计文档

## 核心理念

不创建新事件，而是通过分析玩家对话和好感度，**动态调整原版事件的触发概率和强度**。

---

## ?? 系统架构

### 1. 对话分析 → 2. 好感度评估 → 3. 难度调整 → 4. 事件权重修改

```
玩家对话频率、内容
      ↓
DialogueAnalyzer 分析参与度和情感
      ↓
评估好感度变化趋势
      ↓
DifficultyModulator 计算难度系数
      ↓
调整事件池权重（正面↑ 负面↓ 或相反）
      ↓
原版事件系统使用修改后的权重
```

---

## ?? 调整策略

### 好感度高（≥60）+ 玩家活跃
**效果**: 降低难度，增加奖励
- ? **负面事件**：袭击点数 -30%，疾病概率 -40%
- ? **正面事件**：贸易商队频率 +50%，资源空投 +30%
- ? **中性事件**：保持不变

### 好感度低（≤-30）+ 玩家冷淡
**效果**: 增加难度，减少奖励
- ?? **负面事件**：袭击点数 +20%，灾难频率 +30%
- ?? **正面事件**：贸易商队频率 -30%，资源空投 -50%

### 玩家长时间未对话（48h+）
**效果**: 温和提醒，不惩罚
- ?? 发送信件："好久不见，需要帮助吗？"
- ?? 下次袭击强度 -10%（给予缓冲）

### 玩家非常活跃 + 好感度上升
**效果**: 短期奖励
- ?? 触发一次贸易商队或资源空投
- ?? 发送祝贺信件

---

## ?? 实现细节

### 1. **DialogueAnalyzer**（已实现）
- 分析对话频率、情感趋势、参与度
- 输出：`DialogueAnalysisResult`

### 2. **DifficultyModulator**（新增）
- 根据分析结果计算难度系数
- 方法：
  - `GetRaidPointsMultiplier()` → 0.7 ~ 1.3
  - `GetPositiveEventWeightMultiplier()` → 0.5 ~ 1.5
  - `GetNegativeEventWeightMultiplier()` → 0.5 ~ 1.3

### 3. **事件拦截器**（Harmony Patch）
- 拦截原版事件生成
- 修改事件参数（points, weight）
- 保持原版逻辑不变

---

## ?? 难度系数计算公式

### 袭击点数调整
```csharp
float basePoints = incidentParms.points;
float affinityFactor = (affinity + 100f) / 200f; // 0~1

// 好感度高 → 降低难度
if (affinity > 60f)
{
    incidentParms.points *= 0.7f; // -30%
}
// 好感度低 → 增加难度
else if (affinity < -30f)
{
    incidentParms.points *= 1.2f; // +20%
}
```

### 事件权重调整
```csharp
float GetEventWeightMultiplier(IncidentDef incident, StorytellerAgent agent)
{
    bool isPositive = IsPositiveEvent(incident);
    float multiplier = 1f;
    
    // 基于好感度
    if (agent.affinity > 60f)
    {
        multiplier *= isPositive ? 1.5f : 0.7f; // 正面↑ 负面↓
    }
    else if (agent.affinity < -30f)
    {
        multiplier *= isPositive ? 0.7f : 1.3f; // 正面↓ 负面↑
    }
    
    // 基于参与度
    var analysis = DialogueAnalyzer.AnalyzeDialogueHistory(agent);
    if (analysis.engagementLevel == PlayerEngagement.VeryActive)
    {
        multiplier *= 1.2f; // 活跃玩家获得更多事件
    }
    
    return multiplier;
}
```

---

## ?? 具体调整规则

### 规则 1：好感度友好 + 活跃玩家
**条件**: `affinity >= 60 && engagementLevel >= Active`

**调整**:
- 袭击点数：`×0.7`（-30%）
- 疾病发生率：`×0.6`（-40%）
- 贸易商队频率：`×1.5`（+50%）
- 资源空投概率：`×1.3`（+30%）

**消息**: "看到你这么努力，我会适当减轻困难~"

---

### 规则 2：好感度敌对 + 冷淡玩家
**条件**: `affinity <= -30 && engagementLevel <= Low`

**调整**:
- 袭击点数：`×1.2`（+20%）
- 灾难频率：`×1.3`（+30%）
- 贸易商队频率：`×0.7`（-30%）
- 资源空投概率：`×0.5`（-50%）

**消息**: "既然你不重视我们的关系，那就自己面对困难吧。"

---

### 规则 3：玩家长时间未对话
**条件**: `hoursSinceLastConversation > 48`

**调整**:
- 下次袭击点数：`×0.9`（-10%缓冲）
- 发送提醒信件

**消息**: "我们已经 48 小时没有交流了，你还好吗？"

---

### 规则 4：好感度快速上升
**条件**: `emotionalTrend == Improving && affinity > 40`

**调整**:
- 触发一次贸易商队
- 或触发资源空投

**消息**: "你的积极态度让我很开心，这是我的一点心意~"

---

### 规则 5：好感度下降但仍友好
**条件**: `emotionalTrend == Declining && affinity > 0`

**调整**:
- 暂时保护：负面事件 `×0.8`（-20%）
- 发送支持信件

**消息**: "我注意到你似乎遇到了困难，让我帮你一下。"

---

## ??? 技术实现

### Harmony Patch：拦截事件生成

```csharp
[HarmonyPatch(typeof(IncidentWorker), "TryExecute")]
class Patch_IncidentWorker_TryExecute
{
    static void Prefix(IncidentParms parms, ref bool __result)
    {
        var agent = GetStorytellerAgent();
        if (agent == null) return;
        
        // 调整事件强度
        DifficultyModulator.AdjustIncidentParams(parms, agent);
    }
}

[HarmonyPatch(typeof(StorytellerComp), "IncidentChanceFinal")]
class Patch_StorytellerComp_IncidentChanceFinal
{
    static void Postfix(IncidentDef def, ref float __result)
    {
        var agent = GetStorytellerAgent();
        if (agent == null) return;
        
        // 调整事件权重
        __result *= DifficultyModulator.GetEventWeightMultiplier(def, agent);
    }
}
```

### DifficultyModulator 类

```csharp
public static class DifficultyModulator
{
    /// <summary>
    /// 调整事件参数（点数、强度）
    /// </summary>
    public static void AdjustIncidentParams(IncidentParms parms, StorytellerAgent agent)
    {
        var analysis = DialogueAnalyzer.AnalyzeDialogueHistory(agent);
        
        // 获取难度系数
        float multiplier = GetDifficultyMultiplier(agent, analysis, parms.incidentDef);
        
        // 应用调整
        parms.points *= multiplier;
        
        Log.Message($"[DifficultyModulator] 事件 {parms.incidentDef?.defName} 点数调整：×{multiplier:F2}");
    }
    
    /// <summary>
    /// 调整事件权重
    /// </summary>
    public static float GetEventWeightMultiplier(IncidentDef incident, StorytellerAgent agent)
    {
        var analysis = DialogueAnalyzer.AnalyzeDialogueHistory(agent);
        bool isPositive = IsPositiveEvent(incident);
        
        float multiplier = 1f;
        
        // 基于好感度
        if (agent.affinity > 60f)
        {
            multiplier *= isPositive ? 1.5f : 0.7f;
        }
        else if (agent.affinity < -30f)
        {
            multiplier *= isPositive ? 0.7f : 1.3f;
        }
        
        // 基于参与度
        if (analysis.engagementLevel == PlayerEngagement.VeryActive)
        {
            multiplier *= 1.2f;
        }
        else if (analysis.engagementLevel == PlayerEngagement.Absent)
        {
            multiplier *= 0.8f; // 减少事件频率
        }
        
        return multiplier;
    }
    
    /// <summary>
    /// 判断是否为正面事件
    /// </summary>
    private static bool IsPositiveEvent(IncidentDef incident)
    {
        // 正面事件
        if (incident == IncidentDefOf.TraderCaravanArrival ||
            incident == IncidentDefOf.WandererJoin ||
            incident.defName.Contains("ResourcePod"))
        {
            return true;
        }
        
        // 负面事件
        if (incident == IncidentDefOf.RaidEnemy ||
            incident == IncidentDefOf.ToxicFallout ||
            incident.category == IncidentCategoryDefOf.ThreatBig)
        {
            return false;
        }
        
        // 默认中性
        return false;
    }
}
```

---

## ?? 效果示例

### 场景 1：友好AI + 活跃玩家

**状态**:
- 好感度：75
- 对话频率：每小时 3 次
- 情感趋势：Improving

**结果**:
- 下次袭击：500 点 → 350 点（-30%）
- 贸易商队出现概率：+50%
- 资源空投概率：+30%

**玩家体验**: 游戏难度降低，获得更多支持

---

### 场景 2：敌对AI + 冷淡玩家

**状态**:
- 好感度：-40
- 对话频率：每 48 小时 1 次
- 情感趋势：Declining

**结果**:
- 下次袭击：500 点 → 600 点（+20%）
- 贸易商队出现概率：-30%
- 资源空投概率：-50%

**玩家体验**: 游戏难度增加，挑战更大

---

### 场景 3：长时间未对话

**状态**:
- 72 小时未对话

**结果**:
- 发送提醒信件
- 下次袭击：-10%（给予缓冲）

**玩家体验**: AI 主动关心，不惩罚

---

## ? 优势

1. **不破坏原版平衡**: 只调整参数，不创建新事件
2. **动态响应**: 根据玩家行为实时调整
3. **情感沉浸**: AI 的态度影响游戏体验
4. **可控范围**: 调整幅度有上下限（±50%）

---

## ?? 下一步实现

1. 创建 `DifficultyModulator.cs`
2. 添加 Harmony Patch 拦截事件
3. 集成到 `NarratorController`
4. 测试各种好感度下的效果
5. 平衡调整系数

---

**版本**: v1.6.0  
**状态**: 设计阶段  
**优先级**: 高
