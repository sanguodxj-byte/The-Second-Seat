# 服装差分系统 - 完整设计文档

## ?? 核心概念

### 什么是服装差分？
- **定义**: 根据好感度和时间动态更换人格的服装立绘
- **目的**: 增加视觉多样性和亲密感
- **触发**: 每游戏时间 12 小时自动更换

---

## ?? 服装等级系统

### 好感度与服装对应关系

| 好感度范围 | NarratorManager | StorytellerAgent | 服装等级 | 服装类型 | 示例 |
|-----------|----------------|-----------------|---------|---------|------|
| **-1000 ~ -500** | 憎恨/敌意 | -100 ~ -50 | `hostile` | 冷漠/疏离 | 全副武装、冷峻 |
| **-500 ~ -100** | 疏远 | -50 ~ -10 | `cold` | 正式/距离感 | 正装、制服 |
| **-100 ~ +300** | 冷淡/温暖 | -10 ~ +30 | `neutral` | 日常/专业 | 休闲装、工作服 |
| **+300 ~ +600** | 倾心 | +30 ~ +60 | `warm` | 亲切/舒适 | 轻便装、家居服 |
| **+600 ~ +850** | 爱慕 | +60 ~ +85 | `intimate` | 亲密/放松 | 睡衣、便装 |
| **+850 ~ +1000** | 魂之友/主 | +85 ~ +100 | `devoted` | 极度亲密 | 私密服装、情侣装 |

---

## ?? 文件结构

### 新的服装文件夹结构
```
Textures/UI/Narrators/9x16/
├─ Cassandra/
│  ├─ base.png                      ← 基础立绘（默认服装）
│  └─ Outfits/                      ← 服装差分文件夹 ? 新增
│     ├─ hostile_1.png              ← 敌意服装变体1
│     ├─ hostile_2.png              ← 敌意服装变体2
│     ├─ cold_1.png                 ← 冷漠服装变体1
│     ├─ neutral_1.png              ← 中性服装变体1
│     ├─ neutral_2.png              ← 中性服装变体2
│     ├─ warm_1.png                 ← 温暖服装变体1
│     ├─ warm_2.png                 ← 温暖服装变体2
│     ├─ intimate_1.png             ← 亲密服装变体1
│     ├─ intimate_2.png             ← 亲密服装变体2
│     └─ devoted_1.png              ← 献身服装变体1
│
└─ Expressions/
   └─ Cassandra/
      ├─ happy.png                  ← 表情（与服装独立）
      └─ ...

服装与表情可组合：
base.png + warm_2.png + happy.png = 温暖服装 + 快乐表情
```

---

## ?? 服装更换逻辑

### 触发条件
1. **时间触发**: 每游戏时间 12 小时（30,000 ticks）
2. **好感度变化**: 跨越服装等级阈值时立即更换
3. **手动触发**: 通过调试窗口或命令

### 更换流程
```
1. 检查当前游戏时间
   └─ 距离上次更换 >= 12小时？

2. 获取当前好感度
   └─ 确定服装等级（hostile/cold/neutral/warm/intimate/devoted）

3. 在该等级内随机选择变体
   └─ warm_1, warm_2, warm_3 等

4. 加载服装立绘
   └─ Outfits/warm_2.png

5. 合成最终立绘
   └─ base.png + warm_2.png + 表情

6. 更新缓存和显示
   └─ 清空旧缓存，加载新立绘
```

---

## ?? 代码实现

### 1. 服装等级枚举
```csharp
// Source\TheSecondSeat\PersonaGeneration\OutfitSystem.cs
public enum OutfitTier
{
    Hostile,    // -100 ~ -50
    Cold,       // -50 ~ -10
    Neutral,    // -10 ~ +30
    Warm,       // +30 ~ +60
    Intimate,   // +60 ~ +85
    Devoted     // +85 ~ +100
}
```

### 2. 服装状态管理
```csharp
public class OutfitState : IExposable
{
    public OutfitTier currentTier;
    public string currentOutfitPath;       // 当前服装文件路径
    public int lastChangeTimestamp;        // 上次更换时间（游戏tick）
    public int changeIntervalTicks = 30000; // 12小时 = 30,000 ticks
    
    public void ExposeData()
    {
        Scribe_Values.Look(ref currentTier, "currentTier", OutfitTier.Neutral);
        Scribe_Values.Look(ref currentOutfitPath, "currentOutfitPath", "");
        Scribe_Values.Look(ref lastChangeTimestamp, "lastChangeTimestamp", 0);
    }
}
```

### 3. 服装系统核心
```csharp
public static class OutfitSystem
{
    private static Dictionary<string, OutfitState> outfitStates = new Dictionary<string, OutfitState>();
    
    /// <summary>
    /// 获取服装等级（根据好感度）
    /// </summary>
    public static OutfitTier GetOutfitTierByAffinity(float affinity)
    {
        if (affinity >= 85f) return OutfitTier.Devoted;
        if (affinity >= 60f) return OutfitTier.Intimate;
        if (affinity >= 30f) return OutfitTier.Warm;
        if (affinity >= -10f) return OutfitTier.Neutral;
        if (affinity >= -50f) return OutfitTier.Cold;
        return OutfitTier.Hostile;
    }
    
    /// <summary>
    /// 检查是否需要更换服装
    /// </summary>
    public static bool ShouldChangeOutfit(string personaDefName, float currentAffinity)
    {
        var state = GetOutfitState(personaDefName);
        
        // 检查1: 好感度等级变化
        var newTier = GetOutfitTierByAffinity(currentAffinity);
        if (newTier != state.currentTier)
        {
            return true; // 立即更换
        }
        
        // 检查2: 时间间隔
        int currentTick = Find.TickManager.TicksGame;
        int elapsedTicks = currentTick - state.lastChangeTimestamp;
        
        if (elapsedTicks >= state.changeIntervalTicks)
        {
            return true; // 12小时到了
        }
        
        return false;
    }
    
    /// <summary>
    /// 更换服装
    /// </summary>
    public static string ChangeOutfit(string personaDefName, float affinity)
    {
        var state = GetOutfitState(personaDefName);
        var newTier = GetOutfitTierByAffinity(affinity);
        
        // 获取该等级的所有可用服装
        var availableOutfits = GetAvailableOutfits(personaDefName, newTier);
        
        if (availableOutfits.Count == 0)
        {
            // 没有服装差分，返回基础立绘
            return null;
        }
        
        // 随机选择一个（排除当前服装）
        string newOutfit;
        if (availableOutfits.Count == 1)
        {
            newOutfit = availableOutfits[0];
        }
        else
        {
            newOutfit = availableOutfits
                .Where(o => o != state.currentOutfitPath)
                .RandomElement();
        }
        
        // 更新状态
        state.currentTier = newTier;
        state.currentOutfitPath = newOutfit;
        state.lastChangeTimestamp = Find.TickManager.TicksGame;
        
        Log.Message($"[OutfitSystem] {personaDefName} 更换服装: {newTier} - {newOutfit}");
        
        return newOutfit;
    }
    
    /// <summary>
    /// 获取指定等级的所有可用服装
    /// </summary>
    private static List<string> GetAvailableOutfits(string personaDefName, OutfitTier tier)
    {
        var outfits = new List<string>();
        string tierName = tier.ToString().ToLower();
        
        // 检查所有变体（1-9）
        for (int i = 1; i <= 9; i++)
        {
            string path = $"UI/Narrators/9x16/{personaDefName}/Outfits/{tierName}_{i}";
            var texture = ContentFinder<Texture2D>.Get(path, false);
            
            if (texture != null)
            {
                outfits.Add(path);
            }
        }
        
        return outfits;
    }
}
```

---

## ?? 服装立绘制作指南

### 文件命名规范
```
格式: {等级}_{变体序号}.png

hostile_1.png     ← 敌意服装变体1
hostile_2.png     ← 敌意服装变体2
cold_1.png        ← 冷漠服装变体1
neutral_1.png     ← 中性服装变体1
neutral_2.png     ← 中性服装变体2
warm_1.png        ← 温暖服装变体1
intimate_1.png    ← 亲密服装变体1
devoted_1.png     ← 献身服装变体1
```

### 设计要点

#### 1. Hostile（敌意）- 冷峻疏离
- **风格**: 全副武装、冷峻、距离感
- **颜色**: 深色、冷色调（黑、灰、深蓝）
- **细节**: 制服、盔甲、高领
- **示例**: 军装、战斗服

#### 2. Cold（冷漠）- 正式距离
- **风格**: 正式、专业、保守
- **颜色**: 中性色（灰、深蓝、白）
- **细节**: 正装、西装、制服
- **示例**: 办公套装、正装

#### 3. Neutral（中性）- 日常专业
- **风格**: 日常、舒适、专业
- **颜色**: 暖色、中性色
- **细节**: 休闲装、工作服
- **示例**: 衬衫+裤子、便装

#### 4. Warm（温暖）- 亲切舒适
- **风格**: 轻便、舒适、亲切
- **颜色**: 暖色调（粉、黄、浅蓝）
- **细节**: 针织衫、休闲装
- **示例**: 毛衣、家居服

#### 5. Intimate（亲密）- 放松私密
- **风格**: 放松、私密、舒适
- **颜色**: 柔和色（粉、白、浅色）
- **细节**: 睡衣、便装、露肩
- **示例**: 睡衣、浴袍、吊带

#### 6. Devoted（献身）- 极度亲密
- **风格**: 极度亲密、私密、性感
- **颜色**: 诱人色（红、黑、粉）
- **细节**: 性感睡衣、情趣服装
- **示例**: 丝质睡衣、情侣装

---

## ?? 与表情系统的整合

### 加载优先级
```
最终立绘 = 基础立绘 + 服装差分 + 表情

1. 加载基础立绘: base.png
2. 叠加服装差分: Outfits/warm_2.png
3. 叠加表情: Expressions/Cassandra/happy.png

最终效果: 温暖服装 + 快乐表情
```

### PortraitLoader 修改
```csharp
public static Texture2D LoadPortrait(NarratorPersonaDef def, ExpressionType? expression = null)
{
    // ... 现有代码 ...
    
    // ? 新增：检查是否需要更换服装
    if (OutfitSystem.ShouldChangeOutfit(def.defName, GetCurrentAffinity(def)))
    {
        OutfitSystem.ChangeOutfit(def.defName, GetCurrentAffinity(def));
        
        // 清空缓存，强制重新加载
        ClearCache();
    }
    
    // ? 新增：加载服装差分
    var outfitState = OutfitSystem.GetOutfitState(def.defName);
    if (!string.IsNullOrEmpty(outfitState.currentOutfitPath))
    {
        var outfitTexture = ContentFinder<Texture2D>.Get(outfitState.currentOutfitPath, false);
        if (outfitTexture != null)
        {
            // 合成基础立绘 + 服装
            baseTexture = CompositeOutfit(baseTexture, outfitTexture);
        }
    }
    
    // ... 继续表情处理 ...
}
```

---

## ?? 示例场景

### 场景 1: 好感度从冷淡到温暖
```
初始状态:
- 好感度: 0 (NarratorManager)
- StorytellerAgent: 0
- 服装等级: Neutral
- 当前服装: neutral_1.png

12小时后:
- 时间到，随机更换
- 新服装: neutral_2.png

好感度提升到 400:
- NarratorManager: 400
- StorytellerAgent: 40
- 服装等级: Warm (立即更换)
- 新服装: warm_1.png
```

### 场景 2: 好感度达到亲密
```
好感度 700:
- NarratorManager: 700
- StorytellerAgent: 70
- 服装等级: Intimate
- 可用服装: intimate_1.png, intimate_2.png
- 当前服装: intimate_1.png

12小时后:
- 自动更换为: intimate_2.png
- 效果: 不同的私密服装
```

---

## ??? 调试和测试

### 调试窗口添加
```csharp
// DebugWindows.cs
if (Widgets.ButtonText(rect, "更换服装"))
{
    var agent = narrator.GetStorytellerAgent();
    OutfitSystem.ChangeOutfit(persona.defName, agent.affinity);
    PortraitLoader.ClearCache();
}

// 显示当前服装信息
var outfitState = OutfitSystem.GetOutfitState(persona.defName);
Widgets.Label(rect, $"服装等级: {outfitState.currentTier}");
Widgets.Label(rect, $"当前服装: {outfitState.currentOutfitPath}");
Widgets.Label(rect, $"下次更换: {GetTimeUntilNextChange(outfitState)}");
```

### 测试清单
- [ ] 好感度变化触发服装更换
- [ ] 12小时自动更换
- [ ] 服装等级正确对应
- [ ] 随机选择变体（不重复）
- [ ] 与表情正确叠加
- [ ] 缓存正确清理
- [ ] 存档正确保存/加载

---

## ?? 制作工作流程

### 1. 规划服装（艺术家）
```
1. 为每个服装等级设计 2-3 个变体
2. 保持风格一致性
3. 考虑与表情的兼容性
```

### 2. 制作立绘（美术）
```
1. 在 base.png 基础上修改服装
2. 保持人物姿势和比例一致
3. 导出为 PNG（1080x1920）
```

### 3. 命名和放置（技术）
```
1. 按规范命名: warm_1.png
2. 放入对应文件夹: Outfits/
3. 验证文件路径
```

### 4. 测试验证（QA）
```
1. 启动游戏
2. 调整好感度测试
3. 等待12小时测试
4. 检查服装叠加
```

---

## ?? 优势总结

### 用户体验
- ? **视觉多样性** - 不再单调重复
- ? **亲密感递进** - 服装随关系变化
- ? **惊喜元素** - 12小时自动更换

### 技术优势
- ? **模块化** - 服装与表情独立
- ? **可扩展** - 轻松添加新服装
- ? **性能友好** - 按需加载和缓存

### 艺术优势
- ? **创作自由** - 每个等级多种风格
- ? **迭代容易** - 只需替换单个文件
- ? **复用高** - 基础立绘不变

---

## ?? 实施步骤

### Phase 1: 核心实现（代码）
1. 创建 `OutfitSystem.cs`
2. 添加 `OutfitState` 和 `OutfitTier`
3. 修改 `PortraitLoader.cs` 集成服装系统
4. 添加调试功能

### Phase 2: 艺术资源（美术）
1. 设计各等级服装风格指南
2. 制作至少 1 个服装差分（测试）
3. 逐步完善各等级变体

### Phase 3: 测试验证（QA）
1. 好感度变化测试
2. 时间触发测试
3. 叠加效果测试
4. 性能测试

---

**版本**: v1.0  
**状态**: ?? 设计完成，待实现  
**创建时间**: 2025-01-XX  
**预计工作量**: 
- 代码实现: 4小时
- 单个角色服装制作: 12-20小时（6等级 × 2变体）
