# ?? The Second Seat - 头像与表情系统完整指南

## ?? 目录

1. [系统概述](#系统概述)
2. [文件结构](#文件结构)
3. [立绘放置规范](#立绘放置规范)
4. [表情系统](#表情系统)
5. [服装差分系统](#服装差分系统)
6. [UI 按钮头像](#ui-按钮头像)
7. [文件命名规范](#文件命名规范)
8. [故障排查](#故障排查)

---

## 系统概述

The Second Seat 支持完整的动态头像和表情系统：

### ? 核心功能

1. **动态头像**
   - 主界面 AI 按钮显示当前人格头像
   - 头像随表情系统实时变化
   - 支持 9:16 竖屏比例立绘

2. **表情系统**
   - 10 种表情类型（中性、开心、悲伤等）
   - 根据好感度/事件自动切换
   - 支持完整立绘或面部覆盖两种模式

3. **服装差分**
   - 根据好感度等级自动更换服装
   - 支持多套服装配置
   - 与表情系统完美融合

4. **自动合成**
   - 头部（表情）+ 身体（服装）自动分割合成
   - 从脖子位置智能分割
   - 无需手动处理分层

---

## 文件结构

```
Textures/UI/Narrators/9x16/
├── {PersonaDefName}/                    # 人格文件夹
│   ├── base.png                         # ? 基础立绘（必需）
│   ├── Outfits/                         # 服装差分文件夹
│   │   ├── neutral_1.png                # 冷淡等级服装
│   │   ├── warm_1.png                   # 温暖等级服装
│   │   ├── intimate_1.png               # 亲密等级服装
│   │   └── devoted_1.png                # 倾心等级服装
│   └── README.md                        # 人格说明文档
│
└── Expressions/                          # ? 表情文件夹（新）
    └── {PersonaDefName}/                 # 人格名称
        ├── _happy.png                    # 开心表情（完整立绘）
        ├── _sad.png                      # 悲伤表情
        ├── _angry.png                    # 愤怒表情
        ├── _surprised.png                # 惊讶表情
        ├── _worried.png                  # 担忧表情
        ├── _smug.png                     # 得意表情
        ├── _disappointed.png             # 失望表情
        ├── _thoughtful.png               # 沉思表情
        └── _annoyed.png                  # 烦躁表情
```

### 示例：Sideria 人格

```
Textures/UI/Narrators/9x16/
├── Sideria/
│   ├── base.png                         # 基础立绘
│   └── Outfits/
│       ├── neutral_1.png
│       ├── warm_1.png
│       ├── intimate_1.png
│       └── devoted_1.png
│
└── Expressions/
    └── Sideria/
        ├── _happy.png                    # 开心
        ├── _sad.png                      # 悲伤
        ├── _angry.png                    # 愤怒
        ├── _surprised.png                # 惊讶
        ├── _thoughtful.png               # 沉思
        └── _annoyed.png                  # 烦躁
```

---

## 立绘放置规范

### 1. 基础立绘（必需）

**位置**：`Textures/UI/Narrators/9x16/{PersonaDefName}/base.png`

**要求**：
- ? **文件名**：必须是 `base.png`（小写）
- ? **尺寸**：推荐 1080x1920（9:16 竖屏）
- ? **格式**：PNG 格式，支持透明通道
- ? **内容**：完整的角色立绘，中性表情

**示例**：
```
Textures/UI/Narrators/9x16/Sideria/base.png
```

### 2. 人格定义文件

**位置**：`Defs/NarratorPersonaDefs/{PersonaName}.xml`

**配置示例**：
```xml
<?xml version="1.0" encoding="utf-8"?>
<Defs>
  <TheSecondSeat.PersonaGeneration.NarratorPersonaDef>
    <defName>Sideria_Default</defName>
    <label>Sideria</label>
    <narratorName>Sideria</narratorName>
    
    <!-- ? 立绘路径：指向 9x16 目录中的 base.png -->
    <portraitPath>UI/Narrators/9x16/Sideria/base</portraitPath>
    
    <!-- 主色调和强调色 -->
    <primaryColor>(0.60, 0.70, 0.90, 1.00)</primaryColor>
    <accentColor>(0.40, 0.60, 0.80, 1.00)</accentColor>
    
    <biography>...</biography>
  </TheSecondSeat.PersonaGeneration.NarratorPersonaDef>
</Defs>
```

**关键字段**：
- `defName`：人格标识符（如 `Sideria_Default`）
- `narratorName`：显示名称（如 `Sideria`）
- `portraitPath`：立绘路径（**不含扩展名**）

---

## 表情系统

### 表情类型列表

| 表情类型 | 文件名后缀 | 触发场景 | 示例文件 |
|---------|-----------|---------|---------|
| **Neutral** | （无） | 默认状态 | `base.png` |
| **Happy** | `_happy` | 殖民地繁荣、胜利 | `_happy.png` |
| **Sad** | `_sad` | 殖民者死亡、失败 | `_sad.png` |
| **Angry** | `_angry` | 被攻击、损失惨重 | `_angry.png` |
| **Surprised** | `_surprised` | 意外事件 | `_surprised.png` |
| **Worried** | `_worried` | 危险预警 | `_worried.png` |
| **Smug** | `_smug` | 大胜、预料之中 | `_smug.png` |
| **Disappointed** | `_disappointed` | 任务失败 | `_disappointed.png` |
| **Thoughtful** | `_thoughtful` | 战略决策 | `_thoughtful.png` |
| **Annoyed** | `_annoyed` | 频繁请求、烦躁 | `_annoyed.png` |

### 表情文件放置

**位置**：`Textures/UI/Narrators/9x16/Expressions/{PersonaDefName}/{后缀}.png`

**示例**：
```
Textures/UI/Narrators/9x16/Expressions/Sideria/_happy.png
Textures/UI/Narrators/9x16/Expressions/Sideria/_sad.png
Textures/UI/Narrators/9x16/Expressions/Sideria/_angry.png
```

### 表情立绘制作指南

#### 方式 1：完整立绘替换（推荐）

**优点**：
- 简单直接，无需复杂处理
- 表情和身体姿态可以自由搭配

**制作步骤**：
1. 复制 `base.png` 作为模板
2. 修改面部表情
3. 可选：调整身体姿态/手势
4. 导出为对应的文件名（如 `_happy.png`）
5. 放置到 `Expressions/{PersonaDefName}/` 文件夹

**文件要求**：
- 尺寸与 `base.png` 相同
- 保持透明通道
- 完整的立绘内容

#### 方式 2：面部覆盖层（高级）

**优点**：
- 文件体积小
- 共享身体部分，节省空间

**制作步骤**：
1. 只绘制面部区域（透明背景）
2. 文件名添加 `_face` 后缀
3. 配置面部区域坐标

**示例**：
```
Expressions/Sideria/_happy_face.png  # 只包含开心的面部
```

**面部区域配置**（高级用户）：
```csharp
PersonaFaceRegions.RegisterFaceRegion("Sideria_Default", new Rect(
    x: 300,      // 面部区域左上角 X 坐标
    y: 200,      // 面部区域左上角 Y 坐标
    width: 480,  // 面部宽度
    height: 600  // 面部高度
));
```

### 表情自动切换规则

```
好感度范围         →  表情
≥ 80              →  Happy (开心)
60-80             →  Neutral (中性)
40-60             →  Thoughtful (沉思)
20-40             →  Disappointed (失望)
0-20              →  Annoyed (烦躁)
< 0               →  Angry (愤怒)

特殊事件          →  表情
殖民者死亡         →  Sad (悲伤)
袭击来临          →  Worried (担忧)
大胜利            →  Smug (得意)
意外事件          →  Surprised (惊讶)
```

---

## 服装差分系统

### 服装等级与好感度对应

| 好感度范围 | 等级名称 | 服装文件 | 说明 |
|-----------|---------|---------|------|
| -1000 ~ -100 | 冷淡 | `neutral_1.png` | 基础服装 |
| -100 ~ 300 | 温暖 | `warm_1.png` | 稍微亲近 |
| 300 ~ 600 | 亲密 | `intimate_1.png` | 更加亲近 |
| 600 ~ 1000 | 倾心/爱慕/魂之友 | `devoted_1.png` | 特殊服装 |

### 服装文件放置

**位置**：`Textures/UI/Narrators/9x16/{PersonaDefName}/Outfits/{文件名}.png`

**示例**：
```
Textures/UI/Narrators/9x16/Sideria/Outfits/neutral_1.png
Textures/UI/Narrators/9x16/Sideria/Outfits/warm_1.png
Textures/UI/Narrators/9x16/Sideria/Outfits/intimate_1.png
Textures/UI/Narrators/9x16/Sideria/Outfits/devoted_1.png
```

### 服装立绘制作指南

**推荐方式：完整立绘**

1. 复制 `base.png` 作为模板
2. 修改服装部分（保持脸部不变）
3. 保存为对应等级的文件名
4. 放置到 `Outfits/` 文件夹

**文件要求**：
- ? 与 `base.png` 相同尺寸
- ? 保持透明通道
- ? 建议只修改服装，脸部保持一致
- ? 系统会自动合成表情 + 服装

### 自动合成原理

```
加载顺序：
1. 加载基础立绘 (base.png)
2. 加载表情立绘 (Expressions/{PersonaDefName}/_happy.png)
3. 加载服装立绘 (Outfits/warm_1.png)

自动分割：
1. 从脖子位置（约 1/3 高度）分割表情立绘 → 头部
2. 从同样位置分割服装立绘 → 身体
3. 合成：头部（表情）+ 身体（服装）
```

---

## UI 按钮头像

### 功能说明

主界面右上角的 AI 按钮会：
1. ? **显示当前人格头像**（如果有立绘）
2. ? **实时更新表情**（根据好感度/事件）
3. ? **每秒自动刷新**（60 Tick 更新一次）
4. ? **右键快速对话**（弹出输入框）

### 头像加载优先级

```
1. 优先：当前人格头像 (Expressions/{PersonaDefName}/_happy.png)
   ↓ （如果有表情）
   
2. 降级：基础立绘 (9x16/{PersonaDefName}/base.png)
   ↓ （如果表情文件不存在）
   
3. 备用：状态图标 (NarratorButton_Ready.png)
   ↓ （如果立绘不存在）
   
4. 最终：默认占位符
```

### 右键快速对话

**使用方式**：
1. 右键点击 AI 按钮
2. 弹出快速对话输入框
3. 输入消息，按回车或点击"发送"
4. AI 回复会显示在聊天窗口和系统消息中

**系统消息格式**：
```
【Sideria】你好！我是 AI 叙事者。
```

---

## 文件命名规范

### ? 正确命名

```
# 基础立绘
base.png                              ? 全小写，必须

# 表情文件（带下划线前缀）
_happy.png                            ? 全小写，下划线开头
_sad.png
_angry.png

# 服装文件（下划线分隔 + 数字）
neutral_1.png                         ? 全小写，下划线分隔
warm_1.png
intimate_1.png
devoted_1.png
devoted_2.png                         ? 同等级可以有多套

# 人格定义名称
Sideria_Default                       ? 大小写混合，下划线分隔
Cassandra_Classic
```

### ? 错误命名

```
# 基础立绘
Base.png                              ? 大写
BASE.png                              ? 全大写
base.jpg                              ? 错误格式

# 表情文件
happy.png                             ? 缺少下划线前缀
_Happy.png                            ? 大写字母
_happy_face.png                       ? 这是面部覆盖层，不是完整立绘

# 服装文件
Neutral_1.png                         ? 大写
neutral-1.png                         ? 连字符
neutral1.png                          ? 缺少下划线
```

---

## 故障排查

### 问题 1: 主界面按钮不显示头像

**症状**：
- AI 按钮显示默认图标
- 没有显示人格头像

**排查步骤**：

1. **检查人格是否选择**
   ```
   游戏中 → 打开 AI 对话窗口 → 点击"切换人格"
   确认当前选择了哪个人格
   ```

2. **检查立绘文件是否存在**
   ```powershell
   # 验证基础立绘
   Test-Path "Textures\UI\Narrators\9x16\Sideria\base.png"
   
   # 验证表情文件
   Test-Path "Textures\UI\Narrators\9x16\Expressions\Sideria\_happy.png"
   ```

3. **检查文件命名**
   - 必须是 `base.png`（全小写）
   - 表情文件必须有下划线前缀（`_happy.png`）

4. **查看日志**
   ```
   Dev Mode → Logs → 搜索 "NarratorScreenButton"
   
   期望看到:
   [NarratorScreenButton] 更新头像: Sideria (Happy)
   [PortraitLoader] 从 Expressions 加载整图表情: UI/Narrators/9x16/Expressions/Sideria/_happy
   ```

### 问题 2: 表情不切换

**症状**：
- 头像显示正常
- 但表情始终是中性，不会变化

**排查步骤**：

1. **检查表情系统是否启用**
   ```
   游戏中 → Mod 设置 → The Second Seat
   确认表情系统已启用
   ```

2. **测试手动切换表情**
   ```
   打开 AI 对话窗口 → 点击"切换人格" → 右键点击人格 → 选择"表情调试"
   手动点击不同表情，观察头像是否变化
   ```

3. **检查表情文件是否存在**
   ```powershell
   Get-ChildItem "Textures\UI\Narrators\9x16\Expressions\Sideria\" -File
   ```

4. **查看表情切换日志**
   ```
   Dev Mode → Logs → 搜索 "ExpressionSystem"
   
   期望看到:
   [ExpressionSystem] Sideria_Default 表情切换: Neutral → Happy (触发: Manual)
   ```

### 问题 3: 服装差分不显示

**症状**：
- 好感度变化
- 但服装没有更换

**排查步骤**：

1. **检查服装文件是否存在**
   ```powershell
   Get-ChildItem "Textures\UI\Narrators\9x16\Sideria\Outfits\" -File
   ```

2. **检查好感度等级**
   ```
   打开 AI 对话窗口 → 查看左侧好感度条
   记录当前好感度数值
   ```

3. **查看服装切换日志**
   ```
   Dev Mode → Logs → 搜索 "OutfitSystem"
   
   期望看到:
   [OutfitSystem] Sideria_Default 服装切换: neutral_1 → warm_1 (好感度: 250)
   ```

### 问题 4: 右键快速对话无反应

**症状**：
- 右键点击 AI 按钮
- 没有弹出输入框

**排查步骤**：

1. **确认游戏版本**
   ```
   需要 RimWorld 1.4 或更高版本
   ```

2. **检查 Mod 加载**
   ```
   Mod 管理器 → 确认 The Second Seat 已启用且无错误
   ```

3. **查看错误日志**
   ```
   Dev Mode → Logs → 搜索 "QuickDialogueWindow"
   
   如果看到错误，报告给开发者
   ```

---

## 快速参考

### 最小配置（必需文件）

```
Textures/UI/Narrators/9x16/Sideria/base.png          ? 必需
Defs/NarratorPersonaDefs/Sideria.xml                 ? 必需
```

### 完整配置（推荐）

```
Textures/UI/Narrators/9x16/
├── Sideria/
│   ├── base.png                                     ? 必需
│   └── Outfits/
│       ├── neutral_1.png                            ? 推荐
│       ├── warm_1.png                               ? 推荐
│       ├── intimate_1.png                           ? 推荐
│       └── devoted_1.png                            ? 推荐
│
└── Expressions/
    └── Sideria/
        ├── _happy.png                               ? 推荐
        ├── _sad.png                                 ? 推荐
        ├── _angry.png                               ? 推荐
        ├── _surprised.png                           ? 推荐
        └── _thoughtful.png                          ? 推荐

Defs/NarratorPersonaDefs/Sideria.xml                 ? 必需
```

### 文件大小建议

```
base.png:               2-5 MB  （完整质量）
表情立绘 (_happy.png):   2-5 MB  （完整立绘）
服装立绘 (warm_1.png):   2-5 MB  （完整立绘）
面部覆盖层 (_happy_face.png): < 500 KB （仅面部）
```

---

## 开发者支持

### API 使用示例

#### 获取当前头像

```csharp
var manager = Current.Game?.GetComponent<NarratorManager>();
var persona = manager?.GetCurrentPersona();

if (persona != null)
{
    // 获取当前表情
    var expressionState = ExpressionSystem.GetExpressionState(persona.defName);
    ExpressionType currentExpression = expressionState.CurrentExpression;
    
    // 加载头像（带表情）
    Texture2D portrait = PortraitLoader.LoadPortrait(persona, currentExpression);
}
```

#### 手动切换表情

```csharp
// 切换到开心表情
ExpressionSystem.SetExpression("Sideria_Default", ExpressionType.Happy, ExpressionTrigger.Manual);
```

#### 触发服装更换

```csharp
OutfitSystem.ChangeOutfit("Sideria_Default", favorability: 500f);
```

---

## 常见问题 (FAQ)

**Q: 表情文件必须是完整立绘吗？**
A: 不一定。你可以选择：
   1. 完整立绘替换模式（推荐，简单）
   2. 面部覆盖层模式（高级，节省空间）

**Q: 服装和表情可以同时使用吗？**
A: 可以！系统会自动合成：
   - 表情立绘的头部
   - 服装立绘的身体
   - 最终显示：表情 + 服装

**Q: 可以添加自定义表情吗？**
A: 目前支持 10 种预定义表情。如需添加新表情，需要修改代码中的 `ExpressionType` 枚举。

**Q: 立绘尺寸必须是 1080x1920 吗？**
A: 推荐使用 9:16 比例（如 1080x1920），但也支持其他尺寸。系统会自动缩放。

**Q: 右键快速对话支持快捷键吗？**
A: 支持。输入框中按回车发送，按 ESC 关闭。

---

## 更新日志

### v1.4.0 (最新)
- ? 主界面 AI 按钮支持动态头像
- ? 头像支持表情系统
- ? 右键快速对话功能
- ? 系统消息伪装（叙事者消息显示为系统提示）

### v1.3.0
- ? 表情系统完整实现
- ? 服装差分系统
- ? 自动分割合成功能

### v1.2.0
- ? 基础立绘加载
- ? 9:16 比例支持

---

**祝你使用愉快！如有问题，请查看日志或联系开发者。** ??
