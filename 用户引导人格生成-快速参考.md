# User-Guided Persona Generation - Quick Reference

## ?? Quick Implementation Checklist

### Files to Modify
- [ ] `Source/TheSecondSeat/PersonaGeneration/NarratorPersonaDef.cs` - Add 2 fields
- [ ] `Source/TheSecondSeat/PersonaGeneration/MultimodalAnalysisService.cs` - Modify 2 methods
- [ ] `Source/TheSecondSeat/UI/PersonaSelectionWindow.cs` - Add DrawPersonalityTags method + modify CreatePersonaFromPortrait

### New File to Create
- [ ] `Source/TheSecondSeat/UI/Dialog_PersonaGenerationSettings.cs` - New window class

---

## ?? Modifications Summary

### 1. NarratorPersonaDef.cs
**Add after `toneTags` field:**
```csharp
public List<string> personalityTags = new List<string>();
public string supplementaryBiography = "";
```

### 2. MultimodalAnalysisService.cs
**Modify `AnalyzeTextureAsync` signature:**
```csharp
public async Task<VisionAnalysisResult?> AnalyzeTextureAsync(
    Texture2D texture,
    string userDescription = "",
    List<string>? userTags = null)
```

**Modify `GetVisionPrompt` signature:**
```csharp
private string GetVisionPrompt(
    string userDescription = "",
    List<string>? userTags = null)
```

### 3. PersonaSelectionWindow.cs
**Add method:**
```csharp
private void DrawPersonalityTags(Rect rect, List<string> tags)
private Color GetTagColor(string tag)
```

**Modify method:**
```csharp
// Replace OpenPortraitPickerForNewPersona() call with:
Find.WindowStack.Add(new Dialog_PersonaGenerationSettings(texture, portrait.Path));
```

### 4. Dialog_PersonaGenerationSettings.cs
**Create new file** - See `Source/TheSecondSeat/UI/Dialog_PersonaGenerationSettings.cs`

---

## ?? User Experience Flow

```
1. User clicks "从立绘生成新人格"
   ↓
2. Select portrait
   ↓
3. [NEW] Dialog opens with:
   - Portrait preview
   - Bio text area (max 500 chars)
   - Tags input (comma-separated, max 10)
   - Skip button / Generate button
   ↓
4. User inputs custom text (or skips)
   ↓
5. AI analyzes with user priority:
   Personality: User text > Visual
   Appearance: Visual > User text
   ↓
6. Persona created with colored tag badges
```

---

## ?? Priority Rules

| Aspect | Priority | Reason |
|--------|----------|--------|
| **Personality** | User Input > Visual | User knows character better |
| **Appearance** | Visual > User Input | Image is ground truth |
| **Behavior** | Based on User's Personality | Consistency |

---

## ?? Tag Colors

| Tag Content | Color | Example |
|-------------|-------|---------|
| Positive traits | Green | 善良, benevolent, kind |
| Negative traits | Red | 残忍, sadistic, cruel |
| Strategic traits | Blue | 聪明, strategic, smart |
| Chaotic traits | Orange | 混乱, chaotic, mad |
| Protective traits | Light Blue | 保护, protective, guard |
| Default | Gray | Other tags |

---

## ?? Testing

### Test Case 1: Empty Input
- Input: (blank)
- Expected: Standard generation (existing behavior)

### Test Case 2: User Tags Only
- Input: Tags = "善良,聪明,幽默"
- Expected: Personality matches tags, appearance from image

### Test Case 3: Conflicting Input
- User says: "残忍" (cruel)
- Image shows: Angel
- Expected: Personality = Sadistic, Appearance = angel

---

## ?? Build & Deploy

```powershell
# Build
cd Source
dotnet build TheSecondSeat.csproj

# Verify no errors
# Expected output: Build succeeded. 0 Error(s)
```

---

## ? Verification

### Visual Check
1. Open persona selection window
2. Look for personas with tags
3. See colored badges under names

### Functional Check
1. Click "从立绘生成新人格"
2. Select portrait
3. Dialog opens with input fields
4. Input text and generate
5. Verify persona has user tags

---

**Version**: v1.7.0  
**Status**: ? Ready to deploy
