# 纹理加载静默回退机制 - 完成总结 v1.6.18

## ?? 优化完成！

已成功实现纹理加载的**静默回退机制**，避免日志刷屏，提升用户体验！

---

## ? 核心优化

### **1. 静默回退原则**
- **移除中间日志** - 回退过程不输出任何日志
- **只警告完全失败** - 所有路径都失败时输出一条汇总警告
- **DevMode 保留详情** - 开发者模式下仍可查看详细诊断

### **2. 回退流程**

**完整回退链（按优先级）：**
```
1. 具体变体表情 (happy3.png)
   ↓ 失败（静默）
2. 通用表情 (happy.png)
   ↓ 失败（静默）
3. 变体面部叠加 (happy3_face.png + base.png)
   ↓ 失败（静默）
4. 通用面部叠加 (happy_face.png + base.png)
   ↓ 失败（静默）
5. 基础立绘 (base.png / neutral.png)
   ↓ 失败（静默）
6. 立绘裁剪为头像
   ↓ 失败（静默）
7. 占位符生成
   ? 始终成功
```

**失败时的日志输出：**
```
[AvatarLoader] ? 所有加载方式失败，使用占位符: Sideria_happy3
```

**不再输出（已移除）：**
```
? [PortraitLoader] ? 第1层成功: ...
? [PortraitLoader] ? 表情文件未找到: ...
? [PortraitLoader] ?? 表情文件未找到，回退到基础立绘: ...
? [AvatarLoader] ? 加载表情头像成功: ...
? [AvatarLoader] ? 加载基础头像成功: ...
```

---

## ?? 文件修改详情

### **1. AvatarLoader.cs**

**优化内容：**
```csharp
// ? 优化前（刷屏）：
if (texture != null)
{
    Log.Message($"[AvatarLoader] ? 加载表情头像成功: {avatarPath}");
}

// ? 优化后（静默）：
if (texture != null && Prefs.DevMode)
{
    Log.Message($"[AvatarLoader] ? 加载表情头像: {avatarPath}");
}
```

**移除的日志：**
- ? 表情头像加载成功
- ? 基础头像加载成功
- ? 使用立绘裁剪兜底

**保留的日志：**
- ? 所有加载方式失败（最终警告）
- DevMode 下的成功信息

---

### **2. PortraitLoader.cs**

**优化内容：**
```csharp
// ? 优化前（详细回退日志）：
if (Prefs.DevMode)
{
    Log.Message($"[PortraitLoader] ? 第1层成功（具体变体）: {specificPath}");
    Log.Message($"[PortraitLoader] ? 第2层成功（通用表情）: {genericPath}");
    Log.Warning($"[PortraitLoader] ? 表情文件未找到: {specificPath} 和 {genericPath}");
}

// ? 优化后（静默回退）：
if (texture != null)
{
    // 静默返回，不输出日志
    return texture;
}
// 失败也静默，由上层统一处理
return null;
```

**移除的日志：**
- ? 第1层成功（具体变体）
- ? 第2层成功（通用表情）
- ? 面部叠加合成成功
- ? 表情文件未找到（中间警告）
- ?? 表情文件未找到，回退到基础立绘

**简化的日志：**
```csharp
// ? 优化前（详细路径列表）：
Log.Warning($"[PortraitLoader] 立绘加载失败: {personaName}");
Log.Warning($"[PortraitLoader] 请确保以下路径之一存在纹理文件:");
Log.Warning($"[PortraitLoader]   - Textures/{basePath}.png");
Log.Warning($"[PortraitLoader]   - Textures/{path2}.png");
Log.Warning($"[PortraitLoader]   - Textures/{def.portraitPath}.png");
Log.Warning($"[PortraitLoader]   - Textures/{heroArtPath}.png");

// ? 优化后（简短汇总）：
Log.Warning($"[PortraitLoader] 立绘加载失败: {personaName}（已尝试所有路径）");

// 详细路径列表只在 DevMode 下输出
if (Prefs.DevMode) { /* 详细日志 */ }
```

---

## ?? 用户体验提升

### **优化前（日志刷屏）：**
```
[PortraitLoader] ? 表情文件未找到: UI/Narrators/9x16/Expressions/Sideria/happy3
[PortraitLoader] ? 第2层成功（通用表情）: UI/Narrators/9x16/Expressions/Sideria/happy
[PortraitLoader] ? 表情文件未找到: UI/Narrators/9x16/Expressions/Sideria/sad2
[PortraitLoader] ? 第2层成功（通用表情）: UI/Narrators/9x16/Expressions/Sideria/sad
[AvatarLoader] ? 加载表情头像成功: UI/Narrators/Avatars/Sideria/happy
[AvatarLoader] ? 加载基础头像成功: UI/Narrators/Avatars/Sideria/base
...（数十条日志）
```

### **优化后（静默回退）：**
```
（没有任何中间日志）
（只有在完全失败时才输出一条警告）
[PortraitLoader] 立绘加载失败: UnknownPersona（已尝试所有路径）
```

### **DevMode 下（保留诊断）：**
```
（开启 Dev Mode 后才显示详细信息）
[PortraitLoader] ========== 立绘加载诊断 ==========
[PortraitLoader] defName: Sideria_Default
[PortraitLoader] narratorName: Sideria
[PortraitLoader] 解析的文件夹名: Sideria
[PortraitLoader] ? 路径1成功: UI/Narrators/9x16/Sideria/base
```

---

## ?? 优化效果对比

| 场景 | 优化前日志数 | 优化后日志数 | 减少比例 |
|------|-------------|-------------|---------|
| 成功加载表情 | 3-5 条 | 0 条 | 100% ↓ |
| 回退到通用表情 | 5-8 条 | 0 条 | 100% ↓ |
| 回退到基础立绘 | 8-12 条 | 0 条 | 100% ↓ |
| 完全失败 | 15+ 条 | 1 条 | 93% ↓ |
| DevMode 诊断 | 15+ 条 | 15+ 条 | 0%（保留） |

---

## ??? 实现细节

### **静默回退方法**

**TryLoadTextureWithFallback：**
```csharp
// ? 尝试具体变体
var texture = ContentFinder<Texture2D>.Get(specificPath, false);
if (texture != null) return texture;  // 静默返回

// ? 回退到通用表情
texture = ContentFinder<Texture2D>.Get(genericPath, false);
if (texture != null) return texture;  // 静默返回

// ? 全部失败，静默返回 null
return null;
```

**LoadWithFaceOverlayAndFallback：**
```csharp
// ? 尝试变体面部
Texture2D faceTexture = ContentFinder<Texture2D>.Get(specificFacePath, false);

// ? 回退到通用面部
if (faceTexture == null)
{
    faceTexture = ContentFinder<Texture2D>.Get(genericFacePath, false);
    // 移除回退成功日志，静默返回
}

// ? 合成表情
if (composite != null && Prefs.DevMode)
{
    Log.Message("? 面部叠加合成");  // 只在DevMode下输出
}
```

**LoadBasePortrait：**
```csharp
// ? 尝试5条路径，每条失败都静默
for (int i = 1; i <= 5; i++)
{
    texture = ContentFinder<Texture2D>.Get(pathN, false);
    if (texture != null)
    {
        if (Prefs.DevMode) Log.Message($"? 路径{i}成功");
        return texture;
    }
    // 失败不输出日志，继续下一条
}

// ? 所有路径失败，输出简短警告
Log.Warning($"立绘加载失败: {personaName}（已尝试所有路径）");
```

---

## ?? DevMode 诊断保留

**启用 Dev Mode 后仍可查看：**
```csharp
if (Prefs.DevMode)
{
    Log.Message($"[PortraitLoader] ========== 立绘加载诊断 ==========");
    Log.Message($"[PortraitLoader] defName: {def.defName}");
    Log.Message($"[PortraitLoader] narratorName: {def.narratorName}");
    Log.Message($"[PortraitLoader] portraitPath: {def.portraitPath}");
    Log.Message($"[PortraitLoader] 解析的文件夹名: {personaName}");
    Log.Message($"[PortraitLoader] ? 路径1成功: {basePath}");
    Log.Warning($"[PortraitLoader] 请确保以下路径之一存在纹理文件:");
    Log.Warning($"[PortraitLoader]   - Textures/{basePath}.png");
    // ... 详细路径列表
}
```

---

## ?? Git 提交记录

```
Commit: 2cc1e22
Files: 2 modified
Message: ?? 优化纹理加载：实现静默回退机制
```

**修改文件：**
- `Source/TheSecondSeat/PersonaGeneration/AvatarLoader.cs`
- `Source/TheSecondSeat/PersonaGeneration/PortraitLoader.cs`

**统计：**
- 减少代码：57 行
- 增加代码：50 行
- 净减少：7 行（主要是日志语句）

---

## ?? 相关文档

- [表情和分层立绘文件夹-快速参考-v1.6.18.md](表情和分层立绘文件夹-快速参考-v1.6.18.md)
- [眨眼和张嘴动画-快速参考-v1.6.18.md](眨眼和张嘴动画-快速参考-v1.6.18.md)
- [Expressions/README.md](Textures/UI/Narrators/9x16/Expressions/README.md)
- [Layered/README.md](Textures/UI/Narrators/9x16/Layered/README.md)

---

## ?? 回退机制工作原理

### **完整回退链示例（加载 happy3 表情）：**

```
用户请求: LoadPortrait(Sideria, ExpressionType.Happy) + 变体3

第1层：尝试完整表情立绘
  └─ TryLoadTextureWithFallback("Sideria", "_happy3")
      ├─ 尝试：UI/Narrators/9x16/Expressions/Sideria/happy3.png
      │   └─ ? 未找到（静默）
      └─ 回退：UI/Narrators/9x16/Expressions/Sideria/happy.png
          └─ ? 找到！返回（静默）

（如果第1层失败）
第2层：尝试面部叠加合成
  └─ LoadWithFaceOverlayAndFallback(Sideria, Happy)
      ├─ 加载基础立绘：UI/Narrators/9x16/Sideria/base.png
      ├─ 尝试：UI/Narrators/9x16/Expressions/Sideria/happy3_face.png
      │   └─ ? 未找到（静默）
      ├─ 回退：UI/Narrators/9x16/Expressions/Sideria/happy_face.png
      │   └─ ? 找到！
      └─ 合成：base.png + happy_face.png
          └─ ? 返回（DevMode下输出日志）

（如果第2层失败）
第3层：使用基础立绘
  └─ LoadBasePortrait(Sideria)
      ├─ 尝试路径1：UI/Narrators/9x16/Sideria/base.png
      │   └─ ? 未找到（静默）
      ├─ 尝试路径2：UI/Narrators/9x16/Sideria.png
      │   └─ ? 未找到（静默）
      ├─ 尝试路径3：{def.portraitPath}
      │   └─ ? 未找到（静默）
      ├─ 尝试路径4：{def.customPortraitPath}
      │   └─ ? 未找到（静默）
      └─ 尝试路径5：UI/HeroArt/Sideria.png
          └─ ? 找到！返回（DevMode下输出日志）

（如果第3层失败）
第4层：生成占位符
  └─ GeneratePlaceholder(def.primaryColor)
      └─ ? 始终成功（输出警告）

最终输出（只有完全失败时）：
[PortraitLoader] 立绘加载失败: Sideria（已尝试所有路径）
```

---

## ?? 已知问题

### **LayeredPortraitCompositor.cs 被截断**
- **问题：** 文件只有 863 字节，代码不完整
- **影响：** 分层立绘系统暂时无法使用静默回退
- **解决方案：** 需要从备份恢复或重建文件
- **临时对策：** 已跳过此文件的优化，核心功能（AvatarLoader 和 PortraitLoader）已完成

---

## ?? 总结

### **已完成工作**
- ? AvatarLoader.cs 静默回退优化
- ? PortraitLoader.cs 静默回退优化
- ? 减少日志刷屏 93%+
- ? DevMode 诊断功能保留
- ? 提交并推送到 GitHub

### **预期效果**
- ? 用户体验：不再被日志刷屏
- ? 性能提升：减少日志 I/O 开销
- ? 调试友好：DevMode 下仍可诊断
- ? 代码简洁：移除冗余日志语句

### **下一步（可选）**
- ? 恢复 LayeredPortraitCompositor.cs 文件
- ? 应用相同的静默回退机制
- ? 统一所有加载器的日志策略

---

**版本：** v1.6.18-silent-fallback  
**完成日期：** 2025-01-XX  
**状态：** ? 核心功能完成，已推送到 GitHub  
**GitHub：** https://github.com/sanguodxj-byte/The-Second-Seat  
**Commit:** 2cc1e22
