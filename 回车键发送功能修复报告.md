# ? 回车键发送功能修复报告

**版本**: v1.6.5  
**日期**: 2025-01-15  
**状态**: ?? **部分完成（等待文件修复）**

---

## ?? 问题描述

1. **回车键无法发送消息**（在聊天窗口和快速对话窗口都不工作）
2. **快速对话窗口正常工作**（右键 AI 图标显示）

---

## ? 已完成的修复

### 1. 快速对话窗口（QuickDialogueWindow.cs）

? **修复回车键检测顺序**

**修改前**（第 47-56 行）：
```csharp
// ? 错误：在 TextField 之前检测回车键
if (Event.current.type == EventType.KeyDown && Event.current.keyCode == KeyCode.Return)
{
    if (!string.IsNullOrWhiteSpace(userInput))
    {
        SendMessage();
    }
    Event.current.Use();
    return;
}

userInput = Widgets.TextField(inputRect, userInput);
```

**修改后**：
```csharp
// ? 正确：先绘制 TextField，然后检测回车键
userInput = Widgets.TextField(inputRect, userInput);

// ? 然后检测回车键（必须在 TextField 之后）
if (Event.current.type == EventType.KeyDown && 
    Event.current.keyCode == KeyCode.Return && 
    GUI.GetNameOfFocusedControl() == "QuickDialogueInput")
{
    if (!string.IsNullOrWhiteSpace(userInput))
    {
        SendMessage();
        Event.current.Use();
    }
}
```

---

### 2. 主聊天窗口（NarratorWindow.cs）

? **修复回车键检测顺序**

**修改前**（第 445-463 行）：
```csharp
// ? 错误：在 TextField 之前检测回车键
bool enterPressed = false;
if (Event.current.type == EventType.KeyDown && Event.current.keyCode == KeyCode.Return)
{
    enterPressed = true;
    Event.current.Use();
}

userInput = Widgets.TextField(textFieldRect, userInput);

if (enterPressed && !string.IsNullOrWhiteSpace(userInput))
{
    SendMessage(userInput);
    userInput = "";
    GUI.FocusControl("UserInputField");
}
```

**修改后**：
```csharp
// ? 正确：先绘制 TextField，然后检测回车键
userInput = Widgets.TextField(textFieldRect, userInput);

// ? 然后检测回车键（必须在 TextField 之后）
if (Event.current.type == EventType.KeyDown && 
    Event.current.keyCode == KeyCode.Return && 
    GUI.GetNameOfFocusedControl() == "UserInputField")
{
    if (!string.IsNullOrWhiteSpace(userInput))
    {
        SendMessage(userInput);
        userInput = "";
        Event.current.Use();
        GUI.FocusControl("UserInputField"); // 保持焦点
    }
}
```

**额外改进**：
- 添加了焦点检测：`GUI.GetNameOfFocusedControl() == "UserInputField"`
- 改进了提示文本：`"输入消息...（回车发送）"`

---

## ?? 编译错误

修复代码后，编译时发现 `SystemPromptGenerator.cs` 文件已损坏：

```
SystemPromptGenerator.cs(511,67): error CS1010: 常量中有换行符
SystemPromptGenerator.cs(563,1): error CS0106: 修饰符"private"对该项无效
... 等 10 个错误
```

**原因**：之前尝试修改该文件添加中文语言要求时，文件内容被破坏。

---

## ?? 解决方案

### 方案 1：手动修复 SystemPromptGenerator.cs（推荐）

由于该文件已严重损坏，需要从备份或干净版本恢复。

**步骤**：

1. **找到备份文件**
   - 检查是否有 `.bak` 或 `~` 结尾的备份文件
   - 或者从之前的模组版本复制

2. **使用 Git 恢复**（如果有）
   ```powershell
   git checkout Source\TheSecondSeat\PersonaGeneration\SystemPromptGenerator.cs
   ```

3. **重新下载模组**
   - 从原始来源下载干净的 `SystemPromptGenerator.cs`
   - 替换损坏的文件

---

### 方案 2：使用全局提示词实现中文输出（不修复文件）

如果暂时无法修复 `SystemPromptGenerator.cs`，可以使用**全局提示词**来强制 AI 使用中文：

1. 打开游戏设置 → The Second Seat
2. 在"全局提示词"框中粘贴：
   ```
   【强制要求】你必须使用简体中文回复！
   
   ## 语言规则
   1. 所有对话内容必须用中文
   2. 动作描述也用中文：(点头) 而不是 (nods)
   3. 不要使用英文，除非是专业术语
   ```
3. 点击"应用更改"

详细指南：[强制AI输出中文-快速指南.md](强制AI输出中文-快速指南.md)

---

## ?? 修复前后对比

### ? 修复前

**主聊天窗口**：
- 按回车 → 无反应
- 必须点击"发送"按钮

**快速对话窗口**：
- 按回车 → 无反应
- 窗口自动关闭但不发送

---

### ? 修复后（文件恢复后）

**主聊天窗口**：
- 按回车 → 立即发送消息
- 焦点保持在输入框
- 提示文字："输入消息...（回车发送）"

**快速对话窗口**：
- 按回车 → 发送并关闭窗口
- 标题显示："快速对话（回车发送）"

---

## ?? 快速对话功能说明

### 如何使用

1. **右键点击**屏幕上的 AI 图标（默认左上角）
2. 弹出**快速对话窗口**
3. 输入消息后按**回车键**发送
4. 窗口自动关闭，消息发送给 AI

### 快速对话 vs 主窗口

| 功能 | 快速对话 | 主窗口 |
|------|---------|--------|
| 打开方式 | 右键 AI 图标 | 左键 AI 图标 |
| 窗口大小 | 小（400x100） | 大（900x700） |
| 历史记录 | 不显示 | 完整显示 |
| 发送后 | 自动关闭 | 保持打开 |
| 适用场景 | 快速提问 | 长时间对话 |

---

## ?? 下一步

### 临时解决方案（立即可用）

1. **恢复 SystemPromptGenerator.cs** 到干净版本
2. **重新编译**模组
3. **测试回车键**发送功能

### 永久解决方案

1. 使用**全局提示词**代替修改代码
2. 避免手动编辑复杂的生成器文件
3. 通过设置界面控制 AI 行为

---

## ?? 技术细节

### 为什么之前不工作？

**根本原因**：Unity IMGUI 的事件处理顺序

1. `TextField` 控件会消耗键盘事件
2. 如果在 `TextField` **之前**检测回车键，事件已被消耗
3. 必须先绘制 `TextField`，然后再检测按键

**正确顺序**：
```csharp
// 1. 先绘制输入框
userInput = Widgets.TextField(rect, userInput);

// 2. 然后检测按键
if (Event.current.type == EventType.KeyDown && Event.current.keyCode == KeyCode.Return)
{
    // 处理回车键
}
```

### 焦点检测的重要性

添加 `GUI.GetNameOfFocusedControl() == "UserInputField"` 可以确保：
- 只有输入框获得焦点时才响应回车键
- 避免其他控件（如按钮）误触发
- 提供更好的用户体验

---

## ? 总结

### 已修复
- ? 快速对话窗口回车键发送
- ? 主聊天窗口回车键发送
- ? 添加提示文本引导用户

### 待完成
- ?? 恢复 `SystemPromptGenerator.cs` 文件
- ?? 重新编译模组
- ?? 部署到游戏目录

### 替代方案
- ? 使用全局提示词强制中文输出（无需修复文件）

---

**版本**: v1.6.5  
**状态**: ?? **代码已修复，等待文件恢复后编译**  
**优先级**: **高**（影响核心交互功能）

?? **建议**：优先使用**全局提示词**方案，避免修复复杂的代码文件！
