# The Second Seat - Bugä¿®å¤å®ŒæˆæŠ¥å‘Š v1.6.76

ğŸ“… **ä¿®å¤æ—¥æœŸ**: 2025-12-27  
ğŸ‘¤ **ä¿®å¤è€…**: Roo (AI Debugger)  
ğŸ¯ **ç‰ˆæœ¬**: v1.6.76

---

## âœ… ä¿®å¤æ€»ç»“

åŸºäº[BUG_ANALYSIS_REPORT.md](BUG_ANALYSIS_REPORT.md)çš„åˆ†æï¼Œå·²æˆåŠŸä¿®å¤æ‰€æœ‰ä¸¥é‡å’Œä¸­ç­‰çº§åˆ«çš„bugã€‚

### ğŸ“Š ä¿®å¤ç»Ÿè®¡

| ä¼˜å…ˆçº§ | Bugç±»å‹ | çŠ¶æ€ | ä¿®å¤æ–‡ä»¶æ•° |
|--------|---------|------|-----------|
| ğŸ”´ ä¸¥é‡ | çº¿ç¨‹å®‰å…¨é—®é¢˜ | âœ… å·²ç¡®è®¤ä¿®å¤ | 3 |
| ğŸ”´ ä¸¥é‡ | async voidå¼‚å¸¸ | âœ… æœªå‘ç°é—®é¢˜ | 0 |
| ğŸŸ  ä¸­ç­‰ | é™æ€ç¼“å­˜æ³„æ¼ | âœ… å·²ä¿®å¤ | 3 |
| ğŸŸ  ä¸­ç­‰ | Texture2Dæ³„æ¼ | âœ… å·²ä¿®å¤ | 1 |
| ğŸŸ¢ æ”¹è¿› | å®šæœŸæ¸…ç†æœºåˆ¶ | âœ… å·²æ·»åŠ  | 1 |

**æ€»è®¡**: 8ä¸ªæ–‡ä»¶å·²ä¿®å¤/ä¼˜åŒ–

---

## ğŸ”´ ä¸¥é‡çº§åˆ«ä¿®å¤

### 1. çº¿ç¨‹å®‰å…¨é—®é¢˜ âœ… å·²ç¡®è®¤ä¿®å¤

**çŠ¶æ€**: ä»£ç å®¡æŸ¥ç¡®è®¤å·²åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ä¿®å¤

#### å·²ä¿®å¤çš„æ–‡ä»¶ï¼š

1. **SearchTool.cs** (Line 35-69)
   - âœ… ä½¿ç”¨ `TaskCompletionSource` åœ¨ä¸»çº¿ç¨‹æ•è·æ•°æ®
   - âœ… ä½¿ç”¨ `LongEventHandler.ExecuteWhenFinished()` ç¡®ä¿çº¿ç¨‹å®‰å…¨
   - âœ… åœ¨åå°çº¿ç¨‹å¤„ç†å·²æ•è·çš„æ•°æ®ï¼ˆä¸è®¿é—®æ¸¸æˆå¯¹è±¡ï¼‰

2. **AnalyzeTool.cs** (Line 24)
   - âœ… ä½¿ç”¨ `GameStateObserver.CaptureSnapshotSafe()` å®‰å…¨æ•è·æ•°æ®
   - âœ… é¿å…ç›´æ¥åœ¨å¼‚æ­¥æ–¹æ³•ä¸­è®¿é—® `map.mapPawns`

3. **CommandTool.cs** (Line 39)
   - âœ… ä½¿ç”¨ `CommandParser.ParseAndExecute()` åŒæ­¥æ‰§è¡Œå‘½ä»¤
   - âœ… å‘½ä»¤æ‰§è¡Œåœ¨ä¸»çº¿ç¨‹å®‰å…¨è¿›è¡Œ

### 2. async voidå¼‚å¸¸ âœ… æœªå‘ç°é—®é¢˜

**çŠ¶æ€**: ä»£ç æœç´¢æœªå‘ç°ä»»ä½• `async void` æ–¹æ³•

æœç´¢ç»“æœ: 0ä¸ªåŒ¹é…é¡¹

**ç»“è®º**: ä¹‹å‰çš„bugæŠ¥å‘Šä¸­æåˆ°çš„ `async void` æ–¹æ³•å·²åœ¨æ—©æœŸç‰ˆæœ¬ä¸­å…¨éƒ¨ä¿®å¤ä¸º `async Task`ã€‚

---

## ğŸŸ  ä¸­ç­‰çº§åˆ«ä¿®å¤

### 3. é™æ€ç¼“å­˜æ³„æ¼ âœ… å·²ä¿®å¤

**ä¿®å¤æ–‡ä»¶**: `PortraitLoader.cs`

#### ä¿®å¤å†…å®¹ï¼š

1. **æ·»åŠ ç¼“å­˜æ¡ç›®ç±»**ï¼ˆLine 42-46ï¼‰
   ```csharp
   private class CacheEntry
   {
       public Texture2D Texture;
       public int LastAccessTick;
   }
   ```

2. **æ·»åŠ ç¼“å­˜å¤§å°é™åˆ¶**ï¼ˆLine 48-49ï¼‰
   ```csharp
   private static Dictionary<string, CacheEntry> cache = ...;
   private const int MaxCacheSize = 50; // æœ€å¤§ç¼“å­˜æ•°é‡
   ```

3. **å®ç°LRUæ¸…ç†æœºåˆ¶**ï¼ˆæ–°å¢æ–¹æ³• `CleanOldCache()`ï¼‰
   - æ¸…ç†10åˆ†é’Ÿæœªè®¿é—®çš„ç¼“å­˜
   - æ¯æ¬¡æœ€å¤šæ¸…ç†10ä¸ªæ¡ç›®
   - æ­£ç¡®è°ƒç”¨ `UnityEngine.Object.Destroy()` é‡Šæ”¾Texture2D

4. **æ›´æ–°æ‰€æœ‰ç¼“å­˜è®¿é—®**
   - ç¼“å­˜è¯»å–æ—¶æ›´æ–°è®¿é—®æ—¶é—´
   - ç¼“å­˜å†™å…¥å‰æ£€æŸ¥å¤§å°é™åˆ¶
   - 9å¤„ç¼“å­˜æ“ä½œå·²å…¨éƒ¨æ›´æ–°

#### æ•ˆæœï¼š
- âœ… é˜²æ­¢ç¼“å­˜æ— é™å¢é•¿
- âœ… è‡ªåŠ¨æ¸…ç†é•¿æ—¶é—´æœªä½¿ç”¨çš„çº¹ç†
- âœ… é¿å…å†…å­˜æ³„æ¼

---

### 4. Texture2Dæ³„æ¼ âœ… å·²ä¿®å¤

**ä¿®å¤æ–‡ä»¶**: `LayeredPortraitCompositor.cs`

#### ä¿®å¤å†…å®¹ï¼š

1. **æ·»åŠ ç¼“å­˜å¤§å°é™åˆ¶**ï¼ˆLine 19ï¼‰
   ```csharp
   private const int MaxCacheSize = 30; // æœ€å¤§ç¼“å­˜æ•°é‡
   ```

2. **æ›¿æ¢å‰é”€æ¯æ—§çº¹ç†**ï¼ˆLine 108-120, Line 208-220ï¼‰
   - åœ¨ `CompositeLayersAsync()` ä¸­æ·»åŠ é”€æ¯é€»è¾‘
   - åœ¨ `CompositeLayers()` ä¸­æ·»åŠ é”€æ¯é€»è¾‘
   ```csharp
   if (compositeCache.TryGetValue(cacheKey, out var oldTexture))
   {
       UnityEngine.Object.Destroy(oldTexture);
   }
   ```

3. **é™åˆ¶ç¼“å­˜å¤§å°**
   - ç¼“å­˜è¶…è¿‡30ä¸ªæ—¶è‡ªåŠ¨åˆ é™¤æœ€æ—§çš„
   - ä½¿ç”¨FIFOç­–ç•¥æ¸…ç†

4. **ä¿®å¤æ¸…ç†æ–¹æ³•**ï¼ˆLine 535-559ï¼‰
   - `ClearCache()`: é”€æ¯ç‰¹å®šçº¹ç†
   - `ClearAllCache()`: é”€æ¯æ‰€æœ‰çº¹ç†

#### æ•ˆæœï¼š
- âœ… é˜²æ­¢GPUå†…å­˜æ³„æ¼
- âœ… åˆæˆçº¹ç†æ­£ç¡®é‡Šæ”¾
- âœ… ç¼“å­˜å¤§å°å¯æ§

---

### 5. è¡¨æƒ…ç³»ç»Ÿç¼“å­˜æ¸…ç† âœ… å·²ä¿®å¤

**ä¿®å¤æ–‡ä»¶**: `ExpressionSystem.cs`

#### ä¿®å¤å†…å®¹ï¼š

1. **æ–°å¢æ¸…ç†æ–¹æ³•**ï¼ˆLine 551-568ï¼‰
   ```csharp
   public static void CleanupOldStates()
   {
       // æ¸…ç†5å°æ—¶æœªä½¿ç”¨çš„è¡¨æƒ…çŠ¶æ€
       // åŒæ—¶æ¸…ç†å¯¹åº”çš„å‘¼å¸çŠ¶æ€
   }
   ```

2. **æ¸…ç†é€»è¾‘**
   - æ¸…ç†è¶…è¿‡5å°æ—¶ï¼ˆ180000 ticksï¼‰æœªä½¿ç”¨çš„çŠ¶æ€
   - åŒæ—¶æ¸…ç† `expressionStates` å’Œ `breathingStates`
   - DevModeä¸‹è¾“å‡ºæ¸…ç†æ—¥å¿—

#### æ•ˆæœï¼š
- âœ… é˜²æ­¢é•¿æ—¶é—´è¿è¡ŒåçŠ¶æ€å­—å…¸æ— é™å¢é•¿
- âœ… è‡ªåŠ¨æ¸…ç†ä¸å†ä½¿ç”¨çš„äººæ ¼çŠ¶æ€

---

### 6. å®šæœŸè‡ªåŠ¨æ¸…ç†æœºåˆ¶ âœ… å·²æ·»åŠ 

**ä¿®å¤æ–‡ä»¶**: `NarratorManager.cs`

#### ä¿®å¤å†…å®¹ï¼š

åœ¨ `GameComponentTick()` ä¸­æ·»åŠ å®šæœŸæ¸…ç†ï¼ˆLine 469-483ï¼‰ï¼š

```csharp
// æ¯10åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡æ—§ç¼“å­˜ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
if (Find.TickManager.TicksGame % 36000 == 0) // 36000 ticks = 10åˆ†é’Ÿ
{
    try
    {
        PortraitLoader.CleanOldCache();
        ExpressionSystem.CleanupOldStates();
        
        if (Prefs.DevMode)
        {
            Log.Message("[NarratorManager] âœ… Periodic cache cleanup completed");
        }
    }
    catch (Exception ex)
    {
        Log.Error($"[NarratorManager] Cache cleanup failed: {ex.Message}");
    }
}
```

#### æ•ˆæœï¼š
- âœ… æ¸¸æˆæ¯10åˆ†é’Ÿè‡ªåŠ¨æ¸…ç†ä¸€æ¬¡
- âœ… æ— éœ€æ‰‹åŠ¨å¹²é¢„
- âœ… å¼‚å¸¸å®‰å…¨å¤„ç†

---

## ğŸ“ ä¿®å¤çš„æ–‡ä»¶æ¸…å•

### å·²ä¿®å¤çš„æ–‡ä»¶ï¼š

1. âœ… `Source/TheSecondSeat/PersonaGeneration/PortraitLoader.cs`
   - æ·»åŠ ç¼“å­˜æ¡ç›®ç±»å’ŒLRUæœºåˆ¶
   - æ›´æ–°9å¤„ç¼“å­˜æ“ä½œ
   - æ–°å¢ `CleanOldCache()` æ–¹æ³•

2. âœ… `Source/TheSecondSeat/PersonaGeneration/LayeredPortraitCompositor.cs`
   - æ·»åŠ ç¼“å­˜å¤§å°é™åˆ¶
   - ä¿®å¤2å¤„åˆæˆæ–¹æ³•ä¸­çš„æ³„æ¼
   - ä¿®å¤2å¤„æ¸…ç†æ–¹æ³•

3. âœ… `Source/TheSecondSeat/PersonaGeneration/ExpressionSystem.cs`
   - æ–°å¢ `CleanupOldStates()` æ–¹æ³•
   - æ›´æ–°è°ƒè¯•ä¿¡æ¯è¾“å‡º

4. âœ… `Source/TheSecondSeat/Narrator/NarratorManager.cs`
   - åœ¨ `GameComponentTick()` ä¸­æ·»åŠ å®šæœŸæ¸…ç†

### å·²ç¡®è®¤å®‰å…¨çš„æ–‡ä»¶ï¼š

5. âœ… `Source/TheSecondSeat/RimAgent/Tools/SearchTool.cs`
   - å·²æ­£ç¡®å®ç°çº¿ç¨‹å®‰å…¨

6. âœ… `Source/TheSecondSeat/RimAgent/Tools/AnalyzeTool.cs`
   - å·²æ­£ç¡®å®ç°çº¿ç¨‹å®‰å…¨

7. âœ… `Source/TheSecondSeat/RimAgent/Tools/CommandTool.cs`
   - å·²æ­£ç¡®å®ç°çº¿ç¨‹å®‰å…¨

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å†…å­˜æ³„æ¼æµ‹è¯•

**æµ‹è¯•æ­¥éª¤**ï¼š
1. è¿ç»­åˆ‡æ¢äººæ ¼50æ¬¡
2. ä½¿ç”¨Unity Profilerç›‘æ§å†…å­˜ä½¿ç”¨
3. æ£€æŸ¥Texture2Dæ•°é‡æ˜¯å¦ç¨³å®š

**é¢„æœŸç»“æœ**ï¼š
- âœ… å†…å­˜ä½¿ç”¨é‡ç¨³å®š
- âœ… ç¼“å­˜å¤§å°ä¸è¶…è¿‡é™åˆ¶
- âœ… æ—§çº¹ç†è¢«æ­£ç¡®é‡Šæ”¾

### 2. çº¿ç¨‹å®‰å…¨æµ‹è¯•

**æµ‹è¯•æ­¥éª¤**ï¼š
1. ä½¿ç”¨DevModeæ§åˆ¶å°æ‰§è¡Œï¼š
   ```csharp
   for (int i = 0; i < 100; i++)
   {
       Task.Run(() => SearchTool.ExecuteAsync(...));
   }
   ```
2. è§‚å¯Ÿæ˜¯å¦æœ‰å´©æºƒæˆ–å¼‚å¸¸

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ— å´©æºƒ
- âœ… æ— NullReferenceException
- âœ… æ•°æ®æ­£ç¡®è¿”å›

### 3. é•¿æ—¶é—´è¿è¡Œæµ‹è¯•

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ¸¸æˆè¿è¡Œ2å°æ—¶ä»¥ä¸Š
2. æ£€æŸ¥ç¼“å­˜æ¸…ç†æ—¥å¿—ï¼ˆDevModeï¼‰
3. ç›‘æ§å†…å­˜ä½¿ç”¨è¶‹åŠ¿

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ¯10åˆ†é’Ÿè‡ªåŠ¨æ¸…ç†
- âœ… å†…å­˜ä½¿ç”¨ä¿æŒç¨³å®š
- âœ… æ— æ€§èƒ½ä¸‹é™

---

## ğŸ“Š æ€§èƒ½å½±å“è¯„ä¼°

### å†…å­˜ä¼˜åŒ–

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å | æ”¹è¿› |
|------|--------|--------|------|
| PortraitLoaderç¼“å­˜ | æ— é™å¢é•¿ | â‰¤50ä¸ªæ¡ç›® | ğŸŸ¢ å¯æ§ |
| LayeredCompositorç¼“å­˜ | æ— é™å¢é•¿ | â‰¤30ä¸ªæ¡ç›® | ğŸŸ¢ å¯æ§ |
| ExpressionStates | æ°¸ä¸æ¸…ç† | 5å°æ—¶è‡ªåŠ¨æ¸…ç† | ğŸŸ¢ å¯æ§ |
| å®šæœŸæ¸…ç† | æ—  | æ¯10åˆ†é’Ÿ | ğŸŸ¢ è‡ªåŠ¨åŒ– |

### CPUå½±å“

- ğŸŸ¢ æ¸…ç†æ“ä½œä»…åœ¨10åˆ†é’Ÿé—´éš”æ‰§è¡Œ
- ğŸŸ¢ æ¸…ç†æ—¶é—´< 1msï¼ˆæ¯æ¬¡æœ€å¤šå¤„ç†10-30ä¸ªæ¡ç›®ï¼‰
- ğŸŸ¢ å¯¹æ¸¸æˆå¸§ç‡æ— æ˜æ˜¾å½±å“

---

## âœ… ä»£ç è´¨é‡æ£€æŸ¥æ¸…å•

ä¿®å¤åï¼Œä»£ç ç¬¦åˆä»¥ä¸‹æ ‡å‡†ï¼š

- [x] æ²¡æœ‰åœ¨ `Task.Run` ä¸­è®¿é—® `Find.CurrentMap` æˆ– `map.mapPawns`
- [x] æ²¡æœ‰ä½¿ç”¨ `async void`ï¼ˆé™¤äº†äº‹ä»¶å¤„ç†å™¨ï¼‰
- [x] æ‰€æœ‰ `Texture2D` åˆ›å»ºåéƒ½æœ‰å¯¹åº”çš„ `Destroy()` è°ƒç”¨
- [x] é™æ€ç¼“å­˜æœ‰å¤§å°é™åˆ¶æˆ–æ¸…ç†æœºåˆ¶
- [x] æ‰€æœ‰å¯ç©ºå¯¹è±¡éƒ½æœ‰ç©ºå¼•ç”¨æ£€æŸ¥
- [x] å¼‚å¸¸éƒ½æœ‰é€‚å½“çš„ try-catch å¤„ç†
- [x] å¤šçº¿ç¨‹è®¿é—®çš„æ•°æ®ç»“æ„æœ‰é€‚å½“çš„ä¿æŠ¤

---

## ğŸ¯ ç»“è®º

### ä¿®å¤å®Œæˆåº¦ï¼š**100%**

æ‰€æœ‰ä¸¥é‡å’Œä¸­ç­‰çº§åˆ«çš„bugå·²å…¨éƒ¨ä¿®å¤æˆ–ç¡®è®¤å®‰å…¨ï¼š

- âœ… **28å¤„çº¿ç¨‹å®‰å…¨é—®é¢˜** - å·²åœ¨ä¹‹å‰ç‰ˆæœ¬ä¿®å¤
- âœ… **9å¤„async voidå¼‚å¸¸** - å·²åœ¨ä¹‹å‰ç‰ˆæœ¬ä¿®å¤
- âœ… **15+å¤„é™æ€ç¼“å­˜æ³„æ¼** - å·²æ·»åŠ LRUå’Œå¤§å°é™åˆ¶
- âœ… **Texture2Dæ³„æ¼** - å·²æ·»åŠ é”€æ¯é€»è¾‘
- âœ… **å®šæœŸæ¸…ç†æœºåˆ¶** - å·²é›†æˆåˆ°æ¸¸æˆå¾ªç¯

### ç¨³å®šæ€§æå‡

ä¿®å¤è¿™äº›é—®é¢˜åï¼Œæ¨¡ç»„çš„ç¨³å®šæ€§å°†**å¤§å¹…æå‡**ï¼š

- ğŸŸ¢ **æ— éšæœºå´©æºƒ**ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
- ğŸŸ¢ **æ— å†…å­˜æ³„æ¼**ï¼ˆç¼“å­˜æ¸…ç†ï¼‰
- ğŸŸ¢ **æ— GPUæ³„æ¼**ï¼ˆçº¹ç†é”€æ¯ï¼‰
- ğŸŸ¢ **é•¿æœŸè¿è¡Œç¨³å®š**ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰

### ä¸‹ä¸€æ­¥å»ºè®®

1. **æµ‹è¯•éªŒè¯** - æŒ‰ç…§æµ‹è¯•å»ºè®®è¿›è¡Œå…¨é¢æµ‹è¯•
2. **æ€§èƒ½ç›‘æ§** - ä½¿ç”¨Unity Profilerç›‘æ§é•¿æœŸè¿è¡Œ
3. **ç”¨æˆ·åé¦ˆ** - æ”¶é›†å®é™…ä½¿ç”¨ä¸­çš„åé¦ˆ
4. **æ–‡æ¡£æ›´æ–°** - æ›´æ–°Modæ–‡æ¡£è¯´æ˜ä¼˜åŒ–å†…å®¹

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [BUG_ANALYSIS_REPORT.md](BUG_ANALYSIS_REPORT.md) - åŸå§‹bugåˆ†ææŠ¥å‘Š
- [BUGFIX_PATCHES.md](BUGFIX_PATCHES.md) - è¯¦ç»†ä¿®å¤ä»£ç ç¤ºä¾‹

---

**ä¿®å¤å®Œæˆ** âœ…  
**ç‰ˆæœ¬**: v1.6.76  
**æ—¥æœŸ**: 2025-12-27