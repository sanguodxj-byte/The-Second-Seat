# ?? 人格立绘缺失问题诊断与解决方案

## ? 问题诊断

### 发现的问题

```
?? Textures/UI/Narrators/
└── README.md (4.5 KB)  ? 只有说明文件，无立绘图片
```

**预期文件**:
```
?? Textures/UI/Narrators/
├── Cassandra.png      ? 缺失
├── Phoebe.png         ? 缺失
├── Randy.png          ? 缺失
├── Igor.png           ? 缺失
├── Luna.png           ? 缺失
└── README.md          ? 存在
```

### 人格定义检查

| 人格名称 | DefName | portraitPath | 状态 |
|---------|---------|--------------|------|
| Cassandra Classic | Cassandra_Classic | UI/Narrators/Cassandra | ? 立绘缺失 |
| Phoebe Chillax | Phoebe_Chillax | UI/Narrators/Phoebe | ? 立绘缺失 |
| Randy Random | Randy_Random | UI/Narrators/Randy | ? 立绘缺失 |
| Igor Invader | Igor_Invader | UI/Narrators/Igor | ? 立绘缺失 |
| Luna Protector | Luna_Protector | UI/Narrators/Luna | ? 立绘缺失 |

---

## ?? 根本原因

1. **立绘文件从未创建或部署**
   - 项目中可能只有占位符
   - 实际立绘图片未放入正确目录

2. **PortraitLoader 回退机制**
   ```csharp
   // 当立绘不存在时，使用占位符
   if (texture == null)
   {
       texture = GeneratePlaceholderTexture(persona.primaryColor);
   }
   ```
   - 所有人格使用相同的占位符颜色
   - 导致"看起来都一样"

---

## ? 解决方案

### 方案 1：放置真实立绘（推荐）

#### 步骤 1：准备立绘图片

为每个人格准备一张立绘图片：

| 文件名 | 尺寸 | 格式 | 建议内容 |
|-------|------|------|---------|
| `Cassandra.png` | 512x512+ | PNG | 蓝色系，专业女性形象 |
| `Phoebe.png` | 512x512+ | PNG | 橙黄色系，温和友善形象 |
| `Randy.png` | 512x512+ | PNG | 红色系，混乱狂野形象 |
| `Igor.png` | 512x512+ | PNG | 深红色系，严厉冷酷形象 |
| `Luna.png` | 512x512+ | PNG | 浅蓝色系，守护天使形象 |

#### 步骤 2：放置文件

```powershell
# 将立绘图片复制到正确位置
Copy-Item "你的立绘文件夹\Cassandra.png" `
    -Destination "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\"

# 对所有人格重复此操作
```

#### 步骤 3：验证

```powershell
# 检查文件
Get-ChildItem "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators" -File
```

---

### 方案 2：改进占位符（临时方案）

如果暂时无法提供真实立绘，改进占位符生成：

```csharp
// 修改 PortraitLoader.cs 的 GeneratePlaceholderTexture 方法

private static Texture2D GeneratePlaceholderTexture(Color primaryColor, string defName)
{
    int size = 512;
    var texture = new Texture2D(size, size, TextureFormat.RGBA32, false);
    
    // 1. 渐变背景（而非纯色）
    for (int y = 0; y < size; y++)
    {
        float t = y / (float)size;
        Color gradientColor = Color.Lerp(primaryColor * 0.5f, primaryColor, t);
        
        for (int x = 0; x < size; x++)
        {
            texture.SetPixel(x, y, gradientColor);
        }
    }
    
    // 2. 添加人格标识（绘制文字或图案）
    // 例如：在中心绘制人格名称首字母
    DrawLetterOnTexture(texture, defName[0], size / 2, size / 2, Color.white);
    
    texture.Apply();
    return texture;
}

private static void DrawLetterOnTexture(Texture2D texture, char letter, int centerX, int centerY, Color color)
{
    // 简单的像素字体绘制
    // 这里可以用预定义的字母像素图案
    int size = 100;
    for (int y = -size/2; y < size/2; y++)
    {
        for (int x = -size/2; x < size/2; x++)
        {
            // 绘制字母形状（需要实现字母像素数据）
            if (IsLetterPixel(letter, x + size/2, y + size/2))
            {
                texture.SetPixel(centerX + x, centerY + y, color);
            }
        }
    }
}
```

---

### 方案 3：使用多模态AI生成立绘

如果你配置了多模态AI（OpenAI/Gemini），可以：

1. **使用 DALL-E 生成立绘**（需要 OpenAI API）
2. **使用 Imagen 生成立绘**（需要 Google API）
3. **或手动使用 Stable Diffusion 等工具生成**

**提示词示例**:

```
Cassandra Classic:
"Professional female narrator character, blue theme, strategic and calm expression,
digital art style, portrait view, 512x512, transparent background"

Phoebe Chillax:
"Friendly warm female narrator, orange-yellow theme, gentle caring expression,
anime style, portrait view, 512x512, transparent background"

Randy Random:
"Chaotic wild character, red theme, mischievous grin, playful expression,
comic style, portrait view, 512x512, transparent background"

Igor Invader:
"Dark stern male narrator, deep red theme, cruel intimidating expression,
dark fantasy style, portrait view, 512x512, transparent background"

Luna Protector:
"Guardian angel female, light blue theme, protective caring expression,
ethereal fantasy style, portrait view, 512x512, transparent background"
```

---

## ?? 验证清单

完成后检查：

- [ ] 每个人格都有对应的 .png 文件
- [ ] 文件大小 > 10 KB（真实图片）
- [ ] 在游戏中切换人格时，立绘确实不同
- [ ] 立绘颜色与 `primaryColor` 定义匹配
- [ ] 占位符仅在立绘缺失时显示

---

## ??? 快速验证脚本

```powershell
# 检查立绘完整性
$narratorPath = "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators"
$expectedFiles = @("Cassandra.png", "Phoebe.png", "Randy.png", "Igor.png", "Luna.png")

Write-Host "`n?? 立绘文件检查：" -ForegroundColor Yellow
Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan

foreach ($file in $expectedFiles) {
    $fullPath = Join-Path $narratorPath $file
    if (Test-Path $fullPath) {
        $size = (Get-Item $fullPath).Length
        $sizeKB = [math]::Round($size / 1KB, 2)
        
        if ($sizeKB > 10) {
            Write-Host "  ? $file ($sizeKB KB)" -ForegroundColor Green
        } else {
            Write-Host "  ??  $file ($sizeKB KB) - 可能是占位符" -ForegroundColor Yellow
        }
    } else {
        Write-Host "  ? $file - 缺失" -ForegroundColor Red
    }
}

Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
```

---

## ?? 推荐操作顺序

1. **立即行动**：使用方案2改进占位符，让不同人格至少在颜色上有区别
2. **短期目标**：准备或生成5个人格的立绘图片
3. **长期优化**：设计独特的高质量立绘

---

## ?? 注意事项

### 文件命名规范

- 文件名必须与 `portraitPath` 最后一段匹配
- 例如：`UI/Narrators/Cassandra` → `Cassandra.png`
- **大小写敏感**（在某些系统上）

### 图片规格建议

| 属性 | 建议值 | 说明 |
|------|-------|------|
| 尺寸 | 512x512 或更大 | 高分辨率 |
| 格式 | PNG（Alpha通道） | 支持透明背景 |
| 文件大小 | 50KB - 500KB | 平衡质量和性能 |
| 色彩模式 | RGBA | 支持透明度 |

---

**状态**: ?? 问题已确认  
**影响**: 所有人格使用相同占位符  
**优先级**: 中（影响视觉效果但不影响功能）

