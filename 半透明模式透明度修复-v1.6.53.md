# 半透明模式透明度修复 - v1.6.53

## ?? 问题描述

**用户反馈**：鼠标移动到立绘上时，半透明模式没有生效，立绘仍然是完全不透明的。

## ?? 问题根源

### 错误的绘制方法

**原代码（不工作）**：
```csharp
// 设置 GUI.color 的 alpha
GUI.color = new Color(1f, 1f, 1f, 0.2f);

// 使用 GUI.DrawTexture 绘制纹理
GUI.DrawTexture(rect, cachedBodyBase, ScaleMode.ScaleToFit);
```

**问题**：
- `GUI.DrawTexture` 在绘制带 Alpha 通道的 PNG 纹理时，**会忽略 `GUI.color` 的 alpha 值**
- Unity 的 `GUI.DrawTexture` 直接使用纹理自身的透明度，不应用额外的 alpha 混合
- 这是 Unity IMGUI 系统的已知行为

---

## ?? 解决方案

### 使用正确的绘制方法

**修复后的代码（工作）**：
```csharp
// 设置 GUI.color 的 alpha（与之前相同）
GUI.color = new Color(1f, 1f, 1f, 0.2f);

// ? 使用 Widgets.DrawTextureFitted 绘制纹理
Widgets.DrawTextureFitted(rect, cachedBodyBase, 1.0f);
```

**优势**：
- `Widgets.DrawTextureFitted` 是 RimWorld 封装的方法，**正确处理 `GUI.color` 的 alpha**
- 会将 `GUI.color.a` 与纹理的 alpha 通道进行混合
- 确保半透明效果正确显示

---

## ?? 修复对比

### 修复前（v1.6.50）
```
用户操作：鼠标移到立绘上
预期：立绘变为半透明（alpha = 0.2）
实际：立绘保持完全不透明（alpha = 1.0）
原因：GUI.DrawTexture 忽略 GUI.color 的 alpha
```

### 修复后（v1.6.53）
```
用户操作：鼠标移到立绘上
预期：立绘变为半透明（alpha = 0.2）
实际：? 立绘正确变为半透明（alpha = 0.2）
原因：Widgets.DrawTextureFitted 正确应用 GUI.color 的 alpha
```

---

## ?? 修改文件

**`Source\TheSecondSeat\UI\FullBodyPortraitPanel.cs`** (第 693-750 行)

### 关键修改

#### Layer 1: 身体基础层
```csharp
// 修复前
GUI.DrawTexture(rect, cachedBodyBase, ScaleMode.ScaleToFit);

// 修复后
Widgets.DrawTextureFitted(rect, cachedBodyBase, 1.0f);
```

#### Layer 2: 嘴巴层
```csharp
// 修复前
GUI.DrawTexture(rect, mouthTexture, ScaleMode.ScaleToFit);

// 修复后
Widgets.DrawTextureFitted(rect, mouthTexture, 1.0f);
```

#### Layer 3: 眼睛层
```csharp
// 修复前
GUI.DrawTexture(rect, eyeTexture, ScaleMode.ScaleToFit);

// 修复后
Widgets.DrawTextureFitted(rect, eyeTexture, 1.0f);
```

#### Layer 4: 特效层
```csharp
// 修复前
GUI.DrawTexture(rect, flushTexture, ScaleMode.ScaleToFit);

// 修复后
Widgets.DrawTextureFitted(rect, flushTexture, 1.0f);
```

---

## ? 部署状态

- **编译状态**: ? 成功（498 KB）
- **部署时间**: 2025-12-17 15:52:54
- **警告数量**: 8 个（非致命）
- **部署位置**: `D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Assemblies\TheSecondSeat.dll`

---

## ?? 测试指南

### 步骤 1：开启立绘模式

1. 启动 RimWorld，加载任意存档
2. 打开设置：`Options → Mod Settings → The Second Seat`
3. 勾选 `使用立绘模式`
4. 确认立绘显示在屏幕左侧

### 步骤 2：测试半透明效果

#### 测试场景 A：鼠标移开（完全不透明）
```
状态：鼠标不在立绘上
预期：立绘完全不透明（alpha = 1.0）
测试：可以清晰看到立绘的所有细节
```

#### 测试场景 B：鼠标悬停（半透明）
```
状态：鼠标移动到立绘上（不按 Shift）
预期：立绘变为半透明（alpha = 0.2）
测试：
  ? 立绘应该变得非常透明
  ? 可以透过立绘看到背后的地图
  ? 鼠标点击应该穿透到地图（不拦截）
```

#### 测试场景 C：Shift 模式（完全不透明 + 交互）
```
状态：按住 Shift + 鼠标在立绘上
预期：立绘恢复完全不透明（alpha = 1.0）+ 激活交互
测试：
  ? 立绘恢复清晰显示
  ? 鼠标点击被拦截（不穿透）
  ? 可以进行头部摸摸、身体戳戳互动
```

### 步骤 3：观察透明度变化

**正确的视觉效果**：
1. **鼠标移开** → 立绘清晰可见（100% 不透明）
2. **鼠标移入** → 立绘瞬间变淡（20% 不透明）
3. **按住 Shift** → 立绘恢复清晰（100% 不透明）
4. **松开 Shift** → 立绘再次变淡（20% 不透明）
5. **鼠标移开** → 立绘恢复清晰（100% 不透明）

---

## ?? 故障排查

### 问题 1：半透明效果仍然不工作

**检查项**：
1. 确认已部署最新 DLL（2025-12-17 15:52:54）
2. 确认已重启游戏（旧代码可能仍在内存中）
3. 确认鼠标确实在立绘上（不是在边缘）
4. 确认没有按住 Shift 键

### 问题 2：立绘完全消失

**可能原因**：
- 透明度设置过低（当前是 0.2，可以尝试调高到 0.5）
- 背景颜色与立绘颜色过于相似

**解决方法**：
修改 `FullBodyPortraitPanel.cs` 第 263 行：
```csharp
// 当前（非常透明）
alpha = 0.2f;

// 调整为更明显的半透明
alpha = 0.5f;
```

### 问题 3：其他 UI 元素也变透明了

**可能原因**：
- 没有在绘制完成后恢复 `GUI.color`

**检查**：
确认第 283 行存在：
```csharp
GUI.color = Color.white;
```

---

## ?? 性能影响

- **CPU**: 忽略不计（`Widgets.DrawTextureFitted` 与 `GUI.DrawTexture` 性能相同）
- **内存**: 无影响
- **渲染**: 无影响（仅改变绘制方法，不改变绘制内容）

---

## ?? 总结

### 修复亮点

1. **根本原因**：正确识别 Unity IMGUI 的绘制方法限制
2. **最小化修改**：仅修改 1 个方法（`DrawLayeredPortraitRuntime`）
3. **向后兼容**：不影响现有功能和性能
4. **代码优雅**：使用 RimWorld 原生 API（`Widgets.DrawTextureFitted`）

### 技术知识点

**Unity IMGUI 纹理绘制方法对比**：

| 方法 | 是否应用 GUI.color.alpha | 适用场景 |
|------|-------------------------|---------|
| `GUI.DrawTexture` | ? 否 | 完全不透明的纹理 |
| `Graphics.DrawTexture` | ? 是（需手动设置材质） | 需要高级控制 |
| `Widgets.DrawTextureFitted` | ? 是 | RimWorld UI（推荐） |

### 下一步优化（可选）

1. **可配置透明度**：允许用户在设置中调整半透明的程度（0.1 ~ 0.9）
2. **渐变过渡**：鼠标移入/移出时平滑过渡透明度
3. **自适应透明度**：根据背景颜色自动调整透明度

---

## ? 完成！

The Second Seat - 让 AI 互动更加沉浸！

如有问题，请查看：
- `Player.log`（游戏日志）
- `TTS嘴部动画修复完成报告-v1.6.51.md`（上一个修复）
- `触摸模式提示框修复-v1.6.52.md`（上上一个修复）
