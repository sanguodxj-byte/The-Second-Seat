# 网络搜索功能说明

## ?? 功能概述

叙事者现在可以访问互联网，获取实时信息来回答您的问题！当您询问需要最新信息或外部知识的问题时，AI 会自动搜索网络并整合结果到回复中。

---

## ? 核心特性

### 1. **自动搜索触发**
系统会自动检测以下关键词，判断是否需要联网搜索：

**中文关键词**：
- 搜索、查找、什么是、谁是、如何、怎么
- 最新、新闻、当前、现在

**英文关键词**：
- search, find, what is, who is, how to
- latest, news, current, recent

**示例**：
```
玩家: "最新的 RimWorld 更新内容是什么？"
→ 系统自动触发搜索

玩家: "如何高效种植作物？"
→ 系统自动触发搜索

玩家: "帮我收获作物"
→ 不触发搜索（游戏内命令）
```

### 2. **支持三种搜索引擎**

| 搜索引擎 | 优点 | 缺点 | 成本 | 推荐场景 |
|---------|------|------|------|---------|
| **DuckDuckGo** | 免费，无需 API Key，隐私保护 | 结果较少，即时回答为主 | 免费 | 默认推荐，新手友好 |
| **Bing** | 结果丰富，响应快 | 需要 API Key | 免费额度 1000次/月 | 中高频使用 |
| **Google** | 结果最全，最准确 | 需要 API Key + Search Engine ID | 免费额度 100次/天 | 需要高质量结果 |

### 3. **智能结果整合**
- 自动提取标题、摘要和来源链接
- 最多返回 3-5 个最相关结果
- 限制总长度 ≤ 800 字符（节省 Token）
- 格式化后注入到 LLM 上下文

### 4. **搜索缓存**
- 相同查询 60 分钟内使用缓存
- 最多缓存 100 条搜索结果
- 减少 API 调用和等待时间

---

## ?? 配置指南

### 方案 1：DuckDuckGo（推荐新手）

**优点**：零配置，完全免费

**步骤**：
1. 打开游戏 → 选项 → 模组设置 → The Second Seat
2. 勾选"启用网络搜索"
3. 选择"DuckDuckGo (免费，无需 API Key)"
4. 点击"应用"

**完成！** 现在就可以使用。

---

### 方案 2：Bing（推荐中高频用户）

**优点**：结果丰富，免费额度充足（1000次/月）

**步骤**：

#### 1. 获取 Bing API Key
1. 访问 [Bing Web Search API](https://www.microsoft.com/en-us/bing/apis/bing-web-search-api)
2. 点击"开始免费试用"（需要 Microsoft 账号）
3. 创建资源：
   - 订阅：选择免费层（Free F1）
   - 区域：选择离您最近的区域
4. 创建后，在"密钥和终结点"中复制 **Key 1**

#### 2. 配置模组
1. 打开游戏 → 选项 → 模组设置 → The Second Seat
2. 勾选"启用网络搜索"
3. 选择"Bing (需要 API Key)"
4. 粘贴您的 API Key
5. 点击"应用"

**限制**：
- 免费层：1000 次/月
- 超出后：$7/1000 次

---

### 方案 3：Google（推荐高质量需求）

**优点**：结果最准确，最全面

**步骤**：

#### 1. 获取 Google API Key
1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 创建新项目（或选择现有项目）
3. 启用 API：
   - 搜索"Custom Search API"
   - 点击"启用"
4. 创建凭据：
   - APIs & Services → 凭据 → 创建凭据 → API 密钥
   - 复制生成的 API Key

#### 2. 创建自定义搜索引擎
1. 访问 [Programmable Search Engine](https://programmablesearchengine.google.com/)
2. 点击"添加"
3. 配置：
   - 搜索内容：整个网络
   - 名称：随意（如"RimWorld Search"）
4. 创建后，复制 **Search Engine ID**（cx 参数）

#### 3. 配置模组
1. 打开游戏 → 选项 → 模组设置 → The Second Seat
2. 勾选"启用网络搜索"
3. 选择"Google (需要 API Key)"
4. 粘贴您的 API Key
5. 粘贴您的 Search Engine ID
6. 点击"应用"

**限制**：
- 免费层：100 次/天
- 超出后：$5/1000 次

---

## ?? 使用示例

### 示例 1：查询游戏信息

**对话**：
```
玩家: "RimWorld 1.5 版本有什么新特性？"

[系统自动搜索]
搜索引擎: DuckDuckGo
搜索结果: 3 个

AI 回复:
"根据最新信息，RimWorld 1.5 'Anomaly' 版本的主要新特性包括：
1. 新的异常生物和事件系统
2. 实体检测设备和研究内容
3. 改进的恐怖氛围机制

这些新内容可能会对你的殖民地带来全新的挑战哦！需要我帮你准备应对策略吗？"
```

---

### 示例 2：实时新闻

**对话**：
```
玩家: "最近有什么 RimWorld 模组推荐吗？"

[系统自动搜索]
搜索引擎: Bing
搜索结果: 5 个

AI 回复:
"我找到了一些最近热门的 RimWorld 模组：
1. **Vanilla Expanded 系列** - 扩展游戏内容但保持原版风格
2. **Combat Extended** - 彻底改革战斗系统
3. **Dubs Bad Hygiene** - 添加卫生需求系统

根据你当前殖民地的情况（{当前状态}），我建议先试试 Vanilla Expanded，
它不会打乱现有的游戏平衡~"
```

---

### 示例 3：知识查询

**对话**：
```
玩家: "什么是水培种植？在 RimWorld 里怎么用？"

[系统自动搜索]
搜索引擎: Google
搜索结果: 3 个

AI 回复:
"水培种植是一种无土栽培技术，植物通过营养液直接吸收养分。

在 RimWorld 中，水培盆有以下特点：
- 种植速度比土壤快 280%
- 需要持续供电
- 占地面积小，适合室内种植
- 不受土壤肥力影响

你当前的电力充足，我可以帮你规划一个水培农场吗？"
```

---

### 示例 4：游戏攻略

**对话**：
```
玩家: "如何高效防御机械族袭击？"

[系统自动搜索]
搜索引擎: DuckDuckGo
搜索结果: 4 个

AI 回复:
"根据玩家们的经验，防御机械族的有效策略包括：

**1. 防御布局**
- 使用狭窄通道和掩体
- 设置多层防线
- EMP 陷阱非常有效

**2. 武器选择**
- 优先使用 EMP 手榴弹
- 狙击步枪攻击高价值目标
- 避免近战

看你的殖民地布局({当前布局})，我建议在主入口增加掩体。需要我帮你指定建造吗？"
```

---

## ?? 性能影响

### Token 使用

| 场景 | 无搜索 | 有搜索（3个结果） | 增加量 |
|-----|-------|-----------------|-------|
| 简单查询 | 1800 tokens | 2200 tokens | +400 |
| 复杂查询 | 1800 tokens | 2400 tokens | +600 |

**估算成本**（GPT-4）：
- 每次搜索增加约 $0.003 - $0.005
- 搜索 API 成本：免费（DuckDuckGo）或 $0.007/次（Bing/Google）

### 响应时间

| 搜索引擎 | 平均耗时 |
|---------|---------|
| DuckDuckGo | +1-2 秒 |
| Bing | +0.5-1 秒 |
| Google | +0.5-1 秒 |
| 缓存命中 | +0 秒 |

---

## ?? 隐私和安全

### DuckDuckGo
- ? 不跟踪用户
- ? 不存储搜索历史
- ? 完全匿名

### Bing / Google
- ?? 会记录 API 调用日志
- ?? 需要 API Key（与您的账号关联）
- ?? 建议：使用独立的 API Key，不要与其他服务共用

### 本地缓存
- 搜索结果缓存在本地内存
- 不会上传到任何服务器
- 游戏关闭后自动清空

---

## ?? 测试和调试

### 测试搜索功能

```csharp
// 在开发控制台中

// 1. 手动触发搜索
var service = TheSecondSeat.WebSearch.WebSearchService.Instance;
var result = await service.SearchAsync("RimWorld tips", maxResults: 3);

Log.Message($"找到 {result.Results.Count} 个结果");
foreach (var item in result.Results)
{
    Log.Message($"  - {item.Title}: {item.Snippet}");
}

// 2. 测试搜索检测
bool shouldSearch = TheSecondSeat.WebSearch.WebSearchService.ShouldSearch("最新的游戏更新");
Log.Message($"需要搜索: {shouldSearch}");

// 3. 清空缓存
service.ClearCache();
```

### 调试日志

启用"调试模式"后，会看到详细日志：

```
[NarratorController] 检测到需要联网搜索: 最新的 RimWorld 更新
[WebSearch] 搜索引擎已配置: duckduckgo
[WebSearch] DuckDuckGo 搜索完成: 最新的 RimWorld 更新 - 3 个结果
[NarratorController] 搜索完成，添加 3 个结果到上下文
```

---

## ?? 常见问题

### Q1: 搜索没有结果？

**检查清单**：
1. 是否勾选"启用网络搜索"？
2. API Key 是否正确配置？（Bing/Google）
3. 网络连接是否正常？
4. 查询是否包含触发关键词？

**解决方法**：
- 查看日志（`Player.log`）中的错误信息
- 尝试切换搜索引擎（DuckDuckGo 最稳定）
- 清空缓存后重试

### Q2: 搜索速度慢？

**优化建议**：
- 使用 Bing/Google（比 DuckDuckGo 快）
- 减少 `maxResults`（默认 3 个）
- 利用缓存（相同查询 60 分钟内免费）

### Q3: API 超出限额？

**Bing**：
- 免费层：1000 次/月
- 超出后可升级到付费层

**Google**：
- 免费层：100 次/天
- 超出后等待次日重置或升级

**建议**：
- 使用 DuckDuckGo（无限制）
- 启用缓存
- 只在必要时启用搜索

### Q4: 搜索结果不准确？

**改进方法**：
- 使用更具体的查询词
- 切换到 Google（结果最准）
- 在 System Prompt 中引导 AI 正确解读搜索结果

---

## ?? 高级定制

### 自定义搜索触发逻辑

编辑 `WebSearchService.cs` 中的 `ShouldSearch` 方法：

```csharp
public static bool ShouldSearch(string query)
{
    var lowerQuery = query.ToLower();

    // 添加自定义关键词
    var customTriggers = new[]
    {
        "百科", "维基", "wiki",
        "教程", "tutorial",
        "攻略", "guide"
    };

    return searchTriggers.Concat(customTriggers)
        .Any(trigger => lowerQuery.Contains(trigger));
}
```

### 调整结果数量和长度

编辑 `NarratorController.cs`：

```csharp
// 修改最大结果数（默认 3）
var searchResult = await WebSearchService.Instance.SearchAsync(userMessage, maxResults: 5);

// 修改上下文长度（默认 800 字符）
searchContext = WebSearchService.FormatResultsForContext(searchResult, maxLength: 1200);
```

### 添加新的搜索引擎

编辑 `WebSearchService.cs`，添加新方法：

```csharp
private async Task<SearchResult?> SearchMyEngineAsync(string query, int maxResults)
{
    // 实现您的搜索引擎 API 调用
    // ...
}
```

然后在 `SearchAsync` 中添加分支：

```csharp
SearchResult? result = searchEngine switch
{
    // ...existing engines...
    "myengine" => await SearchMyEngineAsync(query, maxResults),
    _ => await SearchDuckDuckGoAsync(query, maxResults)
};
```

---

## ?? 数据统计

启用搜索后，您可以查看统计信息：

```csharp
// 在开发控制台

var service = TheSecondSeat.WebSearch.WebSearchService.Instance;
// 统计功能需要手动添加计数器
```

---

## ?? 相关文档

- [完整使用手册.md](完整使用手册.md) - 系统总览
- [ARCHITECTURE.md](ARCHITECTURE.md) - 架构设计
- [好感度系统说明.md](好感度系统说明.md) - 好感度机制

---

**版本**: 1.0.0  
**最后更新**: 2024  
**维护者**: TheSecondSeat 开发团队

**特别提示**：网络搜索功能可能会消耗额外的 Token 和 API 调用次数，请根据您的使用情况合理配置。
