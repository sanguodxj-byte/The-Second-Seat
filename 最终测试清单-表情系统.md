# ?? The Second Seat - 最终测试清单

## ? 已完成的修复

### 1. **Sideria 人格定义**
- ? 创建 `Sideria.xml` 人格定义
- ? 部署到游戏 Mod 目录
- ? 使用 UTF-8 无 BOM 编码（避免 VS 崩溃）

### 2. **调试按钮集成**
- ? 在 `NarratorWindow` 中添加"表情调试"按钮
- ? 在 `NarratorWindow` 中添加"好感度调试"按钮
- ? 按钮位于左侧边栏，"指令列表"下方

### 3. **立绘和表情文件**
- ? 部署 Sideria 基础立绘 (base.png)
- ? 部署 7 个表情差分文件
- ? 部署 5 个服装差分文件
- ? 所有材质文件已复制到游戏目录

### 4. **代码修复**
- ? 文件复制重试逻辑（处理文件被占用）
- ? 编译成功（0 errors, 0 warnings）
- ? DLL 已部署到游戏目录

---

## ?? 测试步骤

### 第一步：重启游戏
```
1. 完全退出 RimWorld（如果正在运行）
2. 等待 5 秒确保所有进程结束
3. 重新启动 RimWorld
4. 启用 The Second Seat Mod
5. 开始新游戏或加载存档
```

### 第二步：打开 AI 对话窗口
```
1. 点击屏幕右上角的 AI 按钮
2. 或使用快捷键（如果已配置）
3. 确认 NarratorWindow 正常打开
```

### 第三步：测试调试按钮
```
1. 在左侧边栏找到以下按钮：
   - 切换人格
   - 状态汇报
   - 指令列表
   ? 表情调试  ← 新按钮
   ? 好感度调试 ← 新按钮
   - 清空聊天

2. 点击"表情调试"按钮
   - 应该打开表情调试窗口
   - 显示 Sideria 的立绘预览
   - 显示表情列表

3. 点击表情列表中的任意表情
   - 观察立绘预览是否变化
   - 查看日志窗口输出
```

### 第四步：验证表情切换
```
在表情调试窗口中测试：

? Happy (开心) - 点击应该切换到 happy.png
? Sad (悲伤) - 点击应该切换到 sad.png
? Angry (愤怒) - 点击应该切换到 angry.png
? Surprised (惊讶) - 点击应该切换到 surprised.png
? Thoughtful (沉思) - 点击应该切换到 thoughtful.png
? Annoyed (烦躁) - 点击应该切换到 annoyed.png
? Smug (得意) - 点击应该切换到 smug.jpg
?? Worried (担忧) - 文件缺失
?? Disappointed (失望) - 文件缺失
```

### 第五步：检查日志输出
```
打开 Dev Mode → Logs 窗口，查找：

期望看到的日志：
? [ExpressionSystem] Sideria_Default 表情切换: Neutral → Happy (触发: Manual)
? [PortraitLoader] 加载立绘: UI/Narrators/9x16/Expressions/Sideria/happy
? [ExpressionSystem] 成功切换表情

不应该看到的错误：
? 找不到文件
? 无法加载纹理
? NullReferenceException
```

### 第六步：测试好感度调试
```
1. 点击"好感度调试"按钮
2. 应该打开好感度调试窗口
3. 测试快速调整按钮：
   - +100 / -100
   - +10 / -10
4. 测试等级设置按钮：
   - 憎恨 / 敌意 / 疏远 / 冷淡
   - 温暖 / 倾心 / 爱慕 / 魂之友
```

---

## ?? 已知问题

### 缺失的表情文件
```
?? worried.png - 担忧表情
?? disappointed.png - 失望表情

解决方案：
1. 创建这两个表情的立绘
2. 放置到 Textures\UI\Narrators\9x16\Expressions\Sideria\
3. 重新运行部署脚本
```

### 立绘路径问题
```
当前配置：
- Sideria.xml 中: <portraitPath>UI/Narrators/9x16/Sideria/base</portraitPath>
- 表情路径: UI/Narrators/9x16/Expressions/Sideria/{expression}

确认游戏中能正确加载：
? 基础立绘
? 表情差分
? 服装差分
```

---

## ?? 故障排查

### 问题 1: 表情调试按钮不存在
**原因**: DLL 未正确部署或游戏未重启

**解决**:
```powershell
# 重新部署
.\Deploy-Complete.ps1

# 确认 DLL 文件日期
Get-Item "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Assemblies\TheSecondSeat.dll" | 
  Select-Object LastWriteTime
```

### 问题 2: 点击表情没有反应
**原因**: 
- ExpressionSystem.SetExpression() 未被调用
- 人格 defName 不匹配
- 表情文件路径错误

**解决**:
```
1. 查看日志输出
2. 确认人格 defName 是 "Sideria_Default"
3. 检查表情文件是否存在
```

### 问题 3: 立绘不显示
**原因**: 文件路径或格式问题

**解决**:
```powershell
# 验证立绘文件
Get-ChildItem "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\9x16\Sideria\" -Recurse
Get-ChildItem "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\9x16\Expressions\Sideria\" -Recurse
```

---

## ?? 文件清单

### 已部署的文件

#### DLL
```
? Assemblies\TheSecondSeat.dll (0.29 MB)
```

#### 人格定义
```
? Defs\NarratorPersonaDefs\Sideria.xml
```

#### 立绘文件
```
? Textures\UI\Narrators\9x16\Sideria\base.png (11.1 MB)
```

#### 表情差分
```
? Textures\UI\Narrators\9x16\Expressions\Sideria\happy.png (9.3 MB)
? Textures\UI\Narrators\9x16\Expressions\Sideria\sad.png (13.08 MB)
? Textures\UI\Narrators\9x16\Expressions\Sideria\angry.png (9.27 MB)
? Textures\UI\Narrators\9x16\Expressions\Sideria\surprised.png (11.66 MB)
? Textures\UI\Narrators\9x16\Expressions\Sideria\thoughtful.png (9.29 MB)
? Textures\UI\Narrators\9x16\Expressions\Sideria\annoyed.png (9.37 MB)
? Textures\UI\Narrators\9x16\Expressions\Sideria\smug.jpg (1.27 MB)
?? worried.png - 缺失
?? disappointed.png - 缺失
```

#### 服装差分
```
? Textures\UI\Narrators\9x16\Sideria\Outfits\neutral_1.png (11.1 MB)
? Textures\UI\Narrators\9x16\Sideria\Outfits\warm_1.png (12.91 MB)
? Textures\UI\Narrators\9x16\Sideria\Outfits\intimate_1.png (12.63 MB)
? Textures\UI\Narrators\9x16\Sideria\Outfits\devoted_1.png (9.17 MB)
? Textures\UI\Narrators\9x16\Sideria\Outfits\devoted_2.png (11.5 MB)
```

---

## ?? 成功标准

### 表情系统
- ? 表情调试窗口正常打开
- ? 点击表情能实时切换立绘
- ? 日志显示正确的切换信息
- ? 没有错误或异常

### 好感度系统
- ? 好感度调试窗口正常打开
- ? 快速调整按钮功能正常
- ? 等级设置按钮功能正常
- ? 进度条实时更新

### 立绘系统
- ? 基础立绘正常显示
- ? 表情差分能正确加载
- ? 服装差分能正确加载
- ? 没有材质丢失

---

## ?? 下一步

### 立即测试
```
1. 重启 RimWorld
2. 加载游戏
3. 打开 AI 对话窗口
4. 测试所有调试功能
5. 报告结果
```

### 补充缺失文件
```
如果需要 worried 和 disappointed 表情：
1. 创建立绘文件
2. 放置到正确目录
3. 运行 .\Deploy-Complete.ps1
4. 重启游戏测试
```

### 优化建议
```
1. 添加表情切换动画
2. 实现表情自动恢复（3秒后回到 Neutral）
3. 根据好感度自动切换表情
4. 添加更多表情类型
```

---

## ?? 总结

? **修复完成**:
1. Sideria 人格定义已创建并部署
2. 表情调试按钮已添加到 NarratorWindow
3. 好感度调试按钮已添加到 NarratorWindow
4. 文件复制重试逻辑已实现
5. 所有材质文件已部署

?? **待补充**:
1. worried.png (担忧表情)
2. disappointed.png (失望表情)

?? **准备就绪**: 重启游戏即可测试！
