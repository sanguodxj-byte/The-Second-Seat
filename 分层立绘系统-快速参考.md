# 分层立绘系统 - 快速参考 v1.6.20

## ?? 核心概念

**分层立绘系统** = 将立绘拆分为多个图层（身体、服装、表情、头发等），运行时动态合成。

**优势**:
- 减少美术文件数量（26MB → 4MB）
- 支持服装更换和表情组合
- 只需绘制变化的部分（如面部表情）

---

## ?? 目录结构

```
Textures/UI/Narrators/9x16/Layers/{人格名称}/
├── body.png                    # 身体层（必需）
├── outfit_default.png          # 默认服装层
├── face_neutral.png            # 中性表情（必需）
├── face_happy.png              # 开心表情
├── face_sad.png                # 悲伤表情
├── hair.png                    # 头发层
├── accessories.png             # 配饰层
└── fx.png                      # 特效层
```

**最小配置**（仅需2个文件）:
```
Sideria/
├── body.png          # 身体（必需）
└── face_neutral.png  # 中性表情（必需）
```

---

## ?? XML 配置

在 `Defs/NarratorPersonaDefs.xml` 中启用:

```xml
<NarratorPersonaDef>
  <defName>Sideria_Default</defName>
  <narratorName>Sideria</narratorName>
  
  <!-- ? 启用分层立绘系统 -->
  <useLayeredPortrait>true</useLayeredPortrait>
  
  <!-- 其他配置... -->
</NarratorPersonaDef>
```

---

## ?? 图层类型和优先级

| 图层类型 | 优先级 | 必需 | 说明 |
|:---------|:-------|:-----|:-----|
| Background | 0 | ? | 背景光晕（30%不透明度） |
| Body | 10 | ? | 身体和皮肤 |
| Outfit | 20 | ? | 服装（可更换） |
| Face | 30 | ? | 表情（根据情绪切换） |
| Hair | 40 | ? | 头发 |
| Accessories | 50 | ? | 配饰（眼镜、帽子等） |
| ForegroundFX | 60 | ? | 特效（光效，Additive混合） |
| Overlay | 70 | ? | 覆盖层（UI边框等） |

---

## ?? 代码使用

### 1. **自动加载（推荐）**

```csharp
// 启用分层系统后，PortraitLoader 自动使用分层合成
Texture2D portrait = PortraitLoader.LoadPortrait(def, ExpressionType.Happy);
```

### 2. **手动配置（高级）**

```csharp
// 创建自定义配置
var config = new LayeredPortraitConfig
{
    PersonaDefName = "Sideria_Default"
};

// 添加身体层
config.AddLayer(new LayerDefinition
{
    Type = LayerType.Body,
    Name = "body",
    Priority = 10,
    TexturePath = "UI/Narrators/9x16/Layers/{persona}/body.png",
    Required = true
});

// 添加表情层
config.AddLayer(new LayerDefinition
{
    Type = LayerType.Face,
    Name = "face",
    Priority = 30,
    TexturePath = "UI/Narrators/9x16/Layers/{persona}/face_{expression}.png",
    Required = true
});

// 应用配置
def.SetLayeredConfig(config);
```

### 3. **直接合成**

```csharp
// 使用合成器直接合成
Texture2D composite = LayeredPortraitCompositor.CompositeLayers(
    config, 
    ExpressionType.Happy, 
    "default"
);
```

---

## ?? 支持的表情类型

| 表情类型 | 文件名 | 说明 |
|:---------|:-------|:-----|
| Neutral | `face_neutral.png` | 中性表情（必需） |
| Happy | `face_happy.png` | 开心 |
| Sad | `face_sad.png` | 悲伤 |
| Angry | `face_angry.png` | 愤怒 |
| Surprised | `face_surprised.png` | 惊讶 |
| Worried | `face_worried.png` | 担忧 |
| Smug | `face_smug.png` | 得意 |
| Disappointed | `face_disappointed.png` | 失望 |
| Thoughtful | `face_thoughtful.png` | 沉思 |
| Annoyed | `face_annoyed.png` | 恼怒 |
| Playful | `face_playful.png` | 调皮 |
| Shy | `face_shy.png` | 害羞 |
| Confused | `face_confused.png` | 疑惑 |

---

## ?? 混合模式

| 模式 | 说明 | 适用场景 |
|:-----|:-----|:---------|
| Normal | 标准 Alpha 混合 | 大部分图层 |
| Multiply | 正片叠底（变暗） | 阴影、暗色叠加 |
| Screen | 滤色（变亮） | 高光、亮色叠加 |
| Overlay | 叠加（保留对比） | 纹理叠加 |
| Additive | 加法混合 | 光效、魔法特效 |

---

## ?? 调试和诊断

### 1. **查看配置信息**

```csharp
var config = def.GetLayeredConfig();
Log.Message(config.GetDebugInfo());
```

输出示例:
```
[LayeredPortraitConfig] Sideria_Default
  Output Size: 1024×1572
  Total Layers: 7
  Cache Enabled: True
  Layers:
    ? [0] background (Background)
       Path: UI/Narrators/9x16/Layers/{persona}/background.png
       Blend: Normal, Opacity: 0.3
    ? [10] body (Body) [Required]
       Path: UI/Narrators/9x16/Layers/{persona}/body.png
       Blend: Normal, Opacity: 1
    ...
```

### 2. **查看缓存状态**

```csharp
string stats = LayeredPortraitCompositor.GetCacheStats();
Log.Message(stats);
```

### 3. **清理缓存**

```csharp
// 清除所有缓存
LayeredPortraitCompositor.ClearCache();

// 清除特定人格的缓存
LayeredPortraitCompositor.ClearCache("Sideria_Default");
```

---

## ?? 常见问题

### Q1: 立绘不显示
**A**: 检查以下内容:
1. `useLayeredPortrait=true` 是否设置
2. 文件路径是否正确：`Textures/UI/Narrators/9x16/Layers/Sideria/body.png`
3. 必需图层（body, face_neutral）是否存在

### Q2: 表情不切换
**A**: 检查:
1. 表情文件是否存在：`face_happy.png`（全小写）
2. 文件名是否正确（不是 `face_Happy.png`）
3. 查看开发模式日志

### Q3: 图层错位
**A**: 确保:
1. 所有图层都是 1024×1572 像素
2. 使用相同的画布尺寸导出
3. 图层对齐正确

### Q4: 性能问题
**A**: 优化建议:
1. 确保缓存启用（默认启用）
2. 减少不必要的图层
3. 定期清理缓存

---

## ?? 与完整表情立绘对比

| 特性 | 完整表情立绘 | 分层立绘系统 |
|:-----|:------------|:------------|
| 美术工作量 | 高（每个表情完整绘制） | 低（只绘制面部） |
| 文件数量 | 13个 | 2-8个 |
| 文件大小 | 26MB | 4MB |
| 换装支持 | 困难 | 简单 |
| 灵活性 | 低 | 高 |
| 运行时性能 | 高（直接加载） | 中（需合成，但有缓存） |

---

## ?? 快速开始

### 步骤 1: 准备美术资源
1. 创建 `body.png`（1024×1572）
2. 创建 `face_neutral.png`（1024×1572，透明背景）
3. 放置到 `Textures/UI/Narrators/9x16/Layers/Sideria/`

### 步骤 2: 启用分层系统
在 `Defs/NarratorPersonaDefs.xml` 中添加:
```xml
<useLayeredPortrait>true</useLayeredPortrait>
```

### 步骤 3: 测试
1. 启动游戏
2. 按 F1 打开 AI 叙事者窗口
3. 查看立绘是否正确显示

---

## ?? 相关文件

- **LayerDefinition.cs**: 图层定义类
- **LayeredPortraitCompositor.cs**: 图层合成器
- **PortraitLoader.cs**: 立绘加载器
- **NarratorPersonaDef.cs**: 人格定义
- **Textures/UI/Narrators/9x16/Layers/README.md**: 完整文档

---

## ?? 总结

- ? 减少美术工作量（只绘制变化部分）
- ? 支持服装更换和表情组合
- ? 优化文件大小（26MB → 4MB）
- ? 自动缓存，性能优化
- ? 支持 13 种表情类型
- ? 5 种混合模式（Normal, Multiply, Screen, Overlay, Additive）

**状态**: ? **已完成并编译通过**  
**版本**: v1.6.20  
**时间**: 2025-12-12
