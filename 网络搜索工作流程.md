# 网络搜索工作流程详解

## ?? 完整工作流程

```
玩家输入
    ↓
"最新的 RimWorld 更新是什么？"
    ↓
┌─────────────────────────────────────┐
│  NarratorController                 │
│  - 检测关键词：包含"最新"           │
│  - ShouldSearch() → true            │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  WebSearchService                   │
│  1. 检查缓存（无）                  │
│  2. 调用搜索引擎 API                │
│  3. 解析 JSON 响应                  │
└─────────────────────────────────────┘
    ↓
搜索引擎返回结果
    ↓
┌─────────────────────────────────────┐
│  SearchResult                       │
│  ┌───────────────────────────────┐  │
│  │ Result 1:                     │  │
│  │ Title: "RimWorld 1.5 Update"  │  │
│  │ Snippet: "New anomaly system" │  │
│  │ URL: https://...              │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ Result 2: ...                 │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │ Result 3: ...                 │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
    ↓
格式化为上下文
    ↓
┌─────────────────────────────────────┐
│  LLM Context                        │
│                                     │
│  === 网络搜索结果: "最新的 RimWorld │
│  更新是什么？" (DuckDuckGo) ===     │
│                                     │
│  【RimWorld 1.5 'Anomaly' Update】  │
│  The latest update introduces...    │
│  来源: https://rimworldwiki.com     │
│                                     │
│  【Player Reactions to 1.5】        │
│  Community feedback shows...        │
│  来源: https://reddit.com/r/rimworld│
│                                     │
│  === 搜索结果结束 ===               │
│                                     │
│  + 游戏状态 JSON                    │
│  + 记忆上下文                       │
│  + 玩家消息                         │
└─────────────────────────────────────┘
    ↓
发送到 LLM
    ↓
┌─────────────────────────────────────┐
│  LLM Response                       │
│  {                                  │
│    "thought": "玩家想了解最新更新", │
│    "dialogue": "根据最新信息，      │
│      RimWorld 1.5 带来了全新的      │
│      异常系统和恐怖事件...",        │
│    "command": null                  │
│  }                                  │
└─────────────────────────────────────┘
    ↓
显示给玩家
    ↓
"根据最新信息，RimWorld 1.5 'Anomaly' 
带来了全新的异常系统和恐怖事件..."
```

---

## ?? 实际案例分解

### 案例 1: 知识查询

**输入**:
```
玩家: "什么是水培种植？"
```

**检测**:
```csharp
ShouldSearch("什么是水培种植？")
  → 包含关键词："什么是"
  → 返回: true
```

**搜索（DuckDuckGo API）**:
```http
GET https://api.duckduckgo.com/?q=水培种植&format=json
```

**API 响应**:
```json
{
  "Abstract": "水培是一种不使用土壤，而使用营养液栽培植物的技术...",
  "AbstractURL": "https://zh.wikipedia.org/wiki/水培",
  "Heading": "水培",
  "RelatedTopics": [
    {
      "Text": "水培的优点包括生长速度快、节约水资源...",
      "FirstURL": "https://..."
    }
  ]
}
```

**格式化上下文**:
```
=== 网络搜索结果: "什么是水培种植？" (DuckDuckGo) ===

【水培】
水培是一种不使用土壤，而使用营养液栽培植物的技术。
通过营养液直接为植物根系提供必需的营养元素。
来源: https://zh.wikipedia.org/wiki/水培

【水培的优点】
水培的优点包括生长速度快、节约水资源、不受土壤条件限制。
来源: https://...

=== 搜索结果结束 ===
```

**LLM 生成回复**:
```
"水培种植是一种无土栽培技术，通过营养液直接供给植物养分。

在 RimWorld 中，水培盆的特点是：
- 种植速度比土壤快 280%
- 需要持续供电
- 不受土壤肥力影响

你当前的电力充足（{电力状态}），我可以帮你规划一个
水培农场吗？"
```

---

### 案例 2: 实时新闻

**输入**:
```
玩家: "最近有什么 RimWorld 模组推荐吗？"
```

**检测**:
```csharp
ShouldSearch("最近有什么 RimWorld 模组推荐吗？")
  → 包含关键词："最近"
  → 返回: true
```

**搜索（Bing API）**:
```http
GET https://api.bing.microsoft.com/v7.0/search?q=最近+RimWorld+模组推荐&count=5
Headers:
  Ocp-Apim-Subscription-Key: YOUR_API_KEY
```

**API 响应**:
```json
{
  "webPages": {
    "value": [
      {
        "name": "2024 年最佳 RimWorld 模组推荐",
        "url": "https://...",
        "snippet": "Vanilla Expanded 系列继续保持高人气..."
      },
      {
        "name": "Reddit 社区热议的新模组",
        "url": "https://reddit.com/...",
        "snippet": "Combat Extended Continued 更新了..."
      }
    ]
  }
}
```

**格式化上下文**:
```
=== 网络搜索结果: "最近有什么 RimWorld 模组推荐吗？" (Bing) ===

【2024 年最佳 RimWorld 模组推荐】
Vanilla Expanded 系列继续保持高人气，新增了更多生物群系和职业。
来源: https://...

【Reddit 社区热议的新模组】
Combat Extended Continued 更新了兼容性，支持最新版本。
来源: https://reddit.com/...

=== 搜索结果结束 ===
```

**LLM 生成回复**:
```
"我找到了一些最近热门的 RimWorld 模组：

1. **Vanilla Expanded 系列** - 保持原版风格的扩展内容
2. **Combat Extended Continued** - 已更新兼容最新版本

根据你当前殖民地的发展阶段（{殖民地状态}），
我建议先试试 Vanilla Expanded，它不会破坏游戏平衡~"
```

---

### 案例 3: 复杂查询

**输入**:
```
玩家: "搜索高效的电力网络布局设计"
```

**检测**:
```csharp
ShouldSearch("搜索高效的电力网络布局设计")
  → 包含关键词："搜索"
  → 返回: true
```

**搜索（Google Custom Search API）**:
```http
GET https://www.googleapis.com/customsearch/v1?key=YOUR_KEY&cx=YOUR_CX&q=RimWorld+电力网络布局&num=3
```

**API 响应**:
```json
{
  "items": [
    {
      "title": "RimWorld 电力系统完全指南 - Steam 社区",
      "link": "https://steamcommunity.com/...",
      "snippet": "电力网络的关键是避免长距离传输损耗..."
    },
    {
      "title": "电池室设计最佳实践",
      "link": "https://...",
      "snippet": "将电池集中在一个防火室内，使用自动断路器..."
    }
  ]
}
```

**格式化上下文**:
```
=== 网络搜索结果: "搜索高效的电力网络布局设计" (Google) ===

【RimWorld 电力系统完全指南】
电力网络的关键是避免长距离传输损耗，建议每个区域配置独立的电池组。
来源: https://steamcommunity.com/...

【电池室设计最佳实践】
将电池集中在一个防火室内，使用自动断路器防止短路事故。
来源: https://...

=== 搜索结果结束 ===
```

**LLM 生成回复**:
```
"根据玩家们的经验，高效的电力网络布局要点：

**1. 区域化供电**
每个主要区域（住宅、工业、防御）配置独立电池组，
避免单点故障。

**2. 电池室设计**
- 集中存放电池
- 使用防火材料
- 配置自动断路器

看你的殖民地布局（{当前布局}），建议在这些位置
增加电池室...需要我帮你指定建造吗？"
```

---

## ?? 搜索触发检测逻辑

### 中文关键词检测

```csharp
var chineseKeywords = new[]
{
    "搜索",    // "搜索最新模组"
    "查找",    // "查找攻略"
    "什么是",  // "什么是水培"
    "谁是",    // "谁是最好的叙事者"
    "如何",    // "如何高效种植"
    "怎么",    // "怎么防御袭击"
    "最新",    // "最新的更新"
    "新闻",    // "游戏新闻"
    "当前",    // "当前版本"
    "现在"     // "现在流行什么"
};

foreach (var keyword in chineseKeywords)
{
    if (query.Contains(keyword))
        return true;
}
```

### 英文关键词检测

```csharp
var englishKeywords = new[]
{
    "search",   // "search for tips"
    "find",     // "find best mods"
    "what is",  // "what is hydroponics"
    "who is",   // "who is Cassandra"
    "how to",   // "how to defend"
    "latest",   // "latest updates"
    "news",     // "game news"
    "current",  // "current version"
    "recent"    // "recent changes"
};

var lowerQuery = query.ToLower();
foreach (var keyword in englishKeywords)
{
    if (lowerQuery.Contains(keyword))
        return true;
}
```

---

## ?? 性能优化策略

### 1. 缓存机制

```
第一次搜索 "RimWorld tips"
    ↓
调用 API（耗时 1-2 秒）
    ↓
缓存结果 60 分钟

60 分钟内再次搜索 "RimWorld tips"
    ↓
直接返回缓存（耗时 0 秒）
```

### 2. 结果限制

```csharp
// 限制结果数量（默认 3）
maxResults: 3

// 限制总字符数（默认 800）
maxLength: 800

// 估算 Token 使用
estimatedTokens = 800 / 4 ≈ 200 tokens
```

### 3. 并行处理

```
┌─────────────┐
│ 捕获游戏状态 │ (50ms)
└─────────────┘
       U
       dTTTTTTTTTTTTTTTTTT[
       ↓                  ↓
┌─────────────┐    ┌─────────────┐
│ 网络搜索    │    │ 记忆检索    │
│ (1-2秒)     │    │ (50ms)      │
└─────────────┘    └─────────────┘
       U                  U
       ^TTTTTTTTjTTTTTTTTTa
                ↓
        ┌─────────────┐
        │ 整合上下文  │
        └─────────────┘
                ↓
        ┌─────────────┐
        │ 发送到 LLM  │
        └─────────────┘
```

---

## ?? 最佳实践

### ? 适合搜索的查询

```
? "最新的 RimWorld 更新是什么？"          → 时效性强
? "什么是水培种植？"                       → 知识查询
? "如何高效防御袭击？"                     → 攻略查询
? "搜索最佳模组推荐"                       → 明确搜索意图
```

### ? 不适合搜索的查询

```
? "帮我收获作物"                          → 游戏内命令
? "我的殖民者受伤了"                      → 游戏内状态
? "谢谢你"                                → 社交对话
? "你今天心情怎么样？"                    → AI 人格交互
```

---

## ?? 自定义扩展

### 添加自定义关键词

编辑 `WebSearchService.cs`:

```csharp
public static bool ShouldSearch(string query)
{
    var customKeywords = new[]
    {
        "百科",      // "百科查询"
        "维基",      // "维基搜索"
        "教程",      // "教程查找"
        "攻略",      // "攻略搜索"
        "wiki",
        "tutorial",
        "guide"
    };

    return searchTriggers.Concat(customKeywords)
        .Any(trigger => query.ToLower().Contains(trigger));
}
```

### 调整缓存时间

```csharp
// 默认 60 分钟
private const int CacheExpirationMinutes = 60;

// 改为 30 分钟（更新鲜的结果）
private const int CacheExpirationMinutes = 30;

// 改为 120 分钟（减少 API 调用）
private const int CacheExpirationMinutes = 120;
```

---

**版本**: 1.0.0  
**文档类型**: 技术详解  
**目标读者**: 开发者和高级用户
