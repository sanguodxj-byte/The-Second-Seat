# 呼吸动画与分层立绘 - 快速参考 v1.6.18

## ? 核心要点

**呼吸动画和表情系统已完全适配分层立绘！**

---

## ?? 快速检查清单

### 呼吸动画
- [ ] AI 按钮立绘上下浮动（-2px ~ +2px，1 秒周期）
- [ ] 对话窗口立绘上下浮动
- [ ] 人格名字保持固定位置

### 表情切换
- [ ] 悬停 1 秒 → `Confused` 表情
- [ ] 快速移动 → `Shy` 表情
- [ ] 慢速移动 3 次 → 随机表情
- [ ] 10 次移动 → 组合奖励（+3 好感度）

### 分层立绘
- [ ] 表情切换时，只替换 `face` 层
- [ ] `body` 层保持不变
- [ ] 缓存自动更新

---

## ?? 核心代码片段

### 1. NarratorScreenButton.cs
```csharp
// 应用呼吸偏移
if (currentPortrait != null && currentPersona != null)
{
    float breathingOffset = ExpressionSystem.GetBreathingOffset(currentPersona.defName);
    drawRect = new Rect(inRect.x, inRect.y + breathingOffset, inRect.width, inRect.height);
}
```

### 2. NarratorWindow.cs
```csharp
// 应用呼吸偏移
float breathingOffset = ExpressionSystem.GetBreathingOffset(persona.defName);
portraitRect.y += breathingOffset;
```

### 3. ExpressionSystem.cs
```csharp
// 计算呼吸偏移
public static float GetBreathingOffset(string personaDefName)
{
    float elapsed = Time.realtimeSinceStartup;
    float wave = Mathf.Sin(elapsed * 2f * Mathf.PI / BREATHING_CYCLE_DURATION);
    return wave * BREATHING_AMPLITUDE;
}
```

---

## ?? 文件结构

```
Textures/UI/Narrators/9x16/Layered/Sideria/
├── base_body.png          ← 身体层（必需）
├── face_neutral.png       ← 默认表情（必需）
├── face_happy.png         ← 表情变体
├── face_sad.png
├── face_angry.png
└── outfit_default.png     ← 服装层（可选）
```

---

## ?? 测试步骤

### 1. 部署
```powershell
.\Deploy-BreathingAnimation-Layered-v1.6.18.ps1
```

### 2. 游戏内测试
1. 启动 RimWorld
2. 点击 AI 按钮（左上角）
3. 观察立绘是否上下浮动
4. 悬停 1 秒激活触摸模式
5. 移动鼠标观察表情变化

---

## ?? 调试参数

| 参数 | 默认值 | 位置 |
|------|--------|------|
| 呼吸周期 | 1.0 秒 | `ExpressionSystem.BREATHING_CYCLE_DURATION` |
| 呼吸幅度 | 2.0 像素 | `ExpressionSystem.BREATHING_AMPLITUDE` |
| 悬停激活时间 | 1.0 秒 | `NarratorScreenButton.HOVER_ACTIVATION_TIME` |
| 触摸冷却 | 0.3 秒 | `NarratorScreenButton.TOUCH_COOLDOWN` |

---

## ?? 常见问题

### Q1: 立绘不浮动？
**A:** 检查是否启用了立绘模式（设置 → `usePortraitMode = true`）

### Q2: 表情不切换？
**A:** 检查 `Textures/UI/Narrators/9x16/Layered/{PersonaName}/face_{expression}.png` 是否存在

### Q3: 性能卡顿？
**A:** 减小 `PORTRAIT_UPDATE_INTERVAL`（默认 30 ticks = 0.5 秒）

---

## ?? 相关文档

- [呼吸动画与分层立绘适配报告-v1.6.18.md](呼吸动画与分层立绘适配报告-v1.6.18.md)
- [分层立绘系统-快速参考.md](分层立绘系统-快速参考.md)

**版本：** v1.6.18 | **状态：** ? 完成
