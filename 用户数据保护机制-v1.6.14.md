# 用户数据保护机制 v1.6.14

## ??? 概述

部署脚本现在包含**智能数据保护机制**，确保部署时不会覆盖用户自定义的重要数据。

---

## ?? 保护的内容

### 1?? 人格数据保护

**保护的文件：**
```
Defs\NarratorPersonaDefs\CustomPersona_*.xml
```

**说明：**
- ? 保护所有以 `CustomPersona_` 开头的人格定义文件
- ? 这些是用户通过多模态分析生成的自定义人格
- ? 包含用户上传的立绘路径、biography、对话风格等

**示例：**
```
? 保护: CustomPersona_2bc3dc98.xml
? 保护: CustomPersona_Sideria_20231209.xml
? 不保护: NarratorPersonaDefs.xml (系统默认文件)
```

---

### 2?? 立绘保护

**保护的立绘：**
```
Textures\UI\Narrators\Avatars\*\custom_*.*
Textures\UI\Narrators\Avatars\CustomPersona_*\*.*
```

**说明：**
- ? 保护以 `custom_` 开头的立绘文件
- ? 保护 `CustomPersona_*` 文件夹下的所有立绘
- ? 这些是用户上传的自定义立绘

**示例：**
```
? 保护: Avatars\Sideria\custom_base.png
? 保护: Avatars\CustomPersona_2bc3dc98\base.png
? 不保护: Avatars\Sideria\base.png (系统默认立绘)
```

---

## ?? 工作机制

### 部署流程

```
[ 开始部署 ]
    ↓
[ 步骤 1: 备份受保护的文件 ]
    - 检测 CustomPersona_*.xml
    - 检测 custom_*.* 立绘
    - 复制到临时备份目录
    ↓
[ 步骤 2: 清理旧文件 ]
    - 删除非受保护的文件
    - 保留受保护的文件
    ↓
[ 步骤 3: 复制新文件 ]
    - 跳过已存在的受保护文件
    - 复制系统默认文件
    ↓
[ 步骤 4: 恢复备份 ]
    - 将备份的文件恢复回原位置
    - 确保用户数据完整
    ↓
[ 部署完成 ]
```

---

## ?? 保护级别

### 自动保护（默认开启）

```powershell
# 默认模式：自动保护用户数据
.\Deploy-Animation-System.ps1
```

**特点：**
- ? 自动备份和恢复
- ? 无需手动操作
- ? 安全可靠

### 禁用保护（谨慎使用）

```powershell
# 禁用保护：完全覆盖所有文件
.\Deploy-Animation-System.ps1 -ProtectUserData:$false
```

**警告：**
- ?? 会覆盖所有文件
- ?? 用户自定义数据会丢失
- ?? 仅在需要完全重置时使用

---

## ?? 使用场景

### 场景 1: 日常更新部署

**情况：**
- 更新了系统代码
- 不想影响用户自定义人格

**命令：**
```powershell
.\Deploy-Animation-System.ps1
```

**结果：**
```
? DLL 已更新
? 系统 Defs 已更新
? 用户人格数据完整保留
? 用户立绘完整保留
```

---

### 场景 2: 添加新的默认人格

**情况：**
- 在 `NarratorPersonaDefs.xml` 中添加了新人格
- 需要更新系统默认人格

**命令：**
```powershell
.\Deploy-Animation-System.ps1
```

**结果：**
```
? 新人格已添加到 NarratorPersonaDefs.xml
? 用户自定义人格保持不变
```

---

### 场景 3: 完全重置（慎用）

**情况：**
- 需要完全重置到初始状态
- 删除所有用户数据

**命令：**
```powershell
# 警告：会删除所有用户数据！
.\Deploy-Animation-System.ps1 -ProtectUserData:$false
```

**结果：**
```
?? 所有用户人格已删除
?? 所有用户立绘已删除
? 系统恢复到初始状态
```

---

## ?? 备份位置

### 临时备份

**备份目录：**
```
%TEMP%\TheSecondSeat_Backup_YYYYMMDD_HHMMSS\
%TEMP%\TheSecondSeat_Textures_Backup_YYYYMMDD_HHMMSS\
```

**示例：**
```
C:\Users\Administrator\AppData\Local\Temp\TheSecondSeat_Backup_20231209_153045\
```

**特点：**
- ? 自动生成时间戳
- ? 部署成功后自动清理
- ? 部署失败时保留备份

---

## ?? 验证保护

### 检查命令

```powershell
# 1. 检查受保护的人格文件
Get-ChildItem "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Defs\NarratorPersonaDefs\CustomPersona_*.xml"

# 2. 检查受保护的立绘
Get-ChildItem "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\Avatars\*\custom_*.*"

# 3. 检查备份（部署过程中）
Get-ChildItem "$env:TEMP\TheSecondSeat_Backup_*"
```

### 预期结果

**保护生效：**
```
? CustomPersona_*.xml 文件数量不变
? custom_*.* 立绘数量不变
? 用户上传的立绘路径保持有效
```

**未保护：**
```
?? CustomPersona_*.xml 文件被删除
?? custom_*.* 立绘被删除
?? 用户数据丢失
```

---

## ?? 部署日志示例

### 保护模式开启

```
=== 步骤 4/5: 复制 Defs ===
? 保护用户自定义数据...
? 已备份: NarratorPersonaDefs\CustomPersona_2bc3dc98.xml
? 清理旧的 Defs 文件（保留用户自定义数据）...
? Defs 已复制: 2 个文件
? 跳过受保护的文件: 1 个
? 恢复用户自定义数据...
? 已恢复: NarratorPersonaDefs\CustomPersona_2bc3dc98.xml

=== 步骤 5/5: 复制纹理文件 ===
? 保护用户自定义立绘...
? 已备份立绘: UI\Narrators\Avatars\Sideria\custom_base.png
? 纹理已复制: 45 个文件
? 跳过受保护的立绘: 1 个
? 恢复用户自定义立绘...
? 已恢复立绘: UI\Narrators\Avatars\Sideria\custom_base.png
```

---

## ?? 注意事项

### 1. 文件命名规范

**受保护的命名：**
```
? CustomPersona_*.xml
? custom_*.*
? CustomPersona_*/
```

**不受保护的命名：**
```
? MyPersona.xml (不以 CustomPersona_ 开头)
? my_base.png (不以 custom_ 开头)
```

**建议：**
- 用户自定义人格：使用 `CustomPersona_` 前缀
- 用户自定义立绘：使用 `custom_` 前缀
- 或者放在 `CustomPersona_*` 文件夹下

---

### 2. 备份失败处理

**如果备份失败：**
```powershell
# 手动备份重要数据
Copy-Item "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Defs\NarratorPersonaDefs\CustomPersona_*.xml" `
    "C:\Backup\TheSecondSeat\Defs\" -Recurse

# 然后重新部署
.\Deploy-Animation-System.ps1
```

---

### 3. 恢复失败处理

**如果恢复失败：**

1. **找到备份目录：**
```powershell
Get-ChildItem "$env:TEMP\TheSecondSeat_Backup_*" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
```

2. **手动恢复：**
```powershell
$backupDir = "C:\Users\Administrator\AppData\Local\Temp\TheSecondSeat_Backup_20231209_153045"
$modPath = "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat"

Copy-Item "$backupDir\*" "$modPath\Defs\" -Recurse -Force
```

---

## ?? 最佳实践

### 开发环境

```powershell
# 频繁部署时使用保护模式
.\Deploy-Animation-System.ps1

# 特点：
# - 快速迭代
# - 保留测试数据
# - 安全可靠
```

### 发布环境

```powershell
# 发布新版本前完整测试
.\Deploy-Animation-System.ps1 -ProtectUserData:$false

# 确保：
# - 完全干净的环境
# - 所有文件都是最新的
# - 无旧数据残留
```

### 用户升级

```powershell
# 用户升级时使用保护模式
.\Deploy-Animation-System.ps1

# 好处：
# - 保留用户的自定义人格
# - 保留用户的上传立绘
# - 无缝升级体验
```

---

## ?? 对比

| 特性 | 保护模式 | 非保护模式 |
|------|---------|-----------|
| 用户人格数据 | ? 保留 | ? 删除 |
| 用户立绘 | ? 保留 | ? 删除 |
| 系统文件更新 | ? 更新 | ? 更新 |
| 部署速度 | ?? 稍慢 | ? 快速 |
| 安全性 | ? 高 | ?? 低 |
| 推荐场景 | 日常更新 | 完全重置 |

---

## ? 总结

### 保护机制优势

```
? 自动保护用户数据
? 无需手动备份
? 安全可靠
? 支持回滚
? 智能识别
```

### 使用建议

```
1. 日常部署：始终使用保护模式
2. 测试环境：使用保护模式以保留测试数据
3. 发布前：使用非保护模式确保干净环境
4. 用户升级：使用保护模式确保平滑升级
```

---

**保护机制已启用！** ???  
**版本：** v1.6.14  
**状态：** 用户数据安全

现在可以放心部署，用户的自定义人格和立绘不会被覆盖！

_The Second Seat Mod Team_
