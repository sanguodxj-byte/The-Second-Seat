# 立绘自动分割和组合系统 - 完整指南

## ?? 核心概念

### 什么是自动分割？
- **传统方法**: 手动制作透明背景的差分图（只包含头部或服装）
- **新方法**: 使用完整立绘，系统自动从脖子位置分割和组合

### 优势
- ? **制作简单** - 不需要手动抠图
- ? **无需透明** - 直接使用完整立绘
- ? **自动羽化** - 分割线平滑过渡
- ? **灵活组合** - 表情 + 服装自由搭配

---

## ?? 文件结构

### 新方法：完整立绘
```
Textures/UI/Narrators/9x16/
├─ Cassandra/
│  └─ base.png                    ← 完整立绘（基础）
│
├─ Expressions/
│  └─ Cassandra/
│     ├─ happy.png                ← 完整立绘（头部表情不同）
│     ├─ sad.png                  ← 完整立绘（头部表情不同）
│     └─ angry.png                ← 完整立绘（头部表情不同）
│
└─ Cassandra/
   └─ Outfits/
      ├─ warm_1.png               ← 完整立绘（服装不同）
      ├─ warm_2.png               ← 完整立绘（服装不同）
      └─ intimate_1.png           ← 完整立绘（服装不同）

所有文件都是完整的 1080x1920 立绘！
```

### 对比：旧方法（需要透明背景）
```
? 旧方法需要：
- base.png（完整立绘）
- happy.png（只有头部，背景透明）← 需要手动抠图
- warm_1.png（只有服装，背景透明）← 需要手动抠图
```

---

## ?? 自动分割原理

### 分割流程
```
1. 加载三张完整立绘:
   ├─ base.png（基础立绘）
   ├─ happy.png（表情差分）
   └─ warm_1.png（服装差分）

2. 确定分割线位置:
   └─ 默认：从顶部 30% 的位置（脖子）

3. 提取区域:
   ├─ 头部（0% - 30%）: 从 happy.png 提取
   ├─ 身体（30% - 100%）: 从 base.png 提取
   └─ 服装（30% - 100%）: 从 warm_1.png 提取

4. 合成:
   └─ 身体 + 服装 + 头部 = 最终立绘
```

### 视觉示意
```
┌────────────────┐
│   头部区域     │ ← 从 happy.png 提取
│   (0% - 30%)   │
├────────────────┤ ← 分割线（脖子位置）
│                │
│   身体区域     │ ← 从 base.png 提取
│   (30% - 100%) │   + warm_1.png 叠加
│                │
└────────────────┘
```

---

## ?? 分割线位置配置

### 默认配置
```csharp
水平分割线: 30% (从顶部)
羽化宽度: 10 像素
启用羽化: true
```

### 自定义配置（每个角色不同）
```csharp
Cassandra:
- 分割线: 28% (脖子稍高)
- 羽化: 12px

Phoebe:
- 分割线: 32% (脖子稍低)
- 羽化: 10px

自定义:
- 可在 PortraitSplitter.cs 中配置
```

---

## ?? 羽化效果

### 什么是羽化？
在分割线附近进行平滑过渡，避免生硬的切割线。

### 羽化示意
```
不启用羽化（生硬）:
┌────────────┐
│   头部     │
├────────────┤ ← 明显的切割线
│   身体     │
└────────────┘

启用羽化（平滑）:
┌────────────┐
│   头部     │
│~~~~~~~~~~~~│ ← 平滑过渡区域（10px）
│   身体     │
└────────────┘
```

### 羽化宽度
```csharp
featherWidth = 0   ← 无羽化，生硬切割
featherWidth = 5   ← 轻微羽化
featherWidth = 10  ← 标准羽化（推荐）
featherWidth = 20  ← 强羽化，过渡明显
```

---

## ?? 代码实现

### 核心方法
```csharp
// 自动分割和组合
Texture2D result = PortraitSplitter.ComposePortrait(
    baseTexture,        // 基础立绘（完整）
    expressionTexture,  // 表情差分（完整）
    outfitTexture,      // 服装差分（完整）
    personaDefName      // 人格名称
);
```

### 加载流程
```csharp
LoadPortrait(def, expression)
  │
  ├─ 1. 加载基础立绘（完整）
  │    └─ base.png
  │
  ├─ 2. 加载表情差分（完整，如果有）
  │    └─ Expressions/Cassandra/happy.png
  │
  ├─ 3. 加载服装差分（完整，如果有）
  │    └─ Outfits/warm_1.png
  │
  ├─ 4. 自动分割和组合
  │    └─ PortraitSplitter.ComposePortrait()
  │       ├─ 提取头部（表情）
  │       ├─ 提取身体（基础）
  │       ├─ 叠加服装
  │       └─ 羽化边缘
  │
  └─ 5. 返回最终立绘
```

---

## ??? 制作工作流程

### Step 1: 准备基础立绘
```
1. 在 Photoshop/CSP 中绘制完整立绘
2. 保存为 base.png (1080x1920)
3. 放置: 9x16/Cassandra/base.png
```

### Step 2: 制作表情差分
```
1. 复制 base.png
2. 修改头部表情（其他部分保持一致）
3. 保存为完整立绘
4. 命名: happy.png
5. 放置: 9x16/Expressions/Cassandra/happy.png

? 不需要抠图！
? 不需要透明背景！
? 直接保存完整立绘！
```

### Step 3: 制作服装差分
```
1. 复制 base.png
2. 修改服装（头部保持一致）
3. 保存为完整立绘
4. 命名: warm_1.png
5. 放置: 9x16/Cassandra/Outfits/warm_1.png

? 同样不需要抠图！
? 完整立绘即可！
```

### Step 4: 测试
```
1. 启动游戏
2. 切换表情 → 看到头部变化
3. 等待服装更换 → 看到服装变化
4. 表情 + 服装组合 → 完美合成！
```

---

## ?? 示例场景

### 场景 1: 只有表情差分
```
文件:
- base.png（完整立绘）
- happy.png（完整立绘，头部表情不同）

结果:
- 头部: 从 happy.png 提取
- 身体: 从 base.png 提取
- 最终: 快乐表情的 Cassandra
```

### 场景 2: 只有服装差分
```
文件:
- base.png（完整立绘）
- warm_1.png（完整立绘，服装不同）

结果:
- 头部: 从 base.png 提取
- 身体: 从 base.png 提取
- 服装: 从 warm_1.png 叠加
- 最终: 温暖服装的 Cassandra
```

### 场景 3: 表情 + 服装组合
```
文件:
- base.png（完整立绘）
- happy.png（完整立绘，头部表情不同）
- warm_1.png（完整立绘，服装不同）

结果:
- 头部: 从 happy.png 提取（快乐表情）
- 身体: 从 base.png 提取
- 服装: 从 warm_1.png 叠加（温暖服装）
- 最终: 穿着温暖服装的快乐 Cassandra ?
```

---

## ?? 调试工具

### 保存分割预览
```csharp
// 在分割线位置画红线，查看分割效果
PortraitSplitter.SaveSplitPreview(texture, "Cassandra_Classic");

输出:
- 文件: SaveData/TheSecondSeat/Cassandra_Classic_split_preview.png
- 内容: 立绘 + 红色分割线
```

### 调整分割线位置
```csharp
// 在 PortraitSplitter.cs 中修改
case "Cassandra_Classic":
    return new PortraitSplitConfig
    {
        horizontalSplitY = 0.28f,  // ← 调整这里（0-1范围）
        featherWidth = 12,          // ← 调整羽化宽度
    };
```

---

## ?? 最佳实践

### 1. 分割线位置选择
```
? 推荐: 脖子位置（0.28 - 0.32）
??  避免: 脸部中间（会切割表情）
??  避免: 腰部以下（服装变化不明显）
```

### 2. 羽化宽度选择
```
? 标准: 10-12px（适合大多数情况）
??  太小: < 5px（可能有明显切割线）
??  太大: > 20px（过渡区域太明显）
```

### 3. 文件制作要点
```
? 保持尺寸一致（1080x1920）
? 保持人物位置一致
? 只修改需要变化的部分
? 不要改变人物姿势
? 不要移动人物位置
```

---

## ?? 常见问题

### Q: 为什么要用完整立绘？
**A**: 
- 不需要手动抠图，降低制作难度
- 避免透明背景的边缘锯齿
- 羽化效果更自然

### Q: 分割线位置怎么确定？
**A**:
1. 使用 `SaveSplitPreview()` 保存预览
2. 查看红线是否在脖子位置
3. 调整 `horizontalSplitY` 参数
4. 重新测试

### Q: 表情和服装都是完整的，会不会冲突？
**A**:
- 不会！系统会自动分割：
  - 头部用表情差分
  - 身体用服装差分
  - 自动合成

### Q: 羽化边缘不自然怎么办？
**A**:
1. 增加 `featherWidth` (10 → 15)
2. 确保分割线位置准确（在脖子）
3. 检查立绘是否对齐

---

## ?? 快速开始

### 最简实现（3个文件）
```
1. 准备文件:
   - base.png（基础立绘）
   - happy.png（复制 base.png，修改头部表情）
   - warm_1.png（复制 base.png，修改服装）

2. 放置文件:
   - base.png → 9x16/Cassandra/
   - happy.png → 9x16/Expressions/Cassandra/
   - warm_1.png → 9x16/Cassandra/Outfits/

3. 启动游戏测试

? 完成！不需要任何抠图或透明处理！
```

---

## ?? 性能影响

### 计算开销
```
第一次加载:
- 读取 3 张纹理
- 像素级合成（约 2M 像素）
- 耗时: 约 50-100ms

后续加载:
- 使用缓存
- 耗时: < 1ms
```

### 内存占用
```
单个立绘:
- 原始: 1080x1920 RGBA = 8MB
- 合成结果: 8MB
- 总计: 约 24-32MB（包含缓存）

对比旧方法:
- 差异不大（旧方法也需要多张纹理）
```

---

## ?? 总结

### 核心优势
1. ? **制作简单** - 完整立绘，无需抠图
2. ? **自动合成** - 系统自动分割和组合
3. ? **平滑过渡** - 羽化边缘，无切割感
4. ? **灵活组合** - 表情 + 服装自由搭配

### 适用场景
- ? 表情差分（头部表情不同）
- ? 服装差分（身体服装不同）
- ? 表情 + 服装组合
- ? 不适合: 姿势完全不同的立绘

---

**版本**: v1.0  
**状态**: ? 代码已实现  
**创建时间**: 2025-01-XX  
**下一步**: 制作测试立绘，验证分割效果
