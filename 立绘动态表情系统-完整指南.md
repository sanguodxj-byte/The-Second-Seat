# ?? 立绘动态表情系统 - 完整指南

## ?? 系统概述

立绘动态表情系统让AI叙事者能根据**好感度变化**、**对话内容**和**游戏事件**自动切换表情，让角色更加生动。

---

## ?? 表情类型

### 可用表情列表

| 表情类型 | 英文名 | 文件后缀 | 触发场景 |
|---------|--------|---------|---------|
| **中性** | Neutral | *(无)* | 默认状态 |
| **开心** | Happy | `_happy` | 好感度>80 / 正面事件 |
| **悲伤** | Sad | `_sad` | 殖民者死亡 / 重大损失 |
| **愤怒** | Angry | `_angry` | 好感度<0 / 愤怒对话 |
| **惊讶** | Surprised | `_surprised` | 意外事件 |
| **担忧** | Worried | `_worried` | 袭击即将到来 |
| **得意** | Smug | `_smug` | 胜利 / "我说过吧" |
| **失望** | Disappointed | `_disappointed` | 好感度20-40 / 失败 |
| **沉思** | Thoughtful | `_thoughtful` | 好感度40-60 / 思考 |
| **烦躁** | Annoyed | `_annoyed` | 好感度0-20 |

---

## ?? 立绘文件命名规范

### 基础立绘
```
Cassandra.png          # 基础表情（必需）
```

### 表情变体
```
Cassandra_happy.png        # 开心
Cassandra_sad.png          # 悲伤
Cassandra_angry.png        # 愤怒
Cassandra_surprised.png    # 惊讶
Cassandra_worried.png      # 担忧
Cassandra_smug.png         # 得意
Cassandra_disappointed.png # 失望
Cassandra_thoughtful.png   # 沉思
Cassandra_annoyed.png      # 烦躁
```

### 文件位置
```
D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\
├── Cassandra.png
├── Cassandra_happy.png
├── Cassandra_sad.png
├── Cassandra_angry.png
├── Cassandra_surprised.png
├── ...
├── Phoebe.png
├── Phoebe_happy.png
└── ...
```

---

## ?? 表情触发机制

### 1. **好感度自动触发**

| 好感度范围 | 自动表情 |
|-----------|---------|
| ≥ 80 | Happy (开心) |
| 60-79 | Neutral (中性) |
| 40-59 | Thoughtful (沉思) |
| 20-39 | Disappointed (失望) |
| 0-19 | Annoyed (烦躁) |
| < 0 | Angry (愤怒) |

**触发代码**：
```csharp
ExpressionSystem.UpdateExpressionByAffinity("Cassandra_Classic", affinity);
```

### 2. **对话内容触发**

系统会分析对话文本中的**情感关键词**：

#### 开心表情触发词
```
中文：哈哈、真好、太棒、开心、高兴、喜欢
英文：fantastic, great, wonderful, happy, haha
```

#### 愤怒表情触发词
```
中文：可恶、该死、混蛋、愤怒、生气
英文：damn, angry, furious, irritated
```

#### 惊讶表情触发词
```
中文：什么、不会吧、真的、天啊、哇
英文：what, really, wow, omg, surprising
```

**触发代码**：
```csharp
string dialogue = "哈哈，太棒了！殖民者表现很好！";
ExpressionSystem.UpdateExpressionByDialogueTone("Cassandra_Classic", dialogue);
// → 切换到 Happy 表情
```

### 3. **游戏事件触发**

| 事件类型 | 表情 |
|---------|------|
| `colonist_death` | Sad |
| `raid_victory` | Happy |
| `raid_incoming` | Worried |
| `major_loss` | Disappointed |
| `great_success` | Smug |
| `unexpected_event` | Surprised |

**触发代码**：
```csharp
ExpressionSystem.UpdateExpressionByEvent("Cassandra_Classic", "raid_incoming", false);
// → 切换到 Worried 表情
```

---

## ?? 使用方法

### 基础用法

```csharp
// 1. 手动设置表情
ExpressionSystem.SetExpression("Cassandra_Classic", ExpressionType.Happy);

// 2. 根据好感度自动设置
ExpressionSystem.UpdateExpressionByAffinity("Cassandra_Classic", 75f);

// 3. 根据对话设置
ExpressionSystem.UpdateExpressionByDialogueTone("Cassandra_Classic", "太棒了！");

// 4. 根据事件设置
ExpressionSystem.UpdateExpressionByEvent("Cassandra_Classic", "raid_victory", true);

// 5. 锁定表情（重要场景）
ExpressionSystem.LockExpression("Cassandra_Classic", true);  // 锁定
ExpressionSystem.LockExpression("Cassandra_Classic", false); // 解锁
```

### 在UI中显示表情立绘

```csharp
// PersonaSelectionWindow.cs 中的示例
var expressionState = ExpressionSystem.GetExpressionState(persona.defName);
ExpressionType currentExpression = expressionState.CurrentExpression;

// 加载带表情的立绘
var texture = PortraitLoader.LoadPortrait(persona, currentExpression);
GUI.DrawTexture(rect, texture, ScaleMode.ScaleToFit);
```

---

## ?? 表情动画

### 过渡效果

表情切换时有**平滑过渡动画**（约0.5秒）：

```csharp
// 获取当前过渡进度
var state = ExpressionSystem.GetExpressionState("Cassandra_Classic");
float progress = state.TransitionProgress;  // 0.0 → 1.0

// 更新过渡动画（每帧调用）
ExpressionSystem.UpdateTransition("Cassandra_Classic");
```

### 表情持续时间

- 默认持续：**3秒**
- 3秒后自动恢复到 **Neutral**（除非被锁定）

```csharp
// 设置表情持续时间
var state = ExpressionSystem.GetExpressionState("Cassandra_Classic");
state.ExpressionDuration = 5f;  // 改为5秒
```

---

## ??? 立绘制作指南

### 推荐规格

| 属性 | 值 |
|-----|---|
| **尺寸** | 512x512 或 1024x1024 |
| **格式** | PNG (RGBA) |
| **背景** | 透明 |
| **表情差异** | 仅脸部变化，身体保持一致 |

### 制作流程

1. **创建基础立绘** (`Cassandra.png`)
2. **复制图层**
3. **修改表情区域**（眼睛、嘴巴、眉毛）
4. **保存为新文件** (`Cassandra_happy.png`)
5. **重复步骤2-4** 创建其他表情

### Photoshop 脚本示例

```javascript
// 批量导出表情立绘
var expressions = ["happy", "sad", "angry", "surprised", "worried"];
var baseName = "Cassandra";

for (var i = 0; i < expressions.length; i++) {
    // 显示对应表情图层
    showLayer(expressions[i]);
    
    // 导出
    var saveFile = new File("~/Desktop/Narrators/" + baseName + "_" + expressions[i] + ".png");
    savePNG(saveFile);
    
    // 隐藏图层
    hideLayer(expressions[i]);
}
```

---

## ?? 测试表情系统

### 控制台命令（DevMode）

```csharp
// 在开发者控制台执行
ExpressionSystem.SetExpression("Cassandra_Classic", ExpressionType.Happy);
ExpressionSystem.SetExpression("Cassandra_Classic", ExpressionType.Sad);
ExpressionSystem.SetExpression("Cassandra_Classic", ExpressionType.Angry);

// 查看调试信息
Log.Message(ExpressionSystem.GetDebugInfo());
```

### 测试脚本

创建测试按钮循环所有表情：

```csharp
if (Widgets.ButtonText(new Rect(10, 10, 150, 30), "测试表情"))
{
    var expressions = Enum.GetValues(typeof(ExpressionType));
    int index = (Find.TickManager.TicksGame / 120) % expressions.Length;
    
    ExpressionType current = (ExpressionType)expressions.GetValue(index);
    ExpressionSystem.SetExpression("Cassandra_Classic", current);
    
    Messages.Message($"当前表情: {current}", MessageTypeDefOf.NeutralEvent);
}
```

---

## ?? 高级配置

### 自定义表情映射

```csharp
// 添加新表情类型（需修改ExpressionType枚举）
public enum ExpressionType
{
    // ...existing...
    Excited,      // 兴奋
    Embarrassed,  // 尴尬
    Suspicious    // 怀疑
}

// 对应文件后缀
case ExpressionType.Excited: return "_excited";
case ExpressionType.Embarrassed: return "_embarrassed";
case ExpressionType.Suspicious: return "_suspicious";
```

### 自定义触发规则

```csharp
// 添加自定义关键词
if (ContainsKeywords(dialogueText, new[] { "兴奋", "激动", "excited", "thrilled" }))
{
    expression = ExpressionType.Excited;
}
```

---

## ?? 性能优化

### 缓存机制

- ? 立绘纹理自动缓存
- ? 按 `defName + expressionSuffix` 键缓存
- ? 避免重复加载

```csharp
// 清除缓存（更换立绘后）
PortraitLoader.ClearCache();
```

### 内存管理

- 表情立绘共享基础纹理
- 未使用的表情不会加载
- 自动回退到基础立绘

---

## ?? 完整示例

### 场景：袭击事件触发表情变化

```csharp
public class RaidEventHandler
{
    public void OnRaidIncoming()
    {
        // 1. 叙事者表情切换为担忧
        ExpressionSystem.UpdateExpressionByEvent("Cassandra_Classic", "raid_incoming", false);
        
        // 2. 显示对话（包含关键词"危险"）
        string dialogue = "小心！检测到危险信号，袭击即将到来！";
        ExpressionSystem.UpdateExpressionByDialogueTone("Cassandra_Classic", dialogue);
        // → 确认 Worried 表情
        
        // 3. 锁定表情（袭击期间）
        ExpressionSystem.LockExpression("Cassandra_Classic", true);
    }
    
    public void OnRaidEnded(bool victory)
    {
        // 解锁表情
        ExpressionSystem.LockExpression("Cassandra_Classic", false);
        
        if (victory)
        {
            // 胜利 → 得意表情
            ExpressionSystem.UpdateExpressionByEvent("Cassandra_Classic", "raid_victory", true);
        }
        else
        {
            // 失败 → 失望表情
            ExpressionSystem.UpdateExpressionByEvent("Cassandra_Classic", "major_loss", false);
        }
    }
}
```

---

## ?? 故障排查

### 问题1：表情立绘不显示

**检查**：
```powershell
# 1. 验证文件存在
Test-Path "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\Cassandra_happy.png"

# 2. 检查文件命名
Get-ChildItem "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\" | Where-Object { $_.Name -like "*_*" }
```

**解决方案**：
- 确保文件命名正确（区分大小写）
- 确保后缀与`GetExpressionSuffix`返回值一致

### 问题2：表情不会自动切换

**检查**：
```csharp
// 查看表情状态
var state = ExpressionSystem.GetExpressionState("Cassandra_Classic");
Log.Message($"当前表情: {state.CurrentExpression}");
Log.Message($"锁定状态: {state.IsLocked}");
```

**解决方案**：
- 检查表情是否被锁定
- 确认`UpdateTransition`被定期调用

### 问题3：表情文件找不到回退到基础立绘

这是**正常行为**！

- 系统会自动回退到基础立绘
- 不会影响游戏运行
- 可以逐步添加表情立绘

---

## ?? API参考

### ExpressionSystem

| 方法 | 说明 |
|-----|------|
| `SetExpression(defName, expression, trigger)` | 设置表情 |
| `UpdateExpressionByAffinity(defName, affinity)` | 根据好感度设置 |
| `UpdateExpressionByDialogueTone(defName, dialogue)` | 根据对话设置 |
| `UpdateExpressionByEvent(defName, eventType, isPositive)` | 根据事件设置 |
| `UpdateTransition(defName)` | 更新过渡动画 |
| `LockExpression(defName, locked)` | 锁定/解锁表情 |
| `GetExpressionState(defName)` | 获取表情状态 |
| `ResetAllExpressions()` | 重置所有表情 |

### PortraitLoader

| 方法 | 说明 |
|-----|------|
| `LoadPortrait(def, expression)` | 加载带表情的立绘 |
| `ClearCache()` | 清除缓存 |

---

##  立绘表情系统已完整实现！

### ? 实现的功能

1. **10种表情类型**
2. **3种自动触发机制**（好感度/对话/事件）
3. **平滑过渡动画**
4. **智能文件回退**
5. **表情锁定功能**
6. **自动缓存优化**

### ?? 下一步

1. **制作表情立绘**（推荐从简单的3-5个开始）
2. **测试表情切换**
3. **调整触发规则**（根据实际游戏体验）
4. **添加更多自定义表情**

---

**版本**：v1.0.0  
**作者**：The Second Seat Team  
**最后更新**：2025-01-XX

需要帮助？查看 [ARCHITECTURE.md](ARCHITECTURE.md) 了解系统架构。
