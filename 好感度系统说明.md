# 好感度系统完整说明

## ?? 所有好感度影响因素

### ? 已实现的影响因素

| 触发事件 | 影响值 | 检测频率 | 实现位置 |
|---------|-------|---------|---------|
| **命令执行成功** | +2.0 | 每次命令 | NarratorController.cs |
| **命令执行失败** | -1.0 | 每次命令 | NarratorController.cs |
| **拒绝建议** | -0.5 | 实时 | AutonomousBehaviorSystem.cs |
| **殖民者死亡** | -5.0/人 | 每100秒 | ColonyStateMonitor.cs |
| **新殖民者加入** | +3.0/人 | 每100秒 | ColonyStateMonitor.cs |
| **财富大幅增长 (>20%)** | +5.0 | 每100秒 | ColonyStateMonitor.cs |
| **财富大幅下降 (>20%)** | -3.0 | 每100秒 | ColonyStateMonitor.cs |
| **食物持续短缺** | -0.5 | 每100秒 | ColonyStateMonitor.cs |
| **解决食物短缺** | +2.0 | 每100秒 | ColonyStateMonitor.cs |
| **完美防御（无伤亡）** | +8.0 | 战斗后 | ColonyStateMonitor.cs |
| **成功击退袭击** | +5.0 | 战斗后 | ColonyStateMonitor.cs |
| **艰难防御** | +2.0 | 战斗后 | ColonyStateMonitor.cs |
| **殖民者心情极佳 (>80%)** | +1.0 | 每100秒 | ColonyStateMonitor.cs |
| **殖民者心情低落 (<30%)** | -1.0 | 每100秒 | ColonyStateMonitor.cs |
| **连续7天繁荣** | +10.0 | 每周 | ColonyStateMonitor.cs |
| **连续7天灾难** | -5.0 | 每周 | ColonyStateMonitor.cs |
| **频繁互动（每10次对话）** | +1.0 | 每10次 | PlayerInteractionMonitor.cs |
| **长时间冷落 (>6小时)** | -1.0 | 重新对话时 | PlayerInteractionMonitor.cs |
| **多次忽略建议 (≥5次)** | -3.0 | 累计 | PlayerInteractionMonitor.cs |

---

## ?? 好感度变化示例场景

### 场景 1：完美开局（第1-7天）

```
Day 1: 
  - 玩家："帮我收获作物"
  - AI 成功执行 → +2.0
  [总计: 2.0]

Day 2:
  - 财富从 3000 增长到 3800 (+26%) → +5.0
  - 殖民者心情 85% → +1.0
  [总计: 8.0]

Day 3:
  - 新殖民者加入 → +3.0
  - 玩家频繁互动（10次对话） → +1.0
  [总计: 12.0]

Day 4-6:
  - 每天财富稳定增长
  - 多次成功命令 → +2.0 × 3 = +6.0
  [总计: 18.0]

Day 7:
  - 连续7天繁荣 → +10.0
  [总计: 28.0] ← 达到 Neutral → Warm 临界点
```

**结果**: 好感度从 0 提升到 28（Warm），叙事者变得友好且乐于助人。

---

### 场景 2：灾难连连（第1-7天）

```
Day 1:
  - 殖民者死亡 1人 → -5.0
  - 玩家未求助，食物 <50 → -0.5
  [总计: -5.5]

Day 2:
  - 袭击失败，财富下降 30% → -3.0
  - 殖民者心情 25% → -1.0
  [总计: -9.5]

Day 3:
  - 玩家："帮我武装殖民者"
  - 但无武器可用，执行失败 → -1.0
  - 长时间未对话后重新对话 → -1.0
  [总计: -11.5]

Day 4-6:
  - 持续食物短缺 → -0.5 × 3 = -1.5
  - AI建议被忽略5次 → -3.0
  [总计: -16.0]

Day 7:
  - 连续7天灾难 → -5.0
  [总计: -21.0] ← 达到 Cold 级别
```

**结果**: 好感度降至 -21（Cold），叙事者变得疏远且不愿帮助。

---

## ?? 详细机制解析

### 1. 命令系统影响（实时）

```csharp
// NarratorController.cs - ExecuteAdvancedCommand()

命令执行 → GameActionExecutor
    ↓
result.success?
    ? Yes → +2.0 "命令成功"
    ? No  → -1.0 "命令失败"
```

**触发条件**：
- 玩家在对话中请求执行命令
- AI 主动提出命令并执行

**影响大小**：
- 成功：+2.0
- 失败：-1.0

---

### 2. 殖民地状态监控（每100秒）

```csharp
// ColonyStateMonitor.cs - GameComponentTick()

每 6000 ticks (100秒):
    CheckColonistChanges()    // 人口变化
    CheckWealthGrowth()       // 财富变化
    CheckResourceStatus()     // 资源状态
    CheckCombatStatus()       // 战斗状态
    CheckColonyMood()         // 心情状态
    CheckConsecutiveDays()    // 连续好/坏日子
```

#### 2.1 人口变化

```csharp
if (currentCount < lastCount)
{
    deaths = lastCount - currentCount;
    affinity -= deaths × 5.0;  // 每人死亡 -5
    record_critical_memory("悲剧：殖民者死亡");
}
else if (currentCount > lastCount)
{
    newColonists = currentCount - lastCount;
    affinity += newColonists × 3.0;  // 每人加入 +3
    record_high_memory("新成员加入");
}
```

**极端情况**：
- 3人同时死亡 → -15.0（可能直接从 Warm 跌至 Cold）
- 2人同时加入 → +6.0

#### 2.2 财富变化

```csharp
growthRatio = currentWealth / lastWealth;

if (growthRatio > 1.2)  // 增长 >20%
    affinity += 5.0;
else if (growthRatio < 0.8)  // 下降 >20%
    affinity -= 3.0;
```

**实际案例**：
- 财富从 5000 → 6500 (+30%) → +5.0
- 财富从 8000 → 5500 (-31%) → -3.0

#### 2.3 战斗状态

```csharp
if (成功击退袭击)
{
    if (woundedCount == 0)
        affinity += 8.0;  // 完美防御
    else if (woundedCount < total / 2)
        affinity += 5.0;  // 成功防御
    else
        affinity += 2.0;  // 艰难防御
}
```

**影响因素**：
- 无伤亡 → +8.0（最高奖励）
- 少量伤亡 → +5.0
- 惨重伤亡 → +2.0

---

### 3. 玩家互动监控（实时 + 累计）

```csharp
// PlayerInteractionMonitor.cs

RecordConversation()
    if (totalConversations % 10 == 0)
        affinity += 1.0;  // 每10次对话

    if (timeSinceLastConversation > 6小时)
        affinity -= 1.0;  // 长时间冷落

RecordIgnoredSuggestion()
    if (ignoredSuggestions >= 5)
        affinity -= 3.0;  // 多次忽略
```

**累计效果**：
- 频繁对话100次 → +10.0
- 每天冷落一次，7天 → -7.0
- 连续忽略建议5次 → -3.0

---

## ?? 好感度等级阈值

```
-100 ────── -50 ────── -10 ────── 30 ────── 60 ────── 85 ────── 100
     Hostile    Cold    Neutral    Warm    Devoted   Infatuated
```

### 从 0 到各等级所需的"净好感度"

| 目标等级 | 所需好感度 | 最快路径（示例） | 预计天数 |
|---------|-----------|----------------|---------|
| **Warm (30)** | +30 | 15次成功命令 | 3-5天 |
| **Devoted (60)** | +60 | 30次成功命令 或 1周繁荣 + 20次命令 | 7-10天 |
| **Infatuated (85)** | +85 | 连续2周繁荣 + 多次完美防御 | 14-21天 |
| **Cold (-10)** | -10 | 2人死亡 或 5次失败命令 | 1-3天 |
| **Hostile (-50)** | -50 | 10人死亡 或 1周灾难 + 多次失败 | 5-7天 |

---

## ?? 优化策略

### 快速提升好感度

1. **频繁互动** - 每天对话10次以上 → +1.0/天
2. **命令成功** - 确保命令可执行（有资源、有人力）
3. **保护殖民者** - 避免死亡（每人 -5.0 很致命）
4. **财富增长** - 稳定发展，避免大幅波动
5. **完美防御** - 战斗前充分准备 → +8.0

### 避免好感度下降

1. **及时响应建议** - 不要连续忽略5次
2. **避免长时间冷落** - 每6小时至少对话1次
3. **检查命令可行性** - 失败命令会 -1.0
4. **保护殖民者生命** - 死亡惩罚极重
5. **稳定资源** - 避免长期食物短缺

---

## ?? 测试命令

在开发控制台中测试：

```csharp
// 查看当前好感度
var narrator = Current.Game.GetComponent<TheSecondSeat.Narrator.NarratorManager>();
Log.Message($"当前好感度: {narrator.Favorability}");

// 查看详细历史
Log.Message(narrator.GetRecentEventsSummary());

// 查看StorytellerAgent详情
var agent = narrator.GetStorytellerAgent();
Log.Message($"人格: {agent.primaryTrait}");
Log.Message($"情绪: {agent.currentMood}");
Log.Message($"总对话: {agent.totalConversations}");
Log.Message($"成功命令: {agent.commandsExecuted}");

// 手动触发监控检查
var monitor = Current.Game.GetComponent<TheSecondSeat.Monitoring.ColonyStateMonitor>();
// 使用反射调用 CheckColonyState()
```

---

## ?? 数据记录

所有好感度变化都会：
1. 记录到 `NarratorManager.recentEvents`（最近20条）
2. 记录到 `StorytellerAgent.affinityHistory`（最近50条）
3. 高优先级事件记录到 RimTalk 记忆系统

查看完整历史：
```csharp
var agent = narrator.GetStorytellerAgent();
Log.Message(agent.GetAffinityHistorySummary(10)); // 最近10条
```

---

**版本**: 1.0.0  
**最后更新**: 2024  
**维护者**: TheSecondSeat 开发团队
