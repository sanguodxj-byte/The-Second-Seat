# 表情文件独立存放方案 - 完整指南

## ?? 问题描述

**当前问题**：
- 表情文件和立绘文件放在同一目录
- 右键选择立绘时，表情文件也会出现在列表中
- 造成干扰和混乱

**解决方案**：
- 将表情文件单独存放到独立文件夹
- 保持立绘目录清爽
- 修改代码以适配新结构

---

## ?? 新的文件结构

### 修改前（旧结构）
```
Textures/UI/Narrators/9x16/
├─ Cassandra/
│  ├─ base.png                    ← 基础立绘
│  ├─ happy.png                   ← 整图表情
│  ├─ sad.png                     ← 整图表情
│  ├─ angry.png                   ← 整图表情
│  └─ layers/                     ← 分层表情
│     ├─ eyes_neutral.png
│     ├─ eyes_happy.png
│     ├─ mouth_neutral.png
│     └─ ...
└─ Phoebe/
   └─ ...

问题：选择立绘时看到 happy.png、sad.png 等干扰项
```

### 修改后（新结构）?
```
Textures/UI/Narrators/9x16/
├─ Cassandra/
│  └─ base.png                    ← 只有基础立绘，清爽！
│
├─ Phoebe/
│  └─ base.png
│
└─ Expressions/                   ← 表情专用文件夹
   ├─ Cassandra/
   │  ├─ happy.png                ← 整图表情
   │  ├─ sad.png
   │  ├─ angry.png
   │  └─ layers/                  ← 分层表情
   │     ├─ eyes_neutral.png
   │     ├─ eyes_happy.png
   │     ├─ mouth_neutral.png
   │     └─ ...
   │
   └─ Phoebe/
      ├─ happy.png
      └─ layers/
         └─ ...

优势：选择立绘时只看到 base.png，非常清爽！
```

---

## ?? 需要修改的代码

### 1. PortraitLoader.cs - 加载路径调整

**文件**: `Source\TheSecondSeat\PersonaGeneration\PortraitLoader.cs`

#### 修改前（旧路径）
```csharp
// 旧路径
private const string BASE_PATH_9x16 = "UI/Narrators/9x16/";

public static Texture2D LoadPortrait(NarratorPersonaDef persona, ExpressionType expression)
{
    string personaPath = BASE_PATH_9x16 + persona.defName;
    
    // 尝试加载整图表情
    string fullPath = personaPath + "/" + GetExpressionSuffix(expression);
    // 路径: UI/Narrators/9x16/Cassandra/happy
}
```

#### 修改后（新路径）?
```csharp
private const string BASE_PATH_9x16 = "UI/Narrators/9x16/";
private const string EXPRESSIONS_PATH = "UI/Narrators/9x16/Expressions/"; // ? 新增

public static Texture2D LoadPortrait(NarratorPersonaDef persona, ExpressionType expression)
{
    string basePath = BASE_PATH_9x16 + persona.defName;
    string expressionPath = EXPRESSIONS_PATH + persona.defName; // ? 新增
    
    if (expression == ExpressionType.Neutral)
    {
        // 加载基础立绘
        string fullPath = basePath + "/base";
        return ContentFinder<Texture2D>.Get(fullPath, false);
    }
    
    // ? 尝试加载整图表情（从 Expressions 文件夹）
    string fullExpressionPath = expressionPath + "/" + GetExpressionSuffix(expression);
    var fullTexture = ContentFinder<Texture2D>.Get(fullExpressionPath, false);
    
    if (fullTexture != null)
    {
        return fullTexture;
    }
    
    // ? 如果没有整图，尝试分层合成（从 Expressions/layers 文件夹）
    return LoadWithLayers_9x16(basePath, expressionPath, persona.defName, expression);
}
```

---

### 2. 分层表情加载调整

#### 修改前（旧路径）
```csharp
private static Texture2D LoadLayerTexture(string personaName, string layerType, string variant)
{
    string path = $"UI/Narrators/9x16/{personaName}/layers/{layerType}_{variant}";
    // 路径: UI/Narrators/9x16/Cassandra/layers/eyes_happy
    return ContentFinder<Texture2D>.Get(path, false);
}
```

#### 修改后（新路径）?
```csharp
private static Texture2D LoadLayerTexture(string personaName, string layerType, string variant)
{
    // ? 从 Expressions 文件夹加载
    string path = $"{EXPRESSIONS_PATH}{personaName}/layers/{layerType}_{variant}";
    // 路径: UI/Narrators/9x16/Expressions/Cassandra/layers/eyes_happy
    return ContentFinder<Texture2D>.Get(path, false);
}
```

---

### 3. 完整的 PortraitLoader 修改

```csharp
using System;
using UnityEngine;
using Verse;

namespace TheSecondSeat.PersonaGeneration
{
    public static class PortraitLoader
    {
        // ? 基础立绘路径
        private const string BASE_PATH_9x16 = "UI/Narrators/9x16/";
        
        // ? 表情文件路径（新增）
        private const string EXPRESSIONS_PATH = "UI/Narrators/9x16/Expressions/";
        
        /// <summary>
        /// 加载立绘（带表情）
        /// </summary>
        public static Texture2D LoadPortrait(NarratorPersonaDef persona, ExpressionType expression = ExpressionType.Neutral)
        {
            if (persona == null)
            {
                Log.Warning("[PortraitLoader] persona is null");
                return null;
            }
            
            // ? 基础立绘路径（只包含 base.png）
            string basePath = BASE_PATH_9x16 + persona.defName;
            
            // ? 表情文件路径（包含 happy.png, sad.png 等）
            string expressionPath = EXPRESSIONS_PATH + persona.defName;
            
            // 如果是中性表情，直接加载基础立绘
            if (expression == ExpressionType.Neutral)
            {
                string fullPath = basePath + "/base";
                var baseTex = ContentFinder<Texture2D>.Get(fullPath, false);
                
                if (baseTex != null)
                {
                    return baseTex;
                }
                
                // 降级到旧路径（兼容性）
                Log.Warning($"[PortraitLoader] 未找到 9:16 立绘: {fullPath}，尝试旧路径");
                return ContentFinder<Texture2D>.Get($"UI/Narrators/{persona.defName}", false);
            }
            
            // ? 尝试 1: 加载整图表情（从 Expressions 文件夹）
            string fullExpressionPath = expressionPath + "/" + GetExpressionSuffix(expression);
            var fullTexture = ContentFinder<Texture2D>.Get(fullExpressionPath, false);
            
            if (fullTexture != null)
            {
                Log.Message($"[PortraitLoader] 加载整图表情: {fullExpressionPath}");
                return fullTexture;
            }
            
            // ? 尝试 2: 分层合成（从 Expressions/layers 文件夹）
            var baseTexture = ContentFinder<Texture2D>.Get(basePath + "/base", false);
            
            if (baseTexture != null)
            {
                Log.Message($"[PortraitLoader] 尝试分层合成: {persona.defName} - {expression}");
                return LoadWithLayers_9x16(baseTexture, expressionPath, persona.defName, expression);
            }
            
            // 降级：返回基础立绘
            Log.Warning($"[PortraitLoader] 表情加载失败，返回基础立绘: {persona.defName}");
            return ContentFinder<Texture2D>.Get(basePath + "/base", false);
        }
        
        /// <summary>
        /// ? 分层表情合成（新路径）
        /// </summary>
        private static Texture2D LoadWithLayers_9x16(
            Texture2D baseTexture,
            string expressionPath,  // ? 新参数：表情文件夹路径
            string personaName,
            ExpressionType expression)
        {
            var layers = new System.Collections.Generic.List<ExpressionLayer>();
            
            // 获取表情配置
            var config = GetExpressionLayerConfig(expression);
            
            // ? 加载眼睛层（从 Expressions/layers 文件夹）
            if (!string.IsNullOrEmpty(config.EyesVariant))
            {
                var eyesTex = LoadLayerTexture(expressionPath, "eyes", config.EyesVariant);
                if (eyesTex != null)
                {
                    layers.Add(new ExpressionLayer
                    {
                        LayerType = ExpressionLayerType.Eyes,
                        Variant = config.EyesVariant,
                        Texture = eyesTex,
                        Region = GetLayerRegion(ExpressionLayerType.Eyes),
                        ZOrder = 10
                    });
                }
            }
            
            // ? 加载嘴巴层
            if (!string.IsNullOrEmpty(config.MouthVariant))
            {
                var mouthTex = LoadLayerTexture(expressionPath, "mouth", config.MouthVariant);
                if (mouthTex != null)
                {
                    layers.Add(new ExpressionLayer
                    {
                        LayerType = ExpressionLayerType.Mouth,
                        Variant = config.MouthVariant,
                        Texture = mouthTex,
                        Region = GetLayerRegion(ExpressionLayerType.Mouth),
                        ZOrder = 11
                    });
                }
            }
            
            // ? 加载眉毛层
            if (!string.IsNullOrEmpty(config.EyebrowsVariant))
            {
                var eyebrowsTex = LoadLayerTexture(expressionPath, "eyebrows", config.EyebrowsVariant);
                if (eyebrowsTex != null)
                {
                    layers.Add(new ExpressionLayer
                    {
                        LayerType = ExpressionLayerType.Eyebrows,
                        Variant = config.EyebrowsVariant,
                        Texture = eyebrowsTex,
                        Region = GetLayerRegion(ExpressionLayerType.Eyebrows),
                        ZOrder = 9
                    });
                }
            }
            
            // 合成所有层
            if (layers.Count > 0)
            {
                return LayeredExpressionCompositor.CompositeLayers(
                    baseTexture, 
                    layers, 
                    $"{personaName}_{expression}_9x16");
            }
            
            return baseTexture;
        }
        
        /// <summary>
        /// ? 加载分层纹理（新路径）
        /// </summary>
        private static Texture2D LoadLayerTexture(string expressionPath, string layerType, string variant)
        {
            // ? 从 Expressions/layers 文件夹加载
            string path = $"{expressionPath}/layers/{layerType}_{variant}";
            // 示例路径: UI/Narrators/9x16/Expressions/Cassandra/layers/eyes_happy
            
            var texture = ContentFinder<Texture2D>.Get(path, false);
            
            if (texture != null)
            {
                Log.Message($"[PortraitLoader] 加载分层: {path}");
            }
            
            return texture;
        }
        
        // ... 其他方法保持不变 ...
    }
}
```

---

## ?? 文件迁移步骤

### 步骤 1: 创建新文件夹
```powershell
# 在 Textures/UI/Narrators/9x16/ 下创建 Expressions 文件夹
New-Item -Path "Textures/UI/Narrators/9x16/Expressions" -ItemType Directory
```

### 步骤 2: 移动表情文件
```powershell
# 为每个人格创建表情文件夹
New-Item -Path "Textures/UI/Narrators/9x16/Expressions/Cassandra" -ItemType Directory

# 移动整图表情
Move-Item "Textures/UI/Narrators/9x16/Cassandra/happy.png" `
          "Textures/UI/Narrators/9x16/Expressions/Cassandra/happy.png"
          
Move-Item "Textures/UI/Narrators/9x16/Cassandra/sad.png" `
          "Textures/UI/Narrators/9x16/Expressions/Cassandra/sad.png"

# 移动 layers 文件夹
Move-Item "Textures/UI/Narrators/9x16/Cassandra/layers" `
          "Textures/UI/Narrators/9x16/Expressions/Cassandra/layers"
```

### 步骤 3: 保留基础立绘
```
Textures/UI/Narrators/9x16/Cassandra/ 只保留:
├─ base.png  ← 只有这一个文件！
```

---

## ?? 自动迁移脚本

创建 `Reorganize-Expressions.ps1`:

```powershell
# 表情文件重组脚本

$narratorsPath = "Textures/UI/Narrators/9x16"
$expressionsPath = "$narratorsPath/Expressions"

# 创建 Expressions 主文件夹
if (!(Test-Path $expressionsPath)) {
    New-Item -Path $expressionsPath -ItemType Directory
    Write-Host "? 创建 Expressions 文件夹: $expressionsPath"
}

# 获取所有人格文件夹
$personaFolders = Get-ChildItem -Path $narratorsPath -Directory | Where-Object { $_.Name -ne "Expressions" }

foreach ($persona in $personaFolders) {
    $personaName = $persona.Name
    $sourcePath = $persona.FullName
    $targetPath = "$expressionsPath\$personaName"
    
    Write-Host ""
    Write-Host "处理人格: $personaName" -ForegroundColor Cyan
    
    # 创建表情文件夹
    if (!(Test-Path $targetPath)) {
        New-Item -Path $targetPath -ItemType Directory
        Write-Host "  ? 创建文件夹: $targetPath"
    }
    
    # 移动整图表情文件
    $expressionFiles = Get-ChildItem -Path $sourcePath -File | Where-Object { 
        $_.Name -notmatch "^base\." 
    }
    
    foreach ($file in $expressionFiles) {
        $targetFile = "$targetPath\$($file.Name)"
        Move-Item -Path $file.FullName -Destination $targetFile -Force
        Write-Host "  ?? 移动: $($file.Name) → Expressions/$personaName/"
    }
    
    # 移动 layers 文件夹
    $layersPath = "$sourcePath\layers"
    if (Test-Path $layersPath) {
        $targetLayersPath = "$targetPath\layers"
        Move-Item -Path $layersPath -Destination $targetLayersPath -Force
        Write-Host "  ?? 移动: layers 文件夹 → Expressions/$personaName/"
    }
    
    Write-Host "  ? 完成: $personaName" -ForegroundColor Green
}

Write-Host ""
Write-Host "?? 所有表情文件已重组完成！" -ForegroundColor Green
Write-Host "?? 新结构: $expressionsPath"
```

运行脚本：
```powershell
.\Reorganize-Expressions.ps1
```

---

## ?? 迁移前后对比

### 迁移前
```
Textures/UI/Narrators/9x16/Cassandra/
├─ base.png
├─ happy.png         ← 干扰项
├─ sad.png           ← 干扰项
├─ angry.png         ← 干扰项
└─ layers/
   └─ ...

右键选择立绘时看到 4 个文件 ?
```

### 迁移后
```
Textures/UI/Narrators/9x16/Cassandra/
└─ base.png          ← 只有基础立绘

Textures/UI/Narrators/9x16/Expressions/Cassandra/
├─ happy.png
├─ sad.png
├─ angry.png
└─ layers/
   └─ ...

右键选择立绘时只看到 1 个文件 ? 清爽！
```

---

## ?? 测试验证

### 测试 1: 基础立绘加载
```csharp
var persona = DefDatabase<NarratorPersonaDef>.GetNamed("Cassandra_Classic");
var texture = PortraitLoader.LoadPortrait(persona, ExpressionType.Neutral);

预期结果:
- ? 加载成功
- ? 路径: UI/Narrators/9x16/Cassandra/base
```

### 测试 2: 整图表情加载
```csharp
var texture = PortraitLoader.LoadPortrait(persona, ExpressionType.Happy);

预期结果:
- ? 加载成功
- ? 路径: UI/Narrators/9x16/Expressions/Cassandra/happy
```

### 测试 3: 分层表情加载
```csharp
// 删除 Expressions/Cassandra/happy.png（强制使用分层）
var texture = PortraitLoader.LoadPortrait(persona, ExpressionType.Happy);

预期结果:
- ? 加载基础立绘 + 分层合成
- ? 眼睛层: Expressions/Cassandra/layers/eyes_happy
- ? 嘴巴层: Expressions/Cassandra/layers/mouth_smile
```

### 测试 4: 文件选择干扰
```
1. 右键点击 Textures/UI/Narrators/9x16/Cassandra/
2. 查看文件列表

预期结果:
- ? 只看到 base.png
- ? 没有 happy.png, sad.png 等干扰
```

---

## ?? 兼容性处理

### 降级策略
```csharp
// 如果新路径加载失败，尝试旧路径（兼容旧版本）
var texture = ContentFinder<Texture2D>.Get(newPath, false);

if (texture == null)
{
    Log.Warning($"[PortraitLoader] 新路径失败，尝试旧路径: {oldPath}");
    texture = ContentFinder<Texture2D>.Get(oldPath, false);
}
```

### 支持混合模式
```
允许同时存在:
- 新结构: Expressions/Cassandra/happy.png
- 旧结构: Cassandra/happy.png

优先加载新结构，找不到时降级到旧结构
```

---

## ?? 文档更新

需要更新的文档：
1. ? **立绘放置完整指南.md** - 更新文件夹结构
2. ? **表情文件放置说明.txt** - 更新路径说明
3. ? **9-16立绘动态表情方案.md** - 更新代码示例

---

## ?? 优势总结

### 用户体验改善
- ? **选择立绘时清爽** - 只看到 base.png
- ? **文件组织清晰** - 立绘和表情分离
- ? **降低混淆** - 不会误选表情文件

### 开发维护改善
- ? **结构清晰** - Expressions 文件夹专门存放表情
- ? **易于扩展** - 添加新表情不影响立绘文件夹
- ? **兼容性好** - 支持降级到旧结构

### 性能影响
- ? **无性能损失** - 路径变化不影响加载速度
- ? **缓存继续有效** - 缓存 key 包含完整路径

---

## ?? 实施清单

- [ ] 创建 `Expressions` 文件夹
- [ ] 运行 `Reorganize-Expressions.ps1` 脚本
- [ ] 修改 `PortraitLoader.cs` 代码
- [ ] 测试基础立绘加载
- [ ] 测试整图表情加载
- [ ] 测试分层表情加载
- [ ] 验证文件选择不再干扰
- [ ] 更新相关文档

---

**完成时间**: 2025-01-XX  
**状态**: ? 已规划，待实施  
**预计耗时**: 30 分钟
