# 分层立绘表情拆分系统 - 完成总结 v1.6.18

## ?? **功能已完成！**

成功实现了**表情部件拆分与拼接系统**，将原来的完整表情图拆分为独立的 **eyes（眼睛）**、**mouth（嘴巴）**、**flush（脸红）** 三个部件，并在 `base_body.png` 底图上进行拼接合成。

---

## ? **已完成的工作**

### **1. 代码修改**
- ? **LayerDefinition.cs** - 更新 `CreateDefault()` 方法
  - 新增 `base_body` 图层（Priority=0，最底层）
  - 新增表情部件图层：`flush`（Priority=20）、`eyes`（Priority=30）、`mouth`（Priority=40）
  - 移除旧的完整表情图层

### **2. 文档创建**
- ? **分层立绘表情拆分系统-v1.6.18.md** - 详细实现文档
  - 文件结构说明
  - 制作流程指南
  - 代码逻辑解析
  - 常见问题解答

- ? **分层立绘表情拆分-快速参考-v1.6.18.md** - 快速参考卡
  - 核心概念
  - 文件命名规则
  - 图层叠加顺序
  - 制作流程

- ? **Textures/UI/Narrators/9x16/Layered/README.md** - 更新纹理资源说明
  - v1.6.18 新特性说明
  - 表情部件命名规则
  - Photoshop/GIMP 工作流程
  - 完整示例

### **3. Git 提交**
- ? **Commit:** 716b0e2
- ? **已推送到 GitHub**
- ? **分支:** main

---

## ?? **新的文件结构**

```
Textures/UI/Narrators/9x16/Layered/Sideria/
├── base_body.png           ← 底图（身体+默认表情）
└── 表情部件：
    ├── neutral_eyes.png    ← 默认：眼睛
    ├── neutral_mouth.png   ← 默认：嘴巴
    ├── happy_eyes.png      ← 开心：眼睛
    ├── happy_mouth.png     ← 开心：嘴巴
    ├── happy_flush.png     ← 开心：脸红（可选）
    ├── sad_eyes.png
    ├── sad_mouth.png
    └── ...
```

---

## ?? **核心逻辑**

### **拼接原理**
```
完整立绘 = base_body（底图）
         + {expression}_flush（脸红，如果有）
         + {expression}_eyes（眼睛）
         + {expression}_mouth（嘴巴）
         + hair（头发）
         + accessories（配饰）
```

### **图层顺序（Priority）**
```
Priority  图层         文件名
--------  ----------  -------------------------
0         base_body   base_body.png              ← 最底层
5         background  background.png
10        outfit      outfit_{outfit}.png
20        flush       {expression}_flush.png     ← 脸红
30        eyes        {expression}_eyes.png      ← 眼睛
40        mouth       {expression}_mouth.png     ← 嘴巴
50        hair        hair.png
60        accessories accessories.png
70        fx          fx.png
```

---

## ?? **表情部件命名规则**

### **格式：`{expression}_{part}.png`**

| 表情 | 眼睛 | 嘴巴 | 脸红（可选） |
|-----|------|------|------------|
| Neutral | `neutral_eyes.png` | `neutral_mouth.png` | `neutral_flush.png` |
| Happy | `happy_eyes.png` | `happy_mouth.png` | `happy_flush.png` |
| Sad | `sad_eyes.png` | `sad_mouth.png` | - |
| Angry | `angry_eyes.png` | `angry_mouth.png` | - |
| Surprised | `surprised_eyes.png` | `surprised_mouth.png` | `surprised_flush.png` |
| Confused | `confused_eyes.png` | `confused_mouth.png` | - |
| Smug | `smug_eyes.png` | `smug_mouth.png` | - |
| Shy | `shy_eyes.png` | `shy_mouth.png` | `shy_flush.png` |

---

## ? **优势**

| 优势 | 说明 |
|-----|------|
| **文件大小** | 减少约50%（每个表情只需2-3个小文件） |
| **灵活性** | 可以独立修改眼睛、嘴巴、脸红 |
| **动画支持** | 支持独立的眨眼/张嘴动画 |
| **易维护** | 修改表情只需替换对应部件 |
| **表情组合** | 可以混搭不同表情的部件 |

---

## ?? **下一步：制作纹理资源**

### **任务清单**

#### **1. 准备底图**
- [ ] 创建 `base_body.png`（1024x1572）
- [ ] 绘制身体 + 默认表情（眼睛+嘴巴）
- [ ] 背景保持透明
- [ ] 放置到 `Textures/UI/Narrators/9x16/Layered/Sideria/base_body.png`

#### **2. 制作表情部件**
对于每个表情（建议优先制作以下表情）：

- [ ] **Neutral（默认）**
  - [ ] `neutral_eyes.png`
  - [ ] `neutral_mouth.png`

- [ ] **Happy（开心）**
  - [ ] `happy_eyes.png`
  - [ ] `happy_mouth.png`
  - [ ] `happy_flush.png`（可选）

- [ ] **Sad（悲伤）**
  - [ ] `sad_eyes.png`
  - [ ] `sad_mouth.png`

- [ ] **Angry（愤怒）**
  - [ ] `angry_eyes.png`
  - [ ] `angry_mouth.png`

- [ ] **Shy（害羞）**
  - [ ] `shy_eyes.png`
  - [ ] `shy_mouth.png`
  - [ ] `shy_flush.png`

#### **3. 测试与验证**
- [ ] 启动游戏
- [ ] 选择 Sideria 人格
- [ ] 切换表情，检查是否正确显示
- [ ] 检查表情部件是否对齐

---

## ??? **制作指南**

### **Photoshop 工作流程**

1. **创建 PSD 项目**
   ```
   文件 → 新建 → 1024x1572 像素
   ```

2. **绘制底图**
   ```
   图层结构：
   ├── 底图组 (base_body)
   │   ├── 身体
   │   ├── 默认眼睛
   │   └── 默认嘴巴
   ```

3. **导出底图**
   ```
   隐藏所有表情图层
   文件 → 导出 → 存储为PNG → base_body.png
   ```

4. **制作表情部件**
   ```
   对于每个表情（如 Happy）：
   ├── 新建图层组 "Happy 表情"
   │   ├── happy_flush（脸红）
   │   ├── happy_eyes（眼睛）
   │   └── happy_mouth（嘴巴）
   
   导出每个图层：
   1. 只显示 happy_flush → 导出 happy_flush.png
   2. 只显示 happy_eyes → 导出 happy_eyes.png
   3. 只显示 happy_mouth → 导出 happy_mouth.png
   ```

5. **检查透明度**
   ```
   确保：
   - 部件图层的非绘制区域是透明的（不是白色或其他颜色）
   - 导出设置中"透明度"已勾选
   ```

---

## ?? **相关文档**

### **详细文档**
- [分层立绘表情拆分系统-v1.6.18.md](分层立绘表情拆分系统-v1.6.18.md) - 完整实现说明
- [分层立绘路径修复说明-v1.6.18.md](分层立绘路径修复说明-v1.6.18.md) - 路径修复说明

### **快速参考**
- [分层立绘表情拆分-快速参考-v1.6.18.md](分层立绘表情拆分-快速参考-v1.6.18.md) - 快速参考卡
- [分层立绘系统-快速参考.md](分层立绘系统-快速参考.md) - 系统总览

### **纹理资源**
- [Textures/UI/Narrators/9x16/Layered/README.md](Textures/UI/Narrators/9x16/Layered/README.md) - 纹理资源说明

---

## ?? **代码变更总结**

### **LayerDefinition.cs**
```diff
// 旧逻辑（v1.6.17）：
- new LayerDefinition {
-     LayerId = "body",
-     TexturePath = "UI/Narrators/9x16/Layered/{persona}/body.png"
- }
- new LayerDefinition {
-     LayerId = "face",
-     TexturePath = "UI/Narrators/9x16/Layered/{persona}/face_{expression}.png"
- }

// 新逻辑（v1.6.18）：
+ new LayerDefinition {
+     LayerId = "base_body",
+     Priority = 0,  // 最底层
+     TexturePath = "UI/Narrators/9x16/Layered/{persona}/base_body.png"
+ }
+ new LayerDefinition {
+     LayerId = "flush",
+     Priority = 20,
+     TexturePath = "UI/Narrators/9x16/Layered/{persona}/{expression}_flush.png"
+ }
+ new LayerDefinition {
+     LayerId = "eyes",
+     Priority = 30,
+     TexturePath = "UI/Narrators/9x16/Layered/{persona}/{expression}_eyes.png"
+ }
+ new LayerDefinition {
+     LayerId = "mouth",
+     Priority = 40,
+     TexturePath = "UI/Narrators/9x16/Layered/{persona}/{expression}_mouth.png"
+ }
```

---

## ?? **预期效果**

### **表情切换流程**
```
1. 玩家触发表情切换（如 Happy）
2. 系统保留 base_body.png（底图不变）
3. 加载新的表情部件：
   - happy_flush.png（如果有）
   - happy_eyes.png
   - happy_mouth.png
4. 按 Priority 顺序叠加合成
5. 显示完整的 Happy 表情立绘
```

### **文件大小对比**
```
旧系统（完整立绘）：
- neutral.png     300KB
- happy.png       300KB
- sad.png         300KB
- angry.png       300KB
总计：1.2MB（4个表情）

新系统（部件拆分）：
- base_body.png   300KB  ← 只需要1个底图
- happy_eyes.png  50KB
- happy_mouth.png 30KB
- happy_flush.png 20KB
- sad_eyes.png    50KB
- sad_mouth.png   30KB
- angry_eyes.png  50KB
- angry_mouth.png 30KB
总计：560KB（4个表情）

节省：~54%
```

---

## ?? **已知问题与解决**

### **问题1：路径错误（Layers/ vs Layered/）**
- **状态：** ? 已修复（Commit: 3236576）
- **解决：** 所有路径统一为 `Layered/`

### **问题2：表情部件对不齐**
- **原因：** PNG尺寸不一致
- **解决：** 确保所有PNG都是 1024x1572

### **问题3：脸红层不显示**
- **原因：** 不透明度过低或文件不存在
- **解决：** 脸红层不透明度建议 50-70%，文件不存在时系统会跳过

---

## ?? **版本信息**

| 项目 | 详情 |
|-----|------|
| **版本** | v1.6.18 |
| **Commit** | 716b0e2 |
| **分支** | main |
| **状态** | ? 代码已完成，等待纹理资源 |
| **推送时间** | 2024 |
| **修改文件** | 4 个文件（+767 行，-357 行） |

---

## ?? **总结**

成功实现了**分层立绘表情拆分系统**，将表情从完整图片拆分为独立的 eyes/mouth/flush 部件，并在 base_body 底图上进行拼接合成。

**优势：**
- 文件大小减少约50%
- 支持独立的眨眼/张嘴动画
- 灵活的表情部件混搭
- 更容易制作和维护

**下一步：** 制作纹理资源（base_body + 表情部件）

---

**?? 准备好开始制作纹理资源了吗？**
