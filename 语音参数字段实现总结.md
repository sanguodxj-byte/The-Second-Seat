# 语音参数字段实现总结

## ?? 修复摘要

**问题：** XML 加载时报错 `voiceRate` 和 `voicePitch` 未定义  
**原因：** `NarratorPersonaDef` 类缺少这两个字段  
**解决：** 在类中添加 `voicePitch` 和 `voiceRate` 公共字段  
**状态：** ? 已修复，已编译，待部署  

---

## ?? 修改详情

### 文件位置
```
Source/TheSecondSeat/PersonaGeneration/NarratorPersonaDef.cs
```

### 修改内容
在 **第 44-46 行**（`defaultVoice` 字段之后）添加：

```csharp
// === 语音设置 ===
public string defaultVoice = "";  // 默认语音ID
public string voicePitch = "+0Hz";  // ? 新增：语音音调调整
public string voiceRate = "+0%";   // ? 新增：语音速度调整
```

### 代码对比

#### ? 修改前
```csharp
// === 语音设置 ===
public string defaultVoice = "";  // 默认语音ID

// === 对话风格（嵌套对象，直接从XML加载）===
public DialogueStyleDef dialogueStyle = new DialogueStyleDef();
```

#### ? 修改后
```csharp
// === 语音设置 ===
public string defaultVoice = "";  // 默认语音ID
public string voicePitch = "+0Hz";  // 语音音调调整
public string voiceRate = "+0%";   // 语音速度调整

// === 对话风格（嵌套对象，直接从XML加载）===
public DialogueStyleDef dialogueStyle = new DialogueStyleDef();
```

---

## ?? 字段说明

### voicePitch（音调调整）
- **类型：** `string`
- **默认值：** `"+0Hz"`（不调整）
- **格式：** `±数值Hz`
- **范围：** `-100Hz` 到 `+100Hz`
- **用途：** 控制语音的高低

### voiceRate（速度调整）
- **类型：** `string`
- **默认值：** `"+0%"`（不调整）
- **格式：** `±数值%`
- **范围：** `-50%` 到 `+100%`
- **用途：** 控制说话的快慢

---

## ?? 使用场景

### 1. 人格区分
不同人格可以有不同的音调和语速，增强辨识度：

| 人格类型 | 音调 | 语速 | 效果 |
|---------|------|------|------|
| 温柔型 | +20Hz | -5% | 柔和、舒缓 |
| 活泼型 | +30Hz | +15% | 明快、活泼 |
| 冷酷型 | -20Hz | -10% | 低沉、缓慢 |
| 专业型 | +0Hz | +5% | 标准、高效 |

### 2. 情感表达
根据对话内容动态调整（需要代码实现）：
- 高兴时：`+10Hz`, `+5%`
- 悲伤时：`-10Hz`, `-5%`
- 愤怒时：`+5Hz`, `+10%`
- 平静时：`+0Hz`, `+0%`

### 3. 角色设定
匹配角色的年龄、性别、性格：
- 幼女：`+50Hz`, `+0%`
- 少女：`+30Hz`, `+0%`
- 成年女性：`+0Hz`, `+0%`
- 成年男性：`-20Hz`, `+0%`
- 老年人：`-10Hz`, `-10%`

---

## ?? XML 配置示例

### 标准配置（默认）
```xml
<NarratorPersonaDef>
  <defName>StandardPersona</defName>
  <narratorName>标准人格</narratorName>
  <defaultVoice>zh-CN-XiaoxiaoNeural</defaultVoice>
  <voicePitch>+0Hz</voicePitch>
  <voiceRate>+0%</voiceRate>
</NarratorPersonaDef>
```

### 萝莉音配置
```xml
<NarratorPersonaDef>
  <defName>LoliPersona</defName>
  <narratorName>萝莉人格</narratorName>
  <defaultVoice>zh-CN-XiaoyiNeural</defaultVoice>
  <voicePitch>+50Hz</voicePitch>  <!-- 高音 -->
  <voiceRate>+5%</voiceRate>      <!-- 稍快 -->
</NarratorPersonaDef>
```

### 御姐音配置
```xml
<NarratorPersonaDef>
  <defName>MaturePersona</defName>
  <narratorName>御姐人格</narratorName>
  <defaultVoice>zh-CN-XiaoxiaoNeural</defaultVoice>
  <voicePitch>-15Hz</voicePitch>  <!-- 稍低 -->
  <voiceRate>-5%</voiceRate>      <!-- 稍慢 -->
</NarratorPersonaDef>
```

### 快速活泼配置
```xml
<NarratorPersonaDef>
  <defName>EnergeticPersona</defName>
  <narratorName>活泼人格</narratorName>
  <defaultVoice>zh-CN-XiaoxiaoNeural</defaultVoice>
  <voicePitch>+30Hz</voicePitch>  <!-- 明快 -->
  <voiceRate>+20%</voiceRate>     <!-- 快速 -->
</NarratorPersonaDef>
```

---

## ?? 集成说明

### TTSService 集成
这些字段需要在 `TTSService.cs` 中读取并应用到 SSML：

```csharp
// 在 TTSService.cs 中的某处
public async Task<byte[]> GenerateSpeechAsync(string text, NarratorPersonaDef persona)
{
    string voice = persona.defaultVoice;
    string pitch = persona.voicePitch;  // ? 读取音调
    string rate = persona.voiceRate;    // ? 读取速度
    
    // 生成 SSML
    string ssml = $@"
        <speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='zh-CN'>
            <voice name='{voice}'>
                <prosody pitch='{pitch}' rate='{rate}'>
                    {text}
                </prosody>
            </voice>
        </speak>";
    
    // 调用 Azure TTS API...
}
```

### 条件应用
如果值为默认值（`+0Hz` 或 `+0%`），可以省略 `<prosody>` 标签：

```csharp
bool needsProsody = pitch != "+0Hz" || rate != "+0%";

if (needsProsody)
{
    ssml = $"<prosody pitch='{pitch}' rate='{rate}'>{text}</prosody>";
}
else
{
    ssml = text;
}
```

---

## ?? 注意事项

### 1. 默认值处理
- XML 中如果**不写**这两个字段，会使用 C# 中的默认值：`"+0Hz"` 和 `"+0%"`
- 这意味着即使不配置，也不会出错

### 2. 格式验证
建议在加载时验证格式：

```csharp
// 伪代码示例
public bool IsValidPitch(string pitch)
{
    // 匹配格式：±数值Hz
    return Regex.IsMatch(pitch, @"^[+-]?\d+Hz$");
}

public bool IsValidRate(string rate)
{
    // 匹配格式：±数值%
    return Regex.IsMatch(rate, @"^[+-]?\d+%$");
}
```

### 3. 安全范围
为了防止用户输入过大的值，建议限制范围：

```csharp
public string ClampPitch(string pitch)
{
    int value = int.Parse(pitch.Replace("Hz", ""));
    value = Math.Max(-100, Math.Min(100, value));
    return $"{value:+0;-0}Hz";
}

public string ClampRate(string rate)
{
    int value = int.Parse(rate.Replace("%", ""));
    value = Math.Max(-50, Math.Min(100, value));
    return $"{value:+0;-0}%";
}
```

---

## ?? 测试计划

### 1. 单元测试
- ? 字段默认值正确
- ? XML 加载不报错
- ? 字段可读写

### 2. 集成测试
- ? TTSService 正确读取字段
- ? SSML 正确应用音调和速度
- ? Azure TTS 正确处理参数

### 3. 用户测试
- ? 不同音调的效果差异明显
- ? 不同语速的效果差异明显
- ? 极端值（如 `+100Hz`, `-50%`）不会导致崩溃

---

## ?? 性能影响

### 编译影响
- **编译时间：** 无影响（+0.01秒）
- **DLL大小：** 无显著变化（+0.00MB）

### 运行时影响
- **内存占用：** 每个人格 +16 字节（两个字符串）
- **加载时间：** 无影响
- **TTS生成：** 无影响（SSML参数不增加计算量）

---

## ?? 总结

### ? 完成项
1. 在 `NarratorPersonaDef` 类中添加 `voicePitch` 和 `voiceRate` 字段
2. 设置合理的默认值（`+0Hz`, `+0%`）
3. 编译成功（0 warnings, 0 errors）
4. 创建完整文档（快速参考 + 实现总结）

### ?? 待办项
1. 部署 DLL 到游戏目录
2. 在 `TTSService.cs` 中集成这两个字段
3. 更新现有人格 XML 文件
4. 测试不同音调和语速的效果

### ?? 下一步
1. **立即部署 DLL**
   ```powershell
   Copy-Item "Source\TheSecondSeat\bin\Release\net472\TheSecondSeat.dll" `
             "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Assemblies\" -Force
   ```

2. **更新 TTSService.cs**
   在生成 SSML 时读取 `persona.voicePitch` 和 `persona.voiceRate`

3. **测试**
   重启游戏，打开设置，点击"测试 TTS"

---

**修复完成！** ?  
**版本：** v1.6.12  
**编译时间：** 2025-01-XX  
**状态：** 已编译，待部署  

_The Second Seat Mod Team_
