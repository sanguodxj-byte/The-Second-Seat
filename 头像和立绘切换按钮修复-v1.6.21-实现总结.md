# 头像和立绘切换按钮修复 - v1.6.21 实现总结

## ? **已完成修复**

### **修复内容**

#### 1. **PortraitLoader.cs - 缓存键修改**
- **文件位置**：`Source/TheSecondSeat/PersonaGeneration/PortraitLoader.cs`
- **修改行号**：第 57 行左右
- **修改内容**：
```csharp
// 修改前
string cacheKey = def.defName + expressionSuffix;

// 修改后
string cacheKey = $"{def.defName}_portrait_{expressionSuffix}";
```

- **新增方法**：
```csharp
/// <summary>
/// ? v1.6.21: 清空所有缓存（用于模式切换）
/// </summary>
public static void ClearAllCache()
{
    cache.Clear();
    Log.Message("[PortraitLoader] 所有立绘缓存已清空");
}
```

#### 2. **AvatarLoader.cs - 缓存键修改**
- **文件位置**：`Source/TheSecondSeat/PersonaGeneration/AvatarLoader.cs`
- **修改行号**：第 52 行左右
- **修改内容**：
```csharp
// 修改前
string cacheKey = def.defName + "_avatar" + expressionSuffix;

// 修改后
string cacheKey = $"{def.defName}_avatar_{expressionSuffix}";
```

- **新增方法**：
```csharp
/// <summary>
/// ? v1.6.21: 清空所有缓存（用于模式切换）
/// </summary>
public static void ClearAllCache()
{
    cache.Clear();
    Log.Message("[AvatarLoader] 所有头像缓存已清空");
}
```

#### 3. **NarratorScreenButton.cs - 设置变化检测**（待手动完成）
- **文件位置**：`Source/TheSecondSeat/UI/NarratorScreenButton.cs`
- **需要添加的字段**（在第 41 行左右）：
```csharp
// ? v1.6.21: 上一次设置缓存（用于检测模式切换）
private bool lastUsePortraitMode = false;
```

- **需要修改的方法**（`UpdatePortrait` 方法开头）：
```csharp
private void UpdatePortrait()
{
    if (Find.TickManager.TicksGame - portraitUpdateTick < PORTRAIT_UPDATE_INTERVAL)
    {
        return;
    }
    
    portraitUpdateTick = Find.TickManager.TicksGame;
    
    // ? v1.6.21: 检测设置变化
    var modSettings = LoadedModManager.GetMod<TheSecondSeatMod>()?.GetSettings<TheSecondSeatSettings>();
    bool currentPortraitMode = modSettings?.usePortraitMode ?? false;
    
    if (currentPortraitMode != lastUsePortraitMode)
    {
        // 设置变化，清除所有缓存
        AvatarLoader.ClearAllCache();
        PortraitLoader.ClearAllCache();
        LayeredPortraitCompositor.ClearAllCache();
        
        lastUsePortraitMode = currentPortraitMode;
        currentPortrait = null;  // 强制重新加载
        currentPersona = null;
        
        if (Prefs.DevMode)
        {
            Log.Message($"[NarratorScreenButton] Portrait mode changed to: {currentPortraitMode}");
        }
    }
    
    // ... 继续原有逻辑
}
```

---

## ?? **手动完成步骤**

由于网络超时，`NarratorScreenButton.cs` 需要手动修改：

### **Step 1: 添加字段**
在 `NarratorScreenButton.cs` 第 41 行（`portraitUpdateTick` 字段后）添加：

```csharp
private bool lastUsePortraitMode = false;
```

### **Step 2: 修改 UpdatePortrait 方法**
在 `UpdatePortrait` 方法的开头（`portraitUpdateTick = Find.TickManager.TicksGame;` 这一行后）添加：

```csharp
// ? v1.6.21: 检测设置变化
var modSettings = LoadedModManager.GetMod<TheSecondSeatMod>()?.GetSettings<TheSecondSeatSettings>();
bool currentPortraitMode = modSettings?.usePortraitMode ?? false;

if (currentPortraitMode != lastUsePortraitMode)
{
    // 设置变化，清除所有缓存
    AvatarLoader.ClearAllCache();
    PortraitLoader.ClearAllCache();
    LayeredPortraitCompositor.ClearAllCache();
    
    lastUsePortraitMode = currentPortraitMode;
    currentPortrait = null;  // 强制重新加载
    currentPersona = null;
    
    if (Prefs.DevMode)
    {
        Log.Message($"[NarratorScreenButton] Portrait mode changed to: {currentPortraitMode}");
    }
}
```

---

## ?? **修复前后对比**

### **修复前**
| 加载器 | 缓存键格式 | 问题 |
|--------|-----------|------|
| AvatarLoader | `{defName}_avatar{expression}` | 缺少标识符 |
| PortraitLoader | `{defName}{expression}` | 与 AvatarLoader 冲突 |
| LayeredPortraitCompositor | `{defName}_layered_{expression}_{outfit}` | 正常 |

**问题**：当用户切换"使用立绘模式"时，缓存键格式相同，导致加载旧图片。

### **修复后**
| 加载器 | 缓存键格式 | 状态 |
|--------|-----------|------|
| AvatarLoader | `{defName}_avatar_{expression}` | ? 清晰标识 |
| PortraitLoader | `{defName}_portrait_{expression}` | ? 清晰标识 |
| LayeredPortraitCompositor | `{defName}_layered_{expression}_{outfit}` | ? 已有标识 |

**结果**：每个加载器的缓存键都有明确的标识符，不会冲突。

---

## ? **预期效果**

修复后：
1. 在设置中切换"使用立绘模式"
2. 返回游戏，`NarratorScreenButton.UpdatePortrait()` 检测到设置变化
3. 清除所有缓存（AvatarLoader + PortraitLoader + LayeredPortraitCompositor）
4. 强制重新加载头像或立绘
5. AI按钮立即显示更新后的图片
6. **无需重启游戏**

---

## ?? **测试清单**

完成手动修改后，请测试：

- [ ] 从头像模式切换到立绘模式，AI按钮立即显示立绘
- [ ] 从立绘模式切换到头像模式，AI按钮立即显示头像
- [ ] 表情切换在两种模式下都正常工作
- [ ] 缓存正确清除，没有残留旧图片
- [ ] DevMode 下查看日志，确认缓存清除和重新加载

---

## ?? **下一步**

1. 手动完成 `NarratorScreenButton.cs` 的修改
2. 编译测试
3. 验证功能是否正常
4. 创建部署脚本

---

**版本：** v1.6.21  
**状态：** 部分完成（需手动修改 NarratorScreenButton.cs）  
**预计工作量：** 10 分钟手动修改 + 5 分钟测试
