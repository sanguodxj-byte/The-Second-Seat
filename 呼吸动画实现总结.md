# 呼吸动画功能实现总结

## ? 实现完成

### 1. **ExpressionSystem.cs 修改**

已为 `ExpressionState` 类添加呼吸动画参数：

```csharp
public class ExpressionState
{
    // ...existing properties...
    
    // 呼吸动画参数
    public float BreathingSpeed { get; set; } = 2f;        // 速度（默认 2.0）
    public float BreathingIntensity { get; set; } = 4f;    // 强度（默认 4.0 像素）
}
```

### 2. **GetBreathingOffset() 方法**

添加了计算呼吸偏移量的辅助方法：

```csharp
/// <summary>
/// 获取呼吸动画的Y轴偏移量
/// </summary>
public static float GetBreathingOffset(string personaDefName)
{
    var state = GetExpressionState(personaDefName);
    return Mathf.Sin(Time.realtimeSinceStartup * state.BreathingSpeed) * state.BreathingIntensity;
}
```

**工作原理：**
- 使用 `Time.realtimeSinceStartup` 确保即使游戏暂停也能正常运行
- 正弦波函数产生平滑的上下浮动效果
- 偏移量 = `sin(time * speed) * intensity`
- 默认参数下：每秒完成约 0.32 次呼吸循环，偏移 ±4 像素

### 3. **NarratorWindow.cs 修改**

在 `DrawPersonaCardCompact` 方法中应用呼吸动画：

```csharp
// 获取呼吸偏移量
float breathingOffset = ExpressionSystem.GetBreathingOffset(persona.defName);

// 应用到立绘区域
portraitRect.y += breathingOffset;

// 绘制立绘
GUI.DrawTexture(portraitRect, currentPortrait, ScaleMode.ScaleToFit);

// 名字区域保持固定（抵消呼吸偏移）
var nameRect = new Rect(innerRect.x, portraitRect.yMax + 2f - breathingOffset, innerRect.width, 18f);
```

---

## ?? 功能特性

### ? 要求达成情况

| 要求 | 状态 | 说明 |
|------|------|------|
| 添加 BreathingSpeed | ? | 默认值 2.0 |
| 添加 BreathingIntensity | ? | 默认值 4.0 |
| 创建 GetBreathingOffset() | ? | 使用正弦波计算偏移 |
| 使用 Time.realtimeSinceStartup | ? | 游戏暂停时仍然工作 |
| 应用到 GUI.DrawTexture | ? | 修改 portraitRect.y |
| 纯视觉效果 | ? | 不影响纹理资产 |

### ?? 视觉效果

- **呼吸周期**: 约 3.14 秒（2π / 2.0）
- **偏移范围**: -4 到 +4 像素
- **效果**: 立绘轻柔地上下浮动，模拟呼吸
- **稳定性**: 使用实时时间，不受游戏速度影响

---

## ?? 使用说明

### 调整呼吸参数

如果需要自定义呼吸效果，可以修改人格的表情状态：

```csharp
var state = ExpressionSystem.GetExpressionState("Sideria_Default");
state.BreathingSpeed = 3f;        // 更快的呼吸
state.BreathingIntensity = 6f;    // 更大的移动幅度
```

### 禁用呼吸动画

将强度设为 0：

```csharp
state.BreathingIntensity = 0f;
```

---

## ?? 技术细节

### 正弦波动画原理

```
Offset = sin(Time × Speed) × Intensity

Time = 0.0s  → Offset = 0.0px     (中间位置)
Time = 0.25s → Offset = +4.0px    (最高点)
Time = 0.5s  → Offset = 0.0px     (中间位置)
Time = 0.75s → Offset = -4.0px    (最低点)
Time = 1.0s  → Offset = 0.0px     (循环开始)
```

### 性能影响

- **CPU**: 极低（每帧一次三角函数计算）
- **内存**: 无额外分配
- **GPU**: 无变化（仅改变绘制位置）

---

## ?? 文件变更

### 新增文件
- `Source/TheSecondSeat/PersonaGeneration/ExpressionSystem_WithBreathing.cs`
  - 包含完整呼吸动画功能的 ExpressionSystem 版本

### 修改文件
- `Source/TheSecondSeat/UI/NarratorWindow.cs`
  - `DrawPersonaCardCompact()` 方法中应用呼吸偏移

---

## ? 部署步骤

### 1. 替换文件

将 `ExpressionSystem_WithBreathing.cs` 重命名并替换原文件：

```powershell
# 备份原文件
Copy-Item "Source\TheSecondSeat\PersonaGeneration\ExpressionSystem.cs" `
          "Source\TheSecondSeat\PersonaGeneration\ExpressionSystem.cs.bak"

# 替换为新文件
Move-Item "Source\TheSecondSeat\PersonaGeneration\ExpressionSystem_WithBreathing.cs" `
          "Source\TheSecondSeat\PersonaGeneration\ExpressionSystem.cs" -Force
```

### 2. 编译测试

```powershell
cd Source
dotnet build TheSecondSeat.csproj
```

### 3. 游戏内测试

1. 启动 RimWorld
2. 打开叙事者窗口
3. 观察左侧立绘是否有轻微的上下浮动
4. 确认名字标签保持固定位置

---

## ?? 预期效果

打开叙事者窗口后，您应该看到：

- ? 立绘以约 3 秒周期轻柔地上下浮动
- ? 移动幅度约 4 像素，视觉上非常微妙
- ? 名字标签保持固定，不会跟随浮动
- ? 即使游戏暂停，动画仍然继续播放
- ? 所有人格都自动应用呼吸效果

---

## ?? 故障排除

### 问题：立绘没有移动
- 检查 `GetBreathingOffset()` 是否被正确调用
- 确认 `BreathingIntensity > 0`
- 使用开发模式日志查看偏移值

### 问题：移动过快或过慢
- 调整 `BreathingSpeed` 参数
- 建议范围：1.0 ~ 5.0

### 问题：移动幅度过大或过小
- 调整 `BreathingIntensity` 参数
- 建议范围：2.0 ~ 10.0

---

## ?? 相关文档

- [立绘动态表情系统-完整指南.md](立绘动态表情系统-完整指南.md)
- [ExpressionSystem 快速参考](表情系统快速参考.md)

---

**实现日期**: 2025-01-XX  
**版本**: v1.6.17  
**状态**: ? 已完成
