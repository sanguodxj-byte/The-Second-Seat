表情变化系统诊断报告
生成时间: 2025-12-06 15:37:26

## 检查项目

1. ? ExpressionSystem.cs - 表情系统核心
2. ? PortraitLoader.cs - 立绘加载器
3. ? AvatarLoader.cs - 头像加载器
4. ? NarratorWindow.cs - 表情触发
5. ? DLL 编译状态
6. ? 游戏日志检查
7. ? 表情文件检查

## 常见问题排查

### 问题1：表情不切换
- 检查 NarratorWindow.cs 是否调用 UpdateExpressionByDialogueTone
- 检查对话文本是否包含触发关键词
- 检查日志是否有 [ExpressionSystem] 表情切换 记录

### 问题2：随机变体不生效
- 确认 GetRandomVariant 方法存在
- 确认 PortraitLoader 和 AvatarLoader 都调用 GetExpressionSuffix
- 检查是否有多个变体文件（如 happy1.png, happy2.png）

### 问题3：害羞表情不显示
- 确认 ExpressionType.Shy 枚举存在
- 确认 UpdateExpressionByDialogueTone 包含害羞关键词识别
- 确认 shy.png 文件存在

## 下一步操作

1. 如果 DLL 过时：重新编译
   cd "Source\TheSecondSeat"
   dotnet build -c Release

2. 如果代码正确但不生效：检查游戏日志
   查看: C:\Users\Administrator\AppData\Local\..\LocalLow\Ludeon Studios\RimWorld by Ludeon Studios\Player.log

3. 如果日志无输出：可能未触发表情切换
   - 确保与叙事者对话时发送了包含关键词的文本
   - 检查 NarratorWindow.cs 的事件绑定

4. 如果有错误日志：查看具体错误信息并修复

## 测试建议

1. 发送包含害羞关键词的消息：
   "谢谢你"、"不好意思"、"有点害羞"

2. 观察立绘和头像是否同步切换

3. 多次触发同一表情，观察是否随机显示不同变体
