# ?? 多模态立绘分析人格生成系统 - v1.6.62

**实现时间**: 2024-12-19  
**状态**: ? **开发中**（Step 1-3 已完成）

---

## ?? 核心功能

### 用户体验流程
1. **点击选择立绘** → 打开多模态分析弹窗
2. **左侧**：立绘预览（自动缩放）
3. **右侧**：
   - 输入人格名称
   - 选择最多3个特质（善良、坚强、温柔等18个选项）
   - 输入用户补充描述（必填，至少20字）
4. **右下角**：点击"开始分析"按钮
5. **AI分析**：
   - 结合图像视觉分析
   - 结合用户选择的特质
   - 结合用户补充描述
6. **生成结果**：
   - 完整的人格数据
   - 3-6个个性标签（如：善良、坚强、爱撒娇、病娇等）
   - 可在人格卡片上显示和修改

---

## ? 已完成的改动

### 1. 新建文件

| 文件 | 说明 |
|------|------|
| `Source/TheSecondSeat/UI/Dialog_MultimodalPersonaGeneration.cs` | 多模态分析弹窗 |

### 2. 修改文件

| 文件 | 修改内容 |
|------|----------|
| `MultimodalAnalysisService.cs` | 添加 `AnalyzePersonaImageWithTraits` 方法 |
| `PersonaAnalyzer.cs` | `PersonaAnalysisResult` 添加 `PersonalityTags` 字段 |
| `NarratorPersonaDef.cs` | 添加 `personalityTags` 和 `selectedTraits` 字段 |

---

## ?? 核心代码结构

### Dialog_MultimodalPersonaGeneration.cs

```csharp
// 用户输入
private string personaName = "";
private List<string> selectedTraits = new List<string>();  // 最多3个
private string userSupplement = "";

// 可选特质列表（18个）
private static readonly string[] AvailableTraits = new[]
{
    "善良", "坚强", "温柔", "冷酷", "勇敢", "谨慎",
    "乐观", "悲观", "理性", "感性", "自信", "谦逊",
    "外向", "内向", "严肃", "活泼", "冷静", "热情"
};

// 核心方法
private void StartAnalysis()
{
    // 1. 构建完整的用户输入（特质 + 补充）
    string fullUserInput = BuildFullUserInput();
    
    // 2. 调用多模态分析服务
    var analysisResult = MultimodalAnalysisService.Instance
        .AnalyzePersonaImageWithTraits(
            portraitTexture,
            personaName,
            selectedTraits,
            fullUserInput
        );
    
    // 3. 创建人格定义
    CreatePersonaFromAnalysis(analysisResult);
}
```

### MultimodalAnalysisService.cs

```csharp
// 新增方法：支持特质和用户补充的分析
public PersonaAnalysisResult AnalyzePersonaImageWithTraits(
    Texture2D texture,
    string personaName,
    List<string> selectedTraits,
    string userSupplement)
{
    // 1. 调用异步方法进行多模态分析
    var visionResult = await AnalyzeTextureWithTraitsAsync(
        texture, selectedTraits, userSupplement);
    
    // 2. 提取个性标签（来自AI分析）
    result.PersonalityTags = visionResult.personalityTags;
    
    // 3. 生成对话风格（基于用户描述 + 图片分析）
    result.SuggestedDialogueStyle = GenerateDialogueStyleFromAnalysis(
        visionResult, userSupplement);
    
    return result;
}

// 增强版 Vision Prompt
private string GetVisionPromptWithTraits(
    List<string> selectedTraits, 
    string userSupplement)
{
    // 包含用户选择的特质
    // 包含用户补充描述
    // 要求AI返回个性标签
}
```

### VisionAnalysisResult

```csharp
public class VisionAnalysisResult
{
    // ...existing fields...
    
    /// <summary>
    /// ?? v1.6.62: 个性标签（如：善良、坚强、爱撒娇、病娇等）
    /// </summary>
    public List<string> personalityTags { get; set; } = new List<string>();
}
```

### PersonaAnalysisResult

```csharp
public class PersonaAnalysisResult
{
    // ...existing fields...
    
    /// <summary>
    /// ?? v1.6.62: 个性标签（如：善良、坚强、爱撒娇、病娇等）
    /// </summary>
    public List<string> PersonalityTags { get; set; } = new List<string>();
}
```

### NarratorPersonaDef

```csharp
public class NarratorPersonaDef : Def
{
    // ...existing fields...
    
    /// <summary>
    /// ?? v1.6.62: 个性标签（如：善良、坚强、爱撒娇、病娇等）
    /// 可在人格卡片上显示和修改
    /// </summary>
    public List<string> personalityTags = new List<string>();
    
    /// <summary>
    /// ?? v1.6.62: 用户选择的特质（创建人格时选择的3个特质）
    /// </summary>
    public List<string> selectedTraits = new List<string>();
}
```

---

## ?? UI 布局说明

### 弹窗布局（900x700）

```
XTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT[
U           多模态立绘分析 - 生成人格                          U
dTTTTTTTTTTTTTTTTTTTTjTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTg
U                    U  人格名称: [______________]          U
U                    U                                      U
U   立绘预览区域        U  选择特质（最多3个，已选 0/3）:        U
U   (360x640)         U  ┌────┬────┬────┐                  U
U                    U  │善良│坚强│温柔│                    U
U   [立绘图片]         U  ├────┼────┼────┤                  U
U   (自动缩放)        U  │冷酷│勇敢│谨慎│                    U
U                    U  └────┴────┴────┘                  U
U                    U  (共18个特质，每行3个)                U
U                    U                                      U
U                    U  用户补充 *:                          U
U                    U  ┌─────────────────────────┐        U
U                    U  │ 请描述角色的性格、        │        U
U                    U  │ 背景、说话风格等...       │        U
U                    U  │                          │        U
U                    U  │ (最少20个字符)            │        U
U                    U  └─────────────────────────┘        U
dTTTTTTTTTTTTTTTTTTTTmTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTg
U  [取消]                                   [开始分析]       U
^TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTa
```

---

## ?? AI分析流程

### 1. 用户输入构建
```
【核心特质】: 善良、坚强、温柔

【详细描述】: 这是一个温柔体贴的女性角色，说话轻声细语，
喜欢照顾别人。她有银白色的长发和猩红色的眼眸...
```

### 2. Vision API 提示词
```
USER SELECTED TRAITS:
---
善良, 坚强, 温柔
---

USER PROVIDED CONTEXT:
---
【核心特质】: 善良、坚强、温柔
【详细描述】: 这是一个温柔体贴的女性角色...
---

CRITICAL INSTRUCTIONS:
1. The user description provides the CHARACTER'S PERSONALITY
2. You MUST analyze the visual image to describe PHYSICAL APPEARANCE
3. In your characterDescription, COMBINE visual details + personality traits
4. DO NOT contradict the user's personality description!

PERSONALITY TAGS REQUIREMENT:
6. Based on the image and user description, suggest 3-6 personality tags in Chinese
7. Examples: "善良", "坚强", "爱撒娇", "病娇", "傲娇", "温柔", "冷酷"
8. Include the user's selected traits if they match the analysis
```

### 3. AI 返回结构
```json
{
  "dominantColors": [...],
  "visualElements": [...],
  "characterDescription": "（300-500字中文描述，结合视觉和性格）",
  "mood": "gentle",
  "suggestedPersonality": "Benevolent",
  "styleKeywords": ["elegant", "caring", "protective"],
  "personalityTags": ["善良", "坚强", "温柔", "爱撒娇", "温暖"]
}
```

### 4. 生成的人格
```
defName: UserGenerated_小雪_638393728000000000
narratorName: 小雪
personalityTags: ["善良", "坚强", "温柔", "爱撒娇", "温暖"]
selectedTraits: ["善良", "坚强", "温柔"]

biography:
【用户描述】
【核心特质】: 善良、坚强、温柔
【详细描述】: 这是一个温柔体贴的女性角色...

【AI视觉分析】
这是一位拥有银白色长发的温柔少女，她的猩红色眼眸流露出关怀...

【综合分析】
结合视觉特征和用户描述，这是一个...
```

---

## ?? 待完成的任务

| 步骤 | 任务 | 状态 |
|------|------|------|
| Step 1 | 创建多模态分析弹窗 | ? 完成 |
| Step 2 | 修改 MultimodalAnalysisService | ? 完成 |
| Step 3 | 修改 PersonaAnalysisResult | ? 完成 |
| **Step 4** | **修改 NarratorPersonaDef** | ? 完成 |
| **Step 5** | **创建人格卡片编辑器** | ? 待完成 |
| **Step 6** | **集成到人格选择界面** | ? 待完成 |
| **Step 7** | **编译部署并验证** | ? 待完成 |

---

## ?? 下一步行动

1. ? **完成 Step 4**: 修改 NarratorPersonaDef 添加字段
2. ? **开始 Step 5**: 创建人格卡片编辑器（显示和修改个性标签）
3. ? **开始 Step 6**: 在 PersonaSelectionWindow 中添加"从立绘生成"按钮
4. ? **开始 Step 7**: 编译、部署、测试

---

## ?? 技术细节

### 特质选择UI（网格布局）
- 每行3个按钮
- 选中时高亮显示（绿色）
- 最多选择3个
- 超过3个时提示用户

### 输入验证
- 人格名称：不能为空
- 用户补充：不能为空，至少20个字符
- 立绘纹理：必须存在

### 分析状态
- `isAnalyzing = true` 时禁用按钮
- 显示"正在分析，请稍候..."
- 分析完成后延迟2秒关闭窗口

### 生成的人格
- 自动注册到 DefDatabase（本次会话立即可用）
- 自动导出到 Defs 文件夹（永久保存）
- 包含完整的个性标签和用户特质

---

**状态**: Step 1-4 已完成，Step 5-7 待开发  
**下一步**: 创建人格卡片编辑器
