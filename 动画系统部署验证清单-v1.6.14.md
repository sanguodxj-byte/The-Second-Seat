# 动画系统部署验证清单 v1.6.14

## ? 已完成项目

### 1?? 代码实现

- [x] **PortraitController.cs** - 核心控制器
  - 单例模式 ?
  - 纹理缓存 ?
  - 自动眨眼系统 ?
  - 语音同步 ?
  - 优先级逻辑 ?

- [x] **TTSService.cs** - 语音状态追踪
  - `IsSpeaking` 属性 ?
  - 播放前后状态设置 ?

- [x] **TTSAudioPlayer.cs** - 播放完成回调
  - `onComplete` 参数 ?
  - 播放完成后调用回调 ?

- [x] **NarratorPersonaDef.cs** - 纹理路径字段
  - `portraitPathBlink` ?
  - `portraitPathSpeaking` ?

### 2?? XML 配置

- [x] **NarratorPersonaDefs.xml** - Sideria 配置
  ```xml
  <portraitPath>UI/Narrators/9x16/Sideria/base</portraitPath>
  <portraitPathBlink>UI/Narrators/9x16/Sideria/blink</portraitPathBlink>
  <portraitPathSpeaking>UI/Narrators/9x16/Sideria/speaking</portraitPathSpeaking>
  ```

### 3?? 文档

- [x] **PortraitController-使用指南.md** - 详细使用说明
- [x] **PortraitController-快速参考.md** - 快速查阅
- [x] **PortraitController-实现完成总结.md** - 完整总结
- [x] **TTS语音播放状态追踪-实现报告.md** - TTS 状态追踪
- [x] **TTS语音播放状态-快速参考.md** - TTS 快速参考

---

## ?? 待集成步骤

### 1?? 在 NarratorScreenButton 中集成

**文件：** `Source/TheSecondSeat/UI/NarratorScreenButton.cs`

**修改 DoWindowContents 方法：**

```csharp
public override void DoWindowContents(Rect inRect)
{
    // ? 使用 PortraitController 获取当前纹理
    Texture2D currentTexture = PortraitController.Instance.GetCurrentPortrait(currentPersona);
    
    // 绘制按钮
    if (Widgets.ButtonImage(inRect, currentTexture))
    {
        ToggleNarratorWindow();
    }
    
    // ...existing code...
}
```

### 2?? 在 NarratorWindow 中集成

**文件：** `Source/TheSecondSeat/UI/NarratorWindow.cs`

**修改绘制立绘的部分：**

```csharp
private void DrawPortrait(Rect rect)
{
    var narratorManager = Current.Game?.GetComponent<NarratorManager>();
    var persona = narratorManager?.GetCurrentPersona();
    
    if (persona != null)
    {
        // ? 使用 PortraitController 获取当前纹理
        Texture2D texture = PortraitController.Instance.GetCurrentPortrait(persona);
        GUI.DrawTexture(rect, texture, ScaleMode.ScaleToFit);
    }
}
```

---

## ?? 纹理文件准备

### 需要准备的文件

```
Textures/UI/Narrators/9x16/Sideria/
├── base.png      (必需) - 基础立绘
├── blink.png     (可选) - 闭眼纹理
└── speaking.png  (可选) - 张嘴纹理
```

### 纹理要求

| 要求 | 规格 |
|------|------|
| **尺寸** | 推荐 512x512 或 1024x1024 |
| **格式** | PNG（支持透明） |
| **比例** | 9:16 竖版（可以是正方形） |
| **大小** | 建议 < 2 MB/张 |

---

## ?? 测试计划

### 1?? 编译测试

```bash
# 1. 编译项目
dotnet build Source/TheSecondSeat/TheSecondSeat.csproj

# 2. 检查编译错误
# 预期：编译成功，无错误
```

### 2?? 功能测试

#### 测试 1: 眨眼动画

**步骤：**
1. 启动游戏，进入存档
2. 观察 AI 按钮（或对话窗口）的立绘
3. 等待 3-6 秒

**预期结果：**
- ? 立绘会短暂切换到闭眼纹理（0.15秒）
- ? 然后自动恢复到基础纹理
- ? 间隔 3-6 秒后再次眨眼

#### 测试 2: 语音同步

**步骤：**
1. 在对话窗口发送消息
2. 等待 AI 回复并播放 TTS 语音
3. 观察立绘变化

**预期结果：**
- ? TTS 播放时，立绘切换到张嘴纹理
- ? TTS 结束后，立绘恢复到基础纹理
- ? 如果在说话时眨眼，眨眼动画优先显示

#### 测试 3: 优先级测试

**场景：** 正在说话时触发眨眼

**预期结果：**
1. 正在说话 → 显示 speaking 纹理
2. 眨眼触发 → 切换到 blink 纹理（0.15秒）
3. 眨眼结束 → 恢复到 speaking 纹理（因为还在说话）
4. 说话结束 → 恢复到 base 纹理

#### 测试 4: 纹理缺失测试

**场景：** 删除 blink.png 或 speaking.png

**预期结果：**
- ? 系统不崩溃
- ? 缺失的纹理回退到 base 纹理
- ? 日志输出警告信息（DevMode 下）

---

## ?? 性能监控

### 内存占用

```csharp
// 查看缓存状态
Log.Message(PortraitController.Instance.GetCacheInfo());

// 预期输出：
// [PortraitController] Cached textures: 3
// (base + blink + speaking)
```

### 眨眼状态

```csharp
// 查看眨眼状态
Log.Message(PortraitController.Instance.GetBlinkStatus());

// 预期输出：
// "Idle (next blink in: 4.56s)" 或
// "Blinking (remaining: 0.12s)"
```

### 完整调试信息

```csharp
// 查看完整调试信息
Log.Message(PortraitController.Instance.GetDebugInfo());

// 预期输出：
// [PortraitController Debug]
// Cached textures: 3
// Blink status: Idle (next blink in: 2.34s)
// TTS Speaking: No
```

---

## ?? 常见问题

### 问题 1: 纹理未加载

**症状：** 只显示灰色占位符

**检查：**
1. 纹理文件是否存在于正确路径
2. XML 中路径配置是否正确
3. 文件名是否正确（区分大小写）

**解决：**
```csharp
// 在 DevMode 下查看日志
[PortraitController] Texture not found: UI/Narrators/9x16/Sideria/blink
```

### 问题 2: 眨眼不工作

**症状：** 立绘不眨眼

**检查：**
1. `portraitPathBlink` 是否在 XML 中配置
2. blink.png 文件是否存在
3. 是否在 UI 循环中调用 `GetCurrentPortrait()`

**测试：**
```csharp
// 强制触发眨眼
PortraitController.Instance.ForceBlinkNow();
```

### 问题 3: 说话动画不工作

**症状：** TTS 播放时立绘不变化

**检查：**
1. `portraitPathSpeaking` 是否配置
2. `TTSService.Instance.IsSpeaking` 是否为 true
3. TTS 是否正在播放

**测试：**
```csharp
// 查看 TTS 状态
Log.Message($"TTS Speaking: {TTSService.Instance.IsSpeaking}");
```

---

## ?? 部署步骤

### 1. 编译

```bash
# 编译项目
dotnet build Source/TheSecondSeat/TheSecondSeat.csproj --configuration Release
```

### 2. 准备纹理

```bash
# 检查纹理文件是否存在
ls Textures/UI/Narrators/9x16/Sideria/
# 预期：base.png, blink.png, speaking.png
```

### 3. 复制到游戏目录

```bash
# 复制 DLL
cp Source/TheSecondSeat/bin/Release/net472/TheSecondSeat.dll D:/steam/steamapps/common/RimWorld/Mods/TheSecondSeat/Assemblies/

# 复制纹理
cp -r Textures/* D:/steam/steamapps/common/RimWorld/Mods/TheSecondSeat/Textures/

# 复制 Defs
cp -r Defs/* D:/steam/steamapps/common/RimWorld/Mods/TheSecondSeat/Defs/
```

### 4. 启动游戏测试

1. 启动 RimWorld
2. 加载 The Second Seat Mod
3. 进入存档
4. 观察 AI 按钮是否显示动画

---

## ?? 验证清单

### 编译验证

- [ ] 项目编译成功，无错误
- [ ] DLL 文件生成正确
- [ ] 文件大小合理（约 500KB-2MB）

### 功能验证

- [ ] 眨眼动画正常（3-6秒间隔）
- [ ] 语音同步正常（TTS 播放时显示说话纹理）
- [ ] 优先级正确（眨眼 > 说话 > 默认）
- [ ] 回退机制有效（纹理缺失时使用 base）

### 性能验证

- [ ] 纹理缓存有效（重复调用不重新加载）
- [ ] 内存占用合理（约 3-6 MB/人格）
- [ ] CPU 占用低（眨眼更新 O(1)）
- [ ] 无内存泄漏

### UI 验证

- [ ] NarratorScreenButton 显示正确
- [ ] NarratorWindow 显示正确
- [ ] 纹理切换流畅
- [ ] 无闪烁或卡顿

---

## ?? 下一步计划

### 短期目标（v1.6.15）

1. **集成到 UI 系统**
   - 修改 NarratorScreenButton
   - 修改 NarratorWindow
   - 测试多人格切换

2. **添加调试面板**
   - 实时显示缓存状态
   - 手动触发眨眼
   - 显示当前优先级

### 中期目标（v1.7.0）

1. **更多动画状态**
   - 微笑、惊讶、愤怒表情
   - 转头、点头动作

2. **动画过渡**
   - 淡入淡出效果
   - 平滑过渡

### 长期目标（v2.0.0）

1. **情绪系统集成**
   - 根据好感度改变表情频率
   - 根据心情调整眨眼速度

2. **缓存策略优化**
   - LRU 缓存
   - 自动清理未使用纹理

---

**验证清单创建完成！** ?  
**版本：** v1.6.14  
**状态：** 准备部署

_The Second Seat Mod Team_
