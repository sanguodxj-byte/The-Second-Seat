# 头像和立绘切换按钮修复 - 快速参考

## ?? 修复概要

**版本**：v1.6.21  
**问题**：在设置中切换"使用立绘模式"后，AI 按钮不会立即切换图片，需要重启游戏  
**原因**：缓存键格式不一致，导致头像和立绘共享缓存  

---

## ? 已完成修改

### 1. **PortraitLoader.cs**
- ? 缓存键：`{defName}{expression}` → `{defName}_portrait_{expression}`
- ? 新增方法：`ClearAllCache()`

### 2. **AvatarLoader.cs**
- ? 缓存键：`{defName}_avatar{expression}` → `{defName}_avatar_{expression}`
- ? 新增方法：`ClearAllCache()`

### 3. **NarratorScreenButton.cs**
- ? 新增字段：`private bool lastUsePortraitMode = false;`
- ?? **需要手动修改**：`UpdatePortrait()` 方法（见下文）

---

## ?? 手动修改步骤

### 修改 UpdatePortrait() 方法

1. 打开 `Source/TheSecondSeat/UI/NarratorScreenButton.cs`
2. 找到 `UpdatePortrait()` 方法（约第 616 行）
3. 在 `portraitUpdateTick = Find.TickManager.TicksGame;` **之后**添加：

```csharp
// ? v1.6.21: 检测设置变化
var modSettings = LoadedModManager.GetMod<TheSecondSeatMod>()?.GetSettings<TheSecondSeatSettings>();
bool currentPortraitMode = modSettings?.usePortraitMode ?? false;

if (currentPortraitMode != lastUsePortraitMode)
{
    // 设置变化，清除所有缓存
    AvatarLoader.ClearAllCache();
    PortraitLoader.ClearAllCache();
    
    // ? 同时清除分层立绘缓存
    try
    {
        LayeredPortraitCompositor.ClearAllCache();
    }
    catch
    {
        // 如果方法不存在，静默忽略
    }
    
    lastUsePortraitMode = currentPortraitMode;
    currentPortrait = null;  // 强制重新加载
    currentPersona = null;
    
    if (Prefs.DevMode)
    {
        Log.Message($"[NarratorScreenButton] Portrait mode changed to: {(currentPortraitMode ? "立绘模式" : "头像模式")}");
    }
}
```

**完整方法**参考：`NarratorScreenButton-UpdatePortrait-补丁-v1.6.21.md`

---

## ?? 部署流程

### 方式 1：自动部署（推荐）
```powershell
.\Deploy-v1.6.21.ps1
```

### 方式 2：手动部署
1. 修改 `UpdatePortrait()` 方法（见上文）
2. 编译项目：
   ```powershell
   dotnet build Source\TheSecondSeat\TheSecondSeat.csproj -c Release
   ```
3. 复制 DLL：
   ```powershell
   Copy-Item "1.5\Assemblies\TheSecondSeat.dll" "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\1.5\Assemblies\" -Force
   ```

---

## ?? 测试清单

在游戏中测试：

- [ ] 从头像模式切换到立绘模式，AI 按钮立即显示立绘
- [ ] 从立绘模式切换到头像模式，AI 按钮立即显示头像
- [ ] 表情切换在两种模式下都正常工作
- [ ] 无需重启游戏即可切换模式

DevMode 日志检查：

```
[NarratorScreenButton] Portrait mode changed to: 立绘模式
[AvatarLoader] 所有头像缓存已清空
[PortraitLoader] 所有立绘缓存已清空
```

---

## ?? 缓存键对比

| 加载器 | 修复前 | 修复后 |
|--------|--------|--------|
| AvatarLoader | `Sideria_avatar_happy` | `Sideria_avatar__happy` |
| PortraitLoader | `Sideria_happy` | `Sideria_portrait__happy` |
| LayeredPortraitCompositor | `Sideria_layered_happy_default` | `Sideria_layered_happy_default` |

**关键变化**：每个加载器都有清晰的标识符，避免缓存冲突。

---

## ?? 故障排除

### 问题 1：切换模式后按钮仍显示旧图片
**原因**：`UpdatePortrait()` 方法未修改  
**解决**：参考 `NarratorScreenButton-UpdatePortrait-补丁-v1.6.21.md` 手动修改

### 问题 2：编译错误 "ClearAllCache 不存在"
**原因**：AvatarLoader.cs 或 PortraitLoader.cs 未添加新方法  
**解决**：检查这两个文件，确保包含 `ClearAllCache()` 方法

### 问题 3：DevMode 下无日志输出
**原因**：设置变化检测逻辑未添加  
**解决**：确认 `UpdatePortrait()` 方法包含 `Portrait mode changed to` 日志

---

## ?? 相关文档

- 完整实现总结：`头像和立绘切换按钮修复-v1.6.21-实现总结.md`
- 方法补丁：`NarratorScreenButton-UpdatePortrait-补丁-v1.6.21.md`
- 部署报告：`部署报告-v1.6.21.md`（部署后自动生成）

---

**最后更新**：2025-01-XX  
**状态**：? AvatarLoader/PortraitLoader 已完成，?? NarratorScreenButton 需手动修改
