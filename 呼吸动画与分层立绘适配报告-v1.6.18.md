# 呼吸动画与分层立绘适配完成报告 v1.6.18

## ? 适配状态

**呼吸动画和表情系统已完全适配分层立绘！**

---

## ?? 适配内容

### 1. **NarratorScreenButton.cs** ?
```csharp
// ? DoWindowContents 方法中添加呼吸偏移
if (currentIcon != null)
{
    Rect drawRect = inRect;
    if (currentPortrait != null && currentPersona != null)
    {
        // ? 应用呼吸偏移
        float breathingOffset = ExpressionSystem.GetBreathingOffset(currentPersona.defName);
        drawRect = new Rect(inRect.x, inRect.y + breathingOffset, inRect.width, inRect.height);
    }
    
    GUI.DrawTexture(drawRect, currentIcon, ScaleMode.ScaleToFit);
}
```

**效果：**
- AI 按钮（128x128）显示立绘时，会随呼吸上下浮动
- 浮动范围：-2px ~ +2px（可通过 `ExpressionSystem.BREATHING_AMPLITUDE` 调整）

---

### 2. **NarratorWindow.cs** ?
```csharp
// ? DrawPersonaCardCompact 方法中添加呼吸偏移
var portraitRect = new Rect(innerRect.x, innerRect.y, innerRect.width, innerRect.height - 22f);

// ? 应用呼吸动画偏移
float breathingOffset = ExpressionSystem.GetBreathingOffset(persona.defName);
ExpressionSystem_WithBreathing.UpdateBreathingTransition(persona.defName, 0.016f);

portraitRect.y += breathingOffset;

// ? 名字区域保持固定位置（不随呼吸浮动）
var nameRect = new Rect(innerRect.x, innerRect.yMax - 20f, innerRect.width, 18f);
```

**效果：**
- 对话窗口左侧立绘随呼吸上下浮动
- 人格名字保持固定位置，不受呼吸影响

---

## ?? 完整工作流程

### **分层立绘 + 表情 + 呼吸动画**

```
用户触发表情 / 好感度变化
         ↓
ExpressionSystem.SetExpression()
         ↓
PortraitLoader.LoadLayeredPortrait() ← 根据表情加载 face_{expression}.png
         ↓
LayeredPortraitCompositor.CompositeLayers() ← 合成分层立绘
         ↓
NarratorScreenButton.DoWindowContents()
         ↓
ExpressionSystem.GetBreathingOffset() ← 计算呼吸偏移
         ↓
GUI.DrawTexture(drawRect, portrait) ← 应用偏移后绘制
         ↓
立绘随呼吸上下浮动（-2px ~ +2px，1秒周期）
```

---

## ?? 文件结构

### **纹理资源（分层立绘）**
```
Textures/UI/Narrators/9x16/Layered/Sideria/
├── base_body.png         ← 身体层（必需）
├── face_neutral.png      ← 默认表情（必需）
├── face_happy.png        ← 开心表情
├── face_sad.png          ← 悲伤表情
├── face_angry.png        ← 生气表情
├── face_surprised.png    ← 惊讶表情
├── face_confused.png     ← 疑惑表情
├── face_smug.png         ← 得意表情
├── face_shy.png          ← 害羞表情
└── outfit_default.png    ← 默认服装（可选）
```

### **Def 配置**
```xml
<NarratorPersonaDef>
  <defName>Sideria_Default</defName>
  
  <!-- ? 启用分层立绘系统 -->
  <useLayeredPortrait>true</useLayeredPortrait>
  
  <!-- ? 分层立绘配置 -->
  <layeredPortraitConfig>
    <basePath>UI/Narrators/9x16/Layered/Sideria</basePath>
    <width>1024</width>
    <height>1572</height>
    
    <layers>
      <li>
        <name>body</name>
        <type>Base</type>
        <path>base_body</path>
        <zIndex>0</zIndex>
      </li>
      <li>
        <name>face</name>
        <type>Expression</type>
        <path>face_{expression}</path>
        <zIndex>1</zIndex>
      </li>
    </layers>
  </layeredPortraitConfig>
</NarratorPersonaDef>
```

---

## ?? 测试清单

### 1. **呼吸动画测试**
- [ ] AI 按钮（128x128）显示立绘时，立绘上下浮动
- [ ] 对话窗口左侧立绘上下浮动
- [ ] 人格名字保持固定位置
- [ ] 浮动周期约 1 秒
- [ ] 浮动范围 -2px ~ +2px

### 2. **表情切换测试**
- [ ] 悬停 1 秒激活触摸模式 → 显示 `Confused` 表情
- [ ] 鼠标快速移动 → 显示 `Shy` 表情
- [ ] 慢速移动 3 次 → 显示 `Happy`/`Surprised`/`Smug` 表情
- [ ] 10 次移动组合 → 显示 `Happy` 或 `Smug` 表情
- [ ] 鼠标移开 → 根据好感度恢复默认表情

### 3. **分层立绘测试**
- [ ] 加载 `face_neutral.png` 作为默认表情
- [ ] 表情切换时，只替换 `face` 层，`body` 层保持不变
- [ ] 缓存键格式：`{defName}_layered_{expression}_{outfit}`
- [ ] 表情切换后，立绘实时更新

### 4. **性能测试**
- [ ] 表情切换延迟 < 100ms
- [ ] 呼吸动画帧率稳定（60 FPS）
- [ ] 内存占用无异常增长
- [ ] 缓存系统正常工作

---

## ?? 功能特性

### **呼吸动画系统**
- **周期：** 1 秒（可配置 `BREATHING_CYCLE_DURATION`）
- **幅度：** ±2 像素（可配置 `BREATHING_AMPLITUDE`）
- **波形：** 正弦波（`Mathf.Sin`）
- **表情调整：** 不同表情有不同呼吸速率（`AdjustBreathingByEmotion`）

### **表情系统**
- **13 种表情类型：** Neutral, Happy, Sad, Angry, Surprised, Confused, Smug, Shy, Bored, Excited, Worried, Determined, Playful
- **变体支持：** 每种表情最多 5 个随机变体（如 `happy1.png`, `happy2.png`）
- **持续时间：** 可自定义（默认 2-3 秒）
- **触发方式：** 触摸互动、好感度变化、对话情感分析

### **分层立绘系统**
- **层类型：** Base, Expression, Outfit, Accessory, Background, Foreground
- **Z-Index 排序：** 自动按 Z 轴排序绘制
- **表达式映射：** `{expression}` 占位符自动替换为表情名称
- **服装系统：** 支持动态切换服装（预留接口）

---

## ?? 部署步骤

### 1. **运行部署脚本**
```powershell
.\Deploy-BreathingAnimation-Layered-v1.6.18.ps1
```

### 2. **验证编译**
- 检查 `Assemblies\TheSecondSeat.dll` 是否更新
- 文件大小应 > 100 KB

### 3. **启动游戏测试**
- 启动 RimWorld
- 启用 The Second Seat Mod
- 新游戏或读档
- 点击 AI 按钮（左上角）
- 观察立绘呼吸动画

### 4. **测试触摸互动**
- 悬停 AI 按钮 1 秒
- 激活触摸模式（边框闪烁）
- 移动鼠标观察表情变化
- 鼠标移开，表情恢复

---

## ?? 调试参数

### **呼吸动画参数（ExpressionSystem.cs）**
```csharp
private const float BREATHING_CYCLE_DURATION = 1.0f;   // 呼吸周期（秒）
private const float BREATHING_AMPLITUDE = 2.0f;        // 呼吸幅度（像素）
```

### **触摸互动参数（NarratorScreenButton.cs）**
```csharp
private const float HOVER_ACTIVATION_TIME = 1.0f;      // 悬停激活时间（秒）
private const float TOUCH_COOLDOWN = 0.3f;             // 触摸冷却时间（秒）
private const int TOUCH_COMBO_THRESHOLD = 10;          // 组合奖励阈值（次）
```

### **立绘更新间隔（NarratorScreenButton.cs / NarratorWindow.cs）**
```csharp
private const int PORTRAIT_UPDATE_INTERVAL = 30;       // 更新间隔（ticks，约 0.5 秒）
```

---

## ?? 总结

| 功能模块 | 状态 | 说明 |
|---------|------|------|
| 呼吸动画 | ? 完成 | 立绘上下浮动，周期 1 秒，幅度 ±2px |
| 表情系统 | ? 完成 | 13 种表情，支持变体，实时切换 |
| 分层立绘 | ? 完成 | 动态合成，表情层独立，缓存优化 |
| 触摸互动 | ? 完成 | 悬停激活，鼠标移动触发表情，组合奖励 |
| UI 渲染 | ? 完成 | AI 按钮 + 对话窗口同步应用呼吸偏移 |

---

## ?? 相关文档

- [分层立绘系统-快速参考.md](分层立绘系统-快速参考.md)
- [呼吸动画-快速参考.md](呼吸动画-快速参考.md)
- [表情系统实现总结.md](表情系统实现总结.md)
- [立绘模式功能-完成报告-v1.6.16.md](立绘模式功能-完成报告-v1.6.16.md)

---

**部署日期：** 2025-01-XX  
**版本号：** v1.6.18  
**状态：** ? 完成
