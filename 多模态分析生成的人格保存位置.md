# ?? 多模态分析生成的人格保存位置

## ?? 快速回答

多模态分析生成的人格会保存在**两个地方**：

### 1. **立即可用**（运行时）?

```
保存位置：DefDatabase<NarratorPersonaDef>
保存方式：内存中注册
生效时间：立即（无需重启）
持久性：? 游戏关闭后消失
```

### 2. **永久保存**（文件系统）?

```
保存位置：Mod目录的XML文件
保存方式：磁盘文件
生效时间：下次启动游戏时自动加载
持久性：? 永久保存
```

---

## ?? 详细保存位置

### 立绘文件

**保存路径**：
```
D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\
```

**文件命名**：
```
{人格名称}.png

例如：
- Cassandra_Classic.png
- Dark_Dragon_Rider.png
- Mysterious_Mage.png
```

**文件格式**：
- 格式：PNG
- 尺寸：推荐512x512或1024x1024
- 透明度：支持Alpha通道

---

### XML定义文件

**保存路径**：
```
D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Defs\NarratorPersonaDefs\
```

**文件命名**：
```
{defName}.xml

例如：
- CustomPersona_abc12345.xml
- DarkDragonRider.xml
- MysteriousMage.xml
```

**文件内容示例**：
```xml
<?xml version="1.0" encoding="utf-8"?>
<Defs>

  <!-- 自动生成的人格定义 -->
  <!-- 生成时间: 2025-01-15 14:30:00 -->

  <TheSecondSeat.PersonaGeneration.NarratorPersonaDef>
    <defName>CustomPersona_abc12345</defName>
    <label>Dark Dragon Rider</label>
    <narratorName>Dark Dragon Rider</narratorName>

    <portraitPath>UI/Narrators/Dark_Dragon_Rider</portraitPath>

    <primaryColor>(0.78, 0.08, 0.24, 1.00)</primaryColor>
    <accentColor>(0.95, 0.85, 0.75, 1.00)</accentColor>

    <biography>
      A menacing dragon rider who commands fear and destruction.
      She speaks with dark authority and enjoys watching battles unfold.
    </biography>

    <overridePersonality>Sadistic</overridePersonality>

    <dialogueStyle>
      <formalityLevel>0.60</formalityLevel>
      <emotionalExpression>0.70</emotionalExpression>
      <humorLevel>0.40</humorLevel>
      <sarcasmLevel>0.60</sarcasmLevel>
      <verbosity>0.50</verbosity>
    </dialogueStyle>

    <toneTags>
      <li>menacing</li>
      <li>powerful</li>
      <li>dark</li>
    </toneTags>

  </TheSecondSeat.PersonaGeneration.NarratorPersonaDef>

</Defs>
```

---

## ?? 保存流程详解

### 步骤1：用户选择立绘

```
用户操作：
1. 打开"人格选择"窗口
2. 点击"从立绘生成新人格"
3. 选择立绘文件（原版/Mod/用户自定义）
```

### 步骤2：多模态API分析

```
系统操作：
1. 将立绘发送到Vision API（OpenAI/DeepSeek/Gemini）
2. API返回分析结果：
   - 主要颜色
   - 次要颜色
   - 角色描述
   - 人格特质
   - 风格关键词
```

### 步骤3：创建人格对象

```csharp
var newPersona = new NarratorPersonaDef
{
    defName = $"CustomPersona_{Guid.NewGuid().ToString().Substring(0, 8)}",
    label = "Dark Dragon Rider",
    narratorName = "Dark Dragon Rider",
    biography = visionResult.characterDescription,
    primaryColor = visionResult.GetPrimaryColor(),
    accentColor = visionResult.GetAccentColor(),
    overridePersonality = visionResult.suggestedPersonality,
    toneTags = visionResult.styleKeywords,
    // ...
};
```

### 步骤4：立即注册（运行时可用）

```csharp
// ? 立即添加到DefDatabase
DefDatabase<NarratorPersonaDef>.Add(newPersona);

// 效果：立即可在人格选择窗口中看到并使用
```

### 步骤5：导出文件（永久保存）

```csharp
// 1. 复制立绘到Mod目录
string targetPath = "D:\steam\...\Textures\UI\Narrators\Dark_Dragon_Rider.png";
File.Copy(sourcePath, targetPath);

// 2. 生成XML定义
string xmlContent = GeneratePersonaDefXml(persona);

// 3. 保存XML文件
string xmlPath = "D:\steam\...\Defs\NarratorPersonaDefs\CustomPersona_abc12345.xml";
File.WriteAllText(xmlPath, xmlContent);

// 效果：下次启动游戏时自动加载
```

---

## ?? 双重保存机制的好处

### 立即注册（DefDatabase）

**优点**：
- ? 立即可用（无需重启）
- ? 可以立即切换到新人格
- ? 可以立即测试对话效果

**缺点**：
- ? 游戏关闭后消失
- ? 无法在其他存档中使用

### 文件保存（XML + PNG）

**优点**：
- ? 永久保存
- ? 下次启动自动加载
- ? 可以在其他存档中使用
- ? 可以手动编辑XML调整参数
- ? 可以分享给其他玩家

**缺点**：
- ?? 需要重启游戏才能看到修改

---

## ?? 查看已保存的人格

### 方法1：通过游戏内UI

```
1. 打开人格选择窗口
2. 查看人格列表
3. 包含：
   - 原版人格（Cassandra, Phoebe, Randy等）
   - 本Mod预设人格（Igor, Luna等）
   - 自动生成的人格（CustomPersona_xxx）
```

### 方法2：通过文件管理器

```
1. 打开文件浏览器
2. 导航到：
   D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\
3. 查看：
   - Textures\UI\Narrators\   （立绘文件）
   - Defs\NarratorPersonaDefs\ （XML定义）
```

### 方法3：通过开发者控制台

```csharp
// 打开开发者模式（F12或Mod设置）
// 执行代码：

var personas = DefDatabase<NarratorPersonaDef>.AllDefsListForReading;
Log.Message($"当前加载的人格数量: {personas.Count}");

foreach (var persona in personas)
{
    Log.Message($"  - {persona.defName}: {persona.narratorName}");
}
```

---

## ?? 文件结构示例

### 完整的Mod目录结构

```
TheSecondSeat/
├── Textures/
│   └── UI/
│       └── Narrators/
│           ├── Cassandra.png              # 原版预设
│           ├── Phoebe.png                 # 原版预设
│           ├── Randy.png                  # 原版预设
│           ├── Igor.png                   # Mod预设
│           ├── Luna.png                   # Mod预设
│           ├── Dark_Dragon_Rider.png      # ? 多模态生成
│           ├── Mysterious_Mage.png        # ? 多模态生成
│           └── Custom_Persona_abc123.png  # ? 多模态生成
│
└── Defs/
    └── NarratorPersonaDefs/
        ├── NarratorPersonaDefs.xml        # 原版+Mod预设
        ├── CustomPersona_abc12345.xml     # ? 多模态生成
        ├── DarkDragonRider.xml            # ? 多模态生成
        └── MysteriousMage.xml             # ? 多模态生成
```

### 文件关联关系

```
立绘文件                        →  XML定义
─────────────────────────────────────────────
Dark_Dragon_Rider.png          →  CustomPersona_abc12345.xml
                                  ├── portraitPath: "UI/Narrators/Dark_Dragon_Rider"
                                  ├── primaryColor: (0.78, 0.08, 0.24, 1.00)
                                  └── biography: "A menacing dragon rider..."

Mysterious_Mage.png            →  MysteriousMage.xml
                                  ├── portraitPath: "UI/Narrators/Mysterious_Mage"
                                  ├── primaryColor: (0.45, 0.20, 0.85, 1.00)
                                  └── biography: "An enigmatic mage..."
```

---

## ??? 手动管理保存的人格

### 编辑人格属性

**步骤**：
1. 打开XML文件（用记事本或VS Code）
2. 修改参数（如对话风格、人格特质等）
3. 保存文件
4. 重启游戏

**示例**：将人格改为更幽默的风格

```xml
<!-- 之前 -->
<dialogueStyle>
  <humorLevel>0.40</humorLevel>
  <sarcasmLevel>0.60</sarcasmLevel>
</dialogueStyle>

<!-- 修改后 -->
<dialogueStyle>
  <humorLevel>0.80</humorLevel>  <!-- ? 增加幽默 -->
  <sarcasmLevel>0.30</sarcasmLevel>  <!-- ? 减少讽刺 -->
</dialogueStyle>
```

### 删除人格

**方法1：通过游戏内UI**
```
1. 打开人格选择窗口
2. 右键点击人格卡片
3. 选择"删除"
4. 确认删除
```

**方法2：手动删除文件**
```
1. 删除立绘文件：Textures\UI\Narrators\{人格名称}.png
2. 删除XML文件：Defs\NarratorPersonaDefs\{defName}.xml
3. 重启游戏
```

### 分享人格

**步骤**：
1. 复制两个文件：
   - `{人格名称}.png`
   - `{defName}.xml`
2. 发送给其他玩家
3. 其他玩家将文件放到对应目录
4. 重启游戏即可使用

---

## ?? 常见问题

### Q1：为什么重启游戏后人格消失了？

**原因**：文件保存失败，可能是：
- 磁盘空间不足
- Mod目录权限问题
- 文件名包含非法字符

**解决**：
1. 检查日志（开发者模式 → 日志）
2. 查看是否有错误提示
3. 手动检查文件是否存在

### Q2：如何备份生成的人格？

**方法**：
```
复制两个目录：
- Textures\UI\Narrators\
- Defs\NarratorPersonaDefs\

粘贴到安全位置（如桌面、云盘）
```

### Q3：可以修改已生成的人格吗？

**可以！**
1. 编辑XML文件修改参数
2. 替换PNG文件更换立绘
3. 重启游戏应用修改

### Q4：生成的人格会影响游戏性能吗？

**不会！**
- 人格数据很小（XML几KB，PNG几百KB）
- 只在需要时加载
- 不影响游戏运行速度

---

## ?? 相关文档

- [立绘动态表情系统-完整指南.md](立绘动态表情系统-完整指南.md) - 表情立绘制作
- [多模态AI分析完整指南.md](多模态AI分析完整指南.md) - API配置
- [人格生成系统指南.md](人格生成系统指南.md) - 手动创建人格
- [面部区域覆盖表情制作指南.md](面部区域覆盖表情制作指南.md) - 表情制作技巧

---

## ? 总结

### 保存位置一览

| 内容 | 位置 | 何时可用 | 是否永久 |
|-----|------|---------|---------|
| **人格对象** | DefDatabase | 立即 | ? 临时 |
| **立绘文件** | `Textures/UI/Narrators/` | 下次启动 | ? 永久 |
| **XML定义** | `Defs/NarratorPersonaDefs/` | 下次启动 | ? 永久 |

### 使用建议

1. **立即测试**：生成后可以立即切换和使用
2. **验证效果**：测试对话、查看立绘、调整参数
3. **重启游戏**：验证XML和立绘文件正确保存
4. **备份重要人格**：复制文件到安全位置

---

**版本**：v1.0.0  
**作者**：The Second Seat Team  
**最后更新**：2025-01-XX

需要帮助？查看 [完整使用手册.md](完整使用手册.md)
