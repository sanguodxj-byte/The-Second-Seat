# 半透明模式下面部部件透明度修复 - v1.6.50

## ?? 问题描述

在半透明模式下（未按 Shift），面部部件（嘴部、眼睛）叠加后出现"双重透明"效果：
```
基础层 (alpha=0.2) + 嘴部层 (alpha=0.2) = 叠加区域异常
```

这导致：
- 嘴部/眼睛区域比其他区域更暗/更浅
- 出现明显的"重影"效果
- 半透明效果不自然

---

## ? 解决方案（方案 2：混合模式渲染 - 推荐）

### 原理
使用 `Blend SrcAlpha OneMinusSrcAlpha` 混合模式，让图层正确叠加而不产生"双重透明"。

### 修改步骤

#### 1. 修改 `FullBodyPortraitPanel.cs`

在 `DrawPortraitContents()` 方法中，修改半透明模式的绘制逻辑：

```csharp
// ==================== 2. 绘制立绘 ====================

// 应用呼吸动画偏移
float breathingOffset = ExpressionSystem.GetBreathingOffset(currentPersona.defName);
Rect animatedRect = new Rect(drawRect.x, drawRect.y + breathingOffset, drawRect.width, drawRect.height);

// ? 关键修复：半透明模式使用预乘 Alpha
GUI.color = new Color(1f, 1f, 1f, alpha);
DrawLayeredPortraitRuntime(animatedRect, currentPersona);
GUI.color = Color.white;
```

**关键点**：
- 移除 `if (alpha < 1.0f)` 的分支判断
- 统一使用 `DrawLayeredPortraitRuntime` 绘制
- 通过 `GUI.color` 的 alpha 通道控制整体透明度

#### 2. 确保纹理格式正确

确保所有图层纹理使用 **ARGB32** 格式，并启用 **Alpha Channel**：

```
Textures/UI/Narrators/9x16/Layered/{PersonaName}/
├── base_body.png (RGB + Alpha)
├── small_mouth.png (RGB + Alpha)
├── medium_mouth.png (RGB + Alpha)
├── larger_mouth.png (RGB + Alpha)
├── eyes_open.png (RGB + Alpha)
└── eyes_closed.png (RGB + Alpha)
```

---

## ?? 为什么这样修复有效？

### Unity GUI 渲染原理

1. **默认混合模式**：`Blend SrcAlpha OneMinusSrcAlpha`
   ```
   最终颜色 = 源颜色 × 源Alpha + 目标颜色 × (1 - 源Alpha)
   ```

2. **统一 Alpha**：通过 `GUI.color` 设置整体透明度
   - 基础层绘制时：`color = (1, 1, 1, 0.2)` → 整体半透明
   - 嘴部层绘制时：`color = (1, 1, 1, 0.2)` → 继承相同透明度
   - 眼睛层绘制时：`color = (1, 1, 1, 0.2)` → 继承相同透明度

3. **正确叠加**：
   ```
   第一层：base_body (alpha=0.2)
   第二层：small_mouth (alpha=0.2) 
   → 叠加区域不会变成 alpha=0.04，而是正确混合
   ```

---

## ?? 实现代码（完整版）

```csharp
private void DrawPortraitContents()
{
    if (currentPersona == null) return;
    
    UpdateBodyBaseIfNeeded();
    
    bool mouseOver = Mouse.IsOver(drawRect);
    bool shiftHeld = Event.current.shift;
    
    // 计算 Alpha 值
    float alpha = (mouseOver && !shiftHeld) ? 0.2f : 1.0f;
    bool shouldConsumeInput = shiftHeld && mouseOver;
    
    // 绘制立绘（统一使用分层绘制）
    float breathingOffset = ExpressionSystem.GetBreathingOffset(currentPersona.defName);
    Rect animatedRect = new Rect(drawRect.x, drawRect.y + breathingOffset, drawRect.width, drawRect.height);
    
    // ? 关键：统一设置 GUI.color 的 alpha
    GUI.color = new Color(1f, 1f, 1f, alpha);
    DrawLayeredPortraitRuntime(animatedRect, currentPersona);
    GUI.color = Color.white;
    
    // ... 处理交互和提示 ...
}
```

---

## ?? 备用方案 1：预合成纹理（性能换质量）

如果方案 2 仍然有问题，可以使用预合成：

```csharp
if (alpha < 1.0f)
{
    // 半透明模式：预合成所有图层
    DrawCompositePortrait(animatedRect, currentPersona, alpha);
}
else
{
    // 完全不透明：直接分层绘制
    GUI.color = Color.white;
    DrawLayeredPortraitRuntime(animatedRect, currentPersona);
    GUI.color = Color.white;
}

private void DrawCompositePortrait(Rect rect, NarratorPersonaDef persona, float alpha)
{
    int width = Mathf.RoundToInt(rect.width);
    int height = Mathf.RoundToInt(rect.height);
    
    RenderTexture rt = RenderTexture.GetTemporary(width, height, 0, RenderTextureFormat.ARGB32);
    RenderTexture previousRT = RenderTexture.active;
    
    try
    {
        RenderTexture.active = rt;
        GL.Clear(true, true, Color.clear);
        
        GUI.BeginGroup(new Rect(0, 0, width, height));
        GUI.color = Color.white; // 完全不透明地合成
        DrawLayeredPortraitRuntime(new Rect(0, 0, width, height), persona);
        GUI.color = Color.white;
        GUI.EndGroup();
        
        RenderTexture.active = previousRT;
        
        // 将合成结果统一应用透明度
        GUI.color = new Color(1f, 1f, 1f, alpha);
        GUI.DrawTexture(rect, rt, ScaleMode.ScaleToFit);
        GUI.color = Color.white;
    }
    finally
    {
        RenderTexture.active = previousRT;
        RenderTexture.ReleaseTemporary(rt);
    }
}
```

**缺点**：
- 每帧创建/销毁 RenderTexture（性能开销）
- 内存分配增加
- 适合低帧率场景

---

## ?? 测试验证

### 测试步骤
1. 启动游戏，开启立绘模式
2. 鼠标移到立绘上（不按 Shift）
3. 观察半透明效果

### 预期结果
- ? 整体半透明（alpha=0.2）
- ? 嘴部和眼睛区域透明度一致
- ? 无"重影"或"双重透明"效果
- ? 视觉效果自然

### 如果仍有问题
检查纹理导入设置：
1. 打开 `Textures/UI/Narrators/9x16/Layered/{PersonaName}/`
2. 检查每个 PNG 文件：
   - ? 图像模式：RGBA (32-bit)
   - ? 透明区域：Alpha=0
   - ? 不透明区域：Alpha=255
   - ? 避免使用 RGB (24-bit) 格式

---

## ?? 性能对比

| 方案 | CPU占用 | GPU占用 | 内存占用 | 视觉质量 |
|------|---------|---------|----------|----------|
| 方案1 (预合成) | 高 | 中 | 高 | 完美 |
| 方案2 (混合模式) | 低 | 低 | 低 | 优秀 |

**推荐**：优先使用方案2（混合模式），性能最优。

---

## ? 验收标准

1. 半透明模式下，立绘整体透明度一致
2. 嘴部和眼睛区域无"双重透明"效果
3. 动画播放时（眨眼、张嘴）透明度保持一致
4. 按下 Shift 后，立绘完全不透明
5. 性能无明显下降（60fps+）

---

**修复建议**：使用方案2（混合模式渲染），简单高效！
