# ?? The Second Seat - 立绘加载系统实现计划

## ?? 当前状态

### ? 未实现的功能
- 用户上传自定义立绘
- 从 Mod Textures 目录加载立绘
- 立绘预览功能
- 立绘管理界面

### ? 已实现的功能
- PersonaDef 中的 `portraitPath` 字段
- PersonaSelectionWindow 中的占位符代码
- 颜色分析（primaryColor, secondaryColor）

---

## ?? 实现目标

### 1. 加载 Mod 自带立绘
从 `Textures/Narrators/` 目录加载预设立绘图片

### 2. 支持用户自定义立绘
- 从用户指定的外部路径加载
- 支持常见图片格式（PNG, JPG）
- 自动缓存加载的纹理

### 3. 立绘管理界面
- 在人格选择窗口中显示立绘预览
- 支持点击选择立绘文件
- 显示立绘信息（尺寸、格式）

---

## ??? 实现方案

### 方案 A：使用 RimWorld ContentFinder（推荐）

**优点**：
- 自动处理 Mod 目录路径
- 支持多个 Mod 之间的纹理共享
- 内置缓存机制

**实现**：
```csharp
// 1. 从 Mod Textures 目录加载
Texture2D texture = ContentFinder<Texture2D>.Get("Narrators/Cassandra", false);

// 2. 路径结构
// Mods/TheSecondSeat/Textures/Narrators/Cassandra.png
```

### 方案 B：支持外部路径（用户上传）

**实现**：
```csharp
// 从外部文件加载
public static Texture2D LoadTextureFromFile(string filePath)
{
    if (!File.Exists(filePath)) return null;
    
    byte[] fileData = File.ReadAllBytes(filePath);
    Texture2D texture = new Texture2D(2, 2);
    texture.LoadImage(fileData); // 自动调整大小
    
    return texture;
}
```

### 方案 C：混合方案（最佳）

1. 优先从 Mod Textures 加载（使用 defName）
2. 如果未找到，尝试从 `portraitPath` 指定的外部路径加载
3. 如果都失败，使用 primaryColor 作为占位符

---

## ?? 目录结构设计

```
TheSecondSeat/
├── Textures/
│   └── Narrators/
│       ├── Cassandra.png       # 256x256, PNG
│       ├── Phoebe.png
│       ├── Randy.png
│       ├── Igor.png
│       └── Luna.png
│
├── UserPortraits/              # 用户自定义（存储在配置目录）
│   ├── Custom1.png
│   └── Custom2.png
│
└── Defs/
    └── NarratorPersonaDefs.xml
```

---

## ?? 实现步骤

### 步骤 1：创建 PortraitLoader 工具类

**文件**：`Source/TheSecondSeat/PersonaGeneration/PortraitLoader.cs`

**功能**：
- 加载 Mod 自带立绘
- 加载外部文件立绘
- 纹理缓存管理
- 格式验证和大小调整

### 步骤 2：更新 PersonaSelectionWindow

**功能**：
- 显示实际立绘（替代颜色方块）
- 添加"选择立绘"按钮
- 文件选择对话框
- 立绘预览缩放

### 步骤 3：更新 NarratorPersonaDef

**新增字段**：
```xml
<portraitPath>Narrators/Cassandra</portraitPath>  <!-- Mod 内部路径 -->
<customPortraitPath></customPortraitPath>         <!-- 外部文件路径 -->
<useCustomPortrait>false</useCustomPortrait>      <!-- 是否使用自定义 -->
```

### 步骤 4：添加设置选项

**ModSettings 新增**：
- 自定义立绘目录路径
- 是否启用立绘缓存
- 立绘显示质量（高/中/低）

---

## ?? 详细实现代码

### 1. PortraitLoader.cs

```csharp
using System;
using System.Collections.Generic;
using System.IO;
using UnityEngine;
using Verse;

namespace TheSecondSeat.PersonaGeneration
{
    /// <summary>
    /// 立绘加载和管理工具
    /// </summary>
    public static class PortraitLoader
    {
        private static Dictionary<string, Texture2D> cache = new Dictionary<string, Texture2D>();
        
        /// <summary>
        /// 加载立绘（优先 Mod，其次外部文件，最后占位符）
        /// </summary>
        public static Texture2D LoadPortrait(NarratorPersonaDef def)
        {
            // 1. 检查缓存
            string cacheKey = def.defName;
            if (cache.TryGetValue(cacheKey, out Texture2D cached))
            {
                return cached;
            }
            
            Texture2D texture = null;
            
            // 2. 尝试加载自定义立绘
            if (def.useCustomPortrait && !string.IsNullOrEmpty(def.customPortraitPath))
            {
                texture = LoadFromExternalFile(def.customPortraitPath);
                if (texture != null)
                {
                    Log.Message($"[PortraitLoader] 已加载自定义立绘: {def.customPortraitPath}");
                }
            }
            
            // 3. 尝试从 Mod Textures 加载
            if (texture == null && !string.IsNullOrEmpty(def.portraitPath))
            {
                texture = ContentFinder<Texture2D>.Get(def.portraitPath, false);
                if (texture != null)
                {
                    Log.Message($"[PortraitLoader] 已加载 Mod 立绘: {def.portraitPath}");
                }
            }
            
            // 4. 生成占位符
            if (texture == null)
            {
                texture = GeneratePlaceholder(def.primaryColor);
                Log.Warning($"[PortraitLoader] 未找到立绘，使用占位符: {def.defName}");
            }
            
            // 缓存
            cache[cacheKey] = texture;
            return texture;
        }
        
        /// <summary>
        /// 从外部文件加载纹理
        /// </summary>
        public static Texture2D LoadFromExternalFile(string filePath)
        {
            try
            {
                if (!File.Exists(filePath))
                {
                    Log.Warning($"[PortraitLoader] 文件不存在: {filePath}");
                    return null;
                }
                
                byte[] fileData = File.ReadAllBytes(filePath);
                Texture2D texture = new Texture2D(2, 2);
                
                if (!texture.LoadImage(fileData))
                {
                    Log.Error($"[PortraitLoader] 无法加载图片: {filePath}");
                    return null;
                }
                
                return texture;
            }
            catch (Exception ex)
            {
                Log.Error($"[PortraitLoader] 加载失败: {filePath}\n{ex}");
                return null;
            }
        }
        
        /// <summary>
        /// 生成颜色占位符纹理
        /// </summary>
        private static Texture2D GeneratePlaceholder(Color color)
        {
            Texture2D texture = new Texture2D(256, 256);
            Color[] pixels = new Color[256 * 256];
            for (int i = 0; i < pixels.Length; i++)
            {
                pixels[i] = color;
            }
            texture.SetPixels(pixels);
            texture.Apply();
            return texture;
        }
        
        /// <summary>
        /// 清空缓存
        /// </summary>
        public static void ClearCache()
        {
            cache.Clear();
            Log.Message("[PortraitLoader] 立绘缓存已清空");
        }
        
        /// <summary>
        /// 获取推荐的用户立绘目录
        /// </summary>
        public static string GetUserPortraitsDirectory()
        {
            string path = Path.Combine(GenFilePaths.SaveDataFolderPath, "TheSecondSeat", "Portraits");
            if (!Directory.Exists(path))
            {
                Directory.CreateDirectory(path);
            }
            return path;
        }
        
        /// <summary>
        /// 打开文件选择对话框（需要 SteamworksSharp 或 Windows Forms）
        /// </summary>
        public static string OpenFileDialog()
        {
            // 注意：RimWorld 原生不支持文件对话框
            // 需要使用第三方库或让用户手动复制文件到指定目录
            
            string userDir = GetUserPortraitsDirectory();
            Messages.Message($"请将立绘文件（PNG/JPG）复制到以下目录:\n{userDir}", MessageTypeDefOf.NeutralEvent);
            
            // 打开文件夹
            Application.OpenURL("file://" + userDir);
            
            return userDir;
        }
    }
}
```

### 2. 更新 PersonaSelectionWindow.cs

**修改 DrawPortraitPreview 方法**：
```csharp
private void DrawPortraitPreview(Rect rect, NarratorPersonaDef persona)
{
    // 加载立绘
    var texture = PortraitLoader.LoadPortrait(persona);
    
    if (texture != null)
    {
        // 绘制纹理
        GUI.DrawTexture(rect, texture, ScaleMode.ScaleToFit);
    }
    else
    {
        // 回退到颜色方块
        Widgets.DrawBoxSolid(rect, persona.primaryColor);
    }
    
    // 边框
    Widgets.DrawBox(rect);
    
    // 右键菜单：更换立绘
    if (Mouse.IsOver(rect) && Event.current.type == EventType.MouseDown && Event.current.button == 1)
    {
        List<FloatMenuOption> options = new List<FloatMenuOption>();
        
        // 选项 1：使用 Mod 自带立绘
        options.Add(new FloatMenuOption("使用 Mod 自带立绘", () => {
            persona.useCustomPortrait = false;
            PortraitLoader.ClearCache();
        }));
        
        // 选项 2：选择自定义立绘
        options.Add(new FloatMenuOption("选择自定义立绘", () => {
            string userDir = PortraitLoader.OpenFileDialog();
            // 用户手动复制文件后，可以在下方列表中选择
            OpenCustomPortraitPicker(persona);
        }));
        
        // 选项 3：清除自定义立绘
        if (persona.useCustomPortrait)
        {
            options.Add(new FloatMenuOption("清除自定义立绘", () => {
                persona.useCustomPortrait = false;
                persona.customPortraitPath = "";
                PortraitLoader.ClearCache();
            }));
        }
        
        Find.WindowStack.Add(new FloatMenu(options));
        Event.current.Use();
    }
}

private void OpenCustomPortraitPicker(NarratorPersonaDef persona)
{
    string userDir = PortraitLoader.GetUserPortraitsDirectory();
    var files = Directory.GetFiles(userDir, "*.png")
        .Concat(Directory.GetFiles(userDir, "*.jpg"))
        .ToList();
    
    if (files.Count == 0)
    {
        Messages.Message("未找到立绘文件，请将 PNG 或 JPG 文件复制到指定目录", MessageTypeDefOf.RejectInput);
        return;
    }
    
    List<FloatMenuOption> options = new List<FloatMenuOption>();
    foreach (string file in files)
    {
        string fileName = Path.GetFileName(file);
        options.Add(new FloatMenuOption(fileName, () => {
            persona.useCustomPortrait = true;
            persona.customPortraitPath = file;
            PortraitLoader.ClearCache();
            Messages.Message($"已设置自定义立绘: {fileName}", MessageTypeDefOf.PositiveEvent);
        }));
    }
    
    Find.WindowStack.Add(new FloatMenu(options));
}
```

### 3. 更新 NarratorPersonaDef.cs

**新增字段**：
```csharp
public class NarratorPersonaDef : Def
{
    // ...existing fields...
    
    public string portraitPath = "";        // Mod 内部路径
    public string customPortraitPath = "";  // 外部文件路径
    public bool useCustomPortrait = false;  // 是否使用自定义
    
    // ...existing methods...
}
```

### 4. 准备 Mod 自带立绘

**目录**：`Textures/Narrators/`

**文件列表**：
- `Cassandra.png` - 256x256, 蓝色系战略型女性
- `Phoebe.png` - 256x256, 绿色系友善型女性
- `Randy.png` - 256x256, 橙色系混乱型男性
- `Igor.png` - 256x256, 红色系施虐型男性
- `Luna.png` - 256x256, 青色系保护型女性

**图片规格**：
- 格式：PNG with transparency
- 尺寸：256x256 pixels
- 风格：Anime/semi-realistic portrait
- 内容：头部和肩膀特写

---

## ?? 用户使用流程

### 使用 Mod 自带立绘
```
1. 安装模组
2. 启动游戏
3. 人格选择 → 自动显示立绘
```

### 使用自定义立绘
```
1. 准备立绘文件（PNG/JPG，推荐 256x256）
2. 打开人格选择窗口
3. 右键点击立绘 → "选择自定义立绘"
4. 系统打开用户立绘目录
5. 将立绘文件复制到该目录
6. 刷新列表，选择文件
7. 完成！
```

---

## ?? 技术细节

### 纹理加载性能
- **缓存机制**：首次加载后缓存，避免重复 I/O
- **延迟加载**：仅在显示时加载
- **内存管理**：限制缓存大小，自动清理

### 文件格式支持
- ? PNG（推荐，支持透明）
- ? JPG（支持，但无透明）
- ? GIF（不支持动画）
- ? BMP（不推荐，体积大）

### 错误处理
- 文件不存在 → 回退到 Mod 立绘
- 格式不支持 → 显示错误消息
- 加载失败 → 使用颜色占位符

---

## ?? 后续优化

### v1.1 计划
- [ ] 立绘编辑器（裁剪、缩放、滤镜）
- [ ] 在线立绘库（从社区下载）
- [ ] 立绘动画支持（眨眼、表情变化）
- [ ] 多立绘切换（根据好感度/心情）

### v1.2 计划
- [ ] 实时立绘生成（AI 生成）
- [ ] 立绘与人格自动匹配
- [ ] 立绘质量分析和优化建议

---

## ?? 已知限制

1. **文件选择对话框**：RimWorld 不原生支持，需要用户手动复制文件
2. **动画支持**：当前仅支持静态图片
3. **内存占用**：大量高分辨率立绘可能占用较多内存
4. **跨平台兼容性**：外部文件路径在 Linux/Mac 上需要测试

---

## ?? 实现优先级

### 高优先级（v1.0 必须）
1. ? 从 Mod Textures 加载立绘
2. ? 颜色占位符回退
3. ? 立绘缓存机制

### 中优先级（v1.1 计划）
4. ? 用户自定义立绘加载
5. ? 立绘选择界面
6. ? 右键菜单快捷操作

### 低优先级（v1.2+ 计划）
7. ?? 立绘编辑功能
8. ?? 在线立绘库
9. ?? 动画支持

---

## ?? 立即行动

### 现在就实现基础功能：

**命令**：
```bash
# 创建 PortraitLoader.cs
# 创建 Textures/Narrators/ 目录
# 准备 5 个内置人格立绘
# 更新 PersonaSelectionWindow.cs
# 更新 NarratorPersonaDef.cs
# 测试加载功能
```

**预计时间**：2-3 小时

**优先级**：????? （高）

---

**版本**: 1.0-draft  
**创建时间**: 2025-01-XX  
**作者**: The Second Seat Team
