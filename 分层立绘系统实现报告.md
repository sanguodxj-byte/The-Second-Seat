# 分层立绘系统实现报告 v1.6.20

## ?? 任务目标
**全面取代完整表情立绘，创建完整的分层立绘系统，支持图层合成、服装更换、动态表情。**

---

## ? 已实现功能

### 1. 核心类库

#### **LayerDefinition.cs**
- [x] `LayerType` 枚举（8种图层类型）
  - Background（背景）
  - Body（身体）
  - Outfit（服装）
  - Face（面部表情）
  - Hair（头发）
  - Accessories（配饰）
  - ForegroundFX（前景特效）
  - Overlay（覆盖层）

- [x] `BlendMode` 枚举（5种混合模式）
  - Normal（标准 Alpha 混合）
  - Multiply（正片叠底）
  - Screen（滤色）
  - Overlay（叠加）
  - Additive（加法混合，用于光效）

- [x] `LayerDefinition` 类（单图层定义）
  - 图层类型、名称、优先级
  - 纹理路径（支持变量替换：{persona}, {expression}, {outfit}）
  - 混合模式、不透明度
  - 必需标志、启用标志
  - 表情过滤器、服装过滤器
  - 偏移量、缩放、色调调整
  - `ResolveTexturePath()` 方法
  - `ShouldLoad()` 条件判断

- [x] `LayeredPortraitConfig` 类（完整配置）
  - 人格 defName
  - 图层列表（自动按优先级排序）
  - 输出尺寸（默认 1024×1572）
  - 缓存开关
  - `AddLayer()` / `RemoveLayer()` 方法
  - `SortLayers()` 自动排序
  - `GetActiveLayersForCondition()` 条件过滤
  - `CreateDefault()` 默认配置生成
  - `Validate()` 配置验证
  - `GetDebugInfo()` 调试信息

#### **LayeredPortraitCompositor.cs**
- [x] 图层合成核心逻辑
  - `CompositeLayers()` 主合成方法
  - 缓存系统（避免重复合成）
  - `PerformComposite()` 像素级合成
  - `BlendLayer()` 单图层混合
  - 5种混合模式实现（Normal, Multiply, Screen, Overlay, Additive）
  - `MakeReadable()` 纹理转换
  - `GenerateFallbackTexture()` 占位符生成
  - `ClearCache()` / `ClearCache(personaDefName)` 缓存清理
  - `GetCacheStats()` 缓存统计

### 2. 集成到现有系统

#### **NarratorPersonaDef.cs**
- [x] 新增字段
  - `useLayeredPortrait` (bool) - 是否启用分层系统
  - `layeredConfigPath` (string) - 自定义配置文件路径（可选）
  - `cachedLayeredConfig` (LayeredPortraitConfig) - 运行时缓存

- [x] 新增方法
  - `GetLayeredConfig()` - 获取或创建分层配置
  - `SetLayeredConfig()` - 设置自定义配置

#### **PortraitLoader.cs**
- [x] `LoadPortrait()` 方法扩展
  - 检测 `useLayeredPortrait` 标志
  - 自动切换到分层加载模式

- [x] 新增 `LoadLayeredPortrait()` 方法
  - 获取分层配置
  - 确定当前表情和服装
  - 调用 `LayeredPortraitCompositor.CompositeLayers()`
  - 缓存合成结果

### 3. 资源管理

#### **目录结构**
```
Textures/UI/Narrators/9x16/Layers/{人格名称}/
├── body.png                    # 身体层（必需）
├── outfit_default.png          # 默认服装层
├── face_neutral.png            # 中性表情（必需）
├── face_happy.png              # 开心表情
├── face_sad.png                # 悲伤表情
├── (... 其他表情)
├── hair.png                    # 头发层
├── accessories.png             # 配饰层
├── fx.png                      # 特效层
└── background.png              # 背景层
```

#### **README.md**
- [x] 完整的资源放置说明
- [x] 图层说明和优先级
- [x] 快速开始指南
- [x] 故障排查指南
- [x] 高级功能说明

---

## ?? 使用方法

### 方法 1: XML 配置（推荐）

在 `Defs/NarratorPersonaDefs.xml` 中:

```xml
<NarratorPersonaDef>
  <defName>Sideria_Default</defName>
  <narratorName>Sideria</narratorName>
  
  <!-- ? 启用分层立绘系统 -->
  <useLayeredPortrait>true</useLayeredPortrait>
  
  <!-- 其他配置... -->
</NarratorPersonaDef>
```

**自动行为**:
- 系统会自动创建默认配置（7个图层）
- 根据表情类型自动选择 `face_{expression}.png`
- 自动合成并缓存结果

### 方法 2: 代码配置（高级）

```csharp
// 创建自定义配置
var config = new LayeredPortraitConfig
{
    PersonaDefName = "Sideria_Default"
};

// 添加自定义图层
config.AddLayer(new LayerDefinition
{
    Type = LayerType.Body,
    Name = "body",
    Priority = 10,
    TexturePath = "UI/Narrators/9x16/Layers/{persona}/body.png",
    Required = true
});

config.AddLayer(new LayerDefinition
{
    Type = LayerType.Face,
    Name = "face",
    Priority = 30,
    TexturePath = "UI/Narrators/9x16/Layers/{persona}/face_{expression}.png",
    Required = true
});

// 应用配置
def.SetLayeredConfig(config);

// 加载立绘
Texture2D portrait = PortraitLoader.LoadPortrait(def, ExpressionType.Happy);
```

---

## ?? 性能优化

### 1. **缓存机制**
- ? 自动缓存合成结果
- ? 避免重复合成相同配置
- ? 缓存键格式：`{personaDefName}_{expression}_{outfit}`

### 2. **条件加载**
- ? 图层可设置表情过滤器（仅在特定表情时加载）
- ? 图层可设置服装过滤器（仅在特定服装时加载）
- ? 可禁用不需要的图层

### 3. **内存管理**
- ? 支持手动清理缓存：`LayeredPortraitCompositor.ClearCache()`
- ? 支持清理特定人格：`LayeredPortraitCompositor.ClearCache("Sideria_Default")`
- ? 缓存统计：`GetCacheStats()`

---

## ?? 与完整表情立绘的对比

| 特性 | 完整表情立绘 | 分层立绘系统 |
|:-----|:------------|:------------|
| **美术工作量** | 每个表情需要绘制完整立绘 | 只需绘制变化的部分（面部） |
| **文件数量** | 13个完整文件（每个表情1个）| 2-8个图层文件（可复用） |
| **文件大小** | 13×2MB = 26MB | 8×0.5MB = 4MB |
| **换装支持** | 需要为每个服装绘制13个表情 | 只需添加1个服装图层 |
| **内存占用** | 高（13个完整纹理） | 中（图层可复用） |
| **灵活性** | 低（固定表情） | 高（图层可组合） |
| **运行时性能** | 高（直接加载） | 中（需要合成，但有缓存） |

---

## ?? 未来扩展

### 1. **服装系统**
- [ ] 实现 `OutfitSystem.GetCurrentOutfit(personaDefName)`
- [ ] 支持多套服装切换（casual, formal, battle 等）
- [ ] 服装与事件联动（战斗时切换装备）

### 2. **配置文件加载**
- [ ] 支持从 XML/JSON 加载自定义图层配置
- [ ] 使用 `layeredConfigPath` 字段加载外部配置

### 3. **动画支持**
- [ ] 图层支持序列帧动画（如飘动的头发）
- [ ] 特效层支持动态光效

### 4. **高级混合模式**
- [ ] 添加更多 Photoshop 风格的混合模式
- [ ] 支持图层蒙版（Mask）

---

## ?? 示例：Sideria 的分层配置

### 默认图层配置（自动生成）:
```
0.  background.png  (优先级 0, 可选, 30% 不透明度)
10. body.png        (优先级 10, 必需)
20. outfit_default.png (优先级 20, 可选)
30. face_neutral.png (优先级 30, 必需, 表情过滤)
40. hair.png        (优先级 40, 可选)
50. accessories.png (优先级 50, 可选)
60. fx.png          (优先级 60, 可选, Additive 混合)
```

### 合成流程示例（Happy 表情）:
```
1. 加载 background.png → 渐变灰色背景
2. 混合 body.png → 身体和皮肤
3. 混合 outfit_default.png → 黑色哥特装
4. 混合 face_happy.png → 开心表情（眼睛眯起）
5. 混合 hair.png → 银白色长发
6. 混合 accessories.png → 黑色蝴蝶结
7. 混合 fx.png (Additive) → 暗红色魔法光效
→ 输出: 1024×1572 合成纹理
```

---

## ?? 故障排查

### 问题 1: 立绘不显示
**原因**: 未启用分层系统或路径错误  
**解决**:
1. 检查 `useLayeredPortrait=true`
2. 检查文件路径：`Textures/UI/Narrators/9x16/Layers/{人格名}/body.png`
3. 检查开发模式日志

### 问题 2: 表情不变化
**原因**: 面部图层文件缺失  
**解决**:
1. 确保 `face_{expression}.png` 存在
2. 检查文件命名（全小写）：`face_happy.png`（不是 `face_Happy.png`）

### 问题 3: 图层错位
**原因**: 图层尺寸不一致  
**解决**:
1. 确保所有图层都是 1024×1572 像素
2. 使用 Photoshop 的"画布大小"功能统一尺寸

### 问题 4: 性能问题
**原因**: 缓存未生效  
**解决**:
1. 确保 `EnableCache=true`（默认启用）
2. 检查缓存统计：`LayeredPortraitCompositor.GetCacheStats()`

---

## ? 验收清单

- [x] `LayerDefinition.cs` 创建并实现
- [x] `LayeredPortraitCompositor.cs` 创建并实现
- [x] `NarratorPersonaDef.cs` 扩展支持分层配置
- [x] `PortraitLoader.cs` 集成分层加载
- [x] 缓存系统实现
- [x] 5种混合模式实现
- [x] 条件加载（表情过滤、服装过滤）
- [x] 默认配置生成
- [x] 资源目录结构创建
- [x] README.md 文档编写
- [ ] 编译测试（待执行）
- [ ] 游戏内测试（待执行）

---

## ?? 时间线

- **2025-12-12**: 分层立绘系统设计和实现
- **v1.6.20**: 核心功能完成，集成到现有系统

---

## ?? 相关文件

### 新增文件:
- `Source/TheSecondSeat/PersonaGeneration/LayerDefinition.cs`
- `Source/TheSecondSeat/PersonaGeneration/LayeredPortraitCompositor.cs`
- `Textures/UI/Narrators/9x16/Layers/README.md`
- `分层立绘系统实现报告.md`

### 修改文件:
- `Source/TheSecondSeat/PersonaGeneration/NarratorPersonaDef.cs`
- `Source/TheSecondSeat/PersonaGeneration/PortraitLoader.cs`

---

## ?? 总结

分层立绘系统已完整实现，主要优势：

1. **美术资源优化**: 减少文件数量和大小（26MB → 4MB）
2. **灵活性提升**: 支持图层组合、服装更换
3. **维护成本降低**: 修改表情只需更新面部图层
4. **性能优化**: 缓存机制确保合成结果可复用
5. **扩展性强**: 支持自定义图层、混合模式、配置文件

**状态**: ? **核心功能完成，待编译测试**  
**版本**: v1.6.20  
**时间**: 2025-12-12
