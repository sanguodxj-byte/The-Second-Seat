# ?? 表情系统完整测试指南

## ?? 测试前准备

### 1. 重启游戏（必须！）
```
? 错误：不重启游戏，DLL 不会生效
? 正确：完全退出 RimWorld → 等待 5 秒 → 重新启动
```

### 2. 开启开发者模式
```
1. 游戏主菜单 → Options → 开启 Development Mode
2. 或在游戏中按 `~` 键打开控制台
```

### 3. 打开日志窗口
```
Dev Mode → Logs (或按 Ctrl+F12)
设置过滤器：搜索 "ExpressionDebug" 或 "ExpressionSystem"
```

---

## ?? 测试步骤

### 步骤 1: 打开 AI 对话窗口
```
方法 1: 点击屏幕右上角的 AI 按钮
方法 2: 使用快捷键（如果配置了）
```

### 步骤 2: 进入人格选择
```
1. 在 AI 对话窗口左侧找到"切换人格"按钮
2. 点击打开人格列表
```

### 步骤 3: 打开表情调试窗口
```
1. 在人格列表中找到任意人格（如 Sideria）
2. 右键点击该人格
3. 从弹出菜单中选择"表情调试"
```

### 步骤 4: 测试表情切换
```
1. 观察左侧立绘预览（应显示当前人格的立绘）
2. 在右侧列表中点击任意表情（如"开心"）
3. 观察以下内容：
   ? 日志窗口是否有输出
   ? 左侧立绘是否变化
   ? 屏幕底部是否显示消息提示
```

---

## ?? 期望结果

### 成功标志 ?

#### 1. 日志输出（最重要！）
打开日志窗口后，点击表情应该看到：

```
[ExpressionDebug] 点击表情按钮: Happy
[ExpressionDebug] 人格 defName: Sideria_Default
[ExpressionDebug] 人格 narratorName: Sideria
[ExpressionSystem] Sideria_Default 表情切换: Neutral → Happy (触发: Manual)
[ExpressionDebug] 表情切换完成，当前状态: Happy
```

**关键信息解读**：
- `defName: Sideria_Default` - 人格定义名称
- `表情切换: Neutral → Happy` - 从中性切换到开心
- `当前状态: Happy` - 确认切换成功

#### 2. 立绘预览变化
- ? 左侧立绘应该从 `base.png` 变为 `happy.png`
- ? 预览框标题显示"当前表情：[^_^] 开心"
- ? 右侧列表中"开心"一行高亮显示（绿色背景）

#### 3. 消息提示
- ? 屏幕底部显示"已切换至表情：[^_^] 开心"

---

## ?? 故障排查

### 问题 1: 点击表情没有任何反应

#### 症状
- 日志窗口无任何输出
- 立绘没有变化
- 没有消息提示

#### 可能原因
```
? 游戏没有重启（旧 DLL 仍在运行）
? 按钮点击被其他 UI 元素阻挡
? 日志过滤器设置错误
```

#### 解决方案
```
1. 完全退出游戏，等待 5 秒后重启
2. 确保点击在表情列表项的范围内（不要点边缘）
3. 移除日志过滤器，查看所有日志
4. 尝试点击不同的表情（如"悲伤"、"愤怒"）
```

---

### 问题 2: 有日志输出，但立绘没变化

#### 症状
```
? 日志显示: [ExpressionDebug] 点击表情按钮: Happy
? 日志显示: [ExpressionSystem] 表情切换: Neutral → Happy
? 立绘预览仍然是 base.png
```

#### 可能原因
```
? 表情文件不存在（如 happy.png 缺失）
? PortraitLoader 路径配置错误
? 立绘预览没有刷新
```

#### 解决方案
```powershell
# 1. 验证表情文件是否存在
Test-Path "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\9x16\Expressions\Sideria\happy.png"

# 2. 检查所有已部署的表情
Get-ChildItem "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\9x16\Expressions\Sideria\" -File

# 3. 如果文件缺失，重新部署
.\Deploy-Complete.ps1
```

#### 查看加载日志
在日志中搜索 `[PortraitLoader]`：
```
期望看到:
[PortraitLoader] 加载立绘: UI/Narrators/9x16/Expressions/Sideria/happy

如果看到错误:
[PortraitLoader] 找不到纹理: UI/Narrators/9x16/Expressions/Sideria/happy
```

---

### 问题 3: defName 不正确

#### 症状
```
? 日志显示: [ExpressionDebug] 人格 defName: Cassandra_Classic
   （应该是 Sideria_Default）
```

#### 原因
- 你点击的是 Cassandra，不是 Sideria

#### 解决方案
```
1. 确认人格列表中存在 Sideria
2. 右键点击 Sideria（不是 Cassandra）
3. 选择"表情调试"
```

#### 如果 Sideria 不存在
```powershell
# 检查人格定义文件
Test-Path "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Defs\NarratorPersonaDefs\Sideria.xml"

# 如果不存在，重新创建
.\Create-Sideria-Def.ps1

# 重新部署
Copy-Item "Defs\NarratorPersonaDefs\Sideria.xml" "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Defs\NarratorPersonaDefs\" -Force
```

---

### 问题 4: 表情文件路径错误

#### 症状
```
[PortraitLoader] 尝试加载: UI/Narrators/Sideria/happy
[PortraitLoader] 找不到纹理
```

#### 原因
- 路径应该是 `UI/Narrators/9x16/Expressions/Sideria/happy`

#### 解决方案
检查 `Sideria.xml` 中的 `portraitPath`：

```xml
<!-- 正确 ? -->
<portraitPath>UI/Narrators/9x16/Sideria/base</portraitPath>

<!-- 错误 ? -->
<portraitPath>UI/Narrators/Sideria/base</portraitPath>
```

---

## ?? 文件检查清单

### 必须存在的文件

#### Sideria 人格定义
```
? D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Defs\NarratorPersonaDefs\Sideria.xml
```

#### 基础立绘
```
? D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Textures\UI\Narrators\9x16\Sideria\base.png
```

#### 表情差分（至少 7 个）
```
? ...\Textures\UI\Narrators\9x16\Expressions\Sideria\happy.png
? ...\Textures\UI\Narrators\9x16\Expressions\Sideria\sad.png
? ...\Textures\UI\Narrators\9x16\Expressions\Sideria\angry.png
? ...\Textures\UI\Narrators\9x16\Expressions\Sideria\surprised.png
? ...\Textures\UI\Narrators\9x16\Expressions\Sideria\thoughtful.png
? ...\Textures\UI\Narrators\9x16\Expressions\Sideria\annoyed.png
? ...\Textures\UI\Narrators\9x16\Expressions\Sideria\smug.jpg
?? ...\Textures\UI\Narrators\9x16\Expressions\Sideria\worried.png (缺失)
?? ...\Textures\UI\Narrators\9x16\Expressions\Sideria\disappointed.png (缺失)
```

---

## ?? 逐项测试表

### 表情切换测试

| 表情 | 文件存在 | 日志输出 | 立绘变化 | 消息提示 | 结果 |
|------|---------|---------|---------|---------|------|
| **中性 (Neutral)** | ? base.png | ? | ? | ? | ? |
| **开心 (Happy)** | ? happy.png | ? | ? | ? | ? |
| **悲伤 (Sad)** | ? sad.png | ? | ? | ? | ? |
| **愤怒 (Angry)** | ? angry.png | ? | ? | ? | ? |
| **惊讶 (Surprised)** | ? surprised.png | ? | ? | ? | ? |
| **沉思 (Thoughtful)** | ? thoughtful.png | ? | ? | ? | ? |
| **烦躁 (Annoyed)** | ? annoyed.png | ? | ? | ? | ? |
| **得意 (Smug)** | ? smug.jpg | ? | ? | ? | ? |
| **担忧 (Worried)** | ? 缺失 | ? | ? | ? | ? |
| **失望 (Disappointed)** | ? 缺失 | ? | ? | ? | ? |

**测试方法**：
1. 依次点击每个表情
2. 在对应列中打勾 ? 或打叉 ?
3. 记录任何错误或异常

---

## ?? 成功标准

### 完全成功 ?
- ? 所有可用表情（7 个）都能正常切换
- ? 日志输出完整且正确
- ? 立绘预览实时更新
- ? 消息提示正常显示
- ? 没有任何错误或警告

### 部分成功 ??
- ? 大部分表情能正常切换
- ? 日志输出正确
- ? 个别表情文件缺失（worried, disappointed）
- ? 立绘预览正常

### 失败 ?
- ? 点击表情没有任何反应
- ? 日志没有输出
- ? 立绘预览不变化

---

## ?? 测试报告模板

完成测试后，请提供以下信息：

```
### 测试环境
- RimWorld 版本: ________
- Mod 版本: ________
- 测试日期: ________

### 日志输出
粘贴日志窗口中的相关输出（如果有）：
```
[ExpressionDebug] ...
[ExpressionSystem] ...
```

### 测试结果
- [ ] 表情调试窗口正常打开
- [ ] 点击表情有日志输出
- [ ] 立绘预览能正确切换
- [ ] 消息提示正常显示

### 发现的问题
（如果有，请详细描述）

### 截图
（如果可能，提供调试窗口的截图）
```

---

## ?? 下一步

### 如果测试成功
1. 测试好感度调试功能
2. 测试表情自动恢复（3 秒后回到 Neutral）
3. 测试根据好感度自动切换表情

### 如果测试失败
1. 将日志输出粘贴给我
2. 说明具体症状（没反应/有日志但立绘不变/等）
3. 我会帮你诊断问题

---

**准备好了吗？重启游戏开始测试！** ??
