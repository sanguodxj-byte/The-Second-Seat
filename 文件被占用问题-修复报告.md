# 文件被占用问题 - 修复完成

## ? 已修复

### 问题
```
[PersonaDefExporter] 复制立绘失败: System.IO.IOException: 
The process cannot access the file because it is being used by another process.
```

### 原因
立绘文件 `Sideria.png` 被以下进程之一占用：
- Unity/RimWorld 游戏进程
- Windows 图片查看器
- 其他图片编辑器

---

## ?? 修复方案

### 1. 代码层面修复（已完成）

**增强的重试逻辑**：
```csharp
? 最多重试 5 次
? 递增等待时间（500ms → 1000ms → 1500ms...）
? 先尝试删除再复制
? 失败后使用带时间戳的备用文件名
? 友好的错误提示
```

**修复位置**：
- `Source\TheSecondSeat\PersonaGeneration\PersonaDefExporter.cs`
- `CopyPortraitToModDirectory()` 方法

---

## ?? 用户解决方案

### 方案 1: 重启游戏（推荐）
```
1. 完全退出 RimWorld
2. 等待 5 秒
3. 重新启动游戏
4. 再次尝试导出人格
```

### 方案 2: 检查图片查看器
```
1. 检查是否用 Windows 照片查看器打开了 Sideria.png
2. 关闭所有图片查看器
3. 重试
```

### 方案 3: 使用任务管理器
```
1. Ctrl + Shift + Esc 打开任务管理器
2. 结束 "照片查看器" 或 "画图" 进程
3. 重试
```

### 方案 4: 备用文件名（自动）
```
如果重试 5 次都失败，系统会自动：
- 使用带时间戳的文件名
- 例如：Sideria_20250119143022.png
- 避免冲突
```

---

## ?? 错误处理流程

```
尝试复制立绘
    ↓
目标文件存在？
    ↓ Yes
尝试删除旧文件
    ↓
删除成功？
    ↓ Yes
复制新文件
    ↓
复制成功？
    ↓ No
等待 500ms × (重试次数 + 1)
    ↓
重试（最多 5 次）
    ↓
仍然失败？
    ↓ Yes
使用带时间戳的备用文件名
    ↓
Sideria_20250119143022.png
```

---

## ?? 日志监控

### 成功标志
```
[PersonaDefExporter] 已复制立绘: xxx → xxx
? 成功导出人格：Sideria
```

### 重试标志
```
[PersonaDefExporter] 无法删除目标文件（被占用），尝试直接覆盖... (1/5)
[PersonaDefExporter] 复制失败，500ms后重试... (1/5)
```

### 使用备用文件名
```
[PersonaDefExporter] 使用备用文件名保存: Sideria_20250119143022.png
```

### 完全失败
```
[PersonaDefExporter] 复制立绘失败（重试5次后）
?? 立绘复制失败
无法复制立绘文件，目标文件可能被Unity或其他进程占用。
请关闭所有图片查看器，然后重试。
```

---

## ?? 部署新版本

### 当前状态
```
? 代码已修复
? 编译成功（0 errors, 0 warnings）
?? DLL 未部署（游戏正在运行）
```

### 部署步骤
```powershell
# 1. 关闭 RimWorld
# 2. 运行部署命令
Copy-Item "Source\TheSecondSeat\bin\Release\net472\TheSecondSeat.dll" `
          "D:\steam\steamapps\common\RimWorld\Mods\TheSecondSeat\Assemblies\" `
          -Force

# 3. 重新启动游戏
```

---

## ?? 测试清单

启动游戏后测试：

- [ ] 多模态分析功能正常
- [ ] 人格导出无文件占用错误
- [ ] 如果失败，会自动重试 5 次
- [ ] 重试失败后使用备用文件名
- [ ] 错误提示友好且有用
- [ ] 立绘自动分割功能正常

---

## ?? 技术细节

### 重试策略
```csharp
重试次数: 5
等待时间: 500ms × (重试次数 + 1)
- 第 1 次: 等待 500ms
- 第 2 次: 等待 1000ms
- 第 3 次: 等待 1500ms
- 第 4 次: 等待 2000ms
- 第 5 次: 等待 2500ms
总等待: 最多 7.5 秒
```

### 备用文件名格式
```
原始: Sideria.png
备用: Sideria_20250119143022.png
格式: {原始名称}_{yyyyMMddHHmmss}.png
```

---

## ? 总结

**修复内容**：
1. ? 增强的文件复制重试逻辑
2. ? 自动删除旧文件
3. ? 递增等待时间
4. ? 备用文件名机制
5. ? 友好的错误提示

**下一步**：
1. 关闭 RimWorld
2. 部署新 DLL
3. 重新启动游戏
4. 测试人格导出功能
5. 测试立绘自动分割功能

**状态**: ? 代码修复完成，等待部署测试
